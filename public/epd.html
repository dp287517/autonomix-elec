
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>EPD Builder - DRPCE / AutonomiX</title>

  <!-- üîê Auth guard -->
  <script>
    (async function(){
      try{
        const token = localStorage.getItem('autonomix_token');
        if(!token){ window.location.href = 'login.html'; return; }
        const r = await fetch('/api/me', { headers: { Authorization: 'Bearer '+token }});
        if(!r.ok){ localStorage.removeItem('autonomix_token'); localStorage.removeItem('autonomix_user'); window.location.href = 'login.html'; }
      }catch{ window.location.href = 'login.html'; }
    })();
  </script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root{ --offcanvas-w: clamp(420px, 40vw, 560px); }
    body{ background:#f8f9fa; font-family:'Poppins',sans-serif; color:#333; }
    .card{ border-radius:14px; box-shadow:0 4px 10px rgba(0,0,0,.06); }
    .small-muted{ font-size:.9rem; color:#6c757d; }
    .offcanvas-ia{ --bs-offcanvas-width: var(--offcanvas-w); }
    .pill{border:1px solid #e9ecef; border-radius:999px; padding:.15rem .6rem; font-size:.8rem; color:#6c757d; background:#fff;}
    .code{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Courier New",monospace }
    .thumb{ width:84px; height:84px; object-fit:cover; border:1px solid #dee2e6; border-radius:8px; }
    .status-dot{ display:inline-block; width:10px; height:10px; border-radius:50%; margin-left:.4rem; vertical-align:middle; }
    .status-green{ background:#28a745; }
    .status-orange{ background:#fd7e14; }
    .tab-disabled .nav-link:not(.active){ pointer-events:none; opacity:.5; }
  </style>
</head>
<body class="container my-5">

  <header class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h1 class="mb-1">EPD / DRPCE ‚Äî AutonomiX</h1>
      <p class="lead mb-0">Cr√©er, guider et documenter vos EPD avec IA int√©gr√©e.</p>
    </div>
    <div class="d-flex gap-2 flex-wrap">
      <a class="btn btn-outline-secondary" href="dashboard.html"><i data-lucide="home"></i> Menu</a>
      <a class="btn btn-outline-secondary" href="atex-control.html"><i data-lucide="factory"></i> Contr√¥le ATEX</a>
      <a class="btn btn-outline-secondary" href="is-loop.html"><i data-lucide="circuit-board"></i> Boucles Exi</a>
    </div>
  </header>

  <!-- Guide -->
  <div class="card mb-3">
    <div class="card-body d-flex justify-content-between align-items-center flex-wrap">
      <div class="small">
        <strong>Guide :</strong>
        <span class="ms-2">Projets <span id="st-projects" class="status-dot status-orange"></span></span>
        <span class="ms-3">Contexte <span id="st-context" class="status-dot status-orange"></span></span>
        <span class="ms-3">Zonage <span id="st-zoning" class="status-dot status-orange"></span></span>
        <span class="ms-3">√âquipements <span id="st-equip" class="status-dot status-orange"></span></span>
        <span class="ms-3">Mesures <span id="st-measures" class="status-dot status-orange"></span></span>
        <span class="ms-3">G√©n√©ration <span id="st-build" class="status-dot status-orange"></span></span>
      </div>
      <div class="d-flex gap-2">
        <button id="btnNextStep" class="btn btn-primary btn-sm"><i data-lucide="chevrons-right"></i> √âtape suivante</button>
      </div>
    </div>
  </div>

  <ul class="nav nav-tabs tab-disabled" id="epdTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="projects-tab" data-bs-toggle="tab" data-bs-target="#projects" type="button" role="tab">
        <i data-lucide="folders"></i> Projets
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="context-tab" data-bs-toggle="tab" data-bs-target="#context" type="button" role="tab">
        <i data-lucide="building-2"></i> Contexte
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="zoning-tab" data-bs-toggle="tab" data-bs-target="#zoning" type="button" role="tab">
        <i data-lucide="map"></i> Zonage ATEX
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="equip-tab" data-bs-toggle="tab" data-bs-target="#equip" type="button" role="tab">
        <i data-lucide="wrench"></i> √âquipements
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="measures-tab" data-bs-toggle="tab" data-bs-target="#measures" type="button" role="tab">
        <i data-lucide="clipboard-check"></i> Mesures
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="build-tab" data-bs-toggle="tab" data-bs-target="#build" type="button" role="tab">
        <i data-lucide="file-text"></i> G√©n√©ration
      </button>
    </li>
  </ul>

  <div class="tab-content mt-3" id="epdTabContent">

    <!-- Projets -->
    <div class="tab-pane fade show active" id="projects" role="tabpanel">
      <div class="card">
        <div class="card-header d-flex align-items-center justify-content-between flex-wrap">
          <h5 class="mb-0">Projets</h5>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-secondary" id="btnProjReload"><i data-lucide="refresh-cw"></i> Recharger</button>
            <button class="btn btn-sm btn-primary" id="btnProjNew"><i data-lucide="plus"></i> Nouveau</button>
          </div>
        </div>
        <div class="card-body">
          <div class="alert alert-info small mb-3">
            üìå <strong>Que faire ici ?</strong> Cr√©e un projet ou ouvre un existant. Ensuite compl√®te le <em>Contexte</em>, fais le <em>Zonage</em>, s√©lectionne des <em>√âquipements</em> et termine par la <em>G√©n√©ration</em> du document.
          </div>
          <div class="row g-3 align-items-end">
            <div class="col-md-3">
              <label class="form-label">Filtre statut</label>
              <select id="projFilter" class="form-select">
                <option value="">‚Äî Tous ‚Äî</option>
                <option>Brouillon</option>
                <option>En cours</option>
                <option>Termin√©</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Recherche</label>
              <input id="projSearch" class="form-control" placeholder="Titre / contenu‚Ä¶">
            </div>
          </div>

          <div class="table-responsive mt-3">
            <table class="table table-striped align-middle" id="projTable">
              <thead><tr><th>ID</th><th>Titre</th><th>Statut</th><th>Modifi√©</th><th class="text-end">Actions</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Contexte -->
    <div class="tab-pane fade" id="context" role="tabpanel">
      <div class="card mb-3">
        <div class="card-header"><h5 class="mb-0">Contexte</h5></div>
        <div class="card-body">
          <div class="alert alert-info small mb-3">
            ‚ÑπÔ∏è <strong>Que faire ici ?</strong> Renseigne <em>Entreprise, Site, R√©dacteur</em> et d√©cris le <em>proc√©d√©</em> (produits, conditions). Ces infos guident l‚ÄôIA et la suite.
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Entreprise</label>
              <input class="form-control" id="org" placeholder="Nom de l'entreprise">
            </div>
            <div class="col-md-6">
              <label class="form-label">Site / Installation</label>
              <input class="form-control" id="site" placeholder="Ex: STEP B06">
            </div>
            <div class="col-md-6">
              <label class="form-label">Adresse</label>
              <input class="form-control" id="address">
            </div>
            <div class="col-md-6">
              <label class="form-label">R√©dacteur</label>
              <input class="form-control" id="author">
            </div>
            <div class="col-12">
              <label class="form-label">Port√©e / Description du proc√©d√©</label>
              <textarea class="form-control" id="processDesc" rows="3"></textarea>
            </div>
          </div>

          <div class="mt-3 d-flex gap-2 flex-wrap">
            <div class="form-check me-3">
              <input class="form-check-input" type="radio" name="modeEPD" id="modeProjet" value="projet" checked>
              <label class="form-check-label" for="modeProjet">Projet (cr√©ation EPD)</label>
            </div>
            <div class="form-check me-3">
              <input class="form-check-input" type="radio" name="modeEPD" id="modeInspection" value="inspection">
              <label class="form-check-label" for="modeInspection">Inspection / Mise √† jour</label>
            </div>

            <button class="btn btn-outline-secondary btn-sm" id="btnScopeChecklist"><i data-lucide="check-square"></i> IA checklist cadrage</button>
            <button class="btn btn-outline-secondary btn-sm" id="btnScopeHazid"><i data-lucide="alert-triangle"></i> IA pr√©-HAZID</button>
            <button class="btn btn-outline-secondary btn-sm" id="btnAICompleteContext"><i data-lucide="wand-2"></i> IA compl√©ter description</button>
          </div>
        </div>
      </div>

      <!-- Pi√®ces jointes -->
      <div class="card">
        <div class="card-header"><h5 class="mb-0">Pi√®ces jointes</h5></div>
        <div class="card-body">
          <input type="file" id="attachments" class="form-control" multiple>
          <div id="attachmentPreview" class="mt-3"></div>
        </div>
      </div>
    </div>

    <!-- Zonage ATEX -->
    <div class="tab-pane fade" id="zoning" role="tabpanel">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Zonage ATEX</h5>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary btn-sm" id="btnAIIntroZoning"><i data-lucide="book-open-text"></i> IA rappel zones</button>
            <button class="btn btn-outline-secondary btn-sm" id="btnAIProposeZoning"><i data-lucide="map"></i> IA proposition</button>
          </div>
        </div>
        <div class="card-body">
          <div class="alert alert-info small mb-3">
            üß≠ <strong>Que faire ici ?</strong> Coche les <em>zones 0/1/2/20/21/22</em>, puis associe-les √† un <em>B√¢timent</em> et/ou <em>Local</em>. Ajoute plusieurs s√©lections si n√©cessaire (elles serviront de <em>filtres</em> dans l‚Äôonglet √âquipements).
          </div>

          <div class="row g-3 align-items-end">
            <div class="col-md-4">
              <label class="form-label">B√¢timent</label>
              <input class="form-control" id="zoneBat" placeholder="Ex: B06">
            </div>
            <div class="col-md-4">
              <label class="form-label">Local</label>
              <input class="form-control" id="zoneLocal" placeholder="Ex: Soufflantes STEP">
            </div>
            <div class="col-md-4">
              <label class="form-label">Zones pr√©sentes</label>
              <div class="d-flex flex-wrap gap-2">
                <label class="pill"><input class="form-check-input me-1" type="checkbox" value="0"> Zone 0</label>
                <label class="pill"><input class="form-check-input me-1" type="checkbox" value="1"> Zone 1</label>
                <label class="pill"><input class="form-check-input me-1" type="checkbox" value="2"> Zone 2</label>
                <label class="pill"><input class="form-check-input me-1" type="checkbox" value="20"> Zone 20</label>
                <label class="pill"><input class="form-check-input me-1" type="checkbox" value="21"> Zone 21</label>
                <label class="pill"><input class="form-check-input me-1" type="checkbox" value="22"> Zone 22</label>
              </div>
            </div>
            <div class="col-12 d-flex justify-content-end">
              <button class="btn btn-primary" id="btnZoningAdd"><i data-lucide="plus"></i> Ajouter la s√©lection</button>
            </div>
          </div>

          <div id="zoningList" class="mt-3"></div>

          <div class="mt-3">
            <label class="form-label">Plans / commentaires</label>
            <textarea class="form-control" id="zoningNotes" rows="3"></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- √âquipements -->
    <div class="tab-pane fade" id="equip" role="tabpanel">
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Filtres</h5>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-success" id="btnAIEq"><i data-lucide="cpu"></i> IA : Analyser s√©lection</button>
            <button class="btn btn-sm btn-outline-secondary" id="btnAILocalQA"><i data-lucide="messages-square"></i> IA : Q&R par local</button>
          </div>
        </div>
        <div class="card-body">
          <div class="alert alert-info small mb-3">
            üß© <strong>Que faire ici ?</strong> Charge tes √©quipements, filtre par <em>secteur / b√¢timent</em> et active <em>‚ÄúFiltrer par le zonage s√©lectionn√©‚Äù</em> pour ne voir que les √©l√©ments concern√©s. Tu peux aussi <em>cr√©er</em> un √©quipement.
          </div>
          <div class="row g-3 align-items-end">
            <div class="col-md-3">
              <label class="form-label">Secteur</label>
              <input id="fSecteur" class="form-control" placeholder="Texte‚Ä¶">
            </div>
            <div class="col-md-3">
              <label class="form-label">B√¢timent</label>
              <input id="fBat" class="form-control" placeholder="Texte‚Ä¶">
            </div>
            <div class="col-md-3">
              <label class="form-label">Conformit√©</label>
              <select id="fConf" class="form-select">
                <option value="">‚Äî</option>
                <option>Conforme</option>
                <option>Non Conforme</option>
              </select>
            </div>
            <div class="col-md-3 form-check mt-4">
              <input class="form-check-input" type="checkbox" id="fByZoning">
              <label class="form-check-label" for="fByZoning">Filtrer par le zonage s√©lectionn√©</label>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">S√©lection d‚Äô√©quipements</h5>
          <div class="d-flex gap-2 flex-wrap">
            <button class="btn btn-outline-primary btn-sm" id="btnEquipNew"><i data-lucide="plus"></i> Nouvel √©quipement</button>
            <div class="form-check ms-2">
              <input type="checkbox" class="form-check-input" id="checkAll">
              <label class="form-check-label" for="checkAll">Tout cocher</label>
            </div>
          </div>
        </div>
        <div class="card-body table-responsive">
          <table class="table table-striped align-middle" id="equipTable">
            <thead>
              <tr>
                <th></th>
                <th>ID</th><th>Composant</th><th>Secteur</th><th>B√¢timent</th><th>Local</th>
                <th>Zone</th><th>Marquage</th><th>Cat. min.</th><th>Conformit√©</th><th>Risque</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Modal cr√©ation √©quipement -->
      <div class="modal fade" id="equipModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <form class="modal-content" id="equipForm">
            <div class="modal-header">
              <h5 class="modal-title">Nouvel √©quipement ATEX</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body row g-3">
              <div class="col-md-6"><label class="form-label">Composant</label><input class="form-control" id="eqComposant" required></div>
              <div class="col-md-3"><label class="form-label">Secteur</label><input class="form-control" id="eqSecteur"></div>
              <div class="col-md-3"><label class="form-label">B√¢timent</label><input class="form-control" id="eqBatiment"></div>
              <div class="col-md-4"><label class="form-label">Local</label><input class="form-control" id="eqLocal"></div>
              <div class="col-md-4"><label class="form-label">Zone (0/1/2/20/21/22)</label><input class="form-control" id="eqZone"></div>
              <div class="col-md-4"><label class="form-label">Marquage ATEX</label><input class="form-control" id="eqMarquage"></div>
              <div class="col-md-4">
                <label class="form-label">Conformit√©</label>
                <select class="form-select" id="eqConformite">
                  <option value="">‚Äî</option>
                  <option>Conforme</option>
                  <option>Non Conforme</option>
                </select>
              </div>
              <div class="col-md-8"><label class="form-label">Risque (commentaire)</label><input class="form-control" id="eqRisque"></div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
              <button class="btn btn-primary" type="submit">Cr√©er</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Mesures -->
    <div class="tab-pane fade" id="measures" role="tabpanel">
      <div class="card">
        <div class="card-header"><h5 class="mb-0">Mesures pr√©vention / protection</h5></div>
        <div class="card-body">
          <div class="alert alert-info small mb-3">
            üß≠ <strong>Guidance :</strong>  
            <ul class="mb-2">
              <li><em>Pr√©vention</em> : √©liminer / r√©duire l‚Äôatmosph√®re explosive et les sources d‚Äôinflammation (proc√©d√©, ventilation, qualit√© produit, AT, √©quipements).</li>
              <li><em>Protection</em> : limiter les effets (√©vents / d√©couplage / confinement, SIS/ESD, inerte) et d√©finir crit√®res d‚Äôacceptation + p√©riodicit√© des contr√¥les.</li>
              <li>Utilise les boutons IA pour <em>proposer</em> et <em>v√©rifier</em> en fonction de ton Contexte et du Zonage.</li>
            </ul>
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Pr√©vention (√©viter l‚ÄôATEX / sources)</label>
              <textarea id="measuresPrev" class="form-control" rows="7"></textarea>
              <div class="mt-2 d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary" data-ai="prev"><i data-lucide="sparkles"></i> IA : proposer</button>
                <button class="btn btn-sm btn-outline-secondary" data-ai="prev-check"><i data-lucide="shield"></i> IA : v√©rifier</button>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Protection (limiter les effets)</label>
              <textarea id="measuresProt" class="form-control" rows="7"></textarea>
              <div class="mt-2 d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary" data-ai="prot"><i data-lucide="sparkles"></i> IA : proposer</button>
                <button class="btn btn-sm btn-outline-secondary" data-ai="prot-check"><i data-lucide="shield"></i> IA : v√©rifier</button>
              </div>
            </div>
          </div>

          <hr class="my-4">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Programme de formation</label>
              <textarea id="training" class="form-control" rows="6"></textarea>
              <div class="mt-2"><button class="btn btn-sm btn-outline-primary" id="btnTrainingIA"><i data-lucide="sparkles"></i> IA : g√©n√©rer</button></div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Plan de maintenance / contr√¥les</label>
              <textarea id="maintenance" class="form-control" rows="6"></textarea>
              <div class="mt-2"><button class="btn btn-sm btn-outline-primary" id="btnMaintenanceIA"><i data-lucide="sparkles"></i> IA : g√©n√©rer</button></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- G√©n√©ration -->
    <div class="tab-pane fade" id="build" role="tabpanel">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">G√©n√©rer l‚ÄôEPD</h5>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-primary btn-sm" id="btnBuild"><i data-lucide="binary"></i> Construire</button>
            <button class="btn btn-outline-secondary btn-sm" id="btnExportMD"><i data-lucide="download"></i> Exporter .md</button>
            <button class="btn btn-outline-secondary btn-sm" id="btnExportJSON"><i data-lucide="download"></i> Exporter .json</button>
          </div>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6"><label class="form-label">Markdown</label><pre id="mdPreview" class="code p-3 bg-light rounded" style="min-height:260px"></pre></div>
            <div class="col-md-6"><label class="form-label">Aper√ßu HTML</label><div id="htmlPreview" class="p-3 bg-white border rounded" style="min-height:260px"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Offcanvas IA -->
  <div class="offcanvas offcanvas-end offcanvas-ia" tabindex="-1" id="iaPanel" data-bs-scroll="true" data-bs-backdrop="false" aria-labelledby="iaPanelLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="iaPanelLabel"><i data-lucide="bot"></i> Aide IA</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <div id="iaLoading" class="text-center text-muted" style="display:none">
        <div class="spinner-border" role="status" aria-hidden="true"></div>
        <div class="mt-2">Analyse en cours‚Ä¶</div>
      </div>
      <div id="iaDetails" style="display:none"></div>
    </div>
  </div>

  <div class="toast-container position-fixed top-0 end-0 p-3" id="toasts" style="z-index: 2000;"></div>

  <footer class="text-center small mt-4">¬© AutonomiX ‚Äî Tous droits r√©serv√©s</footer>

  <script src="/js/epd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
