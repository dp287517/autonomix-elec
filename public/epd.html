
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>EPD Builder - DRPCE / Explosion Protection Document</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root{
      --offcanvas-w: clamp(420px, 40vw, 560px);
    }
    body{ background:#f8f9fa; font-family:'Poppins',sans-serif; color:#333; }
    .card{ border-radius:14px; box-shadow:0 4px 10px rgba(0,0,0,.06); }
    .small-muted{ font-size:.9rem; color:#6c757d; }
    .offcanvas-ia{ --bs-offcanvas-width: var(--offcanvas-w); }
    #iaPanel{ border-left:1px solid #e5e7eb; }
    #iaPanel .offcanvas-body{ display:flex; flex-direction:column; gap:1rem; padding-top:.75rem; }
    .ia-details{ border:1px solid #e9ecef; border-radius:10px; background:#fff; max-height: 55vh; overflow:auto; padding:1rem; }
    .markdown-preview{ border:1px solid #e9ecef; border-radius:10px; background:#fff; padding:1rem; min-height:220px; max-height:55vh; overflow:auto; }
    .pill{border:1px solid #e9ecef; border-radius:999px; padding:.15rem .6rem; font-size:.8rem; color:#6c757d; background:#fff;}
    .code{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace }
    .save-status{ font-size:.85rem; }
    .thumb{ width:84px; height:84px; object-fit:cover; border:1px solid #dee2e6; border-radius:8px; }
  </style>
</head>
<body class="container my-4">

  <div class="d-flex align-items-center justify-content-between mb-2">
    <div class="d-flex align-items-center gap-3">
      <h1 class="mb-0">EPD / DRPCE — Constructeur</h1>
      <input id="projectTitle" class="form-control form-control-sm" placeholder="Titre du projet (ex: EPD Station B06)" style="width: 340px;">
      <select id="projectStatus" class="form-select form-select-sm" style="width: 160px;">
        <option>Brouillon</option><option>En cours</option><option>Terminé</option>
      </select>
      <button id="btnSaveServerTop" class="btn btn-sm btn-success"><i data-lucide="save"></i> Enregistrer</button>
    </div>
    <div class="save-status text-muted">
      <span id="saveStateDot" class="me-1">●</span><span id="saveStateText">Prêt</span>
    </div>
  </div>
  <p class="text-muted">Créer, documenter et exporter un <strong>Document Relatif à la Protection Contre les Explosions</strong> pour <em>nouveau projet</em> ou <em>inspection/mise à jour</em>.</p>

  <ul class="nav nav-tabs" id="epdTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="context-tab" data-bs-toggle="tab" data-bs-target="#context" type="button" role="tab">
        <i data-lucide="building-2"></i> Contexte
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="zoning-tab" data-bs-toggle="tab" data-bs-target="#zoning" type="button" role="tab">
        <i data-lucide="map"></i> Zonage ATEX
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="equip-tab" data-bs-toggle="tab" data-bs-target="#equip" type="button" role="tab">
        <i data-lucide="cpu"></i> Équipements
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="measures-tab" data-bs-toggle="tab" data-bs-target="#measures" type="button" role="tab">
        <i data-lucide="shield-check"></i> Mesures
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="projects-tab" data-bs-toggle="tab" data-bs-target="#projects" type="button" role="tab">
        <i data-lucide="folder-open"></i> Projets
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="build-tab" data-bs-toggle="tab" data-bs-target="#build" type="button" role="tab">
        <i data-lucide="file-text"></i> Génération
      </button>
    </li>
  </ul>

  <div class="tab-content mt-3" id="epdTabContent">
    <!-- Contexte -->
    <div class="tab-pane fade show active" id="context" role="tabpanel">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Informations générales</h5>
          <div class="d-flex align-items-center gap-3">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="modeEPD" id="modeProjet" value="projet" checked>
              <label class="form-check-label" for="modeProjet">Nouveau projet</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="modeEPD" id="modeInspection" value="inspection">
              <label class="form-check-label" for="modeInspection">Inspection / Mise à jour</label>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Entreprise</label>
              <input class="form-control" id="org" placeholder="Nom de l'entreprise">
            </div>
            <div class="col-md-6">
              <label class="form-label">Site / Installation</label>
              <input class="form-control" id="site" placeholder="Ex: STEP B06">
            </div>
            <div class="col-md-6">
              <label class="form-label">Adresse</label>
              <input class="form-control" id="address">
            </div>
            <div class="col-md-6">
              <label class="form-label">Rédacteur</label>
              <input class="form-control" id="author">
            </div>
            <div class="col-12">
              <label class="form-label">Portée / Description du procédé</label>
              <textarea class="form-control" id="processDesc" rows="3" placeholder="Décris le procédé, les substances manipulées, conditions T/P, ventilation…"></textarea>
            </div>
          </div>

          <hr class="my-4">

          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Fluides / Poudres</label>
              <input class="form-control" id="fluids" placeholder="Ex: méthane, ethanol, farine…">
              <div class="form-text">Indique les principaux produits / solvants / poussières concernés.</div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Conditions opératoires</label>
              <input class="form-control" id="operating" placeholder="T, P, débits, confinement, ventilation">
            </div>
            <div class="col-md-4">
              <label class="form-label">Documents / photos (upload serveur)</label>
              <input class="form-control" id="attachments" type="file" multiple accept=".pdf,.png,.jpg,.jpeg,.webp">
              <div class="form-text">Les fichiers sont envoyés sur le serveur (Render: disque éphémère). Pour du durable, prévoir S3.</div>
            </div>
            <div class="col-12" id="attachmentPreview" class="d-flex flex-wrap gap-2"></div>
          </div>

          <div class="mt-3 d-flex gap-2">
            <button id="btnScopeChecklist" class="btn btn-outline-primary btn-sm"><i data-lucide="list-checks"></i> IA : Checklist cadrage projet</button>
            <button id="btnScopeHazid" class="btn btn-outline-secondary btn-sm"><i data-lucide="radar"></i> IA : Pré-HazID</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Zonage -->
    <div class="tab-pane fade" id="zoning" role="tabpanel">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Zonage ATEX</h5>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-primary" id="btnAIIntroZoning"><i data-lucide="sparkles"></i> IA : Expliquer</button>
            <button class="btn btn-sm btn-outline-secondary" id="btnAIProposeZoning"><i data-lucide="map"></i> IA : Proposer zonage</button>
          </div>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Type d'atmosphère</label>
              <select class="form-select" id="atexType">
                <option value="gaz">Gaz / Vapeurs</option>
                <option value="poussiere">Poussières combustibles</option>
              </select>
            </div>
            <div class="col-md-8">
              <label class="form-label">Zones présentes</label>
              <div class="d-flex flex-wrap gap-2">
                <label class="pill"><input class="form-check-input me-1" type="checkbox" value="0"> Zone 0</label>
                <label class="pill"><input class="form-check-input me-1" type="checkbox" value="1"> Zone 1</label>
                <label class="pill"><input class="form-check-input me-1" type="checkbox" value="2"> Zone 2</label>
                <label class="pill"><input class="form-check-input me-1" type="checkbox" value="20"> Zone 20</label>
                <label class="pill"><input class="form-check-input me-1" type="checkbox" value="21"> Zone 21</label>
                <label class="pill"><input class="form-check-input me-1" type="checkbox" value="22"> Zone 22</label>
              </div>
            </div>
            <div class="col-12">
              <label class="form-label">Plans / commentaires</label>
              <textarea class="form-control" id="zoningNotes" rows="3" placeholder="Lien vers plans, critères IEC 60079-10-x, etc."></textarea>
            </div>
            <div class="col-12 small-muted">Pendant les appels IA, un message “Réflexion en cours…” s’affiche.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Équipements -->
    <div class="tab-pane fade" id="equip" role="tabpanel">
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Filtres</h5>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-success" id="btnAIProposeEquip"><i data-lucide="cpu"></i> IA : Proposer équipements (projet)</button>
            <button class="btn btn-sm btn-outline-secondary" id="btnAILocalQA"><i data-lucide="messages-square"></i> IA : Q&R par local (inspection)</button>
          </div>
        </div>
        <div class="card-body">
          <div class="row g-2">
            <div class="col-md-3"><input id="fSecteur" class="form-control" placeholder="Secteur"></div>
            <div class="col-md-3"><input id="fBat" class="form-control" placeholder="Bâtiment"></div>
            <div class="col-md-3">
              <select id="fConf" class="form-select">
                <option value="">Conformité (tous)</option>
                <option value="Conforme">Conforme</option>
                <option value="Non Conforme">Non Conforme</option>
              </select>
            </div>
            <div class="col-md-3 d-grid d-md-block">
              <button id="btnSyncEquip" class="btn btn-primary"><i data-lucide="refresh-cw"></i> Charger</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Sélection d’équipements</h5>
          <div class="d-flex gap-2 flex-wrap">
            <button class="btn btn-outline-secondary btn-sm" id="btnAIEq"><i data-lucide="bot"></i> IA : analyser la sélection</button>
            <span class="pill">Source : /api/atex-equipments</span>
          </div>
        </div>
        <div class="card-body table-responsive">
          <table class="table table-striped align-middle" id="equipTable">
            <thead>
              <tr>
                <th><input type="checkbox" id="checkAll"></th>
                <th>ID</th><th>Composant</th><th>Secteur</th><th>Bâtiment</th><th>Local</th><th>Zone</th><th>Marquage</th><th>Cat. min</th><th>Conformité</th><th>Risque</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Mesures -->
    <div class="tab-pane fade" id="measures" role="tabpanel">
      <div class="card">
        <div class="card-header"><h5 class="mb-0">Mesures de prévention & protection</h5></div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Prévention (éviter ATEX / ignition)</label>
              <textarea id="measuresPrev" class="form-control" rows="7" placeholder="Ventilation, inertage, contrôle ESD, procédures de nettoyage…"></textarea>
              <div class="mt-2 d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary" data-ai="prev"><i data-lucide="sparkles"></i> IA : proposer</button>
                <button class="btn btn-sm btn-outline-secondary" data-ai="prev-check"><i data-lucide="shield"></i> IA : vérifier</button>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Protection (limiter les effets)</label>
              <textarea id="measuresProt" class="form-control" rows="7" placeholder="Évents, découplage, cloisonnement, arrêt d'urgence…"></textarea>
              <div class="mt-2 d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary" data-ai="prot"><i data-lucide="sparkles"></i> IA : proposer</button>
                <button class="btn btn-sm btn-outline-secondary" data-ai="prot-check"><i data-lucide="shield"></i> IA : vérifier</button>
              </div>
            </div>
          </div>

          <hr class="my-4">

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Programme de formation</label>
              <textarea id="training" class="form-control" rows="6" placeholder="Public cible, périodicité, supports, habilitations…"></textarea>
              <div class="mt-2"><button class="btn btn-sm btn-outline-primary" data-ai="training"><i data-lucide="sparkles"></i> IA : générer</button></div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Plan de maintenance / contrôles</label>
              <textarea id="maintenance" class="form-control" rows="6" placeholder="Périodicité contrôles, inspections, métrologie détecteurs…"></textarea>
              <div class="mt-2"><button class="btn btn-sm btn-outline-primary" data-ai="maintenance"><i data-lucide="sparkles"></i> IA : générer</button></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Projets -->
    <div class="tab-pane fade" id="projects" role="tabpanel">
      <div class="card">
        <div class="card-header d-flex align-items-center justify-content-between">
          <h5 class="mb-0">Projets EPD</h5>
          <div class="d-flex gap-2">
            <select id="projFilter" class="form-select form-select-sm">
              <option value="">Tous</option>
              <option>Brouillon</option>
              <option>En cours</option>
              <option>Terminé</option>
            </select>
            <input id="projSearch" class="form-control form-control-sm" placeholder="Recherche titre/texte…">
            <button id="btnReloadProjects" class="btn btn-sm btn-outline-primary"><i data-lucide="refresh-cw"></i> Recharger</button>
          </div>
        </div>
        <div class="card-body table-responsive">
          <table class="table table-striped align-middle" id="projectsTable">
            <thead>
              <tr>
                <th>ID</th><th>Titre</th><th>Statut</th><th>MAJ</th><th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Génération -->
    <div class="tab-pane fade" id="build" role="tabpanel">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Générer & Exporter</h5>
          <div class="d-flex gap-2 flex-wrap">
            <button id="btnBuild" class="btn btn-primary"><i data-lucide="wand-2"></i> Générer</button>
            <button id="btnExportMD" class="btn btn-outline-secondary"><i data-lucide="download"></i> Exporter .md</button>
            <button id="btnExportJSON" class="btn btn-outline-secondary"><i data-lucide="download"></i> Exporter .json</button>
            <button id="btnSaveServer" class="btn btn-success"><i data-lucide="save"></i> Enregistrer serveur</button>
            <button id="btnReset" class="btn btn-warning"><i data-lucide="erase"></i> Réinitialiser</button>
          </div>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-lg-6">
              <div class="small-muted mb-1">Aperçu Markdown</div>
              <pre id="mdPreview" class="markdown-preview"></pre>
            </div>
            <div class="col-lg-6">
              <div class="small-muted mb-1">Aperçu HTML</div>
              <div id="htmlPreview" class="markdown-preview"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Offcanvas IA global -->
  <div class="offcanvas offcanvas-end offcanvas-ia" tabindex="-1" id="iaPanel" data-bs-scroll="true" data-bs-backdrop="false" aria-labelledby="iaPanelLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="iaPanelLabel"><i data-lucide="bot"></i> AutonomiX IA</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <div id="iaLoading" class="text-center text-muted" style="display:none">
        <div class="spinner-border" role="status" aria-hidden="true"></div>
        <div class="mt-2">Réflexion en cours…</div>
      </div>
      <div id="iaDetails" class="ia-details" style="display:none"></div>
    </div>
  </div>

  <div class="toast-container position-fixed top-0 end-0 p-3" id="toasts" style="z-index: 2000;"></div>

  <!-- JS FRONT -->
  <script src="/js/epd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
