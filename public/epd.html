<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EPD Builder — Document Relatif à la Protection Contre les Explosions</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root { --bg:#0b1220; --card:#11182a; --muted:#8fa0b4; --ink:#e7efff; --acc:#58c4ff; --acc2:#59ffa2; }
    body{background:linear-gradient(180deg,#0b1220 0%,#0e1626 100%); color:var(--ink); font-family:'Poppins',sans-serif;}
    .card{background:rgba(17,24,42,.8); border:1px solid rgba(88,196,255,.15); border-radius:18px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .step{display:flex; align-items:center; gap:.5rem; color:var(--muted)}
    .step.is-active{color:var(--ink)}
    .step .dot{width:28px; height:28px; border:2px solid var(--muted); border-radius:999px; display:grid; place-items:center}
    .step.is-active .dot{border-color:var(--acc); background:rgba(88,196,255,.1)}
    .ghost-input{background:#0e1a2f; border:1px solid rgba(88,196,255,.15); color:var(--ink)}
    .ghost-input:focus{border-color:var(--acc); box-shadow:0 0 0 .2rem rgba(88,196,255,.15)}
    .btn-glow{background:linear-gradient(90deg,var(--acc),var(--acc2)); border:none; color:#001222; font-weight:700}
    .btn-glow:hover{filter:brightness(1.05)}
    .pill{border:1px solid rgba(255,255,255,.1); border-radius:999px; padding:.25rem .6rem; font-size:.8rem; color:var(--muted)}
    .table-dark th,.table-dark td{vertical-align:middle}
    .code{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .right-rail{position:sticky; top:1rem}
    .markdown-preview{background:#0f1b31; border:1px dashed rgba(255,255,255,.15); padding:1rem; border-radius:12px; max-height:50vh; overflow:auto}
    .badge-zone{background:#122341; border:1px solid rgba(88,196,255,.25)}
  </style>
</head>
<body class="container py-4">
  <header class="d-flex align-items-center justify-content-between mb-4">
    <div>
      <h1 class="h3 mb-1">EPD Builder <span class="pill ms-2">ATEX • EPD</span></h1>
      <div class="text-secondary">Crée un <strong>Document Relatif à la Protection Contre les Explosions</strong> dynamique, assisté par IA.</div>
    </div>
    <div class="d-flex gap-2">
      <button id="btnExportMD" class="btn btn-outline-light">Exporter .md</button>
      <button id="btnExportJSON" class="btn btn-outline-light">Exporter .json</button>
      <button id="btnSaveServer" class="btn btn-outline-success">Enregistrer serveur</button>
      <button id="btnReset" class="btn btn-outline-warning">Réinitialiser</button>
    </div>
  </header>

  <!-- Steps Nav -->
  <nav class="row g-3 mb-3">
    <div class="col-12 col-lg-9">
      <div class="card p-3">
        <div class="d-flex flex-wrap gap-3">
          <div class="step is-active" data-step="1"><div class="dot">1</div><div>Contexte & Site</div></div>
          <div class="step" data-step="2"><div class="dot">2</div><div>Zonage ATEX</div></div>
          <div class="step" data-step="3"><div class="dot">3</div><div>Équipements</div></div>
          <div class="step" data-step="4"><div class="dot">4</div><div>Mesures</div></div>
          <div class="step" data-step="5"><div class="dot">5</div><div>Formation & Maintenance</div></div>
          <div class="step" data-step="6"><div class="dot">6</div><div>Revue & Génération</div></div>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-3">
      <div class="card p-3 right-rail">
        <div class="d-flex align-items-center gap-2 mb-2"><i data-lucide="sparkles"></i><strong>AutonomiX IA</strong></div>
        <div class="small text-secondary mb-2">Demande une rédaction ou une vérification.</div>
        <textarea id="aiQuestion" class="form-control ghost-input mb-2" rows="3" placeholder="Ex: propose le texte d'introduction et les responsabilités"></textarea>
        <button id="btnAskAI" class="btn btn-glow w-100 mb-2"><i data-lucide="send"></i> Demander</button>
        <div id="aiReply" class="markdown-preview small"></div>
      </div>
    </div>
  </nav>

  <!-- Step 1: Contexte & Site -->
  <section class="card p-3 mb-4 step-pane" data-step="1">
    <h2 class="h5 mb-3">1) Contexte & Informations Générales</h2>
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Entreprise</label>
        <input class="form-control ghost-input" id="org" placeholder="Nom de l'entreprise" />
      </div>
      <div class="col-md-6">
        <label class="form-label">Site / Installation</label>
        <input class="form-control ghost-input" id="site" placeholder="Ex: STEP B06" />
      </div>
      <div class="col-md-6">
        <label class="form-label">Adresse</label>
        <input class="form-control ghost-input" id="address" />
      </div>
      <div class="col-md-6">
        <label class="form-label">Rédacteur</label>
        <input class="form-control ghost-input" id="author" />
      </div>
      <div class="col-12">
        <label class="form-label">Portée / Description du procédé</label>
        <textarea class="form-control ghost-input" id="processDesc" rows="3" placeholder="Décris le procédé, les substances manipulées, conditions T/P, ventilation…"></textarea>
      </div>
    </div>
  </section>

  <!-- Step 2: Zonage ATEX -->
  <section class="card p-3 mb-4 step-pane d-none" data-step="2">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h2 class="h5 mb-0">2) Zonage ATEX</h2>
      <button class="btn btn-outline-light btn-sm" id="btnAIIntroZoning">IA : Expliquer les zones</button>
    </div>
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Type d'atmosphère</label>
        <select class="form-select ghost-input" id="atexType">
          <option value="gaz">Gaz / Vapeurs</option>
          <option value="poussiere">Poussières combustibles</option>
        </select>
      </div>
      <div class="col-md-8">
        <label class="form-label">Zones présentes</label>
        <div class="d-flex flex-wrap gap-2">
          <label class="pill badge-zone"><input class="form-check-input me-1" type="checkbox" value="0"> Zone 0</label>
          <label class="pill badge-zone"><input class="form-check-input me-1" type="checkbox" value="1"> Zone 1</label>
          <label class="pill badge-zone"><input class="form-check-input me-1" type="checkbox" value="2"> Zone 2</label>
          <label class="pill badge-zone"><input class="form-check-input me-1" type="checkbox" value="20"> Zone 20</label>
          <label class="pill badge-zone"><input class="form-check-input me-1" type="checkbox" value="21"> Zone 21</label>
          <label class="pill badge-zone"><input class="form-check-input me-1" type="checkbox" value="22"> Zone 22</label>
        </div>
      </div>
      <div class="col-12">
        <label class="form-label">Plans / commentaires de zonage</label>
        <textarea class="form-control ghost-input" id="zoningNotes" rows="3" placeholder="Lien vers plans, critères de classification IEC 60079-10-x, etc."></textarea>
      </div>
      <div class="col-12 small text-secondary">Astuce : la catégorie minimale conseillée par zone sera calculée automatiquement dans l'étape Équipements.</div>
    </div>
  </section>

  <!-- Step 3: Équipements -->
  <section class="card p-3 mb-4 step-pane d-none" data-step="3">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h2 class="h5 mb-0">3) Équipements & Conformité</h2>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-light btn-sm" id="btnSyncEquip">Recharger</button>
        <button class="btn btn-outline-light btn-sm" id="btnAIEq">IA : analyser la sélection</button>
      </div>
    </div>
    <div class="row g-3 align-items-end">
      <div class="col-md-3">
        <label class="form-label">Filtre secteur</label>
        <input id="fSecteur" class="form-control ghost-input" placeholder="ex: Utilité" />
      </div>
      <div class="col-md-3">
        <label class="form-label">Filtre bâtiment</label>
        <input id="fBat" class="form-control ghost-input" placeholder="ex: B06" />
      </div>
      <div class="col-md-3">
        <label class="form-label">Conformité</label>
        <select id="fConf" class="form-select ghost-input">
          <option value="">Toutes</option>
          <option value="Conforme">Conforme</option>
          <option value="Non Conforme">Non Conforme</option>
        </select>
      </div>
      <div class="col-md-3 text-end">
        <span class="pill">Source : /api/atex-equipments</span>
      </div>
    </div>
    <div class="table-responsive mt-3">
      <table class="table table-dark table-striped align-middle" id="equipTable">
        <thead>
          <tr>
            <th><input type="checkbox" id="checkAll"></th>
            <th>ID</th><th>Composant</th><th>Secteur</th><th>Bât.</th><th>Local</th><th>Zone</th>
            <th>Marquage</th><th>Cat. min</th><th>Conformité</th><th>Risque</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Step 4: Mesures -->
  <section class="card p-3 mb-4 step-pane d-none" data-step="4">
    <h2 class="h5 mb-3">4) Mesures de Prévention & Protection</h2>
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Prévention (éviter ATEX / ignition)</label>
        <textarea id="measuresPrev" class="form-control ghost-input" rows="6" placeholder="Ventilation, inertage, contrôle ESD, procédures de nettoyage…"></textarea>
        <div class="mt-2 d-flex gap-2">
          <button class="btn btn-outline-light btn-sm" data-ai="prev">IA : proposer</button>
          <button class="btn btn-outline-light btn-sm" data-ai="prev-check">IA : vérifier</button>
        </div>
      </div>
      <div class="col-md-6">
        <label class="form-label">Protection (limiter les effets)</label>
        <textarea id="measuresProt" class="form-control ghost-input" rows="6" placeholder="Évents, découplage, cloisonnement, arrêt d'urgence…"></textarea>
        <div class="mt-2 d-flex gap-2">
          <button class="btn btn-outline-light btn-sm" data-ai="prot">IA : proposer</button>
          <button class="btn btn-outline-light btn-sm" data-ai="prot-check">IA : vérifier</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Step 5: Formation & Maintenance -->
  <section class="card p-3 mb-4 step-pane d-none" data-step="5">
    <h2 class="h5 mb-3">5) Formation & Maintenance</h2>
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Programme de formation</label>
        <textarea id="training" class="form-control ghost-input" rows="6" placeholder="Public cible, périodicité, supports, habilitations…"></textarea>
        <div class="mt-2"><button class="btn btn-outline-light btn-sm" data-ai="training">IA : générer</button></div>
      </div>
      <div class="col-md-6">
        <label class="form-label">Plan de maintenance / contrôles</label>
        <textarea id="maintenance" class="form-control ghost-input" rows="6" placeholder="Périodicité contrôles, inspections, métrologie détecteurs…"></textarea>
        <div class="mt-2"><button class="btn btn-outline-light btn-sm" data-ai="maintenance">IA : générer</button></div>
      </div>
    </div>
  </section>

  <!-- Step 6: Revue & Génération -->
  <section class="card p-3 mb-4 step-pane d-none" data-step="6">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h2 class="h5 mb-0">6) Revue & Génération</h2>
      <button id="btnBuild" class="btn btn-glow"><i data-lucide="wand-2"></i> Générer l'EPD</button>
    </div>
    <div class="row g-4">
      <div class="col-lg-6">
        <h6 class="text-secondary">Aperçu Markdown</h6>
        <div id="mdPreview" class="markdown-preview"></div>
      </div>
      <div class="col-lg-6">
        <h6 class="text-secondary">HTML (lecture seule)</h6>
        <div id="htmlPreview" class="markdown-preview"></div>
      </div>
    </div>
  </section>

  <footer class="text-center text-secondary mt-4 small">EPD Builder • AutonomiX</footer>

  <!-- ⬇️ JS FRONT servi par /js/epd.js (fichier rangé dans main/routes/epd.js) -->
  <script src="/js/epd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
