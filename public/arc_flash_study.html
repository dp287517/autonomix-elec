<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autonomix Elec - Analyse d'Arc Flash</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="/styles.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://unpkg.com/konva@9.3.6/konva.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        #modal-graph {
            background-color: rgba(0, 0, 0, 0.7) !important;
            overflow-y: auto !important;
            z-index: 2000 !important;
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            align-items: center;
            justify-content: center;
        }
        #modal-graph.show {
            display: flex !important;
        }
        #modal-graph > div {
            background-color: #1f2937 !important;
            max-height: 90vh !important;
            width: 90vw !important;
            max-width: 900px !important;
            padding: 1.5rem !important;
            border-radius: 0.5rem !important;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5) !important;
            position: relative;
            z-index: 2001;
        }
        #modal-modal {
            max-height: 600px !important;
            width: 100% !important;
            height: auto !important;
        }
        #mini-modal, #missing-data-modal, #add-node-modal {
            z-index: 2000 !important;
        }
        #global-graph {
            position: relative;
            width: 100% !important;
            height: 800px !important;
            min-height: 800px;
            background-color: #ffffff !important;
        }
        #building-filter, #tableau-filter {
            appearance: none !important;
            cursor: pointer;
            pointer-events: auto !important;
            z-index: 1000 !important;
            user-select: auto !important;
            position: relative !important;
            background-color: #374151 !important;
            color: #ffffff !important;
            border: 1px solid #4b5563 !important;
            padding: 8px !important;
            border-radius: 4px !important;
            width: 200px !important;
            height: 40px !important;
            font-size: 0.875rem !important;
        }
        #building-filter:disabled, #tableau-filter:disabled {
            cursor: not-allowed !important;
            opacity: 0.5 !important;
        }
        .bg-gray-800, .bg-gray-800 * {
            pointer-events: auto !important;
            z-index: 100 !important;
        }
        .container {
            z-index: 60 !important;
            pointer-events: auto !important;
        }
        .badge {
            background-color: #eab308;
            color: #ffffff;
            padding: 2px 6px;
            border-radius: 9999px;
            font-size: 0.75rem;
            margin-left: 4px;
        }
        .badge-critical {
            background-color: #dc2626;
        }
        .touch-friendly {
            min-height: 44px;
            padding: 0.5rem 1rem;
        }
        .animate-slide-up {
            animation: slideUp 0.8s ease-out;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @media (max-width: 640px) {
            #missing-data-modal > div, #add-node-modal > div {
                padding: 1rem;
                max-width: 95vw;
            }
            .missing-data-table th, .missing-data-table td {
                font-size: 0.75rem;
                padding: 0.5rem;
            }
            #building-filter, #tableau-filter {
                width: 100% !important;
                font-size: 0.875rem !important;
            }
            #modal-graph > div {
                width: 95vw !important;
                max-width: 95vw !important;
            }
            #modal-modal {
                max-height: 400px !important;
            }
        }
        @media (min-width: 640px) {
            .missing-data-table th, .missing-data-table td {
                font-size: 1rem;
            }
            #building-filter, #tableau-filter {
                font-size: 1rem !important;
            }
        }
        .sortable:hover {
            cursor: pointer;
            text-decoration: underline;
        }
        .tooltip {
            position: absolute;
            background-color: #2d3748;
            color: #ffffff;
            padding: 8px;
            border: 2px solid #10b981;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
            font-size: 0.875rem;
            z-index: 1000;
            max-width: 300px;
            white-space: normal;
            overflow-y: auto;
            max-height: 200px;
        }
        .node {
            cursor: move;
        }
        .global-chart-container {
            margin-bottom: 2rem;
        }
        .global-chart-container canvas {
            width: 100% !important;
            max-height: 400px !important;
        }
        #arc-flash-card {
            display: none;
            padding: 20px;
            border: 2px solid #000000;
            max-width: 180mm;
            min-height: 100mm;
            margin: 10mm auto;
            font-family: Arial, sans-serif;
            box-sizing: border-box;
            color: #000000;
        }
        #arc-flash-card.low-risk {
            background-color: #d1fae5 !important;
        }
        #arc-flash-card.medium-risk {
            background-color: #fef3c7 !important;
        }
        #arc-flash-card.high-risk {
            background-color: #dc2626 !important;
            color: #ffffff !important;
        }
        #arc-flash-card p {
            margin: 0 0 8px 0;
            line-height: 1.5;
        }
        #arc-flash-card .card-icon {
            font-size: 2rem;
            margin-bottom: 12px;
        }
        #arc-flash-card .card-breaker {
            font-weight: bold;
            font-size: 1.1rem;
        }
        @media print {
            #arc-flash-card {
                display: block !important;
                page-break-inside: avoid;
                width: 180mm;
                height: auto;
                margin: 10mm;
            }
            #modal-graph, nav, .container > *:not(#arc-flash-card) {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <nav class="bg-blue-700 p-4 sticky top-0 z-50 shadow-lg">
        <ul class="flex flex-wrap space-x-6 justify-center text-sm sm:text-base">
            <li><a href="index.html" class="hover:text-yellow-300 transition"><i class="fas fa-home mr-2"></i>Accueil</a></li>
            <li><a href="create.html" class="hover:text-yellow-300 transition"><i class="fas fa-plus-circle mr-2"></i>Créer un tableau</a></li>
            <li><a href="view.html" class="hover:text-yellow-300 transition"><i class="fas fa-table mr-2"></i>Voir les tableaux</a></li>
            <li><a href="selectivity.html" class="hover:text-yellow-300 transition"><i class="fas fa-shield-alt mr-2"></i>Sélectivité</a></li>
            <li><a href="obsolescence.html" class="hover:text-yellow-300 transition"><i class="fas fa-clock mr-2"></i>Obsolescence</a></li>
            <li><a href="fault_level_assessment.html" class="hover:text-yellow-300 transition"><i class="fas fa-bolt mr-2"></i>Évaluation du Niveau de Défaut</a></li>
            <li><a href="hazards_assessment.html" class="hover:text-yellow-300 transition"><i class="fas fa-exclamation-triangle mr-2"></i>Évaluation des Risques</a></li>
            <li><a href="maintenance_org.html" class="hover:text-yellow-300 transition"><i class="fas fa-sitemap mr-2"></i>Organigramme Maintenance</a></li>
            <li><a href="distribution_emergency.html" class="hover:text-yellow-300 transition"><i class="fas fa-plug mr-2"></i>Urgence Distribution</a></li>
            <li><a href="reports.html" class="hover:text-yellow-300 transition"><i class="fas fa-file-alt mr-2"></i>Rapports</a></li>
            <li><a href="electrical_safety_program.html" class="hover:text-yellow-300 transition"><i class="fas fa-hard-hat mr-2"></i>Programme de Sécurité Électrique</a></li>
            <li><a href="breaker_control.html" class="hover:text-yellow-300 transition"><i class="fas fa-cogs mr-2"></i>Contrôle des Disjoncteurs</a></li>
            <li><a href="arc_flash_study.html" class="text-yellow-300"><i class="fas fa-bolt mr-2"></i>Analyse d'Arc Flash</a></li>
        </ul>
    </nav>

    <div class="container mx-auto p-4 sm:p-6">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 sm:mb-6">
            <h1 class="text-2xl sm:text-3xl font-bold flex items-center"><i class="fas fa-bolt mr-2 sm:mr-3"></i>Analyse d'Arc Flash</h1>
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mt-4 sm:mt-0">
                <button onclick="exportToCSV()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 flex items-center touch-friendly">
                    <i class="fas fa-file-csv mr-2"></i>Exporter en CSV
                </button>
                <button onclick="openAddNodeModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex items-center touch-friendly">
                    <i class="fas fa-plus mr-2"></i>Ajouter un tableau
                </button>
            </div>
        </div>

        <div class="bg-gray-800 p-4 rounded-lg mb-4 sm:mb-6 shadow-lg flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0 animate-slide-up">
            <div>
                <label for="building-filter" class="block text-sm font-medium mb-1">Filtrer par bâtiment</label>
                <select id="building-filter" class="mt-1 p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" onchange="updateTableauFilter(); filterData();" aria-label="Filtrer par bâtiment">
                    <option value="">Tous les bâtiments</option>
                </select>
            </div>
            <div>
                <label for="tableau-filter" class="block text-sm font-medium mb-1">Tableau</label>
                <select id="tableau-filter" class="mt-1 p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" onchange="filterData()" aria-label="Filtrer par tableau">
                    <option value="">Sélectionner un tableau</option>
                </select>
            </div>
            <div class="flex items-end">
                <button onclick="resetFilters()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 flex items-center touch-friendly">
                    <i class="fas fa-undo mr-2"></i>Réinitialiser
                </button>
            </div>
        </div>

        <div class="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg mb-4 sm:mb-6 animate-slide-up">
            <h2 class="text-lg sm:text-xl font-bold mb-4 flex items-center"><i class="fas fa-info-circle mr-2"></i>Comment utiliser cette page</h2>
            <ul class="list-disc pl-6 text-gray-300 text-sm sm:text-base">
                <li>Sélectionnez un bâtiment et un tableau pour afficher les résultats d’arc flash.</li>
                <li>Les filtres sont enregistrés automatiquement pour votre prochaine visite.</li>
                <li>Consultez le tableau pour voir l’énergie incidente, la distance de protection, et le niveau de PPE requis.</li>
                <li>Pour les données manquantes, cliquez sur la loupe pour identifier les disjoncteurs concernés.</li>
                <li>Cliquez sur l’icône <i class="fas fa-chart-bar"></i> ou "Agrandir" pour voir un graphique détaillé avec des recommandations.</li>
                <li>Imprimez une carte d’arc flash via le bouton dans le modal du graphique, avec émoticône et couleur selon le risque.</li>
                <li>Le schéma interactif montre les relations entre tableaux et disjoncteurs.</li>
                <li>Les lignes rouges signalent un risque élevé (énergie > 8 cal/cm²).</li>
                <li>Consultez les graphiques globaux par bâtiment en bas de la page.</li>
                <li>Cliquez sur "Exporter en CSV" pour télécharger les données.</li>
            </ul>
        </div>

        <div class="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg mb-4 sm:mb-6 animate-slide-up">
            <h2 class="text-lg sm:text-xl font-bold mb-4 flex items-center"><i class="fas fa-table mr-2"></i>Tableau des résultats d'arc flash</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm sm:text-base">
                    <thead>
                        <tr class="bg-gray-700 text-white">
                            <th class="p-2">Tableau</th>
                            <th class="p-2">Disjoncteur</th>
                            <th class="p-2">Énergie incidente (cal/cm²)</th>
                            <th class="p-2">Distance de protection (m)</th>
                            <th class="p-2">Niveau PPE</th>
                            <th class="p-2">Données manquantes</th>
                            <th class="p-2">Graphique</th>
                        </tr>
                    </thead>
                    <tbody id="arc-flash-table"></tbody>
                </table>
            </div>
        </div>

        <div class="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg mb-4 sm:mb-6 animate-slide-up">
            <h2 class="text-lg sm:text-xl font-bold mb-4 flex items-center"><i class="fas fa-chart-bar mr-2"></i>Graphiques globaux par bâtiment</h2>
            <div id="global-charts" class="flex flex-col space-y-6"></div>
        </div>

        <div class="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg mb-4 sm:mb-6 animate-slide-up">
            <h2 class="text-lg sm:text-xl font-bold mb-4 flex items-center"><i class="fas fa-sitemap mr-2"></i>Schéma global</h2>
            <div id="global-graph" class="w-full h-[800px] bg-white rounded-lg border-2 border-green-600 relative z-10"></div>
            <div id="global-text" class="mt-4 text-gray-300 text-sm sm:text-base"></div>
        </div>

        <div id="modal-graph" class="fixed inset-0 bg-black bg-opacity-70 hidden z-[2000]" role="dialog" aria-labelledby="modal-title">
            <div class="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg w-[90vw] max-w-[900px] flex flex-col relative z-[2001]">
                <div class="sticky top-0 flex items-center justify-between mb-4">
                    <h3 class="text-lg sm:text-xl font-bold text-white flex items-center" id="modal-title"><i class="fas fa-chart-bar mr-2"></i>Analyse d'Arc Flash</h3>
                    <div class="flex space-x-2">
                        <button onclick="printArcFlashCard()" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 touch-friendly" aria-label="Imprimer la carte"><i class="fas fa-print mr-2"></i>Imprimer</button>
                        <button onclick="closeModal()" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 touch-friendly" aria-label="Fermer le modal"><i class="fas fa-times"></i> Fermer</button>
                    </div>
                </div>
                <canvas id="modal-modal" class="w-full h-auto"></canvas>
                <div id="arc-flash-explanation" class="mt-4 text-sm sm:text-base text-gray-300"></div>
            </div>
        </div>

        <div id="arc-flash-card" class="hidden">
            <h2 id="card-title" class="text-xl font-bold mb-4"></h2>
            <p id="card-icon" class="card-icon"></p>
            <p id="card-breaker" class="card-breaker"></p>
            <p id="card-energy" class="mb-2"></p>
            <p id="card-distance" class="mb-2"></p>
            <p id="card-ppe" class="mb-2"></p>
            <p id="card-status" class="mb-2"></p>
            <p id="card-recommendation" class="mb-4"></p>
            <p id="card-footer" class="text-sm italic"></p>
        </div>

        <div id="mini-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden flex items-center justify-center z-[2000]" role="dialog" aria-labelledby="mini-modal-title">
            <div class="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg w-[90vw] max-w-[600px]">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="text-lg sm:text-xl font-bold text-white flex items-center" id="mini-modal-title"><i class="fas fa-info-circle mr-2"></i>Détails</h4>
                    <button onclick="closeMiniModal()" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 touch-friendly" aria-label="Fermer le modal"><i class="fas fa-times"></i></button>
                </div>
                <div id="mini-modal-content" class="text-gray-300 text-sm sm:text-base"></div>
            </div>
        </div>

        <div id="missing-data-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden flex items-center justify-center z-[2000]" role="dialog" aria-labelledby="missing-data-modal-title">
            <div class="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg w-[90vw] max-w-2xl">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="text-lg sm:text-xl font-bold text-white flex items-center" id="missing-data-modal-title"><i class="fas fa-magnifying-glass mr-2"></i>Données Manquantes</h4>
                    <button onclick="closeMissingDataModal()" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 touch-friendly" aria-label="Fermer le modal"><i class="fas fa-times"></i></button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full missing-data-table">
                        <thead>
                            <tr class="bg-gray-700 text-white">
                                <th class="p-2 sm:p-3 sortable" onclick="sortMissingDataTable('id')">ID <i class="fas fa-sort"></i></th>
                                <th class="p-2 sm:p-3">Données Manquantes</th>
                                <th class="p-2 sm:p-3">Action</th>
                            </tr>
                        </thead>
                        <tbody id="missing-data-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="add-node-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden flex items-center justify-center z-[2000]" role="dialog" aria-labelledby="add-node-modal-title">
            <div class="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg w-[90vw] max-w-[400px]">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="text-lg sm:text-xl font-bold text-white flex items-center" id="add-node-modal-title"><i class="fas fa-plus-circle mr-2"></i>Ajouter un élément</h4>
                    <button onclick="closeAddNodeModal()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 touch-friendly" aria-label="Fermer le modal"><i class="fas fa-times"></i></button>
                </div>
                <div class="flex flex-col space-y-4">
                    <input type="text" id="node-id" class="p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="ID de l'élément" aria-label="ID de l'élément">
                    <select id="node-type" class="p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" aria-label="Type d'élément">
                        <option value="tableau">Tableau</option>
                        <option value="disjoncteur">Disjoncteur</option>
                    </select>
                    <input type="text" id="node-building" class="p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Bâtiment (pour tableau)" aria-label="Bâtiment">
                    <input type="text" id="node-marque" class="p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Marque (pour disjoncteur)" aria-label="Marque">
                    <input type="text" id="node-ref" class="p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Référence (pour disjoncteur)" aria-label="Référence">
                    <input type="number" id="node-ue" class="p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Ue (V, pour disjoncteur)" aria-label="Ue (V)">
                    <input type="number" id="node-ir" class="p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Ir (A, pour disjoncteur)" aria-label="Ir (A)">
                    <input type="number" id="node-in" class="p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="In (A, pour disjoncteur)" aria-label="In (A)">
                    <input type="text" id="node-courbe" class="p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Courbe (pour disjoncteur)" aria-label="Courbe">
                    <input type="number" id="node-triptime" class="p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Triptime (s, pour disjoncteur)" aria-label="Triptime (s)">
                    <input type="number" id="node-cableLength" class="p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Longueur câble (m)" aria-label="Longueur câble (m)">
                    <input type="text" id="node-section" class="p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Section câble (mm²)" aria-label="Section câble">
                    <select id="node-linked-tableau" class="p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" aria-label="Tableau lié">
                        <option value="">Aucun tableau lié</option>
                    </select>
                    <div class="flex space-x-4">
                        <button onclick="saveNode()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 touch-friendly" aria-label="Enregistrer le nœud"><i class="fas fa-save mr-2"></i>Enregistrer</button>
                        <button onclick="closeAddNodeModal()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 touch-friendly" aria-label="Annuler"><i class="fas fa-times mr-2"></i>Annuler</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="popup" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[2100] hidden" role="dialog" aria-labelledby="popup-message">
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full animate-slide-up">
                <p id="popup-message" class="mb-4 text-sm sm:text-base"></p>
                <div id="popup-content" class="mb-4"></div>
                <div class="flex space-x-4">
                    <button id="popup-confirm" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 touch-friendly"><i class="fas fa-check mr-2"></i>Confirmer</button>
                    <button id="popup-cancel" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 touch-friendly"><i class="fas fa-times mr-2"></i>Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let tableauxData = [];
        let modalChartInstance = null;
        let missingDataSortDirection = 'asc';
        let globalChartInstances = [];
        let currentTableauId = null;
        let currentDisjoncteurId = null;

        function showPopup(message, content = '', confirmCallback = () => {}) {
            console.log('[ArcFlash] Affichage pop-up:', message);
            document.getElementById('popup-message').textContent = message;
            document.getElementById('popup-content').innerHTML = content;
            document.getElementById('popup').classList.remove('hidden');
            document.getElementById('popup-confirm').onclick = () => {
                confirmCallback();
                hidePopup();
            };
            document.getElementById('popup-cancel').onclick = hidePopup;
            gsap.from('#popup > div', { opacity: 0, scale: 0.8, duration: 0.5, ease: 'power2.out' });
        }

        function hidePopup() {
            console.log('[ArcFlash] Masquage pop-up');
            document.getElementById('popup').classList.add('hidden');
        }

        function normalizeCurrent(value) {
            if (value === null || value === undefined) return null;
            if (typeof value === 'number' && !isNaN(value)) return value;
            if (typeof value === 'string') {
                const match = value.match(/[\d.]+/);
                return match ? parseFloat(match[0]) : null;
            }
            return null;
        }

        function calculateIncidentEnergy(disjoncteur, tableau) {
            const ue = normalizeCurrent(disjoncteur.ue) || 400;
            const inValue = normalizeCurrent(disjoncteur.in) || 16;
            let triptime = parseFloat(disjoncteur.triptime);
            if (isNaN(triptime)) {
                const courbe = disjoncteur.courbe ? disjoncteur.courbe.toUpperCase() : 'C';
                switch (courbe) {
                    case 'B': triptime = 0.01; break;
                    case 'C': triptime = 0.02; break;
                    case 'D': triptime = 0.03; break;
                    case 'K': triptime = 0.015; break;
                    case 'Z': triptime = 0.005; break;
                    default: triptime = 0.02;
                }
            }
            if (triptime > 1) {
                console.warn('[ArcFlash] Triptime aberrant détecté:', triptime, 'pour disjoncteur:', disjoncteur.id, 'Utilisation de 0.02 s');
                triptime = 0.02;
            }
            const cableLength = parseFloat(disjoncteur.cableLength) || 20;
            const section = disjoncteur.section ? parseFloat(disjoncteur.section.match(/[\d.]+/)[0]) : 2.5;
            const k = 0.6;
            const I_arc = k * inValue;
            const D = 0.61;
            const E = (4.184 * I_arc * triptime) / (D * D);
            const boundary = Math.sqrt((4.184 * I_arc * triptime) / 1.2);
            let ppeLevel = '0';
            if (E > 40) ppeLevel = '4';
            else if (E > 25) ppeLevel = '3';
            else if (E > 8) ppeLevel = '2';
            else if (E > 1.2) ppeLevel = '1';
            return {
                incidentEnergy: E.toFixed(2),
                boundaryDistance: boundary.toFixed(2),
                ppeLevel,
                status: E > 8 ? 'Risque élevé' : E > 1.2 ? 'Risque modéré' : 'Risque faible'
            };
        }

        async function chargerTableaux() {
            console.log('[ArcFlash] Chargement des données');
            try {
                const response = await fetch('/api/arc-flash?t=' + Date.now(), {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
                tableauxData = await response.json();
                console.log('[ArcFlash] Données reçues:', tableauxData.length, 'tableaux');
                tableauxData = tableauxData.map(tableau => ({
                    ...tableau,
                    building: tableau.building || 'Inconnu',
                    disjoncteurs: (tableau.disjoncteurs || []).map(d => ({
                        ...d,
                        id: d.id || d.disjoncteur_id || `unknown-${Math.random().toString(36).substring(2, 9)}`,
                        inValue: normalizeCurrent(d.in),
                        irValue: normalizeCurrent(d.ir),
                        ue: normalizeCurrent(d.ue),
                        triptime: normalizeCurrent(d.triptime),
                        linkedTableauIds: d.linkedTableauIds || [],
                        isPrincipal: !!d.isPrincipal,
                        isHTAFeeder: !!d.isHTAFeeder
                    })),
                    issitemain: tableau.issitemain || false,
                    isHTA: tableau.isHTA || false,
                    htaData: tableau.htaData || null
                }));
                populateFilters();
                loadUserFilters();
            } catch (error) {
                console.error('[ArcFlash] Erreur chargement:', error);
                showPopup('Erreur lors du chargement des données: ' + error.message);
            }
        }

        function populateFilters() {
            console.log('[ArcFlash] Remplissage des filtres');
            const buildingFilter = document.getElementById('building-filter');
            const tableauFilter = document.getElementById('tableau-filter');
            const linkedTableauSelect = document.getElementById('node-linked-tableau');
            buildingFilter.innerHTML = '<option value="">Tous les bâtiments</option>';
            tableauFilter.innerHTML = '<option value="">Sélectionner un tableau</option>';
            linkedTableauSelect.innerHTML = '<option value="">Aucun tableau lié</option>';
            const buildings = [...new Set(tableauxData.map(t => t.building).filter(b => b))].sort();
            buildings.forEach(b => {
                const option = document.createElement('option');
                option.value = b;
                option.textContent = b;
                buildingFilter.appendChild(option);
            });
            tableauxData.forEach(t => {
                const option = document.createElement('option');
                option.value = t.id;
                option.textContent = t.id;
                tableauFilter.appendChild(option.cloneNode(true));
                linkedTableauSelect.appendChild(option);
            });
        }

        function updateTableauFilter() {
            const building = document.getElementById('building-filter').value;
            const tableauFilter = document.getElementById('tableau-filter');
            tableauFilter.innerHTML = '<option value="">Sélectionner un tableau</option>';
            const filteredTableaux = building
                ? tableauxData.filter(t => t.building === building)
                : tableauxData;
            filteredTableaux.forEach(t => {
                const option = document.createElement('option');
                option.value = t.id;
                option.textContent = t.id;
                tableauFilter.appendChild(option);
            });
        }

        function saveUserFilters() {
            const building = document.getElementById('building-filter').value;
            const tableau = document.getElementById('tableau-filter').value;
            const userId = 'default_user';
            localStorage.setItem(`arc_flash_filters_${userId}`, JSON.stringify({ building, tableau }));
            console.log('[ArcFlash] Filtres enregistrés:', { building, tableau });
        }

        function loadUserFilters() {
            const userId = 'default_user';
            const savedFilters = localStorage.getItem(`arc_flash_filters_${userId}`);
            if (savedFilters) {
                const { building, tableau } = JSON.parse(savedFilters);
                document.getElementById('building-filter').value = building || '';
                updateTableauFilter();
                document.getElementById('tableau-filter').value = tableau || '';
                console.log('[ArcFlash] Filtres chargés:', { building, tableau });
                filterData();
            } else {
                afficherTableauxEtSchema([]);
                genererGraphiquesGlobaux();
            }
        }

        function resetFilters() {
            console.log('[ArcFlash] Réinitialisation des filtres');
            document.getElementById('building-filter').value = '';
            updateTableauFilter();
            document.getElementById('tableau-filter').value = '';
            saveUserFilters();
            filterData();
        }

        function filterData() {
            console.log('[ArcFlash] Filtrage des données');
            const building = document.getElementById('building-filter').value;
            const tableau = document.getElementById('tableau-filter').value;
            let filteredData = [...tableauxData];
            if (building) {
                filteredData = filteredData.filter(t => t.building === building);
            }
            if (tableau) {
                filteredData = filteredData.filter(t => t.id === tableau);
            } else {
                filteredData = [];
            }
            saveUserFilters();
            afficherTableauxEtSchema(filteredData);
            genererGraphiquesGlobaux();
        }

        function exportToCSV() {
            console.log('[ArcFlash] Exportation CSV');
            if (!tableauxData.length) {
                showPopup('Aucune donnée à exporter.');
                return;
            }
            const headers = [
                'Tableau_ID', 'Bâtiment', 'Disjoncteur_ID', 'Énergie_incidente_cal_cm2', 'Distance_protection_m', 'Niveau_PPE',
                'Statut', 'Ue_V', 'In_A', 'Ir_A', 'Triptime_s', 'Section_mm2', 'Longueur_câble_m'
            ];
            const rows = [];
            tableauxData.forEach(tableau => {
                tableau.disjoncteurs.forEach(disjoncteur => {
                    const arcFlash = calculateIncidentEnergy(disjoncteur, tableau);
                    rows.push([
                        tableau.id,
                        tableau.building,
                        disjoncteur.id,
                        arcFlash.incidentEnergy,
                        arcFlash.boundaryDistance,
                        arcFlash.ppeLevel,
                        arcFlash.status,
                        disjoncteur.ue || 'N/A',
                        disjoncteur.inValue || 'N/A',
                        disjoncteur.irValue || 'N/A',
                        disjoncteur.triptime || 'N/A',
                        disjoncteur.section || 'N/A',
                        disjoncteur.cableLength || 'N/A'
                    ]);
                });
            });
            const csvContent = [
                headers.map(h => `"${h}"`).join(','),
                ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
            ].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `arc_flash_donnees_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function afficherTableauxEtSchema(tableaux) {
            console.log('[ArcFlash] Affichage tableaux et schéma');
            afficherTableaux(tableaux);
            renderArcFlashSchema(tableaux);
        }

        function afficherTableaux(tableaux) {
            console.log('[ArcFlash] Affichage tableaux');
            const tableBody = document.getElementById('arc-flash-table');
            tableBody.innerHTML = '';
            if (!tableaux.length) {
                tableBody.innerHTML = `<tr><td colspan="7" class="p-2 text-center text-gray-500">Veuillez sélectionner un tableau pour afficher les disjoncteurs.</td></tr>`;
                return;
            }
            tableaux.forEach((tableau, tableauIndex) => {
                tableau.disjoncteurs.forEach((disjoncteur, disjIndex) => {
                    const arcFlash = calculateIncidentEnergy(disjoncteur, tableau);
                    const missingData = checkMissingData([disjoncteur]);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="p-2">${tableau.id}${tableau.issitemain ? ' (Principal)' : ''}${tableau.isHTA ? ' (HTA)' : ''}</td>
                        <td class="p-2">${disjoncteur.id} (${disjoncteur.isPrincipal ? 'Principal' : disjoncteur.isHTAFeeder ? 'HTA Feeder' : 'Secondaire'})</td>
                        <td class="p-2">${arcFlash.incidentEnergy}</td>
                        <td class="p-2">${arcFlash.boundaryDistance}</td>
                        <td class="p-2">${arcFlash.ppeLevel}</td>
                        <td class="p-2">
                            ${missingData.length > 0 
                                ? `<button class="bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700 flex items-center touch-friendly" onclick="openMissingDataModal('${encodeURIComponent(tableau.id)}', '${encodeURIComponent(disjoncteur.id)}')"><i class="fas fa-magnifying-glass mr-1"></i> ${missingData.length} champ${missingData.length > 1 ? 's' : ''}<span class="badge ${missingData.length > 3 ? 'badge-critical' : ''}">${missingData.length}</span></button>`
                                : 'Aucune'}
                        </td>
                        <td class="p-2 flex items-center space-x-2">
                            <i class="fas fa-chart-bar text-blue-600 text-xl cursor-pointer hover:text-blue-800" onclick="openModal('${encodeURIComponent(tableau.id)}', '${encodeURIComponent(disjoncteur.id)}')" aria-label="Voir le graphique"></i>
                            <button onclick="openModal('${encodeURIComponent(tableau.id)}', '${encodeURIComponent(disjoncteur.id)}')" class="bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700 touch-friendly">Agrandir</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            });
        }

        function openMissingDataModal(encodedTableauId, encodedDisjoncteurId) {
            console.log('[ArcFlash] Ouverture modal données manquantes');
            const tableauId = decodeURIComponent(encodedTableauId);
            const disjoncteurId = decodeURIComponent(encodedDisjoncteurId);
            const tableau = tableauxData.find(t => t.id === tableauId);
            if (!tableau) {
                showPopup('Erreur: Tableau non trouvé.');
                return;
            }
            const disjoncteur = tableau.disjoncteurs.find(d => d.id === disjoncteurId);
            const missingData = checkMissingData([disjoncteur]);
            const modal = document.getElementById('missing-data-modal');
            const tableBody = document.getElementById('missing-data-table-body');
            const modalTitle = document.getElementById('missing-data-modal-title');

            modalTitle.textContent = `Données Manquantes - ${tableauId} (${disjoncteurId})`;
            tableBody.innerHTML = '';
            missingData.forEach(d => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="p-2 sm:p-3">${d.id}</td>
                    <td class="p-2 sm:p-3">${d.missing.join(', ')}</td>
                    <td class="p-2 sm:p-3"><button onclick="redirigerModifier('${encodeURIComponent(tableauId)}', '${encodeURIComponent(d.id)}')" class="bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700 touch-friendly">Modifier</button></td>
                `;
                tableBody.appendChild(row);
            });

            modal.classList.remove('hidden');
            gsap.from('#missing-data-modal', { opacity: 0, scale: 0.8, duration: 0.5, ease: 'power2.out' });
        }

        function closeMissingDataModal() {
            console.log('[ArcFlash] Fermeture modal données manquantes');
            document.getElementById('missing-data-modal').classList.add('hidden');
        }

        function sortMissingDataTable(column) {
            console.log('[ArcFlash] Tri tableau données manquantes:', column);
            const tableauId = document.getElementById('missing-data-modal-title').textContent.split(' - ')[1].split(' (')[0];
            const disjoncteurId = document.getElementById('missing-data-modal-title').textContent.match(/\(.*?\)/)[0].slice(1, -1);
            const tableau = tableauxData.find(t => t.id === tableauId);
            const disjoncteur = tableau.disjoncteurs.find(d => d.id === disjoncteurId);
            const missingData = checkMissingData([disjoncteur]);
            const tableBody = document.getElementById('missing-data-table-body');

            missingData.sort((a, b) => {
                if (column === 'id') {
                    return missingDataSortDirection === 'asc' ? a.id.localeCompare(b.id) : b.id.localeCompare(a.id);
                }
                return 0;
            });

            missingDataSortDirection = missingDataSortDirection === 'asc' ? 'desc' : 'asc';
            tableBody.innerHTML = '';
            missingData.forEach(d => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="p-2 sm:p-3">${d.id}</td>
                    <td class="p-2 sm:p-3">${d.missing.join(', ')}</td>
                    <td class="p-2 sm:p-3"><button onclick="redirigerModifier('${encodeURIComponent(tableauId)}', '${encodeURIComponent(d.id)}')" class="bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700 touch-friendly">Modifier</button></td>
                `;
                tableBody.appendChild(row);
            });
        }

        function checkMissingData(disjoncteurs) {
            console.log('[ArcFlash] Vérification données manquantes');
            return disjoncteurs.map(d => {
                const missing = [];
                if (!d.ue) missing.push('Ue');
                if (!d.inValue) missing.push('In');
                if (!d.irValue) missing.push('Ir');
                if (!d.triptime) missing.push('Triptime');
                if (!d.section) missing.push('Section');
                if (!d.cableLength) missing.push('Longueur câble');
                return missing.length > 0 ? { id: d.id || 'Inconnu', missing } : null;
            }).filter(Boolean);
        }

        function redirigerModifier(encodedTableauId, encodedDisjoncteurId) {
            console.log('[ArcFlash] Redirection edit.html');
            const tableauId = decodeURIComponent(encodedTableauId);
            const disjoncteurId = decodeURIComponent(encodedDisjoncteurId);
            window.location.assign(`edit.html?id=${encodeURIComponent(tableauId)}#${encodeURIComponent(disjoncteurId)}`);
        }

        function openAddNodeModal() {
            console.log('[ArcFlash] Ouverture modal ajout nœud');
            const modal = document.getElementById('add-node-modal');
            const title = document.getElementById('add-node-modal-title');
            title.textContent = 'Ajouter un élément';
            document.getElementById('node-id').value = '';
            document.getElementById('node-type').value = 'tableau';
            document.getElementById('node-building').value = '';
            document.getElementById('node-marque').value = '';
            document.getElementById('node-ref').value = '';
            document.getElementById('node-ue').value = '';
            document.getElementById('node-ir').value = '';
            document.getElementById('node-in').value = '';
            document.getElementById('node-courbe').value = '';
            document.getElementById('node-triptime').value = '';
            document.getElementById('node-cableLength').value = '';
            document.getElementById('node-section').value = '';
            document.getElementById('node-linked-tableau').value = '';
            modal.classList.remove('hidden');
            gsap.from('#add-node-modal', { opacity: 0, scale: 0.8, duration: 0.5, ease: 'power2.out' });
        }

        function closeAddNodeModal() {
            console.log('[ArcFlash] Fermeture modal ajout nœud');
            document.getElementById('add-node-modal').classList.add('hidden');
        }

        async function saveNode() {
            console.log('[ArcFlash] Sauvegarde nœud');
            const id = document.getElementById('node-id').value.trim();
            const type = document.getElementById('node-type').value;
            const building = document.getElementById('node-building').value.trim();
            const marque = document.getElementById('node-marque').value.trim();
            const ref = document.getElementById('node-ref').value.trim();
            const ue = document.getElementById('node-ue').value.trim();
            const ir = document.getElementById('node-ir').value.trim();
            const inValue = document.getElementById('node-in').value.trim();
            const courbe = document.getElementById('node-courbe').value.trim();
            const triptime = document.getElementById('node-triptime').value.trim();
            const cableLength = document.getElementById('node-cableLength').value.trim();
            const section = document.getElementById('node-section').value.trim();
            const linkedTableau = document.getElementById('node-linked-tableau').value.trim();

            if (!id) {
                showPopup('L’ID est requis.');
                return;
            }

            try {
                if (type === 'tableau') {
                    const newTableau = {
                        id,
                        building: building || 'Inconnu',
                        disjoncteurs: [],
                        issitemain: false,
                        isHTA: false,
                        htaData: null
                    };
                    const response = await fetch('/api/tableaux', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(newTableau)
                    });
                    if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
                    tableauxData.push(newTableau);
                    populateFilters();
                    afficherTableauxEtSchema(tableauxData);
                    genererGraphiquesGlobaux();
                    closeAddNodeModal();
                    showPopup('Tableau ajouté avec succès.');
                } else {
                    const disjoncteur = {
                        id,
                        marque: marque || null,
                        ref: ref || null,
                        ue: ue || null,
                        ir: ir || null,
                        in: inValue || null,
                        courbe: courbe || null,
                        triptime: triptime || null,
                        cableLength: cableLength || null,
                        section: section || null,
                        isPrincipal: false,
                        isHTAFeeder: false,
                        linkedTableauIds: linkedTableau ? [linkedTableau] : []
                    };
                    const tableau = tableauxData.find(t => t.id === linkedTableau) || tableauxData[0] || { id: 'TEMP', disjoncteurs: [] };
                    const response = await fetch(`/api/disjoncteur/${encodeURIComponent(tableau.id)}/${encodeURIComponent(id)}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(disjoncteur)
                    });
                    if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
                    tableau.disjoncteurs.push(disjoncteur);
                    populateFilters();
                    afficherTableauxEtSchema(tableauxData);
                    genererGraphiquesGlobaux();
                    closeAddNodeModal();
                    showPopup('Disjoncteur ajouté avec succès.');
                }
            } catch (error) {
                console.error('[ArcFlash] Erreur ajout:', error);
                showPopup('Erreur lors de l’ajout: ' + error.message);
            }
        }

        function openModal(encodedTableauId, encodedDisjoncteurId) {
            console.log('[ArcFlash] Ouverture modal graphique:', encodedTableauId, encodedDisjoncteurId);
            const tableauId = decodeURIComponent(encodedTableauId);
            const disjoncteurId = decodeURIComponent(encodedDisjoncteurId);
            const tableau = tableauxData.find(t => t.id === tableauId);
            if (!tableau) {
                showPopup('Erreur: Tableau non trouvé.');
                return;
            }
            const disjoncteur = tableau.disjoncteurs.find(d => d.id === disjoncteurId);
            if (!disjoncteur) {
                showPopup('Erreur: Disjoncteur non trouvé.');
                return;
            }

            currentTableauId = tableauId;
            currentDisjoncteurId = disjoncteurId;

            const modal = document.getElementById('modal-graph');
            const canvasContainer = document.getElementById('modal-modal');

            // ✅ Supprimer l’ancien graphique s’il existe
            if (modalChartInstance) {
                modalChartInstance.destroy();
                modalChartInstance = null;
            }

            // ✅ Réinitialiser le canvas
            const newCanvas = document.createElement('canvas');
            newCanvas.id = 'modal-modal';
            canvasContainer.parentNode.replaceChild(newCanvas, canvasContainer);

            // ✅ Afficher correctement le modal
            modal.style.display = 'flex';
            modal.classList.remove('hidden');
            modal.classList.add('show');

            // ✅ Générer le nouveau graphique
            modalChartInstance = genererGraphique('modal-modal', disjoncteur, tableau, true);

            gsap.from('#modal-graph > div', {
                opacity: 0,
                scale: 0.8,
                duration: 0.5,
                ease: 'power2.out'
            });
        }

        function closeModal() {
            console.log('[ArcFlash] Fermeture modal');
            const modal = document.getElementById('modal-graph');
            gsap.to('#modal-graph > div', {
                opacity: 0,
                scale: 0.8,
                duration: 0.5,
                ease: 'power2.in',
                onComplete: () => {
                    modal.classList.remove('show');
                    modal.classList.add('hidden');
                    modal.style.display = 'none';
                    if (modalChartInstance) {
                        modalChartInstance.destroy();
                        modalChartInstance = null;
                    }
                    document.getElementById('arc-flash-card').classList.add('hidden');
                    document.getElementById('arc-flash-card').style.display = 'none';
                }
            });
        }

        function printArcFlashCard() {
            console.log('[ArcFlash] Impression carte arc flash');
            const tableau = tableauxData.find(t => t.id === currentTableauId);
            const disjoncteur = tableau?.disjoncteurs.find(d => d.id === currentDisjoncteurId);
            if (!tableau || !disjoncteur) {
                showPopup('Erreur: Données du tableau ou disjoncteur non trouvées.');
                return;
            }
            const arcFlash = calculateIncidentEnergy(disjoncteur, tableau);
            const card = document.getElementById('arc-flash-card');
            card.classList.remove('low-risk', 'medium-risk', 'high-risk');
            let riskClass = '';
            let icon = '';
            switch (arcFlash.status) {
                case 'Risque faible':
                    riskClass = 'low-risk';
                    icon = '✅';
                    break;
                case 'Risque modéré':
                    riskClass = 'medium-risk';
                    icon = '⚠️';
                    break;
                case 'Risque élevé':
                    riskClass = 'high-risk';
                    icon = '🚨';
                    break;
            }
            card.classList.add(riskClass);
            document.getElementById('card-title').textContent = `Arc Flash - ${tableau.id}`;
            document.getElementById('card-icon').textContent = icon;
            document.getElementById('card-breaker').textContent = `Disjoncteur : ${disjoncteur.id}`;
            document.getElementById('card-energy').textContent = `Énergie incidente : ${arcFlash.incidentEnergy} cal/cm²`;
            document.getElementById('card-distance').textContent = `Distance de protection : ${arcFlash.boundaryDistance} m`;
            document.getElementById('card-ppe').textContent = `Niveau PPE : ${arcFlash.ppeLevel}`;
            document.getElementById('card-status').textContent = `Statut : ${arcFlash.status}`;
            document.getElementById('card-recommendation').textContent = `Recommandation : ${getRecommendation(arcFlash)}`;
            document.getElementById('card-footer').textContent = `Généré par Autonomix Elec le ${new Date().toLocaleDateString('fr-FR')}`;
            card.style.display = 'block';
            setTimeout(() => {
                html2pdf().from(card).set({
                    margin: [10, 10, 10, 10],
                    filename: `arc_flash_${tableau.id}_${disjoncteur.id}.pdf`,
                    html2canvas: { scale: 2, useCORS: true },
                    jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4', compressPDF: true }
                }).save().then(() => {
                    card.style.display = 'none';
                    card.classList.add('hidden');
                }).catch(err => {
                    console.error('[ArcFlash] Erreur génération PDF:', err);
                    showPopup('Erreur lors de la génération du PDF: ' + err.message);
                    card.style.display = 'none';
                    card.classList.add('hidden');
                });
            }, 200);
        }

        function getRecommendation(arcFlash) {
            const E = parseFloat(arcFlash.incidentEnergy);
            switch (arcFlash.status) {
                case 'Risque faible':
                    return 'Aucun risque significatif. Continuez les inspections régulières et assurez-vous que les PPE de niveau 0 sont disponibles pour les interventions.';
                case 'Risque modéré':
                    return 'Risque modéré détecté. Portez des PPE de niveau ' + arcFlash.ppeLevel + ' (gants isolants, lunettes de sécurité, vêtements ignifugés). Vérifiez les paramètres du disjoncteur (courbe, triptime) et envisagez une maintenance préventive pour réduire l’énergie incidente.';
                case 'Risque élevé':
                    return 'Risque élevé détecté ! Arrêtez immédiatement les travaux à proximité sauf si absolument nécessaire. Utilisez des PPE de niveau ' + arcFlash.ppeLevel + ' (combinaison complète ignifugée, écran facial, gants haute tension). Révisez la conception électrique (ex. : ajuster le triptime, augmenter la section des câbles) et planifiez une intervention avec un ingénieur qualifié.';
                default:
                    return 'Surveiller les paramètres électriques et effectuer une maintenance régulière.';
            }
        }

        function genererGraphique(canvasId, disjoncteur, tableau, isModal) {
            console.log('[ArcFlash] Génération graphique pour', disjoncteur.id);
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if (!ctx) {
                showPopup('Erreur: Élément graphique non trouvé.');
                return null;
            }
            const arcFlash = calculateIncidentEnergy(disjoncteur, tableau);
            const datasets = [{
                label: `Énergie incidente (${disjoncteur.id})`,
                data: [{ x: 1, y: arcFlash.incidentEnergy }],
                backgroundColor: arcFlash.incidentEnergy > 8 ? '#dc2626' : arcFlash.incidentEnergy > 1.2 ? '#eab308' : '#22c55e',
                pointRadius: isModal ? 15 : 10
            }];

            if (modalChartInstance && isModal) {
                modalChartInstance.destroy();
                modalChartInstance = null;
            }

            const chart = new Chart(ctx, {
                type: 'scatter',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        x: {
                            title: { display: true, text: 'Index', color: '#ffffff' },
                            min: 0,
                            max: 2,
                            ticks: { color: '#ffffff' }
                        },
                        y: {
                            title: { display: true, text: 'Énergie incidente (cal/cm²)', color: '#ffffff' },
                            min: 0,
                            max: Math.max(10, arcFlash.incidentEnergy * 1.2),
                            ticks: { color: '#ffffff' }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `Arc Flash - ${tableau.id} (${disjoncteur.id})`,
                            color: '#ffffff',
                            font: { size: isModal ? 18 : 14 }
                        },
                        legend: { labels: { color: '#ffffff' } }
                    }
                }
            });

            if (isModal) {
                document.getElementById('arc-flash-explanation').innerHTML = `
                    <p><strong>Énergie incidente :</strong> ${arcFlash.incidentEnergy} cal/cm²</p>
                    <p><strong>Distance de protection :</strong> ${arcFlash.boundaryDistance} m</p>
                    <p><strong>Niveau PPE :</strong> ${arcFlash.ppeLevel}</p>
                    <p><strong>Statut :</strong> ${arcFlash.status}</p>
                    <p><strong>Recommandation :</strong> ${getRecommendation(arcFlash)}</p>
                `;
                document.getElementById('modal-title').textContent = `Arc Flash - ${tableau.id} (${disjoncteur.id})`;
            }

            return chart;
        }

        function genererGraphiquesGlobaux() {
            console.log('[ArcFlash] Génération graphiques globaux');
            const chartsContainer = document.getElementById('global-charts');
            chartsContainer.innerHTML = '';
            globalChartInstances.forEach(chart => chart.destroy());
            globalChartInstances = [];

            const building = document.getElementById('building-filter').value;
            const tableau = document.getElementById('tableau-filter').value;
            let filteredData = [...tableauxData];
            if (building) {
                filteredData = filteredData.filter(t => t.building === building);
            }
            if (tableau) {
                filteredData = filteredData.filter(t => t.id === tableau);
            }

            const buildings = [...new Set(filteredData.map(t => t.building).filter(b => b))].sort();
            buildings.forEach(b => {
                const buildingData = filteredData.filter(t => t.building === b);
                const container = document.createElement('div');
                container.className = 'global-chart-container';
                const canvas = document.createElement('canvas');
                canvas.id = `chart-building-${b.replace(/\s/g, '-')}`;
                container.appendChild(canvas);
                chartsContainer.appendChild(container);

                const datasets = [];
                buildingData.forEach(tableau => {
                    const energies = tableau.disjoncteurs.map(d => {
                        const arcFlash = calculateIncidentEnergy(d, tableau);
                        return arcFlash.incidentEnergy;
                    });
                    datasets.push({
                        label: tableau.id,
                        data: energies,
                        backgroundColor: energies.map(e => e > 8 ? '#dc2626' : e > 1.2 ? '#eab308' : '#22c55e'),
                        pointRadius: 8
                    });
                });

                const ctx = canvas.getContext('2d');
                const chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: buildingData[0]?.disjoncteurs.map((_, i) => `Disj ${i + 1}`) || [],
                        datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            x: {
                                title: { display: true, text: 'Disjoncteurs', color: '#ffffff' },
                                ticks: { color: '#ffffff' }
                            },
                            y: {
                                title: { display: true, text: 'Énergie incidente (cal/cm²)', color: '#ffffff' },
                                min: 0,
                                ticks: { color: '#ffffff' }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: `Énergie incidente par tableau - Bâtiment ${b}`,
                                color: '#ffffff',
                                font: { size: 16 }
                            },
                            legend: { labels: { color: '#ffffff' } }
                        }
                    }
                });
                globalChartInstances.push(chart);
            });
        }

        function renderArcFlashSchema(data, focusedTableauId = null) {
            console.log('[ArcFlash] Rendu schéma Konva.js');
            const graphContainer = document.getElementById('global-graph');
            graphContainer.innerHTML = '';

            const stage = new Konva.Stage({
                container: 'global-graph',
                width: graphContainer.offsetWidth,
                height: 800,
                draggable: true
            });

            const layer = new Konva.Layer();
            stage.add(layer);

            const tooltipContainer = document.createElement('div');
            tooltipContainer.style.position = 'absolute';
            tooltipContainer.style.top = '0';
            tooltipContainer.style.left = '0';
            graphContainer.appendChild(tooltipContainer);

            stage.on('wheel', (e) => {
                e.evt.preventDefault();
                const scaleBy = 1.1;
                const oldScale = stage.scaleX();
                const pointer = stage.getPointerPosition();
                const mousePointTo = {
                    x: (pointer.x - stage.x()) / oldScale,
                    y: (pointer.y - stage.y()) / oldScale
                };
                const newScale = e.evt.deltaY > 0 ? oldScale / scaleBy : oldScale * scaleBy;
                stage.scale({ x: newScale, y: newScale });
                const newPos = {
                    x: pointer.x - mousePointTo.x * newScale,
                    y: pointer.y - mousePointTo.y * newScale
                };
                stage.position(newPos);
                layer.batchDraw();
            });

            const elements = buildArborescence(data, focusedTableauId);
            let globalStatus = 'OK';
            const errors = [];
            data.forEach(tableau => {
                tableau.disjoncteurs.forEach(d => {
                    const arcFlash = calculateIncidentEnergy(d, tableau);
                    if (arcFlash.incidentEnergy > 8) {
                        globalStatus = 'Risque élevé';
                        errors.push(`Disjoncteur ${d.id} (${tableau.id}): Énergie incidente ${arcFlash.incidentEnergy} cal/cm²`);
                    }
                });
            });

            document.getElementById('global-text').innerHTML = `
                <p class="text-xl sm:text-2xl font-bold ${globalStatus === 'OK' ? 'text-green-600' : 'text-red-600'}"><i class="fas ${globalStatus === 'OK' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i>Statut global : ${globalStatus}</p>
                ${errors.length > 0 ? `<ul class="list-disc ml-6 mt-4 text-red-600">${errors.map(e => `<li>${e}</li>`).join('')}</ul>` : ''}
            `;

            const nodePositions = {};
            elements.nodes.forEach((node, index) => {
                let x = 200 + (index % 4) * 300;
                let y = 100 + Math.floor(index / 4) * 200;
                nodePositions[node.id] = { x, y };
            });

            elements.nodes.forEach(node => {
                const pos = nodePositions[node.id];
                const group = new Konva.Group({
                    x: pos.x,
                    y: pos.y,
                    draggable: true,
                    name: 'node'
                });

                const boxWidth = node.group === 'tableau' ? 150 : 120;
                const box = new Konva.Rect({
                    width: boxWidth,
                    height: 60,
                    fill: node.color,
                    stroke: '#ffffff',
                    strokeWidth: 2,
                    cornerRadius: 8,
                    shadowBlur: 5
                });

                const text = new Konva.Text({
                    text: node.label,
                    fontSize: 14,
                    fontFamily: 'Arial',
                    fill: '#ffffff',
                    width: boxWidth,
                    padding: 10,
                    align: 'center'
                });

                group.add(box, text);

                group.on('click', () => {
                    if (node.group === 'tableau') {
                        document.getElementById('mini-modal-title').textContent = `Tableau ${node.tableauId}`;
                        const tableau = data.find(t => t.id === node.tableauId);
                        document.getElementById('mini-modal-content').innerHTML = `
                            <p><strong>Tableau :</strong> ${node.tableauId}</p>
                            <p><strong>Bâtiment :</strong> ${tableau?.building || 'N/A'}</p>
                            <p><strong>Disjoncteurs :</strong> ${tableau?.disjoncteurs.length || 0}</p>
                        `;
                        document.getElementById('mini-modal').classList.remove('hidden');
                        gsap.from('#mini-modal', { opacity: 0, scale: 0.8, duration: 0.5, ease: 'power2.out' });
                    } else {
                        const tableau = data.find(t => t.id === node.id.split('-')[1]);
                        const arcFlash = calculateIncidentEnergy(node.disjoncteur, tableau);
                        document.getElementById('mini-modal-title').textContent = `Disjoncteur ${node.disjoncteurId}`;
                        document.getElementById('mini-modal-content').innerHTML = `
                            <p><strong>Disjoncteur :</strong> ${node.disjoncteurId}</p>
                            <p><strong>Tableau :</strong> ${node.id.split('-')[1]}</p>
                            <p><strong>Énergie incidente :</strong> ${arcFlash.incidentEnergy} cal/cm²</p>
                            <p><strong>Distance de protection :</strong> ${arcFlash.boundaryDistance} m</p>
                            <p><strong>Niveau PPE :</strong> ${arcFlash.ppeLevel}</p>
                        `;
                        document.getElementById('mini-modal').classList.remove('hidden');
                        gsap.from('#mini-modal', { opacity: 0, scale: 0.8, duration: 0.5, ease: 'power2.out' });
                    }
                });

                group.on('mouseover', () => {
                    const tooltip = document.createElement('div');
                    tooltip.className = 'tooltip';
                    tooltip.innerHTML = node.title;
                    tooltipContainer.appendChild(tooltip);
                    const boxRect = box.getClientRect();
                    tooltip.style.left = `${boxRect.x + boxRect.width + 10}px`;
                    tooltip.style.top = `${boxRect.y}px`;
                    group.tooltip = tooltip;
                });

                group.on('mouseout', () => {
                    if (group.tooltip) {
                        group.tooltip.remove();
                        group.tooltip = null;
                    }
                });

                group.on('dragmove', () => {
                    if (group.tooltip) {
                        const boxRect = box.getClientRect();
                        group.tooltip.style.left = `${boxRect.x + boxRect.width + 10}px`;
                        group.tooltip.style.top = `${boxRect.y}px`;
                    }
                    nodePositions[node.id] = { x: group.x(), y: group.y() };
                    layer.batchDraw();
                });

                layer.add(group);
                node.groupKonva = group;
            });

            elements.edges.forEach(edge => {
                const fromNode = elements.nodes.find(n => n.id === edge.from);
                const toNode = elements.nodes.find(n => n.id === edge.to);
                if (fromNode && toNode) {
                    const fromGroup = fromNode.groupKonva;
                    const toGroup = toNode.groupKonva;

                    const line = new Konva.Line({
                        points: [
                            fromGroup.x() + (fromNode.group === 'tableau' ? 150 : 120) / 2,
                            fromGroup.y() + 60,
                            toGroup.x() + (toNode.group === 'tableau' ? 150 : 120) / 2,
                            toGroup.y()
                        ],
                        stroke: edge.color,
                        strokeWidth: 2
                    });

                    fromGroup.on('dragmove', () => {
                        line.points([
                            fromGroup.x() + (fromNode.group === 'tableau' ? 150 : 120) / 2,
                            fromGroup.y() + 60,
                            toGroup.x() + (toNode.group === 'tableau' ? 150 : 120) / 2,
                            toGroup.y()
                        ]);
                        layer.batchDraw();
                    });

                    toGroup.on('dragmove', () => {
                        line.points([
                            fromGroup.x() + (fromNode.group === 'tableau' ? 150 : 120) / 2,
                            fromGroup.y() + 60,
                            toGroup.x() + (toNode.group === 'tableau' ? 150 : 120) / 2,
                            toGroup.y()
                        ]);
                        layer.batchDraw();
                    });

                    layer.add(line);
                }
            });

            layer.draw();
        }

        function buildArborescence(tableaux, focusedTableauId = null) {
            const elements = { nodes: [], edges: [] };
            const tableauIds = new Set(tableaux.map(t => t.id));
            tableaux.forEach(tableau => {
                const nodeId = `tableau-${tableau.id}`;
                elements.nodes.push({
                    id: nodeId,
                    label: `${tableau.id}${tableau.issitemain ? '\n(Principal)' : ''}${tableau.isHTA ? '\n(HTA)' : ''}`,
                    title: `<strong>Tableau :</strong> ${tableau.id}<br><strong>Bâtiment :</strong> ${tableau.building}`,
                    color: '#22c55e',
                    group: 'tableau',
                    tableauId: tableau.id
                });

                tableau.disjoncteurs.forEach(d => {
                    const disjoncteurNodeId = `disjoncteur-${tableau.id}-${d.id}`;
                    const arcFlash = calculateIncidentEnergy(d, tableau);
                    elements.nodes.push({
                        id: disjoncteurNodeId,
                        label: `${d.id}\n(PPE=${arcFlash.ppeLevel})`,
                        title: `<strong>Disjoncteur :</strong> ${d.id}<br><strong>Énergie :</strong> ${arcFlash.incidentEnergy} cal/cm²<br><strong>Distance :</strong> ${arcFlash.boundaryDistance} m<br><strong>PPE :</strong> ${arcFlash.ppeLevel}`,
                        color: arcFlash.incidentEnergy > 8 ? '#dc2626' : '#22c55e',
                        group: 'disjoncteur',
                        disjoncteurId: d.id,
                        disjoncteur: d
                    });
                    elements.edges.push({
                        id: `edge-${nodeId}-to-${disjoncteurNodeId}`,
                        from: nodeId,
                        to: disjoncteurNodeId,
                        color: arcFlash.incidentEnergy > 8 ? '#dc2626' : '#22c55e'
                    });
                });
            });
            return elements;
        }

        function closeMiniModal() {
            console.log('[ArcFlash] Fermeture mini-modal');
            document.getElementById('mini-modal').classList.add('hidden');
        }

        window.onload = function() {
            console.log('[ArcFlash] Page chargée');
            if (window.location.protocol === 'file:') {
                showPopup('Erreur : Veuillez exécuter cette page via un serveur web.');
                return;
            }
            document.getElementById('mini-modal').classList.add('hidden');
            document.getElementById('missing-data-modal').classList.add('hidden');
            document.getElementById('add-node-modal').classList.add('hidden');
            document.getElementById('modal-graph').classList.add('hidden');
            document.getElementById('modal-graph').style.display = 'none';
            document.getElementById('arc-flash-card').classList.add('hidden');
            document.getElementById('arc-flash-card').style.display = 'none';
            chargerTableaux();
        };
    </script>
</body>
</html>