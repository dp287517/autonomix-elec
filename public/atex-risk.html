<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risk Assessment ATEX Global</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: Arial, sans-serif; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        #riskChart { max-height: 400px; }
    </style>
</head>
<body class="container my-5">
    <h1 class="text-center mb-4">Risk Assessment Global ATEX</h1>
    <a href="atex-control.html" class="btn btn-info mb-4">Retour à Contrôle Équipements</a>

    <div class="card">
        <div class="card-header"><h4>Statistiques Globales</h4></div>
        <div class="card-body">
            <canvas id="riskChart"></canvas>
            <div id="riskSummary" class="mt-3"></div>
        </div>
    </div>

    <div class="card">
        <div class="card-header"><h4>Équipements High-Risk ou Overdue</h4></div>
        <div class="card-body">
            <table class="table table-striped">
                <thead><tr><th>ID</th><th>Composant</th><th>Risk</th><th>Prochaine Inspection</th></tr></thead>
                <tbody id="highRiskTable"></tbody>
            </table>
        </div>
    </div>

    <script>
        window.onload = () => loadRiskGlobal();

        async function loadRiskGlobal() {
            const response = await fetch('/api/atex-risk-global');
            const data = await response.json();

            document.getElementById('riskSummary').innerHTML = `
                Total Équipements: ${data.total} | Conformes: ${data.conformePercent}% | Risk Moyen: ${data.avgRisk}/5 | High-Risk: ${data.highRisk}
            `;

            const ctx = document.getElementById('riskChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Low Risk', 'Med Risk', 'High Risk'],
                    datasets: [{ data: [data.lowRisk, data.medRisk, data.highRisk], backgroundColor: ['#28a745', '#ffc107', '#dc3545'] }]
                },
                options: { responsive: true }
            });

            // Fetch full equipments for high-risk table
            const eqResponse = await fetch('/api/atex-equipments');
            const equipments = await eqResponse.json();
            const highRiskEq = equipments.filter(eq => {
                const risk = calculateRisk(eq);
                const next = new Date(eq.next_inspection_date);
                return risk.level === 'High' || next < new Date();
            });

            const tbody = document.getElementById('highRiskTable');
            tbody.innerHTML = '';
            highRiskEq.forEach(eq => {
                const row = `<tr><td>${eq.identifiant}</td><td>${eq.composant}</td><td class="risk-${calculateRisk(eq).level.toLowerCase()}">${calculateRisk(eq).level}</td><td>${eq.next_inspection_date}</td></tr>`;
                tbody.innerHTML += row;
            });
        }

        // Réutiliser fonctions de calcul (copier de atex-control.html si besoin)
        function calculateRisk(eq) {
            let score = (eq.risque || 0) * 2;
            if (eq.conformite !== 'Conforme') score += 4;
            const level = score < 4 ? 'Low' : (score < 7 ? 'Med' : 'High');
            return { score, level };
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
