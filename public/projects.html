<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutonomiX Projects - Gestion de Projets</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/frappe-gantt@0.6.1/dist/frappe-gantt.min.css">
    <script src="https://unpkg.com/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            overflow-x: hidden;
        }
        .card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .btn-primary {
            background: #007bff;
            color: #ffffff;
            transition: background 0.3s ease, transform 0.2s;
        }
        .btn-primary:hover {
            background: #0056b3;
            transform: scale(1.05);
        }
        .btn-finalize {
            background: #28a745;
            color: #ffffff;
            transition: background 0.3s ease, transform 0.2s;
        }
        .btn-finalize:hover {
            background: #218838;
            transform: scale(1.05);
        }
        .btn-analyze {
            background: #6f42c1;
            color: #ffffff;
            transition: background 0.3s ease, transform 0.2s;
        }
        .btn-analyze:hover {
            background: #5a32a3;
            transform: scale(1.05);
        }
        canvas {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 4px;
        }
        .progress-bar {
            background: #333;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-bar-fill {
            background: #007bff;
            height: 100%;
            transition: width 1s ease;
        }
        .step {
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        .hidden {
            opacity: 0;
            pointer-events: none;
            transform: scale(0.95);
        }
        .gantt-container {
            height: 400px;
            margin: 10px 0;
            background: #1a1a1a;
            border: 1px solid #333;
        }
        input[type="text"], input[type="number"], input[type="date"], textarea {
            background: #1a1a1a;
            color: #ffffff;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 8px;
            transition: border-color 0.3s;
        }
        input:focus, textarea:focus {
            border-color: #007bff;
            outline: none;
        }
        input::placeholder, textarea::placeholder {
            color: #aaa;
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: 500;
        }
        .alert-over {
            color: #dc3545;
            font-weight: bold;
        }
        progress {
            width: 100%;
            height: 20px;
            border-radius: 10px;
        }
        progress::-webkit-progress-bar {
            background-color: #333;
            border-radius: 10px;
        }
        progress::-webkit-progress-value {
            background: #007bff;
            border-radius: 10px;
        }
        .over::-webkit-progress-value {
            background: #dc3545;
        }
        table th, table td {
            border: 1px solid #444;
            padding: 8px;
            text-align: left;
        }
        table thead {
            background: #222;
        }
        table tbody tr:hover {
            background: #333;
        }
        .date-label {
            font-size: 0.8rem;
            color: #aaa;
        }
        .stepper {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .stepper-item {
            flex: 1;
            text-align: center;
            position: relative;
        }
        .stepper-item::before {
            content: '';
            position: absolute;
            top: 50%;
            left: -50%;
            width: 100%;
            height: 2px;
            background: #444;
            z-index: -1;
        }
        .stepper-item:first-child::before {
            display: none;
        }
        .stepper-circle {
            width: 30px;
            height: 30px;
            background: #444;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 5px;
            transition: background 0.3s;
        }
        .stepper-active .stepper-circle {
            background: #007bff;
        }
        .stepper-completed .stepper-circle {
            background: #28a745;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            animation: fadeIn 0.3s;
        }
        [title] {
            cursor: help;
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto p-6">
        <h1 class="text-4xl font-bold mb-8 text-center">AutonomiX Projects - Gestion de Projets</h1>

        <!-- Stats en Temps Réel -->
        <div class="card p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4">Statistiques en Temps Réel</h2>
            <div id="globalStats" class="grid grid-cols-1 md:grid-cols-4 gap-4"></div>
        </div>

        <!-- Analyse AI -->
        <div class="card p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4">Analyse AI des Projets</h2>
            <button onclick="analyzeSelectedProject()" class="btn-analyze p-3 rounded-lg font-semibold w-full">Lancer Analyse AI sur un Projet</button>
            <div id="aiAnalysis" class="mt-4"></div>
        </div>

        <!-- Wizard Step-by-Step pour Nouveau Projet -->
        <div class="card p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4">Créer un Nouveau Projet</h2>
            <form id="createForm" class="space-y-4">
                <label for="project_name">Titre du Projet</label>
                <input type="text" id="project_name" placeholder="Titre du Projet" class="w-full" required>
                <label for="project_description">Description du Projet</label>
                <textarea id="project_description" placeholder="Description du Projet" class="w-full h-24"></textarea>
                <label for="budget_total">Budget Total (€)</label>
                <input type="number" id="budget_total" placeholder="Budget Total (€)" class="w-full" step="0.01" min="0" required>

                <!-- Stepper visuel -->
                <div class="stepper">
                    <div class="stepper-item stepper-active" id="stepper1"><div class="stepper-circle">1</div>BC</div>
                    <div class="stepper-item" id="stepper2"><div class="stepper-circle">2</div>PIP</div>
                    <div class="stepper-item" id="stepper3"><div class="stepper-circle">3</div>WBS</div>
                    <div class="stepper-item" id="stepper4"><div class="stepper-circle">4</div>Commandes</div>
                    <div class="stepper-item" id="stepper5"><div class="stepper-circle">5</div>Phase</div>
                    <div class="stepper-item" id="stepper6"><div class="stepper-circle">6</div>Réception</div>
                    <div class="stepper-item" id="stepper7"><div class="stepper-circle">7</div>Clôture</div>
                </div>

                <!-- Étape 1: Création Business Case -->
                <div id="step1" class="step card p-4">
                    <h3 class="text-xl font-semibold mb-2">Étape 1: Création Business Case</h3>
                    <label for="bc_start">Date Début Prévisionnelle</label>
                    <input type="date" id="bc_start">
                    <label for="bc_end">Date Fin Prévisionnelle</label>
                    <input type="date" id="bc_end">
                    <p class="date-label">Format: AAAA-MM-JJ (Fin > Début)</p>
                    <label class="flex items-center" title="Marquer le Business Case comme approuvé">
                        <input type="checkbox" id="business_case_approved" onchange="checkAllStepsCompleted(); updateStepper(1, this.checked);"> Approuvé
                    </label>
                    <div class="flex justify-between mt-4">
                        <button type="button" onclick="saveStep(1)" class="btn-primary p-2 rounded-lg flex-1 mr-2">Sauvegarder</button>
                        <button type="button" onclick="nextStep(1)" class="btn-primary p-2 rounded-lg flex-1">Suivant</button>
                    </div>
                </div>

                <!-- Étape 2: Création PIP -->
                <div id="step2" class="step card p-4 hidden">
                    <h3 class="text-xl font-semibold mb-2">Étape 2: Création PIP</h3>
                    <label for="pip_start">Date Début Prévisionnelle</label>
                    <input type="date" id="pip_start">
                    <label for="pip_end">Date Fin Prévisionnelle</label>
                    <input type="date" id="pip_end">
                    <p class="date-label">Format: AAAA-MM-JJ (Fin > Début)</p>
                    <label class="flex items-center" title="Marquer le PIP comme approuvé">
                        <input type="checkbox" id="pip_approved" onchange="checkAllStepsCompleted(); updateStepper(2, this.checked);"> Approuvé
                    </label>
                    <div class="flex justify-between mt-4">
                        <button type="button" onclick="prevStep(2)" class="btn-primary p-2 rounded-lg flex-1 mr-2">Précédent</button>
                        <button type="button" onclick="saveStep(2)" class="btn-primary p-2 rounded-lg flex-1 mr-2">Sauvegarder</button>
                        <button type="button" onclick="nextStep(2)" class="btn-primary p-2 rounded-lg flex-1">Suivant</button>
                    </div>
                </div>

                <!-- Étape 3: WBS Créé -->
                <div id="step3" class="step card p-4 hidden">
                    <h3 class="text-xl font-semibold mb-2">Étape 3: WBS Créé</h3>
                    <label for="wbs_start">Date Début Prévisionnelle</label>
                    <input type="date" id="wbs_start">
                    <label for="wbs_end">Date Fin Prévisionnelle</label>
                    <input type="date" id="wbs_end">
                    <p class="date-label">Format: AAAA-MM-JJ (Fin > Début)</p>
                    <label class="flex items-center" title="Marquer le WBS comme créé">
                        <input type="checkbox" id="wbs_created" onchange="checkAllStepsCompleted(); updateStepper(3, this.checked);"> Créé
                    </label>
                    <label for="wbs_number">Numéro WBS</label>
                    <input type="text" id="wbs_number" placeholder="Numéro WBS" class="w-full mt-2">
                    <div class="flex justify-between mt-4">
                        <button type="button" onclick="prevStep(3)" class="btn-primary p-2 rounded-lg flex-1 mr-2">Précédent</button>
                        <button type="button" onclick="saveStep(3)" class="btn-primary p-2 rounded-lg flex-1 mr-2">Sauvegarder</button>
                        <button type="button" onclick="nextStep(3)" class="btn-primary p-2 rounded-lg flex-1">Suivant</button>
                    </div>
                </div>

                <!-- Étape 4: Lancement des Commandes -->
                <div id="step4" class="step card p-4 hidden">
                    <h3 class="text-xl font-semibold mb-2">Étape 4: Lancement des Commandes</h3>
                    <label for="po_start">Date Début Prévisionnelle</label>
                    <input type="date" id="po_start">
                    <label for="po_end">Date Fin Prévisionnelle</label>
                    <input type="date" id="po_end">
                    <p class="date-label">Format: AAAA-MM-JJ (Fin > Début)</p>
                    <label class="flex items-center" title="Marquer les commandes comme lancées">
                        <input type="checkbox" id="po_launched" onchange="checkAllStepsCompleted(); updateStepper(4, this.checked);"> Lancé
                    </label>
                    <label for="po_requests">URLs PO (séparées par ;)</label>
                    <textarea id="po_requests" placeholder="URLs PO (séparées par ;)" class="w-full h-24 mt-2"></textarea>
                    <div class="flex justify-between mt-4">
                        <button type="button" onclick="prevStep(4)" class="btn-primary p-2 rounded-lg flex-1 mr-2">Précédent</button>
                        <button type="button" onclick="saveStep(4)" class="btn-primary p-2 rounded-lg flex-1 mr-2">Sauvegarder</button>
                        <button type="button" onclick="nextStep(4)" class="btn-primary p-2 rounded-lg flex-1">Suivant</button>
                    </div>
                </div>

                <!-- Étape 5: Phase Projet -->
                <div id="step5" class="step card p-4 hidden">
                    <h3 class="text-xl font-semibold mb-2">Étape 5: Phase Projet</h3>
                    <label for="project_phase_start">Date Début Prévisionnelle</label>
                    <input type="date" id="project_phase_start">
                    <label for="project_phase_end">Date Fin Prévisionnelle</label>
                    <input type="date" id="project_phase_end">
                    <p class="date-label">Format: AAAA-MM-JJ (Fin > Début)</p>
                    <label class="flex items-center" title="Marquer la phase projet comme complétée">
                        <input type="checkbox" id="project_phase_completed" onchange="checkAllStepsCompleted(); updateStepper(5, this.checked);"> Complété
                    </label>
                    <div class="gantt-container" id="ganttNew"></div>
                    <div class="flex justify-between mt-4">
                        <button type="button" onclick="prevStep(5)" class="btn-primary p-2 rounded-lg flex-1 mr-2">Précédent</button>
                        <button type="button" onclick="saveStep(5)" class="btn-primary p-2 rounded-lg flex-1 mr-2">Sauvegarder</button>
                        <button type="button" onclick="nextStep(5)" class="btn-primary p-2 rounded-lg flex-1">Suivant</button>
                    </div>
                </div>

                <!-- Étape 6: Réception de Projet -->
                <div id="step6" class="step card p-4 hidden">
                    <h3 class="text-xl font-semibold mb-2">Étape 6: Réception de Projet</h3>
                    <label for="reception_start">Date Début Prévisionnelle</label>
                    <input type="date" id="reception_start">
                    <label for="reception_end">Date Fin Prévisionnelle</label>
                    <input type="date" id="reception_end">
                    <p class="date-label">Format: AAAA-MM-JJ (Fin > Début)</p>
                    <label class="flex items-center" title="Marquer la réception comme complétée">
                        <input type="checkbox" id="reception_completed" onchange="checkAllStepsCompleted(); updateStepper(6, this.checked);"> Complété
                    </label>
                    <div class="flex justify-between mt-4">
                        <button type="button" onclick="prevStep(6)" class="btn-primary p-2 rounded-lg flex-1 mr-2">Précédent</button>
                        <button type="button" onclick="saveStep(6)" class="btn-primary p-2 rounded-lg flex-1 mr-2">Sauvegarder</button>
                        <button type="button" onclick="nextStep(6)" class="btn-primary p-2 rounded-lg flex-1">Suivant</button>
                    </div>
                </div>

                <!-- Étape 7: Clôture du Projet -->
                <div id="step7" class="step card p-4 hidden">
                    <h3 class="text-xl font-semibold mb-2">Étape 7: Clôture du Projet</h3>
                    <label for="closure_start">Date Début Prévisionnelle</label>
                    <input type="date" id="closure_start">
                    <label for="closure_end">Date Fin Prévisionnelle</label>
                    <input type="date" id="closure_end">
                    <p class="date-label">Format: AAAA-MM-JJ (Fin > Début)</p>
                    <label class="flex items-center" title="Marquer la clôture comme complétée">
                        <input type="checkbox" id="closure_completed" onchange="checkAllStepsCompleted(); updateStepper(7, this.checked);"> Complété
                    </label>
                    <label for="attachment">Pièce Jointe</label>
                    <input type="file" id="attachment" onchange="uploadAttachment(newProjectId)" class="w-full mt-2">
                    <div class="flex justify-between mt-4">
                        <button type="button" onclick="prevStep(7)" class="btn-primary p-2 rounded-lg flex-1 mr-2">Précédent</button>
                        <button type="button" onclick="saveStep(7)" class="btn-primary p-2 rounded-lg flex-1">Sauvegarder</button>
                    </div>
                </div>

                <button type="submit" id="createButton" class="btn-primary p-3 rounded-lg font-semibold w-full" disabled>Finaliser le Projet</button>
            </form>
        </div>

        <!-- Progression Globale -->
        <div class="card p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4">Progression Globale des Projets</h2>
            <div class="progress-bar mb-2">
                <div id="progressBarFill" class="progress-bar-fill" style="width: 0%"></div>
            </div>
            <p id="progressText" class="text-sm">0% complété</p>
            <p id="forecastText" class="text-sm">Estimation : -</p>
        </div>

        <!-- Recherche pour table -->
        <div class="mb-4">
            <input type="text" id="searchInput" placeholder="Rechercher un projet..." class="w-full" oninput="filterTable()">
        </div>

        <!-- Tableau des Projets -->
        <div class="card p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4">Récapitulatif des Projets</h2>
            <div class="overflow-x-auto">
                <table id="projectsTable" class="min-w-full border-collapse">
                    <thead>
                        <tr class="bg-gray-800">
                            <th class="p-3">Nom</th>
                            <th class="p-3">Description</th>
                            <th class="p-3">Status</th>
                            <th class="p-3">Étapes</th>
                            <th class="p-3">Gantt</th>
                            <th class="p-3">Budget (Total / Dépensé)</th>
                            <th class="p-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="projectsTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Analyses -->
        <div class="card p-6">
            <h2 class="text-2xl font-bold mb-4">Analyses des Projets</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-xl font-semibold mb-2">Répartition des Status (Doughnut)</h3>
                    <canvas id="statusDoughnut" height="200"></canvas>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-2">Budget Global vs Dépensé</h3>
                    <canvas id="budgetBar" height="200"></canvas>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-2">Budgets par Projet</h3>
                    <canvas id="budgetPerProject" height="200"></canvas>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-2">Évolution de la Progression</h3>
                    <canvas id="progressLine" height="200"></canvas>
                </div>
                <div class="col-span-2">
                    <h3 class="text-xl font-semibold mb-2">Gantt Global</h3>
                    <div id="globalGantt" class="gantt-container"></div>
                </div>
            </div>
            <button onclick="exportToPDF()" class="btn-primary p-3 rounded-lg font-semibold w-full mt-4">Exporter Stats en PDF</button>
        </div>

        <!-- Modal pour détails projet -->
        <div id="projectModal" class="modal">
            <div class="modal-content">
                <h2 id="modalTitle" class="text-2xl font-bold mb-4"></h2>
                <label for="modalDescription">Description</label>
                <textarea id="modalDescription" class="w-full h-24 mb-4"></textarea>
                <label for="modalBudgetTotal">Budget Total</label>
                <input type="number" id="modalBudgetTotal" class="w-full mb-4" step="0.01">
                <button onclick="saveModalChanges()" class="btn-primary p-2 rounded-lg w-full">Sauvegarder</button>
                <button onclick="closeModal()" class="btn-primary p-2 rounded-lg w-full mt-2">Fermer</button>
            </div>
        </div>
    </div>

    <script>
        let newProjectId = null;
        let currentStep = 1;
        let selectedProjectId = null;
        const defaultGanttTasks = [
            { id: 'Task1', name: 'Business Case', start: '2025-07-10', end: '2025-08-10', progress: 0, dependencies: '' },
            { id: 'Task2', name: 'PIP', start: '2025-08-10', end: '2025-09-10', progress: 0, dependencies: 'Task1' },
            { id: 'Task3', name: 'WBS', start: '2025-09-10', end: '2025-10-10', progress: 0, dependencies: 'Task2' },
            { id: 'Task4', name: 'Commandes', start: '2025-10-10', end: '2025-11-10', progress: 0, dependencies: 'Task3' },
            { id: 'Task5', name: 'Phase Projet', start: '2025-11-10', end: '2026-01-10', progress: 0, dependencies: 'Task4' },
            { id: 'Task6', name: 'Réception', start: '2026-01-10', end: '2026-02-10', progress: 0, dependencies: 'Task5' },
            { id: 'Task7', name: 'Clôture', start: '2026-02-10', end: '2026-03-10', progress: 0, dependencies: 'Task6' }
        ];

        let statusDoughnutChart = null;
        let budgetBarChart = null;
        let budgetPerProjectChart = null;
        let progressLineChart = null;

        // Check if all steps completed to enable finalize
        function checkAllStepsCompleted() {
            const checkboxes = [
                document.getElementById('business_case_approved').checked,
                document.getElementById('pip_approved').checked,
                document.getElementById('wbs_created').checked,
                document.getElementById('po_launched').checked,
                document.getElementById('project_phase_completed').checked,
                document.getElementById('reception_completed').checked,
                document.getElementById('closure_completed').checked
            ];
            const allChecked = checkboxes.every(checked => checked);
            const button = document.getElementById('createButton');
            button.disabled = !allChecked;
            if (allChecked) {
                button.classList.remove('btn-primary');
                button.classList.add('btn-finalize');
            } else {
                button.classList.add('btn-primary');
                button.classList.remove('btn-finalize');
            }
        }

        // Save step
        function saveStep(step) {
            if (!validateDates(step)) return;
            const data = getFormData(step);
            if (newProjectId) {
                updateProject(newProjectId, data);
            } else {
                createProject(data);
            }
            checkAllStepsCompleted();
        }

        // Get form data
        function getFormData(step) {
            let data = {};
            data.name = document.getElementById('project_name').value || 'Projet Sans Nom';
            data.description = document.getElementById('project_description').value || '';
            data.budget_total = parseFloat(document.getElementById('budget_total').value) || 0;
            let progress = 0;
            if (step === 1) {
                data.business_case_approved = document.getElementById('business_case_approved').checked;
                progress = data.business_case_approved ? 100 : 0;
                data.gantt_data = updateGanttDates(0, document.getElementById('bc_start').value, document.getElementById('bc_end').value, progress);
            } else if (step === 2) {
                data.pip_approved = document.getElementById('pip_approved').checked;
                progress = data.pip_approved ? 100 : 0;
                data.gantt_data = updateGanttDates(1, document.getElementById('pip_start').value, document.getElementById('pip_end').value, progress);
            } else if (step === 3) {
                data.wbs_created = document.getElementById('wbs_created').checked;
                data.wbs_number = document.getElementById('wbs_number').value;
                progress = data.wbs_created ? 100 : 0;
                data.gantt_data = updateGanttDates(2, document.getElementById('wbs_start').value, document.getElementById('wbs_end').value, progress);
            } else if (step === 4) {
                data.po_launched = document.getElementById('po_launched').checked;
                data.po_requests = document.getElementById('po_requests').value.split(';').filter(url => url.trim()).map(url => ({ url: url.trim(), status: 'En attente' }));
                progress = data.po_launched ? 100 : 0;
                data.gantt_data = updateGanttDates(3, document.getElementById('po_start').value, document.getElementById('po_end').value, progress);
            } else if (step === 5) {
                data.project_phase_completed = document.getElementById('project_phase_completed').checked;
                progress = data.project_phase_completed ? 100 : 0;
                data.gantt_data = updateGanttDates(4, document.getElementById('project_phase_start').value, document.getElementById('project_phase_end').value, progress);
            } else if (step === 6) {
                data.reception_completed = document.getElementById('reception_completed').checked;
                progress = data.reception_completed ? 100 : 0;
                data.gantt_data = updateGanttDates(5, document.getElementById('reception_start').value, document.getElementById('reception_end').value, progress);
            } else if (step === 7) {
                data.closure_completed = document.getElementById('closure_completed').checked;
                progress = data.closure_completed ? 100 : 0;
                data.gantt_data = updateGanttDates(6, document.getElementById('closure_start').value, document.getElementById('closure_end').value, progress);
            }
            return data;
        }

        // Update Gantt dates and progress
        function updateGanttDates(taskIndex, start, end, progress) {
            let tasks = JSON.parse(localStorage.getItem('tempGanttTasks')) || defaultGanttTasks;
            tasks[taskIndex].start = start || tasks[taskIndex].start;
            tasks[taskIndex].end = end || tasks[taskIndex].end;
            if (new Date(tasks[taskIndex].end) <= new Date(tasks[taskIndex].start)) tasks[taskIndex].end = new Date(new Date(tasks[taskIndex].start).getTime() + 86400000).toISOString().split('T')[0];
            tasks[taskIndex].progress = progress;
            localStorage.setItem('tempGanttTasks', JSON.stringify(tasks));
            return { tasks };
        }

        // Create project
        async function createProject(data) {
            try {
                const response = await fetch('/api/projects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Erreur lors de la création du projet');
                }
                const project = await response.json();
                newProjectId = project.id;
                document.getElementById('createButton').disabled = false;
                localStorage.removeItem('tempGanttTasks');
                loadProjects();
            } catch (error) {
                console.error('Erreur création:', error);
                alert('Erreur lors de la création du projet: ' + error.message);
            }
        }

        // Update project
        async function updateProject(id, data) {
            try {
                const response = await fetch(`/api/projects/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Erreur lors de la mise à jour du projet');
                }
                loadProjects();
            } catch (error) {
                console.error('Erreur mise à jour:', error);
                alert('Erreur lors de la mise à jour: ' + error.message);
            }
        }

        // Upload attachment
        async function uploadAttachment(id) {
            const file = document.getElementById('attachment').files[0];
            if (!file || !id) return;
            const formData = new FormData();
            formData.append('file', file);
            try {
                const response = await fetch(`/api/projects/${id}/attachment`, { method: 'POST', body: formData });
                if (!response.ok) throw new Error('Erreur lors de l\'upload');
                loadProjects();
            } catch (error) {
                console.error('Erreur upload:', error);
                alert('Erreur lors de l\'upload: ' + error.message);
            }
        }

        // Analyze project
        async function analyzeSelectedProject() {
            const selectedId = prompt('Entrez l\'ID du projet à analyser :');
            if (!selectedId) return;
            try {
                const response = await fetch('/api/projects');
                const projects = await response.json();
                const project = projects.find(p => p.id == selectedId);
                if (!project) {
                    alert('Projet non trouvé !');
                    return;
                }
                const aiResponse = await fetch('/api/project-analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ projectData: project })
                });
                if (!aiResponse.ok) throw new Error('Erreur analyse AI');
                const analysis = await aiResponse.json();
                document.getElementById('aiAnalysis').innerHTML = `
                    <h3 class="text-xl font-semibold mb-2">Analyse pour ${project.name}</h3>
                    <p><strong>Avis :</strong> ${analysis.avis || 'N/A'}</p>
                    <p><strong>Risques :</strong> ${analysis.risques ? analysis.risques.join(', ') : 'Aucun'}</p>
                    <p><strong>Score :</strong> ${analysis.score || 0}/100</p>
                    <p><strong>Suggestions :</strong> ${analysis.suggestions ? analysis.suggestions.join(', ') : 'Aucune'}</p>
                `;
            } catch (error) {
                console.error('Erreur analyse AI:', error);
                alert('Erreur lors de l\'analyse AI: ' + error.message);
            }
        }

        // Load projects table
        async function loadProjects() {
            try {
                const response = await fetch('/api/projects');
                const projects = await response.json();
                const tableBody = document.getElementById('projectsTableBody');
                tableBody.innerHTML = '';
                projects.forEach(p => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-700';
                    row.innerHTML = `
                        <td class="p-3 cursor-pointer" onclick="openModal(${p.id}, '${p.name}', '${p.description}', ${p.budget_total})">${p.name}</td>
                        <td class="p-3">${p.description || 'Aucune description'}</td>
                        <td class="p-3">${p.status}</td>
                        <td class="p-3">
                            BC: <input type="checkbox" ${p.business_case_approved ? 'checked' : ''} onchange="updateProject(${p.id}, {business_case_approved: this.checked});"><br>
                            PIP: <input type="checkbox" ${p.pip_approved ? 'checked' : ''} onchange="updateProject(${p.id}, {pip_approved: this.checked});"><br>
                            WBS: <input type="checkbox" ${p.wbs_created ? 'checked' : ''} onchange="updateProject(${p.id}, {wbs_created: this.checked});"><br>
                            Commandes: <input type="checkbox" ${p.po_launched ? 'checked' : ''} onchange="updateProject(${p.id}, {po_launched: this.checked});"><br>
                            Phase Projet: <input type="checkbox" ${p.project_phase_completed ? 'checked' : ''} onchange="updateProject(${p.id}, {project_phase_completed: this.checked});"><br>
                            Réception: <input type="checkbox" ${p.reception_completed ? 'checked' : ''} onchange="updateProject(${p.id}, {reception_completed: this.checked});"><br>
                            Clôture: <input type="checkbox" ${p.closure_completed ? 'checked' : ''} onchange="updateProject(${p.id}, {closure_completed: this.checked});">
                        </td>
                        <td class="p-3"><div class="gantt-container" id="gantt${p.id}"></div></td>
                        <td class="p-3">
                            <progress value="${parseFloat(p.budget_spent) || 0}" max="${parseFloat(p.budget_total) || 1}" class="${parseFloat(p.budget_spent) > parseFloat(p.budget_total) ? 'over' : ''}"></progress>
                            <span class="${parseFloat(p.budget_spent) > parseFloat(p.budget_total) ? 'alert-over' : ''}">${parseFloat(p.budget_spent) || 0}/${parseFloat(p.budget_total) || 0}</span>
                        </td>
                        <td class="p-3"><button onclick="deleteProject(${p.id})" class="bg-red-500 text-white p-2 rounded">Supprimer</button></td>
                    `;
                    tableBody.appendChild(row);

                    let tasks = p.gantt_data?.tasks || defaultGanttTasks;
                    tasks = tasks.map(t => ({
                        ...t,
                        start: t.start || '2025-07-10',
                        end: t.end && new Date(t.end) > new Date(t.start) ? t.end : new Date(new Date(t.start).getTime() + 86400000).toISOString().split('T')[0]
                    }));
                    if (tasks.length === 0) {
                        document.getElementById(`gantt${p.id}`).innerHTML = '<p class="text-gray-400 text-center">Aucune tâche</p>';
                    } else {
                        new Gantt(`#gantt${p.id}`, tasks, {
                            header_height: 50,
                            column_width: 30,
                            step: 24,
                            view_modes: ['Day', 'Week', 'Month'],
                            bar_height: 20,
                            bar_corner_radius: 3,
                            arrow_curve: 5,
                            padding: 18,
                            view_mode: 'Month',
                            date_format: 'YYYY-MM-DD',
                            language: 'fr',
                            custom_popup_html: task => `<div class="p-2 bg-gray-800 rounded text-white">${task.name}<br>Progress: ${task.progress}%</div>`,
                            on_date_change: (task, start, end) => {
                                if (new Date(end) <= new Date(start)) end = new Date(new Date(start).getTime() + 86400000).toISOString().split('T')[0];
                                const updatedTasks = tasks.map(t => t.id === task.id ? { ...t, start: start.toISOString().split('T')[0], end: end.toISOString().split('T')[0] } : t);
                                updateProject(p.id, { gantt_data: { tasks: updatedTasks } });
                            },
                            on_progress_change: (task, progress) => {
                                const updatedTasks = tasks.map(t => t.id === task.id ? { ...t, progress } : t);
                                updateProject(p.id, { gantt_data: { tasks: updatedTasks } });
                            }
                        });
                    }
                });
                loadStats(projects);
            } catch (error) {
                console.error('Erreur chargement projets:', error);
                alert('Erreur lors du chargement des projets: ' + error.message);
            }
        }

        // Delete project
        async function deleteProject(id) {
            if (confirm('Confirmer la suppression du projet ?')) {
                try {
                    const response = await fetch(`/api/projects/${id}`, { method: 'DELETE' });
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(errorText || 'Erreur lors de la suppression du projet');
                    }
                    loadProjects();
                } catch (error) {
                    console.error('Erreur suppression:', error);
                    alert('Erreur lors de la suppression: ' + error.message);
                }
            }
        }

        // Load stats & graphs
        async function loadStats(projects) {
            try {
                const response = await fetch('/api/project-stats');
                const stats = await response.json();
                document.getElementById('globalStats').innerHTML = `
                    <div class="p-4 bg-gray-800 rounded-lg"><p class="text-sm">Projets Totaux</p><p class="text-2xl font-bold">${stats.totalProjects}</p></div>
                    <div class="p-4 bg-gray-800 rounded-lg"><p class="text-sm">Business Cases Approuvés</p><p class="text-2xl font-bold">${stats.approvedBusinessCases}</p></div>
                    <div class="p-4 bg-gray-800 rounded-lg"><p class="text-sm">Budget Global</p><p class="text-2xl font-bold">${stats.totalBudget.toFixed(2)} €</p></div>
                    <div class="p-4 bg-gray-800 rounded-lg"><p class="text-sm">Budget Dépensé</p><p class="text-2xl font-bold">${stats.spentBudget.toFixed(2)} €</p></div>
                `;

                const avgProgress = projects.length ? projects.reduce((sum, p) => {
                    let progress = 0;
                    if (p.business_case_approved) progress += 14.2857;
                    if (p.pip_approved) progress += 14.2857;
                    if (p.wbs_created) progress += 14.2857;
                    if (p.po_launched) progress += 14.2857;
                    if (p.project_phase_completed) progress += 14.2857;
                    if (p.reception_completed) progress += 14.2857;
                    if (p.closure_completed) progress += 14.2857;
                    return sum + progress;
                }, 0) / projects.length : 0;
                document.getElementById('progressBarFill').style.width = `${avgProgress}%`;
                document.getElementById('progressText').textContent = `${avgProgress.toFixed(2)}% complété`;

                if (projects.length) {
                    const estimatedMonths = Math.ceil((100 - avgProgress) / 10);
                    const estimatedDate = new Date();
                    estimatedDate.setMonth(estimatedDate.getMonth() + estimatedMonths);
                    document.getElementById('forecastText').textContent = `Estimation : ${estimatedDate.toLocaleString('fr-FR', { month: 'long', year: 'numeric' })}`;
                } else {
                    document.getElementById('forecastText').textContent = 'Estimation : -';
                }

                // Destroy existing charts if they exist
                if (statusDoughnutChart) statusDoughnutChart.destroy();
                if (budgetBarChart) budgetBarChart.destroy();
                if (budgetPerProjectChart) budgetPerProjectChart.destroy();
                if (progressLineChart) progressLineChart.destroy();

                // Doughnut Chart for status distribution
                statusDoughnutChart = new Chart(document.getElementById('statusDoughnut'), {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(stats.statusDistribution),
                        datasets: [{ data: Object.values(stats.statusDistribution), backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545'] }]
                    },
                    options: {
                        animation: { duration: 1000, easing: 'easeInOutQuart' },
                        plugins: { zoom: { zoom: { mode: 'xy' } } }
                    }
                });

                // Bar Chart for global budget
                budgetBarChart = new Chart(document.getElementById('budgetBar'), {
                    type: 'bar',
                    data: {
                        labels: ['Total', 'Dépensé'],
                        datasets: [{ data: [stats.totalBudget, stats.spentBudget], backgroundColor: stats.spentBudget > stats.totalBudget ? '#dc3545' : '#007bff' }]
                    },
                    options: {
                        animation: { duration: 1000, easing: 'easeInOutQuart' },
                        plugins: { zoom: { zoom: { mode: 'xy' } } }
                    }
                });

                // Bar Chart for budgets per project
                budgetPerProjectChart = new Chart(document.getElementById('budgetPerProject'), {
                    type: 'bar',
                    data: {
                        labels: projects.map(p => p.name),
                        datasets: [{
                            label: 'Total',
                            data: projects.map(p => parseFloat(p.budget_total) || 0),
                            backgroundColor: '#007bff'
                        }, {
                            label: 'Dépensé',
                            data: projects.map(p => parseFloat(p.budget_spent) || 0),
                            backgroundColor: '#28a745'
                        }]
                    },
                    options: {
                        animation: { duration: 1000, easing: 'easeInOutQuart' },
                        plugins: { zoom: { zoom: { mode: 'xy' } } }
                    }
                });

                // Line Chart for progress evolution (simple estimation)
                const progressData = projects.map(p => {
                    let prog = 0;
                    if (p.business_case_approved) prog += 14.2857;
                    if (p.pip_approved) prog += 14.2857;
                    if (p.wbs_created) prog += 14.2857;
                    if (p.po_launched) prog += 14.2857;
                    if (p.project_phase_completed) prog += 14.2857;
                    if (p.reception_completed) prog += 14.2857;
                    if (p.closure_completed) prog += 14.2857;
                    return prog;
                });
                progressLineChart = new Chart(document.getElementById('progressLine'), {
                    type: 'line',
                    data: {
                        labels: projects.map(p => p.name),
                        datasets: [{ label: 'Progression (%)', data: progressData, borderColor: '#007bff', fill: false }]
                    },
                    options: {
                        animation: { duration: 1000, easing: 'easeInOutQuart' },
                        plugins: { zoom: { zoom: { mode: 'xy' } } }
                    }
                });

                // Global Gantt
                let globalTasks = projects.flatMap(p => (p.gantt_data?.tasks || defaultGanttTasks).map(t => ({ ...t, name: `${p.name} - ${t.name}` })));
                globalTasks = globalTasks.map(t => ({
                    ...t,
                    start: t.start || '2025-07-10',
                    end: t.end && new Date(t.end) > new Date(t.start) ? t.end : new Date(new Date(t.start).getTime() + 86400000).toISOString().split('T')[0]
                }));
                if (globalTasks.length === 0) {
                    document.getElementById('globalGantt').innerHTML = '<p class="text-gray-400 text-center">Aucun projet avec tâches</p>';
                } else {
                    new Gantt('#globalGantt', globalTasks, {
                        view_mode: 'Month',
                        language: 'fr'
                    });
                }
            } catch (error) {
                console.error('Erreur chargement stats:', error);
                alert('Erreur lors du chargement des stats: ' + error.message);
            }
        }

        // Form submit for final create
        document.getElementById('createForm').addEventListener('submit', e => {
            e.preventDefault();
            if (newProjectId) {
                updateProject(newProjectId, { status: 'En cours' });
                newProjectId = null;
                document.getElementById('createButton').disabled = true;
                loadProjects();
            }
        });

        // Filter table
        function filterTable() {
            const input = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.getElementById('projectsTableBody').rows;
            Array.from(rows).forEach(row => {
                const name = row.cells[0].textContent.toLowerCase();
                row.style.display = name.includes(input) ? '' : 'none';
            });
        }

        // Modal functions
        function openModal(id, name, description, budget_total) {
            selectedProjectId = id;
            document.getElementById('modalTitle').textContent = `Éditer ${name}`;
            document.getElementById('modalDescription').value = description || '';
            document.getElementById('modalBudgetTotal').value = budget_total || 0;
            document.getElementById('projectModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('projectModal').style.display = 'none';
        }

        async function saveModalChanges() {
            const data = {
                description: document.getElementById('modalDescription').value,
                budget_total: parseFloat(document.getElementById('modalBudgetTotal').value) || 0
            };
            await updateProject(selectedProjectId, data);
            closeModal();
            loadProjects();
        }

        // Export to PDF (using window.print as simple solution; can be improved with jsPDF)
        function exportToPDF() {
            window.print();
        }

        // Init Gantt for new project
        new Gantt('#ganttNew', defaultGanttTasks, {
            view_mode: 'Month',
            language: 'fr',
            on_date_change: (task, start, end) => {
                if (new Date(end) <= new Date(start)) end = new Date(new Date(start).getTime() + 86400000).toISOString().split('T')[0];
                if (newProjectId) {
                    const updatedTasks = defaultGanttTasks.map(t => t.id === task.id ? { ...t, start: start.toISOString().split('T')[0], end: end.toISOString().split('T')[0] } : t);
                    updateProject(newProjectId, { gantt_data: { tasks: updatedTasks } });
                }
            },
            on_progress_change: (task, progress) => {
                if (newProjectId) {
                    const updatedTasks = defaultGanttTasks.map(t => t.id === task.id ? { ...t, progress } : t);
                    updateProject(newProjectId, { gantt_data: { tasks: updatedTasks } });
                }
            }
        });

        // Load initial data
        loadProjects();
    </script>
</body>
</html>
