<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion de Projets - Autonomix</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1, h2 { color: #333; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        form { max-width: 600px; margin-bottom: 20px; }
        label { display: block; margin-top: 10px; }
        input, textarea, select { width: 100%; padding: 8px; margin-top: 5px; }
        button { margin-top: 10px; padding: 10px 20px; background-color: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        .project-card { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; }
        .hidden { display: none; }
        .approval-check { color: green; font-weight: bold; }
        .pending-check { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Gestion de Projets</h1>

    <!-- Liste des projets -->
    <h2>Liste des Projets</h2>
    <div id="project-list"></div>

    <!-- Formulaire pour créer/éditer un projet -->
    <h2>Créer ou Éditer un Projet</h2>
    <form id="project-form">
        <input type="hidden" id="project-id" value="">
        
        <label for="name">Nom du Projet :</label>
        <input type="text" id="name" required>
        
        <label for="description">Description :</label>
        <textarea id="description"></textarea>
        
        <label for="business_case">Business Case :</label>
        <textarea id="business_case"></textarea>
        <label>Business Case Approuvé : <input type="checkbox" id="business_case_approved"></label>
        
        <label for="pip">PIP (Project Initiation Proposal) :</label>
        <textarea id="pip"></textarea>
        <label>PIP Approuvé : <input type="checkbox" id="pip_approved"></label>
        
        <label for="wbs_number">Numéro WBS :</label>
        <input type="text" id="wbs_number">
        <label>WBS Créé : <input type="checkbox" id="wbs_created"></label>
        
        <label>Lancement des Commandes (PO Launched) : <input type="checkbox" id="po_launched"></label>
        
        <label for="chantier_date">Date du Chantier :</label>
        <input type="date" id="chantier_date">
        
        <label>Phase Projet Complétée : <input type="checkbox" id="project_phase_completed"></label>
        
        <label>Réception Complétée : <input type="checkbox" id="reception_completed"></label>
        
        <label>Clôture Complétée : <input type="checkbox" id="closure_completed"></label>
        
        <label for="budget_total">Budget Total :</label>
        <input type="number" id="budget_total" step="0.01">
        
        <label for="status">Statut :</label>
        <select id="status">
            <option value="En cours">En cours</option>
            <option value="Approuvé">Approuvé</option>
            <option value="Terminé">Terminé</option>
            <option value="Bloqué">Bloqué</option>
        </select>
        
        <!-- Section pour PO Requests, Quotes, Attachments, Gantt (simplifiée) -->
        <label for="po_requests">Demandes PO (JSON array) :</label>
        <textarea id="po_requests" placeholder='[{"url": "", "status": ""}]'></textarea>
        
        <label for="quotes">Devis (JSON array) :</label>
        <textarea id="quotes" placeholder='[{"id": "", "montant": 0, "status": "", "fournisseur": ""}]'></textarea>
        
        <label for="attachments">Pièces Jointes (upload via bouton séparé)</label>
        <input type="file" id="attachment-file">
        <button type="button" id="upload-attachment">Uploader Pièce Jointe</button>
        <div id="attachments-list"></div>
        
        <label for="gantt_data">Données Gantt (JSON) :</label>
        <textarea id="gantt_data" placeholder='{"tasks": [{"name": "", "start": "", "end": "", "progress": 0}]}'></textarea>
        
        <button type="submit">Sauvegarder Projet</button>
    </form>

    <!-- Bouton pour analyser le projet courant -->
    <button id="analyze-project">Analyser le Projet (AI)</button>
    <div id="analysis-result"></div>

    <script>
        const API_BASE = '/api/projects';

        // Fonction pour charger la liste des projets
        async function loadProjects() {
            try {
                const response = await fetch(API_BASE);
                const projects = await response.json();
                const list = document.getElementById('project-list');
                list.innerHTML = '';
                projects.forEach(project => {
                    const card = document.createElement('div');
                    card.classList.add('project-card');
                    card.innerHTML = `
                        <h3>${project.name}</h3>
                        <p>${project.description}</p>
                        <p>Statut: ${project.status}</p>
                        <p>Budget: ${project.budget_total} (€ spent: ${project.budget_spent})</p>
                        <p>Business Case: ${project.business_case_approved ? '<span class="approval-check">Approuvé</span>' : '<span class="pending-check">En attente</span>'}</p>
                        <p>PIP: ${project.pip_approved ? '<span class="approval-check">Approuvé</span>' : '<span class="pending-check">En attente</span>'}</p>
                        <p>WBS Créé: ${project.wbs_created ? '<span class="approval-check">Oui</span>' : '<span class="pending-check">Non</span>'}</p>
                        <p>PO Lancé: ${project.po_launched ? '<span class="approval-check">Oui</span>' : '<span class="pending-check">Non</span>'}</p>
                        <p>Date Chantier: ${project.chantier_date || 'Non définie'}</p>
                        <p>Phase Projet: ${project.project_phase_completed ? '<span class="approval-check">Complétée</span>' : '<span class="pending-check">En cours</span>'}</p>
                        <p>Réception: ${project.reception_completed ? '<span class="approval-check">Complétée</span>' : '<span class="pending-check">En attente</span>'}</p>
                        <p>Clôture: ${project.closure_completed ? '<span class="approval-check">Complétée</span>' : '<span class="pending-check">En attente</span>'}</p>
                        <button onclick="editProject('${project.id}')">Éditer</button>
                        <button onclick="deleteProject('${project.id}')">Supprimer</button>
                    `;
                    list.appendChild(card);
                });
            } catch (err) {
                console.error('Erreur chargement projets:', err);
            }
        }

        // Fonction pour éditer un projet
        async function editProject(id) {
            try {
                const response = await fetch(`${API_BASE}/${id}`);
                const project = await response.json();
                document.getElementById('project-id').value = project.id;
                document.getElementById('name').value = project.name;
                document.getElementById('description').value = project.description;
                document.getElementById('business_case').value = project.business_case;
                document.getElementById('business_case_approved').checked = project.business_case_approved;
                document.getElementById('pip').value = project.pip;
                document.getElementById('pip_approved').checked = project.pip_approved;
                document.getElementById('wbs_number').value = project.wbs_number;
                document.getElementById('wbs_created').checked = project.wbs_created;
                document.getElementById('po_launched').checked = project.po_launched;
                document.getElementById('chantier_date').value = project.chantier_date ? project.chantier_date.split('T')[0] : '';
                document.getElementById('project_phase_completed').checked = project.project_phase_completed;
                document.getElementById('reception_completed').checked = project.reception_completed;
                document.getElementById('closure_completed').checked = project.closure_completed;
                document.getElementById('budget_total').value = project.budget_total;
                document.getElementById('status').value = project.status;
                document.getElementById('po_requests').value = JSON.stringify(project.po_requests || []);
                document.getElementById('quotes').value = JSON.stringify(project.quotes || []);
                document.getElementById('gantt_data').value = JSON.stringify(project.gantt_data || {});
                
                // Afficher attachments
                const attachmentsList = document.getElementById('attachments-list');
                attachmentsList.innerHTML = '';
                (project.attachments || []).forEach(att => {
                    const link = document.createElement('a');
                    link.href = att.data;
                    link.textContent = att.filename;
                    link.download = att.filename;
                    attachmentsList.appendChild(link);
                    attachmentsList.appendChild(document.createElement('br'));
                });
            } catch (err) {
                console.error('Erreur édition projet:', err);
            }
        }

        // Fonction pour supprimer un projet
        async function deleteProject(id) {
            if (confirm('Confirmer la suppression ?')) {
                try {
                    await fetch(`${API_BASE}/${id}`, { method: 'DELETE' });
                    loadProjects();
                } catch (err) {
                    console.error('Erreur suppression projet:', err);
                }
            }
        }

        // Soumission formulaire (créer/mettre à jour)
        document.getElementById('project-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('project-id').value;
            const data = {
                name: document.getElementById('name').value,
                description: document.getElementById('description').value,
                business_case: document.getElementById('business_case').value,
                business_case_approved: document.getElementById('business_case_approved').checked,
                pip: document.getElementById('pip').value,
                pip_approved: document.getElementById('pip_approved').checked,
                wbs_number: document.getElementById('wbs_number').value,
                wbs_created: document.getElementById('wbs_created').checked,
                po_launched: document.getElementById('po_launched').checked,
                chantier_date: document.getElementById('chantier_date').value,
                project_phase_completed: document.getElementById('project_phase_completed').checked,
                reception_completed: document.getElementById('reception_completed').checked,
                closure_completed: document.getElementById('closure_completed').checked,
                budget_total: document.getElementById('budget_total').value,
                status: document.getElementById('status').value,
                po_requests: JSON.parse(document.getElementById('po_requests').value || '[]'),
                quotes: JSON.parse(document.getElementById('quotes').value || '[]'),
                gantt_data: JSON.parse(document.getElementById('gantt_data').value || '{}')
                // attachments géré séparément
            };
            try {
                const method = id ? 'PUT' : 'POST';
                const url = id ? `${API_BASE}/${id}` : API_BASE;
                await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                loadProjects();
                document.getElementById('project-form').reset();
                document.getElementById('project-id').value = '';
            } catch (err) {
                console.error('Erreur sauvegarde projet:', err);
            }
        });

        // Upload attachment
        document.getElementById('upload-attachment').addEventListener('click', async () => {
            const id = document.getElementById('project-id').value;
            if (!id) return alert('Sélectionnez un projet à éditer d\'abord');
            const file = document.getElementById('attachment-file').files[0];
            if (!file) return alert('Sélectionnez un fichier');
            const formData = new FormData();
            formData.append('file', file);
            try {
                await fetch(`${API_BASE}/${id}/attachment`, { method: 'POST', body: formData });
                editProject(id); // Recharge attachments
            } catch (err) {
                console.error('Erreur upload:', err);
            }
        });

        // Analyse AI
        document.getElementById('analyze-project').addEventListener('click', async () => {
            const id = document.getElementById('project-id').value;
            if (!id) return alert('Sélectionnez un projet à analyser');
            try {
                const response = await fetch(`${API_BASE}/${id}`);
                const project = await response.json();
                const analysisResponse = await fetch('/api/project-analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ projectData: project })
                });
                const analysis = await analysisResponse.json();
                document.getElementById('analysis-result').innerHTML = `
                    <h3>Analyse AI</h3>
                    <p>Avis: ${analysis.avis}</p>
                    <p>Risques: ${analysis.risques.join(', ')}</p>
                    <p>Score: ${analysis.score}/100</p>
                    <p>Suggestions: ${analysis.suggestions.join(', ')}</p>
                `;
            } catch (err) {
                console.error('Erreur analyse AI:', err);
            }
        });

        // Chargement initial
        loadProjects();
    </script>
</body>
</html>
