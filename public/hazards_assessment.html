<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Évaluation des Risques Électriques - Autonomix Elec</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" media="print" onload="this.media='all'">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" media="print" onload="this.media='all'">
    <style>
        .touch-friendly { min-height: 44px; padding: 0.5rem 1rem; }
        .animate-slide-up { animation: slideUp 0.8s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-zoom-in { animation: zoomIn 0.5s ease-out; }
        @keyframes zoomIn { from { opacity: 0; scale: 0.8; } to { opacity: 1; scale: 1; } }
        table { border-collapse: collapse; width: 100%; }
        table th, table td { border: 1px solid #4B5563; padding: 0.5rem; font-size: 0.875rem; text-align: left; }
        table th { background-color: #374151; color: #FFF; }
        .error-message { color: #ef4444; font-size: 0.875rem; }
        #building-filter, #tableau-filter { font-size: 0.875rem; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #hazards-chart-container { max-width: 800px; margin: 0 auto; }
        #hazards-chart { max-height: 400px; width: 100%; }
        @media (max-width: 640px) {
            table th, table td { font-size: 0.75rem; padding: 0.25rem; }
            .error-message, #building-filter, #tableau-filter { font-size: 0.75rem; }
            #hazards-chart-container { max-width: 100%; }
            #hazards-chart { max-height: 300px; }
        }
        @media (min-width: 640px) {
            table th, table td { font-size: 1rem; }
            .error-message, #building-filter, #tableau-filter { font-size: 1rem; }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <nav class="bg-blue-700 p-4 sticky top-0 z-50 shadow-lg">
        <ul class="flex flex-wrap space-x-6 justify-center text-sm sm:text-base">
            <li><a href="index.html" class="hover:text-yellow-300 transition"><i class="fas fa-home mr-2"></i>Accueil</a></li>
            <li><a href="create.html" class="hover:text-yellow-300 transition"><i class="fas fa-plus-circle mr-2"></i>Créer un tableau</a></li>
            <li><a href="view.html" class="hover:text-yellow-300 transition"><i class="fas fa-table mr-2"></i>Voir les tableaux</a></li>
            <li><a href="selectivity.html" class="hover:text-yellow-300 transition"><i class="fas fa-shield-alt mr-2"></i>Sélectivité</a></li>
            <li><a href="obsolescence.html" class="hover:text-yellow-300 transition"><i class="fas fa-clock mr-2"></i>Obsolescence</a></li>
            <li><a href="fault_level_assessment.html" class="hover:text-yellow-300 transition"><i class="fas fa-bolt mr-2"></i>Évaluation du Niveau de Défaut</a></li>
            <li><a href="hazards_assessment.html" class="text-yellow-300"><i class="fas fa-exclamation-triangle mr-2"></i>Évaluation des Risques</a></li>
            <li><a href="maintenance_org.html" class="hover:text-yellow-300 transition"><i class="fas fa-sitemap mr-2"></i>Organigramme Maintenance</a></li>
            <li><a href="distribution_emergency.html" class="hover:text-yellow-300 transition"><i class="fas fa-plug mr-2"></i>Urgence Distribution</a></li>
            <li><a href="reports.html" class="hover:text-yellow-300 transition"><i class="fas fa-file-alt mr-2"></i>Rapports</a></li>
            <li><a href="electrical_safety_program.html" class="hover:text-yellow-300 transition"><i class="fas fa-hard-hat mr-2"></i>Programme de Sécurité Électrique</a></li>
            <li><a href="breaker_control.html" class="hover:text-yellow-300 transition"><i class="fas fa-cogs mr-2"></i>Contrôle des Disjoncteurs</a></li>
        </ul>
    </nav>

    <div class="container mx-auto p-4 sm:p-6">
        <div id="fallback-message" class="bg-gray-800 p-4 rounded-lg shadow-lg mb-4 sm:mb-6 animate-slide-up hidden">
            <p class="text-gray-300 text-sm sm:text-base">Erreur de chargement. Vérifiez votre connexion ou contactez l'administrateur.</p>
        </div>
        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 sm:mb-6">
            <h1 class="text-2xl sm:text-3xl font-bold flex items-center"><i class="fas fa-exclamation-triangle mr-2 sm:mr-3"></i>Évaluation des Risques Électriques</h1>
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mt-4 sm:mt-0">
                <button onclick="exportToCSV()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 flex items-center touch-friendly">
                    <i class="fas fa-file-csv mr-2"></i>Exporter en CSV
                </button>
                <button onclick="resetFilters()" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 flex items-center touch-friendly">
                    <i class="fas fa-undo mr-2"></i>Réinitialiser le filtre
                </button>
            </div>
        </div>
        <div id="api-error" class="hidden bg-red-900 text-red-200 p-3 rounded mb-4 sm:mb-6 animate-slide-up">
            <p class="text-sm sm:text-base"><i class="fas fa-exclamation-triangle mr-2"></i>Erreur lors du chargement des données. Veuillez réessayer plus tard.</p>
        </div>
        <div id="loading-spinner" class="hidden flex justify-center items-center mb-4 sm:mb-6">
            <div class="spinner"></div>
            <p class="ml-2 text-sm sm:text-base">Chargement des données...</p>
        </div>
        <div id="no-building-selected" class="bg-gray-800 p-4 rounded-lg shadow-lg mb-4 sm:mb-6 animate-slide-up">
            <p class="text-gray-300 text-sm sm:text-base">Veuillez sélectionner un bâtiment pour afficher les données.</p>
        </div>

        <div class="bg-gray-800 p-4 rounded-lg mb-4 sm:mb-6 shadow-lg flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0 animate-slide-up">
            <div>
                <label for="building-filter" class="block text-sm font-medium mb-1">Filtrer par Bâtiment <span class="text-red-600">*</span></label>
                <select id="building-filter" class="mt-1 p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" aria-label="Filtrer par bâtiment" required>
                    <option value="">Sélectionnez un bâtiment</option>
                </select>
            </div>
            <div>
                <label for="tableau-filter" class="block text-sm font-medium mb-1">Filtrer par Tableau</label>
                <select id="tableau-filter" class="mt-1 p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" aria-label="Filtrer par tableau" disabled>
                    <option value="">Tous les tableaux</option>
                </select>
            </div>
        </div>

        <div class="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg mb-4 sm:mb-6 animate-slide-up">
            <h2 class="text-lg sm:text-xl font-semibold mb-4 flex items-center"><i class="fas fa-info-circle mr-2"></i>Comment utiliser cette page</h2>
            <ul class="list-disc pl-6 text-gray-300 text-sm sm:text-base">
                <li>Sélectionnez un bâtiment pour charger les données spécifiques (requis).</li>
                <li>Filtrez par tableau pour analyser les risques électriques d’un tableau spécifique.</li>
                <li>Le tableau liste les disjoncteurs avec les risques potentiels : arc électrique, choc électrique, surchauffe.</li>
                <li>La colonne "Obsolète" indique si le disjoncteur a dépassé sa durée de vie.</li>
                <li>La colonne "Statut Contrôle" montre le dernier statut de contrôle (Conforme, Non conforme, etc.).</li>
                <li>Cliquez sur l’icône <i class="fas fa-eye"></i> pour voir les détails et les recommandations.</li>
                <li>Le graphique à barres montre la répartition des risques par type.</li>
                <li>Les alertes signalent les données manquantes (ex. IP, température, tension, section) nécessaires pour l’évaluation.</li>
                <li>Complétez les données via le panneau latéral pour réduire les risques.</li>
                <li>Vérifiez les conditions environnementales (humidité, température ambiante) pour éviter les risques accrus.</li>
                <li>Cliquez sur "Exporter en CSV" pour télécharger les données des disjoncteurs au format CSV.</li>
                <li>Utilisez "Réinitialiser le filtre" pour revenir à la sélection initiale.</li>
            </ul>
        </div>

        <div id="missing-data-alert" class="hidden bg-red-900 text-red-200 p-3 rounded mb-4 sm:mb-6 flex items-center animate-slide-up">
            <p class="text-sm sm:text-base"><i class="fas fa-exclamation-triangle mr-2"></i>Données manquantes pour certains disjoncteurs (ex. IP, température, tension, section). <a href="#" id="missing-data-link" class="underline">Modifier</a></p>
        </div>

        <div id="no-tableaux-alert" class="hidden bg-gray-800 p-4 rounded-lg shadow-lg mb-4 sm:mb-6 animate-slide-up">
            <p class="text-gray-300 text-sm sm:text-base">Aucun tableau trouvé pour les critères sélectionnés.</p>
        </div>

        <div id="data-section" class="hidden">
            <div class="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg mb-4 sm:mb-6 animate-slide-up">
                <h2 class="text-lg sm:text-xl font-semibold mb-4 flex items-center"><i class="fas fa-table mr-2"></i>Tableau des Risques</h2>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="bg-gray-700">
                                <th class="p-2">Tableau</th>
                                <th class="p-2">Disjoncteur ID</th>
                                <th class="p-2">Marque</th>
                                <th class="p-2">Risque Arc</th>
                                <th class="p-2">Risque Choc</th>
                                <th class="p-2">Risque Surchauffe</th>
                                <th class="p-2">Obsolète</th>
                                <th class="p-2">Statut Contrôle</th>
                                <th class="p-2">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="hazards-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div class="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg mb-4 sm:mb-6 animate-slide-up" id="hazards-chart-container">
                <h2 class="text-lg sm:text-xl font-semibold mb-4 flex items-center"><i class="fas fa-chart-bar mr-2"></i>Répartition des Risques</h2>
                <canvas id="hazards-chart"></canvas>
            </div>
        </div>

        <div id="modal-details" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden" role="dialog" aria-labelledby="modal-title">
            <div class="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-xl max-w-lg w-full animate-zoom-in">
                <h2 class="text-lg sm:text-xl font-semibold mb-4 flex items-center" id="modal-title"><i class="fas fa-info-circle mr-2"></i>Détails du Disjoncteur</h2>
                <div id="modal-content" class="mb-4 text-gray-300 text-sm sm:text-base"></div>
                <div id="modal-error" class="text-red-600 hidden mt-2 text-sm sm:text-base"></div>
                <div id="modal-success" class="text-green-600 hidden mt-2 text-sm sm:text-base"></div>
                <div class="flex space-x-4 mt-4">
                    <button id="save-disjoncteur" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 touch-friendly" aria-label="Enregistrer les modifications"><i class="fas fa-save mr-2"></i>Enregistrer</button>
                    <button id="close-modal" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 touch-friendly" aria-label="Fermer le modal"><i class="fas fa-times mr-2"></i>Fermer</button>
                </div>
            </div>
        </div>

        <div id="popup" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[60] hidden" role="dialog" aria-labelledby="popup-message">
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full animate-slide-up">
                <p id="popup-message" class="mb-4 text-sm sm:text-base"></p>
                <div id="popup-content" class="mb-4"></div>
                <div class="flex space-x-4">
                    <button id="popup-confirm" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 touch-friendly"><i class="fas fa-check mr-2"></i>Confirmer</button>
                    <button id="popup-cancel" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 touch-friendly"><i class="fas fa-times mr-2"></i>Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let tableauxData = [];
        let checklistsData = [];
        let missingData = [];
        let chartInstance = null;
        const currentYear = 2025;
        const validIpValues = ['IP20', 'IP40', 'IP54', 'IP65'];
        let filterDebounceTimeout = null;
        let buildingsCache = null;

        function loadScript(src, async = true) {
            console.log('[Hazards] Chargement script:', src);
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.async = async;
                script.onload = () => {
                    console.log('[Hazards] Script chargé:', src);
                    resolve();
                };
                script.onerror = () => {
                    console.error('[Hazards] Erreur chargement script:', src);
                    reject(new Error(`Échec du chargement de ${src}`));
                };
                document.head.appendChild(script);
            });
        }

        function showPopup(message, content = '', confirmCallback = () => {}) {
            console.log('[Hazards] Affichage pop-up:', message);
            document.getElementById('popup-message').textContent = message;
            document.getElementById('popup-content').innerHTML = content;
            document.getElementById('popup').classList.remove('hidden');
            document.getElementById('popup-confirm').onclick = () => {
                console.log('[Hazards] Pop-up confirmé');
                confirmCallback();
                hidePopup();
            };
            document.getElementById('popup-cancel').onclick = () => {
                console.log('[Hazards] Pop-up annulé');
                hidePopup();
            };
            if (typeof gsap !== 'undefined') {
                gsap.from('#popup > div', { opacity: 0, scale: 0.8, duration: 0.5, ease: 'power2.out' });
            }
        }

        function hidePopup() {
            console.log('[Hazards] Masquage pop-up');
            document.getElementById('popup').classList.add('hidden');
        }

        function cleanNumericValue(value) {
            if (value == null) return null;
            if (typeof value === 'number' && !isNaN(value)) return value;
            if (typeof value !== 'string') return null;
            const match = value.match(/[\d.]+/);
            return match ? parseFloat(match[0]) : null;
        }

        async function loadBuildings() {
            console.log('[Hazards] Chargement des bâtiments');
            if (buildingsCache) {
                console.log('[Hazards] Utilisation du cache des bâtiments');
                return buildingsCache;
            }
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 2000);
                const response = await fetch('/api/fault-level', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
                const data = await response.json();
                buildingsCache = [...new Set(data.data.map(tableau => tableau.building))].sort();
                console.log('[Hazards] Bâtiments chargés:', buildingsCache);
                return buildingsCache;
            } catch (error) {
                console.error('[Hazards] Erreur chargement bâtiments:', error);
                showPopup('Erreur lors du chargement des bâtiments: ' + error.message);
                document.getElementById('fallback-message').classList.remove('hidden');
                return [];
            }
        }

        async function loadTableaux(building, tableauId = null) {
            if (!building) {
                console.warn('[Hazards] Aucun bâtiment spécifié');
                return [];
            }
            console.log('[Hazards] Chargement tableaux pour bâtiment:', building, 'Tableau ID:', tableauId);
            document.getElementById('loading-spinner').classList.remove('hidden');
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 2000);
                const url = tableauId 
                    ? `/api/fault-level?building=${encodeURIComponent(building)}&tableauId=${encodeURIComponent(tableauId)}`
                    : `/api/fault-level?building=${encodeURIComponent(building)}`;
                const [faultLevelResponse, checklistsResponse] = await Promise.all([
                    fetch(url, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' },
                        signal: controller.signal
                    }),
                    fetch(`/api/breaker-checklists?building=${encodeURIComponent(building)}`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' },
                        signal: controller.signal
                    })
                ]);
                clearTimeout(timeoutId);

                if (!faultLevelResponse.ok) throw new Error(`Erreur HTTP (fault-level): ${faultLevelResponse.status}`);
                if (!checklistsResponse.ok) throw new Error(`Erreur HTTP (breaker-checklists): ${checklistsResponse.status}`);

                const faultLevelData = await faultLevelResponse.json();
                checklistsData = await checklistsResponse.json();

                const data = faultLevelData.data.map(tableau => ({
                    ...tableau,
                    disjoncteurs: (tableau.disjoncteurs || []).map(d => ({
                        ...d,
                        id: d.id || d.disjoncteur_id || `unknown_${Math.random().toString(36).substring(2, 9)}`,
                        ip: d.ip || 'IP20',
                        temp: cleanNumericValue(d.temp) || 70,
                        ue: cleanNumericValue(d.ue) || 400,
                        section: cleanNumericValue(d.section) || (d.in ? getRecommendedSection(d.in) : 2.5),
                        humidite: cleanNumericValue(d.humidite) || 50,
                        temp_ambiante: cleanNumericValue(d.temp_ambiante) || 25,
                        date: d.date || null,
                        lifespan: d.lifespan || 30
                    }))
                }));

                console.log('[Hazards] Tableaux chargés:', data.length);
                document.getElementById('loading-spinner').classList.add('hidden');
                document.getElementById('api-error').classList.add('hidden');
                document.getElementById('fallback-message').classList.add('hidden');
                return data;
            } catch (error) {
                console.error('[Hazards] Erreur chargement tableaux:', error);
                showPopup('Erreur lors du chargement des données: ' + error.message);
                document.getElementById('loading-spinner').classList.add('hidden');
                document.getElementById('api-error').classList.remove('hidden');
                document.getElementById('fallback-message').classList.remove('hidden');
                return [];
            }
        }

        function getRecommendedSection(inValue) {
            const inNum = cleanNumericValue(inValue) || 0;
            const sections = [
                { in: 2, section: 1.5 }, { in: 10, section: 1.5 }, { in: 16, section: 2.5 },
                { in: 20, section: 2.5 }, { in: 25, section: 4 }, { in: 32, section: 6 },
                { in: 40, section: 10 }, { in: 50, section: 16 }, { in: 63, section: 25 },
                { in: 80, section: 35 }, { in: 100, section: 50 }, { in: 125, section: 70 },
                { in: 160, section: 95 }, { in: 200, section: 120 }, { in: 250, section: 150 },
                { in: 315, section: 185 }, { in: 400, section: 240 }, { in: 500, section: 300 },
                { in: 630, section: 400 }, { in: 800, section: 500 }, { in: 1000, section: 630 },
                { in: 1250, section: 800 }, { in: 1600, section: 1000 }, { in: 2000, section: 1200 },
                { in: 2500, section: 1600 }
            ];
            for (let i = 0; i < sections.length; i++) {
                if (inNum <= sections[i].in) return sections[i].section;
            }
            return 1600;
        }

        function populateFilters(buildings) {
            console.log('[Hazards] Remplissage des filtres avec', buildings.length, 'bâtiments');
            const buildingFilter = document.getElementById('building-filter');
            const tableauFilter = document.getElementById('tableau-filter');
            if (!buildingFilter || !tableauFilter) {
                console.error('[Hazards] Éléments de filtre non trouvés');
                showPopup('Erreur: Éléments de filtre introuvables.');
                document.getElementById('fallback-message').classList.remove('hidden');
                return;
            }

            buildingFilter.innerHTML = '<option value="">Sélectionnez un bâtiment</option>';
            buildings.forEach(b => {
                const option = document.createElement('option');
                option.value = b;
                option.textContent = b;
                buildingFilter.appendChild(option);
            });

            function updateTableauFilter(selectedBuilding) {
                console.log('[Hazards] Mise à jour filtre tableau pour bâtiment:', selectedBuilding);
                tableauFilter.innerHTML = '<option value="">Tous les tableaux</option>';
                const filteredTableaux = selectedBuilding
                    ? tableauxData.filter(t => t.building === selectedBuilding)
                    : [];
                filteredTableaux.forEach(t => {
                    const option = document.createElement('option');
                    option.value = t.id;
                    option.textContent = t.id;
                    tableauFilter.appendChild(option);
                });
                tableauFilter.disabled = !selectedBuilding || filteredTableaux.length === 0;
            }

            const savedBuilding = localStorage.getItem('selectedBuilding');
            if (savedBuilding && buildings.includes(savedBuilding)) {
                console.log('[Hazards] Restauration bâtiment sauvegardé:', savedBuilding);
                buildingFilter.value = savedBuilding;
                updateTableauFilter(savedBuilding);
                filterData(savedBuilding);
            } else {
                updateTableauFilter('');
                showNoBuildingMessage();
            }

            buildingFilter.onchange = () => {
                const selectedBuilding = buildingFilter.value;
                console.log('[Hazards] Changement bâtiment:', selectedBuilding);
                localStorage.setItem('selectedBuilding', selectedBuilding);
                updateTableauFilter(selectedBuilding);
                if (selectedBuilding) {
                    filterData(selectedBuilding);
                } else {
                    showNoBuildingMessage();
                }
            };

            tableauFilter.onchange = () => {
                console.log('[Hazards] Changement tableau:', tableauFilter.value);
                clearTimeout(filterDebounceTimeout);
                filterDebounceTimeout = setTimeout(() => {
                    filterData(buildingFilter.value);
                }, 500);
            };
        }

        function showNoBuildingMessage() {
            console.log('[Hazards] Affichage message aucun bâtiment sélectionné');
            document.getElementById('no-building-selected').classList.remove('hidden');
            document.getElementById('no-tableaux-alert').classList.add('hidden');
            document.getElementById('data-section').classList.add('hidden');
            document.getElementById('missing-data-alert').classList.add('hidden');
            document.getElementById('fallback-message').classList.add('hidden');
        }

        async function filterData(building) {
            console.log('[Hazards] Filtrage données pour bâtiment:', building);
            if (!building) {
                tableauxData = [];
                checklistsData = [];
                missingData = [];
                showNoBuildingMessage();
                renderHazardsTable([]);
                renderHazardsChart([]);
                updateMissingDataAlert();
                return;
            }

            const tableauFilter = document.getElementById('tableau-filter');
            const tableauId = tableauFilter.value;
            tableauxData = await loadTableaux(building, tableauId);

            let filteredData = tableauxData.filter(t => t.building === building);
            if (tableauId) {
                filteredData = filteredData.filter(t => t.id === tableauId);
            }

            if (filteredData.length === 0) {
                console.log('[Hazards] Aucun tableau trouvé pour les critères');
                document.getElementById('no-building-selected').classList.add('hidden');
                document.getElementById('no-tableaux-alert').classList.remove('hidden');
                document.getElementById('data-section').classList.add('hidden');
                document.getElementById('missing-data-alert').classList.add('hidden');
                renderHazardsTable([]);
                renderHazardsChart([]);
                updateMissingDataAlert();
                showPopup('Aucun tableau trouvé pour les critères sélectionnés.');
                return;
            }

            missingData = filteredData.flatMap(t =>
                t.disjoncteurs.filter(d => !d.ip || d.temp === null || d.ue === null || d.section === null)
                    .map(d => ({ tableauId: t.id, disjoncteurId: d.id }))
            );

            console.log('[Hazards] Données filtrées:', filteredData.length, 'tableaux,', missingData.length, 'données manquantes');
            document.getElementById('no-building-selected').classList.add('hidden');
            document.getElementById('no-tableaux-alert').classList.add('hidden');
            document.getElementById('data-section').classList.remove('hidden');
            try {
                await loadScript('https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js').catch(() => console.warn('[Hazards] Échec chargement Chart.js'));
                await loadScript('https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js').catch(() => console.warn('[Hazards] Échec chargement GSAP'));
            } catch (error) {
                console.error('[Hazards] Erreur chargement scripts:', error);
            }
            renderHazardsTable(filteredData);
            renderHazardsChart(filteredData);
            updateMissingDataAlert();
        }

        function resetFilters() {
            console.log('[Hazards] Réinitialisation filtres');
            localStorage.removeItem('selectedBuilding');
            const buildingFilter = document.getElementById('building-filter');
            const tableauFilter = document.getElementById('tableau-filter');
            if (buildingFilter && tableauFilter) {
                buildingFilter.value = '';
                tableauFilter.value = '';
                tableauFilter.disabled = true;
            }
            tableauxData = [];
            checklistsData = [];
            missingData = [];
            showNoBuildingMessage();
            renderHazardsTable([]);
            renderHazardsChart([]);
            updateMissingDataAlert();
        }

        function exportToCSV() {
            console.log('[Hazards] Exportation CSV');
            if (!tableauxData.length) {
                showPopup('Aucune donnée à exporter. Veuillez sélectionner un bâtiment.');
                return;
            }

            const headers = [
                'Tableau_ID', 'Bâtiment', 'Disjoncteur_ID', 'Marque', 'Risque_Arc', 'Risque_Choc',
                'Risque_Surchauffe', 'Obsolète', 'Statut_Contrôle', 'Date_Dernier_Contrôle',
                'IP', 'Température_Limite_C', 'Tension_Nominale_V', 'Section_Cable_mm2',
                'Humidité_Ambiante_Pourcentage', 'Température_Ambiante_C'
            ];
            const rows = [];

            tableauxData.forEach(tableau => {
                tableau.disjoncteurs.forEach(disjoncteur => {
                    const risks = evaluateRisks(disjoncteur);
                    const isObsoleteStatus = isObsolete(disjoncteur);
                    const latestCheck = getLatestCheckStatus(tableau.id, disjoncteur.id);
                    rows.push([
                        tableau.id,
                        tableau.building,
                        disjoncteur.id || 'N/A',
                        disjoncteur.marque || 'N/A',
                        risks.arc,
                        risks.choc,
                        risks.surchauffe,
                        isObsoleteStatus ? 'Oui' : 'Non',
                        latestCheck.status || 'Non contrôlé',
                        latestCheck.timestamp ? new Date(latestCheck.timestamp).toLocaleDateString('fr-FR') : 'N/A',
                        disjoncteur.ip || 'N/A',
                        disjoncteur.temp || 'N/A',
                        disjoncteur.ue || 'N/A',
                        disjoncteur.section || 'N/A',
                        disjoncteur.humidite || 'N/A',
                        disjoncteur.temp_ambiante || 'N/A'
                    ]);
                });
            });

            const csvContent = [
                headers.map(h => `"${h}"`).join(','),
                ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `risques_electriques_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            console.log('[Hazards] CSV exporté');
        }

        function isObsolete(disjoncteur) {
            if (!disjoncteur.date || !disjoncteur.lifespan) return false;
            const manufactureYear = new Date(disjoncteur.date).getFullYear();
            if (isNaN(manufactureYear)) return false;
            const lifespan = parseInt(disjoncteur.lifespan) || 30;
            return (currentYear - manufactureYear) >= lifespan;
        }

        function evaluateRisks(disjoncteur) {
            const risks = { arc: 'Faible', choc: 'Faible', surchauffe: 'Faible' };
            if (disjoncteur.ik && disjoncteur.icn && disjoncteur.ik > disjoncteur.icn * 0.9) {
                risks.arc = disjoncteur.ik > disjoncteur.icn * 1.2 ? 'Élevé' : 'Moyen';
            }
            if (!disjoncteur.ip || disjoncteur.ip === 'IP20') {
                risks.choc = 'Moyen';
            }
            if (disjoncteur.ip === 'IP40' && disjoncteur.humidite > 70) {
                risks.choc = 'Moyen';
            }
            if (disjoncteur.humidite && parseFloat(disjoncteur.humidite) > 80) {
                risks.choc = 'Élevé';
            }
            if (disjoncteur.temp && parseFloat(disjoncteur.temp) > 80) {
                risks.surchauffe = 'Élevé';
            } else if (disjoncteur.temp && parseFloat(disjoncteur.temp) > 60) {
                risks.surchauffe = 'Moyen';
            }
            if (disjoncteur.temp_ambiante && parseFloat(disjoncteur.temp_ambiante) > 40) {
                risks.surchauffe = 'Moyen';
            }
            return risks;
        }

        function getLatestCheckStatus(tableauId, disjoncteurId) {
            const latestCheck = checklistsData
                .filter(c => c.tableau_id === tableauId && c.disjoncteur_id === disjoncteurId)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
            if (!latestCheck) return { status: null, timestamp: null };
            let points = [];
            try {
                const comment = latestCheck.comment.startsWith('Checklist vide: ')
                    ? latestCheck.comment.replace('Checklist vide: ', '')
                    : latestCheck.comment;
                points = JSON.parse(comment).points || [];
            } catch (e) {
                points = [];
            }
            const isPending = latestCheck.status === 'Non applicable' && points.every(p => !p.status);
            return {
                status: isPending ? 'En attente' : latestCheck.status,
                timestamp: latestCheck.timestamp
            };
        }

        function renderHazardsTable(data) {
            console.log('[Hazards] Rendu tableau des risques:', data.length, 'tableaux');
            const tbody = document.getElementById('hazards-table-body');
            if (!tbody) {
                console.error('[Hazards] Tableau body non trouvé');
                return;
            }
            tbody.innerHTML = '';
            const fragment = document.createDocumentFragment();
            data.forEach(tableau => {
                tableau.disjoncteurs.forEach(disjoncteur => {
                    const risks = evaluateRisks(disjoncteur);
                    const isObsoleteStatus = isObsolete(disjoncteur);
                    const latestCheck = getLatestCheckStatus(tableau.id, disjoncteur.id);
                    const statusClass = latestCheck.status === 'Conforme' ? 'text-green-600' :
                                       latestCheck.status === 'Non conforme' ? 'text-red-600' :
                                       latestCheck.status === 'Non applicable' ? 'text-yellow-600' :
                                       latestCheck.status === 'En attente' ? 'text-purple-600' :
                                       'text-gray-600';
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="p-2">${tableau.id}</td>
                        <td class="p-2">${disjoncteur.id}</td>
                        <td class="p-2">${disjoncteur.marque || 'Inconnu'}</td>
                        <td class="p-2 ${risks.arc === 'Élevé' ? 'text-red-600' : risks.arc === 'Moyen' ? 'text-yellow-400' : 'text-green-600'}">${risks.arc}</td>
                        <td class="p-2 ${risks.choc === 'Élevé' ? 'text-red-600' : risks.choc === 'Moyen' ? 'text-yellow-400' : 'text-green-600'}">${risks.choc}</td>
                        <td class="p-2 ${risks.surchauffe === 'Élevé' ? 'text-red-600' : risks.surchauffe === 'Moyen' ? 'text-yellow-400' : 'text-green-600'}">${risks.surchauffe}</td>
                        <td class="p-2 ${isObsoleteStatus ? 'text-red-600' : 'text-green-600'}">${isObsoleteStatus ? 'Oui' : 'Non'}</td>
                        <td class="p-2 ${statusClass}">${latestCheck.status || 'Non contrôlé'}</td>
                        <td class="p-2">
                            <button class="action-btn text-blue-400 hover:text-blue-600 touch-friendly" data-tableau-id="${encodeURIComponent(tableau.id)}" data-disjoncteur-id="${encodeURIComponent(disjoncteur.id)}"><i class="fas fa-eye"></i></button>
                        </td>
                    `;
                    fragment.appendChild(tr);
                });
            });
            tbody.appendChild(fragment);
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tableauId = decodeURIComponent(btn.dataset.tableauId);
                    const disjoncteurId = decodeURIComponent(btn.dataset.disjoncteurId);
                    console.log('[Hazards] Clic action:', { tableauId, disjoncteurId });
                    openModal(tableauId, disjoncteurId);
                });
            });
            if (typeof gsap !== 'undefined') {
                gsap.from('tr', { opacity: 0, y: 20, duration: 0.5, stagger: 0.05 });
            }
        }

        function renderHazardsChart(data) {
            console.log('[Hazards] Rendu graphique des risques');
            const canvas = document.getElementById('hazards-chart');
            const container = document.getElementById('hazards-chart-container');
            if (!canvas || !container) {
                console.error('[Hazards] Canvas ou conteneur hazards-chart non trouvé');
                showPopup('Erreur: Élément de graphique non trouvé.');
                return;
            }

            if (chartInstance) {
                chartInstance.destroy();
                console.log('[Hazards] Ancien graphique détruit');
            }

            const counts = { arc: { faible: 0, moyen: 0, élevé: 0 }, choc: { faible: 0, moyen: 0, élevé: 0 }, surchauffe: { faible: 0, moyen: 0, élevé: 0 } };
            data.forEach(tableau => {
                tableau.disjoncteurs.forEach(disjoncteur => {
                    const risks = evaluateRisks(disjoncteur);
                    counts.arc[risks.arc.toLowerCase()]++;
                    counts.choc[risks.choc.toLowerCase()]++;
                    counts.surchauffe[risks.surchauffe.toLowerCase()]++;
                });
            });

            if (Object.values(counts).every(type => Object.values(type).every(v => v === 0))) {
                console.log('[Hazards] Aucune donnée pour le graphique');
                const existingError = container.querySelector('.error-message');
                if (!existingError) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'text-red-600 mt-2 error-message';
                    errorDiv.textContent = 'Aucune donnée valide pour afficher le graphique.';
                    container.appendChild(errorDiv);
                }
                return;
            }

            const existingError = container.querySelector('.error-message');
            if (existingError) existingError.remove();

            if (typeof Chart !== 'undefined') {
                try {
                    chartInstance = new Chart(canvas.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: ['Arc Électrique', 'Choc Électrique', 'Surchauffe'],
                            datasets: [
                                { label: 'Faible', data: [counts.arc.faible, counts.choc.faible, counts.surchauffe.faible], backgroundColor: '#22c55e' },
                                { label: 'Moyen', data: [counts.arc.moyen, counts.choc.moyen, counts.surchauffe.moyen], backgroundColor: '#f4b400' },
                                { label: 'Élevé', data: [counts.arc.élevé, counts.choc.élevé, counts.surchauffe.élevé], backgroundColor: '#dc2626' }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            animation: {
                                duration: 1500,
                                easing: 'easeOutBounce'
                            },
                            scales: {
                                y: { 
                                    beginAtZero: true, 
                                    title: { display: true, text: 'Nombre de Disjoncteurs', color: '#FFF', font: { size: 12 } }, 
                                    ticks: { color: '#FFF', font: { size: 10 } },
                                    grid: { color: '#4B5563' }
                                },
                                x: { 
                                    title: { display: true, text: 'Type de Risque', color: '#FFF', font: { size: 12 } }, 
                                    ticks: { color: '#FFF', font: { size: 10 } },
                                    grid: { display: false }
                                }
                            },
                            plugins: { 
                                legend: { position: 'top', labels: { color: '#FFF', font: { size: 12 } } },
                                tooltip: { 
                                    backgroundColor: '#1F2937', 
                                    titleColor: '#FFF', 
                                    bodyColor: '#FFF',
                                    callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y}` }
                                }
                            }
                        }
                    });
                    console.log('[Hazards] Graphique rendu');
                    if (typeof gsap !== 'undefined') {
                        gsap.from('#hazards-chart-container', { opacity: 0, y: 20, duration: 1, ease: 'power2.out' });
                    }
                } catch (error) {
                    console.error('[Hazards] Erreur rendu graphique:', error);
                    showPopup('Erreur lors du rendu du graphique.');
                }
            } else {
                console.warn('[Hazards] Chart.js non disponible');
                showPopup('Erreur: Chart.js non chargé.');
            }
        }

        function updateMissingDataAlert() {
            console.log('[Hazards] Mise à jour alerte données manquantes:', missingData.length);
            const alert = document.getElementById('missing-data-alert');
            const link = document.getElementById('missing-data-link');
            if (missingData.length > 0) {
                alert.classList.remove('hidden');
                link.onclick = () => {
                    const { tableauId, disjoncteurId } = missingData[0];
                    console.log('[Hazards] Clic lien données manquantes:', { tableauId, disjoncteurId });
                    openModal(tableauId, disjoncteurId);
                };
            } else {
                alert.classList.add('hidden');
            }
        }

        function openModal(tableauId, disjoncteurId) {
            console.log('[Hazards] Ouverture modal:', { tableauId, disjoncteurId });
            const modal = document.getElementById('modal-details');
            if (!modal) {
                console.error('[Hazards] Modal non trouvé');
                showPopup('Erreur: Modal non trouvé.');
                return;
            }
            const tableau = tableauxData.find(t => t.id === tableauId);
            if (!tableau) {
                console.error('[Hazards] Tableau non trouvé:', tableauId);
                showPopup('Erreur: Tableau non trouvé.');
                return;
            }
            const disjoncteur = tableau.disjoncteurs.find(d => d.id === disjoncteurId);
            if (!disjoncteur) {
                console.error('[Hazards] Disjoncteur non trouvé:', disjoncteurId);
                showPopup('Erreur: Disjoncteur non trouvé.');
                return;
            }
            const risks = evaluateRisks(disjoncteur);
            const isObsoleteStatus = isObsolete(disjoncteur);
            const content = `
                <p class="text-sm sm:text-base"><strong>Tableau :</strong> ${tableauId}</p>
                <p class="text-sm sm:text-base"><strong>Disjoncteur :</strong> ${disjoncteur.id}</p>
                <p class="text-sm sm:text-base"><strong>Bâtiment :</strong> ${tableau.building}</p>
                <p class="text-sm sm:text-base"><strong>Risque Arc Électrique :</strong> ${risks.arc}</p>
                <p class="text-sm sm:text-base"><strong>Risque Choc Électrique :</strong> ${risks.choc}</p>
                <p class="text-sm sm:text-base"><strong>Risque Surchauffe :</strong> ${risks.surchauffe}</p>
                <p class="text-sm sm:text-base"><strong>Obsolète :</strong> ${isObsoleteStatus ? 'Oui' : 'Non'}</p>
                <h3 class="text-lg font-semibold mt-4">Recommandations :</h3>
                <ul class="list-disc pl-6 text-sm sm:text-base">
                    ${risks.arc === 'Élevé' ? '<li>Remplacer le disjoncteur par un modèle avec un pouvoir de coupure (Icn) supérieur au courant de court-circuit (Ik).</li>' : risks.arc === 'Moyen' ? '<li>Vérifier si le pouvoir de coupure (Icn) est suffisant pour le courant de court-circuit (Ik).</li>' : ''}
                    ${risks.choc === 'Moyen' || risks.choc === 'Élevé' ? '<li>Améliorer l’indice de protection (ex. IP40 ou IP54 pour environnements humides ou poussiéreux).</li>' : ''}
                    ${risks.choc === 'Élevé' && disjoncteur.humidite > 80 ? '<li>Réduire l’humidité ambiante ou installer un boîtier étanche (ex. IP65).</li>' : ''}
                    ${risks.surchauffe === 'Élevé' ? '<li>Vérifier la ventilation ou réduire la charge électrique.</li>' : risks.surchauffe === 'Moyen' ? '<li>Surveiller la température et envisager une meilleure ventilation.</li>' : ''}
                    ${risks.surchauffe === 'Moyen' && disjoncteur.temp_ambiante > 40 ? '<li>Améliorer le refroidissement ou déplacer l’équipement dans un environnement plus frais.</li>' : ''}
                    ${isObsoleteStatus ? '<li>Planifier le remplacement du disjoncteur obsolète pour éviter les défaillances.</li>' : ''}
                </ul>
                <h3 class="text-lg font-semibold mt-4">Modifier les données :</h3>
                <div class="mb-4">
                    <label for="ip-input" class="block text-sm font-medium">Indice de protection (IP):</label>
                    <input id="ip-input" type="text" value="${disjoncteur.ip || ''}" class="mt-1 p-2 rounded bg-gray-700 text-white border-gray-600 w-full text-sm sm:text-base" placeholder="Ex. IP40" aria-label="Indice de protection">
                </div>
                <div class="mb-4">
                    <label for="temp-input" class="block text-sm font-medium">Température limite (°C):</label>
                    <input id="temp-input" type="number" step="0.1" value="${disjoncteur.temp || ''}" class="mt-1 p-2 rounded bg-gray-700 text-white border-gray-600 w-full text-sm sm:text-base" placeholder="Ex. 70" aria-label="Température limite">
                </div>
                <div class="mb-4">
                    <label for="ue-input" class="block text-sm font-medium">Tension nominale (V):</label>
                    <input id="ue-input" type="number" step="0.1" value="${disjoncteur.ue || ''}" class="mt-1 p-2 rounded bg-gray-700 text-white border-gray-600 w-full text-sm sm:text-base" placeholder="Ex. 400" aria-label="Tension nominale">
                </div>
                <div class="mb-4">
                    <label for="section-input" class="block text-sm font-medium">Section du câble (mm²):</label>
                    <input id="section-input" type="number" step="0.1" value="${disjoncteur.section || ''}" class="mt-1 p-2 rounded bg-gray-700 text-white border-gray-600 w-full text-sm sm:text-base" placeholder="Ex. 2.5" aria-label="Section du câble">
                </div>
                <div class="mb-4">
                    <label for="humidite-input" class="block text-sm font-medium">Humidité ambiante (%):</label>
                    <input id="humidite-input" type="number" step="0.1" value="${disjoncteur.humidite || ''}" class="mt-1 p-2 rounded bg-gray-700 text-white border-gray-600 w-full text-sm sm:text-base" placeholder="Ex. 60" aria-label="Humidité ambiante">
                </div>
                <div class="mb-4">
                    <label for="temp_ambiante-input" class="block text-sm font-medium">Température ambiante (°C):</label>
                    <input id="temp_ambiante-input" type="number" step="0.1" value="${disjoncteur.temp_ambiante || ''}" class="mt-1 p-2 rounded bg-gray-700 text-white border-gray-600 w-full text-sm sm:text-base" placeholder="Ex. 25" aria-label="Température ambiante">
                </div>
            `;
            document.getElementById('modal-content').innerHTML = content;
            document.getElementById('modal-error').classList.add('hidden');
            document.getElementById('modal-success').classList.add('hidden');
            modal.classList.remove('hidden');

            document.getElementById('save-disjoncteur').onclick = async () => {
                console.log('[Hazards] Enregistrement données disjoncteur:', { tableauId, disjoncteurId });
                const ip = document.getElementById('ip-input').value.trim();
                const temp = document.getElementById('temp-input').value.trim();
                const ue = document.getElementById('ue-input').value.trim();
                const section = document.getElementById('section-input').value.trim();
                const humidite = document.getElementById('humidite-input').value.trim();
                const temp_ambiante = document.getElementById('temp_ambiante-input').value.trim();

                if (ip && !validIpValues.includes(ip)) {
                    document.getElementById('modal-error').classList.remove('hidden');
                    document.getElementById('modal-error').textContent = 'Indice de protection invalide. Valeurs acceptées : IP20, IP40, IP54, IP65.';
                    document.getElementById('modal-success').classList.add('hidden');
                    return;
                }
                if (temp && (isNaN(parseFloat(temp)) || parseFloat(temp) < 0)) {
                    document.getElementById('modal-error').classList.remove('hidden');
                    document.getElementById('modal-error').textContent = 'La température doit être une valeur numérique positive (ex. 70).';
                    document.getElementById('modal-success').classList.add('hidden');
                    return;
                }
                if (ue && (isNaN(parseFloat(ue)) || parseFloat(ue) < 0)) {
                    document.getElementById('modal-error').classList.remove('hidden');
                    document.getElementById('modal-error').textContent = 'La tension nominale doit être une valeur numérique positive (ex. 400).';
                    document.getElementById('modal-success').classList.add('hidden');
                    return;
                }
                if (section && (isNaN(parseFloat(section)) || parseFloat(section) < 0)) {
                    document.getElementById('modal-error').classList.remove('hidden');
                    document.getElementById('modal-error').textContent = 'La section du câble doit être une valeur numérique positive (ex. 2.5).';
                    document.getElementById('modal-success').classList.add('hidden');
                    return;
                }
                if (humidite && (isNaN(parseFloat(humidite)) || parseFloat(humidite) < 0 || parseFloat(humidite) > 100)) {
                    document.getElementById('modal-error').classList.remove('hidden');
                    document.getElementById('modal-error').textContent = 'L’humidité doit être une valeur numérique entre 0 et 100 (ex. 60).';
                    document.getElementById('modal-success').classList.add('hidden');
                    return;
                }
                if (temp_ambiante && (isNaN(parseFloat(temp_ambiante)) || parseFloat(temp_ambiante) < -20 || parseFloat(temp_ambiante) > 60)) {
                    document.getElementById('modal-error').classList.remove('hidden');
                    document.getElementById('modal-error').textContent = 'La température ambiante doit être une valeur numérique entre -20 et 60 (ex. 25).';
                    document.getElementById('modal-success').classList.add('hidden');
                    return;
                }

                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 2000);
                    const response = await fetch(`/api/disjoncteur/${encodeURIComponent(tableauId)}/${encodeURIComponent(disjoncteurId)}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ip: ip || null,
                            temp: temp ? parseFloat(temp) : null,
                            ue: ue || null,
                            section: section ? parseFloat(section) : null,
                            humidite: humidite ? parseFloat(humidite) : null,
                            temp_ambiante: temp_ambiante ? parseFloat(temp_ambiante) : null
                        }),
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    if (!response.ok) {
                        const responseData = await response.json().catch(() => ({}));
                        throw new Error(responseData.error || `Erreur HTTP: ${response.status}`);
                    }
                    console.log('[Hazards] Données disjoncteur mises à jour');
                    document.getElementById('modal-error').classList.add('hidden');
                    document.getElementById('modal-success').classList.remove('hidden');
                    document.getElementById('modal-success').textContent = 'Données mises à jour avec succès !';
                    await filterData(document.getElementById('building-filter').value);
                    if (typeof gsap !== 'undefined') {
                        gsap.to('#modal-details', {
                            opacity: 0,
                            scale: 0.8,
                            duration: 0.5,
                            ease: 'power2.out',
                            onComplete: () => modal.classList.add('hidden')
                        });
                    } else {
                        modal.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('[Hazards] Erreur mise à jour disjoncteur:', error);
                    document.getElementById('modal-error').classList.remove('hidden');
                    document.getElementById('modal-error').textContent = 'Erreur : ' + error.message;
                    document.getElementById('modal-success').classList.add('hidden');
                }
            };

            document.getElementById('close-modal').onclick = () => {
                console.log('[Hazards] Fermeture modal');
                if (typeof gsap !== 'undefined') {
                    gsap.to('#modal-details', {
                        opacity: 0,
                        scale: 0.8,
                        duration: 0.5,
                        ease: 'power2.out',
                        onComplete: () => modal.classList.add('hidden')
                    });
                } else {
                    modal.classList.add('hidden');
                }
            };
        }

        window.onload = async () => {
            console.log('[Hazards] Initialisation page hazards_assessment à', new Date().toLocaleString('fr-FR'));
            try {
                if (window.location.protocol === 'file:') {
                    console.error('[Hazards] Page exécutée en mode fichier');
                    showPopup('Erreur : Veuillez exécuter cette page via un serveur web.');
                    document.getElementById('fallback-message').classList.remove('hidden');
                    return;
                }

                const modal = document.getElementById('modal-details');
                const popup = document.getElementById('popup');
                if (modal) modal.classList.add('hidden');
                if (popup) popup.classList.add('hidden');
                document.getElementById('data-section').classList.add('hidden');
                document.getElementById('fallback-message').classList.add('hidden');

                const buildings = await loadBuildings();
                if (buildings.length) {
                    console.log('[Hazards] Bâtiments disponibles:', buildings.length);
                    populateFilters(buildings);
                } else {
                    console.warn('[Hazards] Aucun bâtiment disponible');
                    showPopup('Aucun bâtiment disponible.');
                    showNoBuildingMessage();
                    document.getElementById('fallback-message').classList.remove('hidden');
                }
            } catch (error) {
                console.error('[Hazards] Erreur initialisation:', error);
                showPopup('Erreur lors de l’initialisation de la page: ' + error.message);
                document.getElementById('fallback-message').classList.remove('hidden');
            }
        };
    </script>
</body>
</html>