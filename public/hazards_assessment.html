<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Évaluation des Risques Électriques - Autonomix Elec</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
</head>
<body class="bg-gray-900 text-white">
    <nav class="bg-blue-700 p-4 sticky top-0 z-50 shadow-lg">
        <ul class="flex space-x-6 text-white font-semibold">
            <li><a href="index.html" class="hover:text-yellow-300 transition"><i class="fas fa-home mr-2"></i>Accueil</a></li>
            <li><a href="create.html" class="hover:text-yellow-300 transition"><i class="fas fa-plus-circle mr-2"></i>Créer un tableau</a></li>
            <li><a href="view.html" class="hover:text-yellow-300 transition"><i class="fas fa-table mr-2"></i>Voir les tableaux</a></li>
            <li><a href="selectivity.html" class="hover:text-yellow-300 transition"><i class="fas fa-shield-alt mr-2"></i>Sélectivité</a></li>
            <li><a href="obsolescence.html" class="hover:text-yellow-300 transition"><i class="fas fa-clock mr-2"></i>Obsolescence</a></li>
            <li><a href="fault_level_assessment.html" class="hover:text-yellow-300 transition"><i class="fas fa-bolt mr-2"></i>Évaluation du Niveau de Défaut</a></li>
            <li><a href="hazards_assessment.html" class="text-yellow-300"><i class="fas fa-exclamation-triangle mr-2"></i>Évaluation des Risques</a></li>
            <li><a href="maintenance_chart.html" class="hover:text-yellow-300 transition"><i class="fas fa-sitemap mr-2"></i>Organigramme Maintenance</a></li>
            <li><a href="distribution_emergency.html" class="hover:text-yellow-300 transition"><i class="fas fa-siren mr-2"></i>Urgence Distribution</a></li>
            <li><a href="reports.html" class="hover:text-yellow-300 transition"><i class="fas fa-file-pdf mr-2"></i>Rapports</a></li>
        </ul>
    </nav>

    <div class="container mx-auto p-6">
        <h1 class="text-3xl font-bold mb-6 flex items-center"><i class="fas fa-exclamation-triangle mr-3"></i>Évaluation des Risques Électriques</h1>
        <div id="api-error" class="hidden bg-red-900 text-red-200 p-3 rounded mb-6">
            <p><i class="fas fa-exclamation-triangle mr-2"></i>Erreur lors du chargement des données. Veuillez réessayer plus tard.</p>
        </div>

        <!-- Filtres -->
        <div class="bg-gray-800 p-4 rounded-lg mb-6 shadow-lg flex space-x-4">
            <div>
                <label for="building-filter" class="block text-sm font-medium">Filtrer par Bâtiment</label>
                <select id="building-filter" class="mt-1 p-2 rounded bg-gray-700 text-white border-gray-600">
                    <option value="">Tous les bâtiments</option>
                </select>
            </div>
            <div>
                <label for="tableau-filter" class="block text-sm font-medium">Filtrer par Tableau</label>
                <select id="tableau-filter" class="mt-1 p-2 rounded bg-gray-700 text-white border-gray-600">
                    <option value="">Tous les tableaux</option>
                </select>
            </div>
        </div>

        <!-- Instructions -->
        <div class="bg-gray-800 p-4 rounded-lg mb-6 shadow-lg animate-slide-up">
            <h2 class="text-xl font-semibold mb-2 flex items-center"><i class="fas fa-info-circle mr-2"></i>Comment utiliser cette page</h2>
            <ul class="list-disc pl-6 text-gray-300">
                <li>Filtrez par bâtiment ou tableau pour analyser les risques électriques spécifiques.</li>
                <li>Le tableau liste les disjoncteurs avec les risques potentiels : arc électrique, choc électrique, surchauffe.</li>
                <li>La colonne "Obsolète" indique si le disjoncteur a dépassé sa durée de vie.</li>
                <li>Cliquez sur l’icône <i class="fas fa-eye"></i> pour voir les détails et les recommandations.</li>
                <li>Le graphique à barres montre la répartition des risques par type.</li>
                <li>Les alertes signalent les données manquantes (ex. IP, température, tension, section) nécessaires pour l’évaluation.</li>
                <li>Complétez les données via le panneau latéral pour réduire les risques.</li>
                <li>Vérifiez les conditions environnementales (humidité, température ambiante) pour éviter les risques accrus.</li>
            </ul>
        </div>

        <!-- Alertes -->
        <div id="missing-data-alert" class="hidden bg-red-900 text-red-200 p-3 rounded mb-4 flex items-center">
            <p><i class="fas fa-exclamation-triangle mr-2"></i>Données manquantes pour certains disjoncteurs (ex. IP, température, tension, section). <a href="#" id="missing-data-link" class="underline">Modifier</a></p>
        </div>

        <!-- Tableau des Risques -->
        <div class="bg-gray-800 p-4 rounded-lg mb-6 shadow-lg animate-slide-up">
            <h2 class="text-xl font-semibold mb-2 flex items-center"><i class="fas fa-table mr-2"></i>Tableau des Risques</h2>
            <table class="w-full border-collapse">
                <thead>
                    <tr class="bg-gray-700">
                        <th class="border border-gray-600 p-2">Tableau</th>
                        <th class="border border-gray-600 p-2">Disjoncteur ID</th>
                        <th class="border border-gray-600 p-2">Marque</th>
                        <th class="border border-gray-600 p-2">Risque Arc</th>
                        <th class="border border-gray-600 p-2">Risque Choc</th>
                        <th class="border border-gray-600 p-2">Risque Surchauffe</th>
                        <th class="border border-gray-600 p-2">Obsolète</th>
                        <th class="border border-gray-600 p-2">Actions</th>
                    </tr>
                </thead>
                <tbody id="hazards-table-body"></tbody>
            </table>
        </div>

        <!-- Graphique des Risques -->
        <div class="bg-gray-800 p-4 rounded-lg mb-6 shadow-lg animate-slide-up">
            <h2 class="text-xl font-semibold mb-2 flex items-center"><i class="fas fa-chart-bar mr-2"></i>Répartition des Risques</h2>
            <canvas id="hazards-chart" class="w-full h-96"></canvas>
        </div>

        <!-- Modal Détails -->
        <div id="modal-details" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-lg w-full animate-zoom-in">
                <h2 class="text-xl font-semibold mb-4 flex items-center"><i class="fas fa-info-circle mr-2"></i>Détails du Disjoncteur</h2>
                <div id="modal-content" class="mb-4 text-gray-300"></div>
                <div class="flex space-x-4">
                    <button id="save-disjoncteur" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition"><i class="fas fa-save mr-2"></i>Enregistrer</button>
                    <button id="close-modal" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 transition"><i class="fas fa-times mr-2"></i>Fermer</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let tableauxData = [];
        let missingData = [];
        let chartInstance = null;
        const currentYear = 2025;
        const validIpValues = ['IP20', 'IP40', 'IP54', 'IP65'];

        // Nettoyer les valeurs pour extraire les nombres
        function cleanNumericValue(value) {
            if (value === null || value === undefined) return '';
            if (typeof value === 'number' && !isNaN(value)) return value;
            if (typeof value !== 'string') return '';
            const match = value.match(/[\d.]+/);
            return match ? parseFloat(match[0]) : '';
        }

        // Charger les données
        async function loadTableaux() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 2000);
                const response = await fetch('/api/fault-level', {
                    method: 'GET',
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                const responseData = await response.json();
                if (!response.ok) throw new Error(responseData.error || 'Erreur lors du chargement');

                // Appliquer des valeurs par défaut aux champs manquants
                tableauxData = responseData.data.map(tableau => ({
                    ...tableau,
                    disjoncteurs: tableau.disjoncteurs.map(d => ({
                        ...d,
                        ip: d.ip || 'IP20',
                        temp: cleanNumericValue(d.temp) || 70,
                        ue: cleanNumericValue(d.ue) || 400,
                        section: cleanNumericValue(d.section) || (d.in ? getRecommendedSection(d.in) : 2.5),
                        humidite: d.humidite || 50,
                        temp_ambiante: d.temp_ambiante || 25
                    }))
                }));

                missingData = tableauxData.flatMap(t => t.disjoncteurs.filter(d => !d.ip || !d.temp || !d.ue || !d.section).map(d => ({ tableauId: t.id, disjoncteurId: d.id })));
                console.log('[Client] Données chargées:', tableauxData, 'Données manquantes:', missingData);
                document.getElementById('api-error').classList.add('hidden');
                populateFilters();
                renderHazardsTable();
                renderHazardsChart();
                updateMissingDataAlert();
            } catch (error) {
                console.error('[Client] Erreur chargement:', error);
                document.getElementById('api-error').classList.remove('hidden');
                tableauxData = [];
                missingData = [];
                renderHazardsTable();
                renderHazardsChart();
                updateMissingDataAlert();
            }
        }

        // Fonction pour obtenir la section recommandée (simplifiée côté client)
        function getRecommendedSection(inValue) {
            const inNum = parseFloat(inValue?.match(/[\d.]+/)?.[0]) || 0;
            const sections = [
                { in: 2, section: 1.5 }, { in: 10, section: 1.5 }, { in: 16, section: 2.5 },
                { in: 20, section: 2.5 }, { in: 25, section: 4 }, { in: 32, section: 6 },
                { in: 40, section: 10 }, { in: 50, section: 16 }, { in: 63, section: 25 },
                { in: 80, section: 35 }, { in: 100, section: 50 }, { in: 125, section: 70 },
                { in: 160, section: 95 }, { in: 200, section: 120 }, { in: 250, section: 150 },
                { in: 315, section: 185 }, { in: 400, section: 240 }, { in: 500, section: 300 },
                { in: 630, section: 400 }, { in: 800, section: 500 }, { in: 1000, section: 630 },
                { in: 1250, section: 800 }, { in: 1600, section: 1000 }, { in: 2000, section: 1200 },
                { in: 2500, section: 1600 }
            ];
            for (let i = 0; i < sections.length; i++) {
                if (inNum <= sections[i].in) return sections[i].section;
            }
            return 1600;
        }

        // Remplir les filtres
        function populateFilters() {
            const buildingFilter = document.getElementById('building-filter');
            const tableauFilter = document.getElementById('tableau-filter');
            const buildings = [...new Set(tableauxData.map(t => t.building))].sort();
            buildings.forEach(b => {
                const option = document.createElement('option');
                option.value = b;
                option.textContent = b;
                buildingFilter.appendChild(option);
            });
            tableauxData.forEach(t => {
                const option = document.createElement('option');
                option.value = t.id;
                option.textContent = t.id;
                tableauFilter.appendChild(option);
            });
            buildingFilter.onchange = filterData;
            tableauFilter.onchange = filterData;
        }

        // Filtrer les données
        function filterData() {
            const building = document.getElementById('building-filter').value;
            const tableau = document.getElementById('tableau-filter').value;
            const filteredData = tableauxData.filter(t => (!building || t.building === building) && (!tableau || t.id === tableau));
            renderHazardsTable(filteredData);
            renderHazardsChart(filteredData);
        }

        // Vérifier si le disjoncteur est obsolète
        function isObsolete(disjoncteur) {
            if (!disjoncteur.date || !disjoncteur.lifespan) return false;
            const manufactureYear = new Date(disjoncteur.date).getFullYear();
            const lifespan = parseInt(disjoncteur.lifespan) || 30;
            return (currentYear - manufactureYear) >= lifespan;
        }

        // Évaluer les risques
        function evaluateRisks(disjoncteur) {
            const risks = { arc: 'Faible', choc: 'Faible', surchauffe: 'Faible' };
            // Risque arc électrique
            if (disjoncteur.ik && disjoncteur.icn && disjoncteur.ik > disjoncteur.icn) {
                risks.arc = 'Élevé';
            }
            // Risque choc électrique
            if (!disjoncteur.ip || disjoncteur.ip === 'IP20') {
                risks.choc = 'Moyen';
            }
            if (disjoncteur.humidite && parseFloat(disjoncteur.humidite) > 80) {
                risks.choc = 'Élevé';
            }
            // Risque surchauffe
            if (disjoncteur.temp && parseFloat(disjoncteur.temp) > 70) {
                risks.surchauffe = 'Élevé';
            }
            if (disjoncteur.temp_ambiante && parseFloat(disjoncteur.temp_ambiante) > 40) {
                risks.surchauffe = 'Moyen';
            }
            return risks;
        }

        // Rendre le tableau des risques
        function renderHazardsTable(data = tableauxData) {
            const tbody = document.getElementById('hazards-table-body');
            tbody.innerHTML = '';
            data.forEach(tableau => {
                tableau.disjoncteurs.forEach(disjoncteur => {
                    const risks = evaluateRisks(disjoncteur);
                    const isObsoleteStatus = isObsolete(disjoncteur);
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="border border-gray-600 p-2">${tableau.id}</td>
                        <td class="border border-gray-600 p-2">${disjoncteur.id}</td>
                        <td class="border border-gray-600 p-2">${disjoncteur.marque || 'Inconnu'}</td>
                        <td class="border border-gray-600 p-2 ${risks.arc === 'Élevé' ? 'text-red-600' : risks.arc === 'Moyen' ? 'text-yellow-400' : 'text-green-600'}">${risks.arc}</td>
                        <td class="border border-gray-600 p-2 ${risks.choc === 'Élevé' ? 'text-red-600' : risks.choc === 'Moyen' ? 'text-yellow-400' : 'text-green-600'}">${risks.choc}</td>
                        <td class="border border-gray-600 p-2 ${risks.surchauffe === 'Élevé' ? 'text-red-600' : risks.surchauffe === 'Moyen' ? 'text-yellow-400' : 'text-green-600'}">${risks.surchauffe}</td>
                        <td class="border border-gray-600 p-2 ${isObsoleteStatus ? 'text-red-600' : 'text-green-600'}">${isObsoleteStatus ? 'Oui' : 'Non'}</td>
                        <td class="border border-gray-600 p-2">
                            <button class="action-btn text-blue-400 hover:text-blue-600" data-tableau-id="${tableau.id}" data-disjoncteur-id="${disjoncteur.id}"><i class="fas fa-eye"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            });
            // Associer les événements aux boutons d'action
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tableauId = btn.dataset.tableauId;
                    const disjoncteurId = btn.dataset.disjoncteurId;
                    console.log('[Client] Bouton Action cliqué:', { tableauId, disjoncteurId });
                    openModal(tableauId, disjoncteurId);
                });
            });
            gsap.from('tr', { opacity: 0, y: 20, duration: 0.5, stagger: 0.1 });
        }

        // Rendre le graphique des risques
        function renderHazardsChart(data = tableauxData) {
            const ctx = document.getElementById('hazards-chart').getContext('2d');
            
            // Détruire l'instance précédente du graphique si elle existe
            if (chartInstance) {
                chartInstance.destroy();
            }

            const counts = { arc: { faible: 0, moyen: 0, élevé: 0 }, choc: { faible: 0, moyen: 0, élevé: 0 }, surchauffe: { faible: 0, moyen: 0, élevé: 0 } };
            data.forEach(tableau => {
                tableau.disjoncteurs.forEach(disjoncteur => {
                    const risks = evaluateRisks(disjoncteur);
                    counts.arc[risks.arc.toLowerCase()]++;
                    counts.choc[risks.choc.toLowerCase()]++;
                    counts.surchauffe[risks.surchauffe.toLowerCase()]++;
                });
            });

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Arc Électrique', 'Choc Électrique', 'Surchauffe'],
                    datasets: [
                        { label: 'Faible', data: [counts.arc.faible, counts.choc.faible, counts.surchauffe.faible], backgroundColor: '#22c55e' },
                        { label: 'Moyen', data: [counts.arc.moyen, counts.choc.moyen, counts.surchauffe.moyen], backgroundColor: '#f4b400' },
                        { label: 'Élevé', data: [counts.arc.élevé, counts.choc.élevé, counts.surchauffe.élevé], backgroundColor: '#dc2626' }
                    ]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Nombre de Disjoncteurs', color: '#FFF' }, ticks: { color: '#FFF' } },
                        x: { title: { display: true, text: 'Type de Risque', color: '#FFF' }, ticks: { color: '#FFF' } }
                    },
                    plugins: { legend: { labels: { color: '#FFF' } } }
                }
            });
            gsap.from('#hazards-chart', { scale: 0.8, opacity: 0, duration: 1.5, ease: 'elastic.out(1, 0.5)' });
        }

        // Gérer l'alerte des données manquantes
        function updateMissingDataAlert() {
            const alert = document.getElementById('missing-data-alert');
            const link = document.getElementById('missing-data-link');
            if (missingData.length > 0) {
                alert.classList.remove('hidden');
                link.onclick = () => {
                    const { tableauId, disjoncteurId } = missingData[0];
                    console.log('[Client] Clic sur lien données manquantes:', { tableauId, disjoncteurId });
                    openModal(tableauId, disjoncteurId);
                };
            } else {
                alert.classList.add('hidden');
            }
        }

        // Gérer le modal
        function openModal(tableauId, disjoncteurId) {
            console.log('[Client] Ouverture modal:', { tableauId, disjoncteurId });
            const modal = document.getElementById('modal-details');
            const tableau = tableauxData.find(t => t.id === tableauId);
            if (!tableau) {
                console.error('[Client] Tableau non trouvé:', tableauId);
                alert('Erreur: Tableau non trouvé');
                return;
            }
            const disjoncteur = tableau.disjoncteurs.find(d => d.id === disjoncteurId);
            if (!disjoncteur) {
                console.error('[Client] Disjoncteur non trouvé:', disjoncteurId);
                alert('Erreur: Disjoncteur non trouvé');
                return;
            }
            const risks = evaluateRisks(disjoncteur);
            const isObsoleteStatus = isObsolete(disjoncteur);
            // Utiliser les valeurs directement sans réappliquer cleanNumericValue
            const content = `
                <p><strong>Tableau :</strong> ${tableauId}</p>
                <p><strong>Disjoncteur :</strong> ${disjoncteur.id}</p>
                <p><strong>Bâtiment :</strong> ${tableau.building}</p>
                <p><strong>Risque Arc Électrique :</strong> ${risks.arc}</p>
                <p><strong>Risque Choc Électrique :</strong> ${risks.choc}</p>
                <p><strong>Risque Surchauffe :</strong> ${risks.surchauffe}</p>
                <p><strong>Obsolète :</strong> ${isObsoleteStatus ? 'Oui' : 'Non'}</p>
                <h3 class="text-lg font-semibold mt-4">Recommandations :</h3>
                <ul class="list-disc pl-6">
                    ${risks.arc === 'Élevé' ? '<li>Remplacer le disjoncteur par un modèle avec un pouvoir de coupure (Icn) supérieur au courant de court-circuit (Ik).</li>' : ''}
                    ${risks.choc === 'Moyen' || risks.choc === 'Élevé' ? '<li>Améliorer l’indice de protection (ex. IP40 ou IP54 pour environnements humides ou poussiéreux).</li>' : ''}
                    ${risks.choc === 'Élevé' && disjoncteur.humidite > 80 ? '<li>Réduire l’humidité ambiante ou installer un boîtier étanche (ex. IP65).</li>' : ''}
                    ${risks.surchauffe === 'Élevé' ? '<li>Vérifier la ventilation ou réduire la charge électrique.</li>' : ''}
                    ${risks.surchauffe === 'Moyen' && disjoncteur.temp_ambiante > 40 ? '<li>Améliorer le refroidissement ou déplacer l’équipement dans un environnement plus frais.</li>' : ''}
                    ${isObsoleteStatus ? '<li>Planifier le remplacement du disjoncteur obsolète pour éviter les défaillances.</li>' : ''}
                </ul>
                <h3 class="text-lg font-semibold mt-4">Modifier les données :</h3>
                <div class="mb-4">
                    <label for="ip-input" class="block text-sm font-medium">Indice de protection (IP):</label>
                    <input id="ip-input" type="text" value="${disjoncteur.ip || ''}" class="mt-1 p-2 rounded bg-gray-700 text-white border-gray-600 w-full" placeholder="Ex. IP40">
                </div>
                <div class="mb-4">
                    <label for="temp-input" class="block text-sm font-medium">Température limite (°C):</label>
                    <input id="temp-input" type="number" step="0.1" value="${disjoncteur.temp || ''}" class="mt-1 p-2 rounded bg-gray-700 text-white border-gray-600 w-full" placeholder="Ex. 70">
                </div>
                <div class="mb-4">
                    <label for="ue-input" class="block text-sm font-medium">Tension nominale (V):</label>
                    <input id="ue-input" type="number" step="0.1" value="${disjoncteur.ue || ''}" class="mt-1 p-2 rounded bg-gray-700 text-white border-gray-600 w-full" placeholder="Ex. 400">
                </div>
                <div class="mb-4">
                    <label for="section-input" class="block text-sm font-medium">Section du câble (mm²):</label>
                    <input id="section-input" type="number" step="0.1" value="${disjoncteur.section || ''}" class="mt-1 p-2 rounded bg-gray-700 text-white border-gray-600 w-full" placeholder="Ex. 2.5">
                </div>
                <div class="mb-4">
                    <label for="humidite-input" class="block text-sm font-medium">Humidité ambiante (%):</label>
                    <input id="humidite-input" type="number" step="0.1" value="${disjoncteur.humidite || ''}" class="mt-1 p-2 rounded bg-gray-700 text-white border-gray-600 w-full" placeholder="Ex. 60">
                </div>
                <div class="mb-4">
                    <label for="temp_ambiante-input" class="block text-sm font-medium">Température ambiante (°C):</label>
                    <input id="temp_ambiante-input" type="number" step="0.1" value="${disjoncteur.temp_ambiante || ''}" class="mt-1 p-2 rounded bg-gray-700 text-white border-gray-600 w-full" placeholder="Ex. 25">
                </div>
            `;
            document.getElementById('modal-content').innerHTML = content;
            modal.classList.remove('hidden');
            document.getElementById('save-disjoncteur').onclick = async () => {
                console.log('[Client] Bouton Enregistrer cliqué:', { tableauId, disjoncteurId });
                try {
                    const ip = document.getElementById('ip-input').value;
                    const temp = document.getElementById('temp-input').value;
                    const ue = document.getElementById('ue-input').value;
                    const section = document.getElementById('section-input').value;
                    const humidite = document.getElementById('humidite-input').value;
                    const temp_ambiante = document.getElementById('temp_ambiante-input').value;

                    // Validation des données
                    if (ip && !validIpValues.includes(ip)) {
                        console.log('[Client] Validation échouée: IP invalide', ip);
                        alert('Indice de protection invalide. Valeurs acceptées : IP20, IP40, IP54, IP65.');
                        return;
                    }
                    if (temp && (isNaN(parseFloat(temp)) || temp < 0)) {
                        console.log('[Client] Validation échouée: Température invalide', temp);
                        alert('La température doit être une valeur numérique positive (ex. 70).');
                        return;
                    }
                    if (ue && (isNaN(parseFloat(ue)) || ue < 0)) {
                        console.log('[Client] Validation échouée: Tension invalide', ue);
                        alert('La tension nominale doit être une valeur numérique positive (ex. 400).');
                        return;
                    }
                    if (section && (isNaN(parseFloat(section)) || section < 0)) {
                        console.log('[Client] Validation échouée: Section invalide', section);
                        alert('La section du câble doit être une valeur numérique positive (ex. 2.5).');
                        return;
                    }
                    if (humidite && (isNaN(parseFloat(humidite)) || humidite < 0 || humidite > 100)) {
                        console.log('[Client] Validation échouée: Humidité invalide', humidite);
                        alert('L’humidité doit être une valeur numérique entre 0 et 100 (ex. 60).');
                        return;
                    }
                    if (temp_ambiante && (isNaN(parseFloat(temp_ambiante)) || temp_ambiante < -20 || temp_ambiante > 60)) {
                        console.log('[Client] Validation échouée: Température ambiante invalide', temp_ambiante);
                        alert('La température ambiante doit être une valeur numérique entre -20 et 60 (ex. 25).');
                        return;
                    }

                    const response = await fetch(`/api/disjoncteur/${tableauId}/${disjoncteurId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ip, temp, ue, section, humidite, temp_ambiante })
                    });
                    const responseData = await response.json();
                    if (!response.ok) {
                        console.error('[Client] Erreur mise à jour serveur:', responseData.error);
                        throw new Error(responseData.error || 'Erreur lors de la mise à jour');
                    }
                    console.log('[Client] Disjoncteur mis à jour:', responseData.data);
                    alert('Données mises à jour avec succès !');
                    modal.classList.add('hidden');
                    await loadTableaux();
                } catch (error) {
                    console.error('[Client] Erreur mise à jour:', error.message);
                    alert('Erreur : ' + error.message);
                }
            };
            document.getElementById('close-modal').onclick = () => {
                console.log('[Client] Bouton Fermer cliqué');
                modal.classList.add('hidden');
            };
        }

        // Initialisation
        window.onload = () => {
            console.log('[Client] Initialisation hazards_assessment.html');
            const modal = document.getElementById('modal-details');
            if (modal) modal.classList.add('hidden'); // S'assurer que le modal est masqué
            loadTableaux();
        };
    </script>
</body>
</html>