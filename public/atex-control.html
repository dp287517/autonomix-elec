<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ATEX Control</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script defer src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <style>
    body { background:#f8f9fa; }
    .table td, .table th { vertical-align: middle; }
    .last-photo{max-height:36px;border-radius:4px}
    .actions .btn{margin-right:4px}
    .badge-atex{font-weight:500}
    .modal-fullscreen .modal-body{height:calc(100vh - 140px)}
  </style>
</head>
<body>
<div class="container-fluid py-3">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="mb-0">Ã‰quipements ATEX</h3>
    <div>
      <button class="btn btn-primary" onclick="openEquipModal(null)">Ajouter</button>
    </div>
  </div>

  <div class="card">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0" id="tbl">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>Composant</th>
              <th>Secteur</th>
              <th>Marquage ATEX</th>
              <th>Zones</th>
              <th>Prochaine insp.</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Viewer (images + PDF) -->
<div class="modal fade" id="attViewerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content bg-dark">
      <div class="modal-header border-0">
        <h5 class="modal-title text-white" id="attViewerTitle">AperÃ§u</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body d-flex align-items-center justify-content-center p-0">
        <div id="attViewerStage" class="w-100 h-100 d-flex align-items-center justify-content-center"></div>
      </div>
      <div class="modal-footer border-0 justify-content-between">
        <div class="text-white-50 small" id="attViewerMeta"></div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-light" id="attPrev">&laquo;</button>
          <button class="btn btn-outline-light" id="attNext">&raquo;</button>
          <a class="btn btn-primary" id="attOpen" href="#" target="_blank" rel="noopener">Ouvrir</a>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Offcanvas Ajouter/Ã‰diter (simplifiÃ©e) -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasEquip">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="offcanvasEquipLabel">Ajouter / Ã‰diter</h5>
    <button type="button" id="btnFormAttachments" class="btn btn-sm btn-outline-dark ms-2"
      onclick="if(currentEquipId){openEquipModal(currentEquipId); setTimeout(()=>document.getElementById('equipAttachments').scrollIntoView({behavior:'smooth'}),300)}">
      ðŸ“Ž PiÃ¨ces jointes
    </button>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <form id="equipForm" onsubmit="return false;">
      <div class="row g-2">
        <div class="col-md-6">
          <label class="form-label">Composant</label>
          <input class="form-control" id="f_composant">
        </div>
        <div class="col-md-6">
          <label class="form-label">Secteur</label>
          <select class="form-select" id="secteur-input"><option value="">â€” SÃ©lectionner â€”</option></select>
        </div>
      </div>
      <div class="row g-2 mt-1">
        <div class="col-md-6">
          <label class="form-label">Marquage ATEX</label>
          <input class="form-control" id="f_marquage">
        </div>
        <div class="col-md-3">
          <label class="form-label">Zone G</label>
          <input class="form-control" id="f_zoneg" placeholder="0,1,2">
        </div>
        <div class="col-md-3">
          <label class="form-label">Zone D</label>
          <input class="form-control" id="f_zoned" placeholder="20,21,22">
        </div>
      </div>
      <div class="mt-3">
        <button class="btn btn-primary" onclick="saveEquip()">Enregistrer</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal DÃ©tails / Fichiers (lightbox capable) -->
<div class="modal fade" id="equipModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Ã‰quipement</h5>
        <div class="ms-3">
          <div class="btn-group" role="group">
            <a class="btn btn-sm btn-outline-secondary" id="btnExportCsv" target="_blank" rel="noopener">Export CSV</a>
            <a class="btn btn-sm btn-outline-secondary" id="btnExportXlsx" target="_blank" rel="noopener">Export XLSX</a>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="equipAttachments" class="mb-3">
          <div class="d-flex align-items-center justify-content-between">
            <h6 class="mb-0">Fichiers (photos/documents)</h6>
            <form id="uploadForm" class="d-flex gap-2" onsubmit="return false;">
              <input type="file" id="attFiles" multiple class="form-control form-control-sm" style="max-width:320px">
              <button class="btn btn-sm btn-outline-primary" onclick="uploadAttachments()">Uploader</button>
            </form>
          </div>
          <div id="attGrid" class="row g-2 mt-2"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
let _attList = [], _attIndex = 0, _attViewerModal;
let currentEquipId = null;
let equipments = [];

// ---------- Fetch & render list ----------
async function loadList(){
  const r = await fetch('/api/atex-equipments');
  const data = await r.json();
  equipments = Array.isArray(data) ? data : [];
  const tbody = $('#tbody');
  tbody.innerHTML = '';
  equipments.forEach(eq => {
    const zg = eq.zone_gaz || eq.zone_type || '';
    const zd = eq.zone_poussiere || (eq.zone_poussieres != null ? String(eq.zone_poussieres) : '');
    const tr = document.createElement('tr');
    const marq = eq.marquage_atex ? '<span class="badge bg-secondary badge-atex">'+eq.marquage_atex+'</span>' : '';
    tr.innerHTML = ''
      + '<td>'+eq.id+'</td>'
      + '<td>'+ (eq.composant || '') +' '+ marq +'</td>'
      + '<td>'+ (eq.secteur || '') +'</td>'
      + '<td>'+ (eq.marquage_atex || '') +'</td>'
      + '<td>'+ (zg || 'â€”') +' / '+ (zd || 'â€”') +'</td>'
      + '<td>'+ (eq.next_inspection_date || '') +'</td>'
      + '<td class="actions">'
        + '<button class="btn btn-sm btn-outline-primary" onclick="openEquipModal('+eq.id+')">Voir</button>'
        + '<button class="btn btn-sm btn-outline-dark ms-1" onclick="openEquipModal('+eq.id+'); setTimeout(()=>document.getElementById(\'equipAttachments\').scrollIntoView({behavior:\'smooth\'}),300)">ðŸ“Ž PiÃ¨ces jointes ('+(eq.attachments_count||0)+')</button>'
        + '<button class="btn btn-sm '+(eq.has_ia_history ? 'btn-success' : 'btn-outline-secondary')+' ms-1" onclick="openIA('+eq.id+')" title="IA Analysis"><i data-lucide="sparkles"></i> IA</button>'
      + '</td>';
    tbody.appendChild(tr);
  });
  if (window.lucide) window.lucide.createIcons();
}
loadList();

// ---------- Sectors ----------
async function loadSecteurs(){
  const r = await fetch('/api/atex-secteurs');
  const secteurs = await r.json();
  const sel = $('#secteur-input');
  sel.innerHTML = '<option value="">â€” SÃ©lectionner â€”</option>';
  (Array.isArray(secteurs) ? secteurs : []).forEach(s => {
    const name = (typeof s === 'string') ? s : (s && s.name) ? s.name : '';
    if(!name) return;
    const o = document.createElement('option'); o.value = name; o.text = name; sel.appendChild(o);
  });
}
loadSecteurs();

// ---------- Attachments viewer ----------
function openAttachment(index){
  if(!_attList.length) return;
  _attIndex = (index + _attList.length) % _attList.length;
  const att = _attList[_attIndex];
  const stage = document.getElementById('attViewerStage');
  const title = document.getElementById('attViewerTitle');
  const meta  = document.getElementById('attViewerMeta');
  const openA = document.getElementById('attOpen');
  stage.innerHTML = '';
  title.textContent = att.name || 'AperÃ§u';
  meta.textContent = (att.mime || 'application/octet-stream') + ' â€” ' + (att.name || '');
  openA.href = att.url;
  const isImg = /^image\//.test(att.mime || '') || /\.(png|jpe?g|webp|gif)$/i.test(att.name||'');
  const isPdf = (att.mime === 'application/pdf') || /\.pdf$/i.test(att.name||'');
  if (isImg){
    const img = document.createElement('img');
    img.src = att.url;
    img.alt = att.name || '';
    img.className = 'img-fluid';
    stage.appendChild(img);
  } else if (isPdf){
    const iframe = document.createElement('iframe');
    iframe.src = att.url;
    iframe.title = att.name || 'PDF';
    iframe.style = 'width:100%; height:100%; border:0; background:#222;';
    stage.appendChild(iframe);
  } else {
    const box = document.createElement('div');
    box.className = 'text-center text-white-50 p-4';
    box.innerHTML = '<div class="mb-2">Fichier non prÃ©visualisable</div>';
    stage.appendChild(box);
  }
  const el = document.getElementById('attViewerModal');
  _attViewerModal = bootstrap.Modal.getOrCreateInstance(el);
  _attViewerModal.show();
}
document.addEventListener('click', function(e){
  if (e.target && e.target.id === 'attPrev'){ e.preventDefault(); openAttachment(_attIndex-1); }
  if (e.target && e.target.id === 'attNext'){ e.preventDefault(); openAttachment(_attIndex+1); }
});

// ---------- Equipment modal ----------
async function openEquipModal(id){
  currentEquipId = id;
  // export buttons
  document.getElementById('btnExportCsv').href = '/api/atex-attachments/'+id+'/export.csv';
  document.getElementById('btnExportXlsx').href = '/api/atex-attachments/'+id+'/export.xlsx';
  // load attachments
  await loadAttachments(id);
  const el = document.getElementById('equipModal');
  bootstrap.Modal.getOrCreateInstance(el).show();
}
async function loadAttachments(id){
  const r = await fetch('/api/atex-attachments/'+id);
  const list = await r.json();
  _attList = Array.isArray(list) ? list : [];
  const grid = document.getElementById('attGrid');
  grid.innerHTML = '';
  _attList.forEach((a,idx)=>{
    const col = document.createElement('div'); col.className = 'col-6 col-md-3';
    const card = document.createElement('div'); card.className = 'border rounded p-2 h-100';
    const isImg = /^image\//.test(a.mime || '') || /\.(png|jpe?g|webp|gif)$/i.test(a.name||'');
    const isPdf = (a.mime === 'application/pdf') || /\.pdf$/i.test(a.name||'');
    if (isImg){
      card.innerHTML = '<div class="ratio ratio-1x1 mb-2"><img src="'+a.url+'" alt="'+(a.name||'')+'" class="w-100 h-100 object-fit-cover rounded" onclick="openAttachment('+idx+')"></div>';
    } else if (isPdf){
      card.innerHTML = '<div class="ratio ratio-1x1 mb-2 d-flex align-items-center justify-content-center bg-light rounded" onclick="openAttachment('+idx+')">PDF</div>';
    } else {
      card.innerHTML = '<div class="ratio ratio-1x1 mb-2 d-flex align-items-center justify-content-center bg-light rounded" onclick="openAttachment('+idx+')">Fichier</div>';
    }
    const footer = document.createElement('div');
    footer.className = 'd-flex align-items-center justify-content-between';
    footer.innerHTML = '<small class="text-truncate me-2" style="max-width:160px">'+(a.name||'')+'</small>'
      + '<button class="btn btn-sm btn-outline-danger" onclick="removeAttachment(\''+a.id+'\')">Suppr</button>';
    card.appendChild(footer);
    col.appendChild(card);
    grid.appendChild(col);
  });
}
async function uploadAttachments(){
  if (!currentEquipId) return;
  const input = document.getElementById('attFiles');
  if (!input.files || !input.files.length) return;
  const fd = new FormData();
  Array.from(input.files).forEach(f => fd.append('files', f));
  await fetch('/api/atex-attachments/'+currentEquipId, { method:'POST', body:fd });
  await loadAttachments(currentEquipId);
  await loadList();
}
async function removeAttachment(attId){
  if (!currentEquipId) return;
  await fetch('/api/atex-attachments/'+currentEquipId+'/'+attId, { method:'DELETE' });
  await loadAttachments(currentEquipId);
  await loadList();
}

// ---------- IA ----------
async function openIA(id){
  const r = await fetch('/api/atex-help/'+id);
  if (!r.ok) { alert('Aucune analyse IA disponible'); return; }
  const json = await r.json();
  const html = String(json.response || '');
  const m = document.createElement('div');
  m.className = 'modal fade';
  m.innerHTML = '<div class="modal-dialog modal-lg"><div class="modal-content">'
    + '<div class="modal-header"><h5 class="modal-title">Analyse IA</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>'
    + '<div class="modal-body">'+html+'</div>'
    + '</div></div>';
  document.body.appendChild(m);
  const mdl = new bootstrap.Modal(m);
  mdl.show();
  m.addEventListener('hidden.bs.modal', ()=> m.remove(), { once:true });
}

// ---------- Save (simplified) ----------
async function saveEquip(){
  const payload = {
    composant: document.getElementById('f_composant').value,
    secteur: document.getElementById('secteur-input').value,
    marquage_atex: document.getElementById('f_marquage').value,
    zone_gaz: document.getElementById('f_zoneg').value,
    zone_poussiere: document.getElementById('f_zoned').value
  };
  if (currentEquipId){
    await fetch('/api/atex-equipments/'+currentEquipId, { method:'PUT', body: toForm(payload) });
  } else {
    await fetch('/api/atex-equipments', { method:'POST', body: toForm(payload) });
  }
  loadList();
}

function toForm(obj){
  const fd = new FormData();
  Object.keys(obj).forEach(k => fd.append(k, obj[k] ?? ''));
  return fd;
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
