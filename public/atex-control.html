<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ATEX — Gestion des équipements</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { --brand:#0d6efd; --bg:#0b1320; --card:#121a2a; --muted:#8aa4c0; }
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:#eaf2ff}
    .navbar{background:linear-gradient(180deg,rgba(13,110,253,.12),rgba(13,110,253,0))}
    .brand{font-weight:700;letter-spacing:.3px}
    .btn-brand{background:var(--brand);border:none}
    .btn-brand:hover{filter:brightness(1.08)}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.12)}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08)}
    .table thead th{color:#cfe1ff;border-bottom:1px solid rgba(255,255,255,.12)}
    .table td,.table th{color:#eaf2ff;border-bottom-color:rgba(255,255,255,.06)}
    .badge-soft{background:rgba(13,110,253,.15);color:#b8d2ff;border:1px solid rgba(13,110,253,.25)}
    .badge-danger-soft{background:rgba(220,53,69,.15);color:#ffc6cd;border:1px solid rgba(220,53,69,.25)}
    .badge-success-soft{background:rgba(25,135,84,.15);color:#c6ffea;border:1px solid rgba(25,135,84,.25)}
    .form-label{color:#cfe1ff}
    .form-control,.form-select{background:#0f1726;border:1px solid rgba(255,255,255,.12);color:#eaf2ff}
    .form-control:focus,.form-select:focus{border-color:#77aaff;box-shadow:0 0 0 .2rem rgba(13,110,253,.15)}
    .snackbar{position:fixed;right:16px;bottom:16px;z-index:1200;display:none}
    .snackbar.show{display:block}
    /* Drawer IA */
    .drawer{position:fixed;top:0;right:-480px;width:480px;max-width:90vw;height:100%;background:#0f1726;border-left:1px solid rgba(255,255,255,.08);box-shadow:-24px 0 64px rgba(0,0,0,.35);transition:right .28s ease;z-index:1100;display:flex;flex-direction:column}
    .drawer.open{right:0}
    .drawer-header{padding:16px 20px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;gap:10px}
    .drawer-body{padding:16px;overflow:auto;flex:1}
    .drawer-footer{padding:12px;border-top:1px solid rgba(255,255,255,.08)}
    .chat-msg{padding:10px 12px;border-radius:10px;margin-bottom:10px;max-width:85%}
    .chat-me{background:#0d6efd1a;border:1px solid rgba(13,110,253,.35);margin-left:auto}
    .chat-ai{background:#17233a;border:1px solid rgba(255,255,255,.08)}
    .list-actions .btn{padding:4px 8px;font-size:.8rem}
    .col-required:after{content:" *";color:#ff8a8a}
    .link-like{all:unset;cursor:pointer;color:#b8d2ff;text-decoration:underline}
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg border-bottom border-opacity-10 border-white">
    <div class="container-fluid">
      <span class="navbar-brand text-white brand">AutonomiX • ATEX</span>
      <div class="d-flex gap-2 ms-auto">
        <button id="btnRisk" class="btn btn-ghost btn-sm" onclick="openRisk()">Voir Risk assessment global</button>
        <button id="btnSync" class="btn btn-ghost btn-sm" onclick="syncData()">Sync</button>
        <button id="btnIA" class="btn btn-brand btn-sm" onclick="toggleDrawer(true)">Assistant IA</button>
      </div>
    </div>
  </nav>

  <main class="container py-3">
    <ul class="nav nav-tabs" id="mainTabs" role="tablist">
      <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-liste" type="button" role="tab">Liste</button></li>
      <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-form" type="button" role="tab">Ajouter / Éditer</button></li>
      <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-import" type="button" role="tab">Importer</button></li>
    </ul>

    <div class="tab-content pt-3">
      <!-- Liste -->
      <div class="tab-pane fade show active" id="tab-liste" role="tabpanel">
        <div class="card p-3">
          <div class="table-responsive">
            <table class="table align-middle" id="tblEquip">
              <thead><tr>
                <th>#</th><th>Secteur</th><th>Bâtiment</th><th>Local</th>
                <th>Composant</th><th>Fabricant</th><th>Type</th><th>Marquage</th>
                <th>Risque</th><th>Conformité</th><th>Dern. insp.</th><th>Proch. insp.</th><th>Photo</th><th>Actions</th>
              </tr></thead>
              <tbody id="equipBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Formulaire -->
      <div class="tab-pane fade" id="tab-form" role="tabpanel">
        <div class="card p-3">
          <form id="equipForm" onsubmit="saveEquipment(event)">
            <input type="hidden" id="id" />
            <div class="row g-3">
              <div class="col-md-3"><label class="form-label">Secteur</label><select id="secteur" class="form-select"></select></div>
              <div class="col-md-3"><label class="form-label">Bâtiment</label><input id="batiment" class="form-control" /></div>
              <div class="col-md-3"><label class="form-label">Local</label><input id="local" class="form-control" /></div>
              <div class="col-md-3"><label class="form-label col-required">Composant</label><input id="composant" class="form-control" required /></div>

              <div class="col-md-3"><label class="form-label col-required">Fabricant</label><input id="fournisseur" class="form-control" required /></div>
              <div class="col-md-3"><label class="form-label col-required">Type</label><input id="type" class="form-control" required /></div>
              <div class="col-md-3"><label class="form-label">Identifiant</label><input id="identifiant" class="form-control" /></div>
              <div class="col-md-3"><label class="form-label">Grade</label><select id="grade" class="form-select"><option>V</option><option>IV</option><option>III</option><option>II</option><option>I</option></select></div>

              <div class="col-md-3"><label class="form-label">Fréquence (ans)</label><input id="frequence" type="number" min="1" class="form-control" value="3" /></div>
              <div class="col-md-3"><label class="form-label">Type de zone</label>
                <select id="zone_type" class="form-select">
                  <option value="">—</option>
                  <option>Zone 0</option><option>Zone 1</option><option>Zone 2</option>
                  <option>Zone 20</option><option>Zone 21</option><option>Zone 22</option>
                </select>
              </div>
              <div class="col-md-3"><label class="form-label col-required">Marquage ATEX</label><input id="marquage_atex" class="form-control" required placeholder="Ex: Ex II 2G Ex d IIC T6 Gb"/></div>
              <div class="col-md-3"><label class="form-label">Catégorie minimum</label><input id="categorie_minimum" class="form-control" placeholder="Ex: II 3G/3D T135°C" /></div>

              <div class="col-md-3"><label class="form-label">Date dernière inspection</label><input id="last_inspection_date" type="date" class="form-control" /></div>
              <div class="col-md-3"><label class="form-label">Photo (URL ou data:)</label><input id="photo" class="form-control" /></div>
              <div class="col-md-6"><label class="form-label">Commentaires</label><textarea id="comments" rows="2" class="form-control"></textarea></div>

              <div class="col-12 d-flex gap-2">
                <button class="btn btn-brand" type="submit">Enregistrer</button>
                <button class="btn btn-ghost" type="button" onclick="resetForm()">Nouveau</button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Importer -->
      <div class="tab-pane fade" id="tab-import" role="tabpanel">
        <div class="card p-3">
          <p class="text-muted">Importer depuis Excel/CSV. Colonnes supportées : <code>secteur, batiment, local, composant, fournisseur, type, identifiant, marquage_atex, categorie_minimum, zone_type, last_inspection_date</code>.</p>
          <div class="d-flex gap-2 align-items-center">
            <input type="file" id="fileImport" class="form-control" accept=".csv,.xlsx" style="max-width:360px">
            <button class="btn btn-brand" onclick="importFile()">Importer</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Drawer IA -->
  <div id="iaDrawer" class="drawer" aria-hidden="true">
    <div class="drawer-header">
      <strong>AutonomiX IA</strong>
      <span id="iaEquipTitle" class="ms-2 small text-secondary"></span>
      <button class="btn btn-sm btn-ghost ms-auto" onclick="toggleDrawer(false)">Fermer</button>
    </div>
    <div class="drawer-body">
      <div id="iaEquipBadge" class="mb-2"></div>
      <div id="chatBox"></div>
    </div>
    <div class="drawer-footer">
      <div class="d-flex gap-2">
        <input id="chatInput" class="form-control" placeholder="Demandez de l'aide… (ex: pourquoi non conforme ?)" onkeydown="if(event.key==='Enter'){sendChat()}" />
        <button class="btn btn-brand" onclick="sendChat()">Envoyer</button>
      </div>
    </div>
  </div>

  <!-- Snackbar -->
  <div id="snackbar" class="snackbar">
    <div class="card p-3">✅ Enregistré</div>
  </div>

  <script>
    const api = (p, opt={}) => fetch('/api'+p, {headers:{'Content-Type':'application/json'}, credentials:'same-origin', ...opt}).then(r=>{if(!r.ok) throw new Error('HTTP '+r.status); return r.json()});
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const fmtDate = v => { if(!v) return ''; const d = new Date(v); if(Number.isNaN(d)) return ''; return d.toLocaleDateString('fr-FR'); };
    const toast = (msg='Enregistré') => { $('#snackbar').firstElementChild.textContent=msg; $('#snackbar').classList.add('show'); setTimeout(()=>$('#snackbar').classList.remove('show'), 1600)};

    let secteurs = [];
    let equipments = [];
    let selectedId = null;

    // Init
    document.addEventListener('DOMContentLoaded', async ()=>{
      await loadSecteurs();
      await loadEquipments();
    });

    async function loadSecteurs(){
      try {
        const data = await api('/atex-secteurs');
        secteurs = (data?.length? data: data?.data)||[];
        const s = $('#secteur'); s.innerHTML = '<option value="">—</option>' + secteurs.map(x=>`<option>${x.name||x}</option>`).join('');
      } catch(e){ console.error('Secteurs', e); }
    }

    async function loadEquipments(){
      const body = $('#equipBody'); body.innerHTML = '<tr><td colspan="14" class="text-center text-muted">Chargement…</td></tr>';
      try {
        const list = await api('/atex-equipments');
        equipments = (Array.isArray(list)? list: list?.data)||[];
        renderTable();
      } catch(e){ console.error('Equipments', e); body.innerHTML = '<tr><td colspan="14" class="text-center text-danger">Erreur de chargement</td></tr>'; }
    }

    function renderTable(){
      const body = $('#equipBody');
      if(!equipments.length){ body.innerHTML = '<tr><td colspan="14" class="text-center text-muted">Aucun équipement</td></tr>'; return }
      body.innerHTML = equipments.map(row=>{
        const conf = (row.conformite||'').toLowerCase();
        const badge = conf.includes('non') ? '<span class="badge badge-danger-soft rounded-pill">Non conforme</span>' : '<span class="badge badge-success-soft rounded-pill">Conforme</span>';
        const photoCell = renderPhotoCell(row.photo);
        return `<tr>
          <td>${row.id}</td>
          <td>${row.secteur||''}</td>
          <td>${row.batiment||''}</td>
          <td>${row.local||''}</td>
          <td>${row.composant||''}</td>
          <td>${row.fournisseur||''}</td>
          <td>${row.type||''}</td>
          <td>${row.marquage_atex||''}</td>
          <td>${row.risque ?? ''}</td>
          <td>${badge}</td>
          <td>${fmtDate(row.last_inspection_date)}</td>
          <td>${fmtDate(row.next_inspection_date)}</td>
          <td>${photoCell}</td>
          <td class="list-actions">
            <button class="btn btn-sm btn-ghost" onclick="editRow(${row.id})">Éditer</button>
            <button class="btn btn-sm btn-ghost" onclick="openIA(${row.id})">Demander IA</button>
            <button class="btn btn-sm btn-outline-danger" onclick="delRow(${row.id})">Supprimer</button>
          </td>
        </tr>`
      }).join('');
    }

    function renderPhotoCell(photo){
      if(!photo) return '';
      if(photo.startsWith('data:application/pdf')||photo.endsWith('.pdf')){
        return `<button class="btn btn-ghost btn-sm" onclick=\"openPhoto('${encodeURIComponent(photo)}')\">Voir PDF</button>`;
      }
      return `<button class="btn btn-ghost btn-sm" onclick=\"openPhoto('${encodeURIComponent(photo)}')\">Voir</button>`;
    }

    function openPhoto(src){
      const url = decodeURIComponent(src);
      const w = window.open();
      w.document.write(`<iframe src="${url}" style="border:0;width:100%;height:100%"></iframe>`);
    }

    function editRow(id){
      const it = equipments.find(x=>x.id===id); if(!it) return;
      selectedId = id;
      $('#id').value = id;
      $('#secteur').value = it.secteur || '';
      $('#batiment').value = it.batiment || '';
      $('#local').value = it.local || '';
      $('#composant').value = it.composant || '';
      $('#fournisseur').value = it.fournisseur || '';
      $('#type').value = it.type || '';
      $('#identifiant').value = it.identifiant || '';
      $('#grade').value = it.grade || 'V';
      $('#frequence').value = it.frequence || 3;
      $('#zone_type').value = it.zone_type || '';
      $('#marquage_atex').value = it.marquage_atex || '';
      $('#categorie_minimum').value = it.categorie_minimum || '';
      $('#last_inspection_date').value = it.last_inspection_date? String(it.last_inspection_date).slice(0,10): '';
      $('#photo').value = it.photo || '';
      $('#comments').value = it.comments || '';
      new bootstrap.Tab(document.querySelector('[data-bs-target="#tab-form"]').classList.contains('active')? document.querySelector('[data-bs-target="#tab-form"]'):document.querySelector('[data-bs-target="#tab-form"]').parentElement).show();
      new bootstrap.Tab(document.querySelector('[data-bs-target="#tab-form"]').parentElement).show?.();
      bootstrap.Tab.getOrCreateInstance(document.querySelector('[data-bs-target="#tab-form"]').closest('button')).show?.();
      const btn = document.querySelector('[data-bs-target="#tab-form"]'); if(btn) bootstrap.Tab.getOrCreateInstance(btn).show();
    }

    function resetForm(){
      selectedId = null; $('#equipForm').reset(); $('#id').value='';
    }

    async function saveEquipment(ev){
      ev?.preventDefault();
      // validation min
      const requiredIds = ['composant','fournisseur','type','marquage_atex'];
      for(const id of requiredIds){ if(!$('#'+id).value.trim()){ $('#'+id).focus(); return toast('Merci de remplir les champs obligatoires'); } }

      const payload = {
        secteur: $('#secteur').value.trim(), batiment: $('#batiment').value.trim(), local: $('#local').value.trim(),
        composant: $('#composant').value.trim(), fournisseur: $('#fournisseur').value.trim(), type: $('#type').value.trim(), identifiant: $('#identifiant').value.trim(),
        grade: $('#grade').value, frequence: +($('#frequence').value||3),
        zone_type: $('#zone_type').value || null,
        marquage_atex: $('#marquage_atex').value.trim(), categorie_minimum: $('#categorie_minimum').value.trim(),
        last_inspection_date: $('#last_inspection_date').value||null,
        photo: $('#photo').value.trim(), comments: $('#comments').value.trim()
      };
      try{
        const method = selectedId? 'PUT':'POST';
        const url = selectedId? `/atex-equipments/${selectedId}`: '/atex-equipments';
        const res = await api(url,{method, body:JSON.stringify(payload)});
        toast('Équipement enregistré');
        await loadEquipments();
        if(res?.id){ selectedId = res.id; $('#id').value = res.id; }
      }catch(e){ console.error(e); toast('Erreur enregistrement'); }
    }

    async function delRow(id){
      if(!confirm('Supprimer définitivement cet équipement ?')) return;
      try{ await api(`/atex-equipments/${id}`,{method:'DELETE'}); await loadEquipments(); }catch(e){ console.error(e); }
    }

    function openRisk(){ window.open('atex-risk.html', '_blank'); }
    function syncData(){ loadEquipments(); toast('Données synchronisées'); }

    /* ===== Assistant IA (drawer) ===== */
    function toggleDrawer(open){ $('#iaDrawer').classList.toggle('open', !!open); if(open){ renderChatHeader(); loadChatHistory(); } }
    function openIA(id){ editRow(id); toggleDrawer(true); sendChatPreset('Peux-tu analyser cet équipement et me dire si quelque chose est non conforme ?'); }

    function renderChatHeader(){
      const it = currentEquip(); if(!it){ $('#iaEquipTitle').textContent=''; return; }
      $('#iaEquipTitle').textContent = `• ${it.composant||'Équipement'} (#${it.id||''})`;
      const conf = (it.conformite||'').toLowerCase();
      $('#iaEquipBadge').innerHTML = conf.includes('non')
        ? '<span class="badge badge-danger-soft rounded-pill">Non conforme</span> '
        : '<span class="badge badge-success-soft rounded-pill">Conforme</span>';
    }
    function currentEquip(){ const id = $('#id').value||selectedId; return equipments.find(x=> String(x.id)===String(id)) || null; }

    function pushMsg(role, content){
      const box = $('#chatBox');
      const div = document.createElement('div');
      div.className = 'chat-msg ' + (role==='user'?'chat-me':'chat-ai');
      div.innerHTML = content.replace(/```[\s\S]*?```/g, m=>`<pre class="mb-0 small">${m.replaceAll('<','&lt;')}</pre>`);
      box.appendChild(div); box.scrollTop = box.scrollHeight;
    }

    function loadChatHistory(){
      const it = currentEquip(); if(!it) return;
      const key = 'iahist_'+it.id; const arr = JSON.parse(localStorage.getItem(key)||'[]');
      $('#chatBox').innerHTML = ''; arr.forEach(m=>pushMsg(m.role, m.content));
    }
    function saveChatHistory(role, content){ const it=currentEquip(); if(!it) return; const key='iahist_'+it.id; const arr=JSON.parse(localStorage.getItem(key)||'[]'); arr.push({role,content}); localStorage.setItem(key, JSON.stringify(arr.slice(-30))); }

    async function sendChat(){
      const it = currentEquip(); const q = $('#chatInput').value.trim(); if(!q) return; $('#chatInput').value='';
      pushMsg('user', q); saveChatHistory('user', q);
      try{
        const payload = { message:q, equipmentId: it?.id||null };
        const r = await api('/atex-chat', { method:'POST', body: JSON.stringify(payload) });
        const answer = r?.answer || r?.response || '…';
        pushMsg('assistant', answer); saveChatHistory('assistant', answer);
      }catch(e){ console.error(e); pushMsg('assistant', "Désolé, je n'ai pas pu répondre."); }
    }
    function sendChatPreset(q){ $('#chatInput').value=q; sendChat(); }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
