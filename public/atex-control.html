<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Contr√¥le ATEX - √âquipements</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- üîê Garde d'acc√®s -->
  <script src="js/atex-control.guard.js" defer></script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root{
      --actions-min-width: 220px;
      --offcanvas-w: clamp(420px, 40vw, 580px);
    }
    body{ background:#f8f9fa; font-family:'Poppins',sans-serif; color:#333; }
    .card{ border-radius:14px; box-shadow:0 4px 10px rgba(0,0,0,.06); }
    .table-responsive{ overflow-x:auto; }

    /* Miniatures et pi√®ces jointes */
    .last-photo{ width:48px; height:48px; object-fit:cover; border-radius:6px; border:1px solid #ddd; cursor:pointer; }
    .att-thumb{ width:32px; height:32px; object-fit:cover; border-radius:4px; border:1px solid #ddd; margin-left:4px; cursor:pointer; vertical-align:middle; }
    .att-file{ display:inline-block; margin-left:6px; font-size:18px; text-decoration:none; }
    .att-more{ margin-left:6px; font-size:12px; }
    .att-wrap{ display:inline-flex; align-items:center; margin-left:4px; }

    .form-text{ color:#6c757d; }
    .small-muted{ font-size:.85rem; color:#6c757d; }
    .link-list a{ text-decoration:none; }

    .badge-conf{ font-weight:600; padding:.40rem .55rem; font-size:.82rem; border-radius:.65rem; white-space:nowrap; }
    .badge-conf.ok{ background:#16a34a; color:#fff; }
    .badge-conf.ko{ background:#dc2626; color:#fff; }
    td.col-conf{ white-space:nowrap; }

    .badge-st.ok{ background:#22c55e; }
    .badge-st.soon{ background:#f59e0b; }
    .badge-st.today{ background:#0ea5e9; }
    .badge-st.late{ background:#ef4444; }
    .badge-st{ color:#fff; font-weight:600; }

    td.actions{ min-width:var(--actions-min-width); white-space:nowrap; }
    @media (max-width: 992px){
      td.actions{ display:grid; grid-template-columns: repeat(3, 1fr); gap:.4rem; }
      td.actions .btn{ width:100%; }
    }
    @media (max-width: 576px){ td.actions{ grid-template-columns: 1fr; } }

    /* Offcanvas IA */
    .offcanvas-ia{ --bs-offcanvas-width: var(--offcanvas-w); }
    #iaPanel{ border-left:1px solid #e5e7eb; }
    #iaPanel .offcanvas-body{ display:flex; flex-direction:column; gap:1rem; padding-top:.75rem; }
    .ia-history{ border:1px solid #e9ecef; border-radius:10px; overflow:hidden; max-height:55vh; overflow-y:auto; background:#fff; }
    .ia-item{ cursor:pointer; }
    .ia-item.active{ background:#eef2ff; border-left:3px solid #0d6efd; }
    .ia-details{ border:1px solid #e9ecef; border-radius:10px; background:#fff; max-height:55vh; overflow:auto; padding:1rem; }
    .chat-thread{ border:1px solid #e9ecef; border-radius:10px; background:#fff; padding:1rem; max-height:45vh; overflow:auto; }
    .msg{ padding:.45rem .65rem; border-radius:.5rem; margin-bottom:.5rem; }
    .msg.user{ background:#eef2ff; }
    .msg.ia{ background:#f6f7f9; }
    .chat-input{ display:flex; gap:.5rem; }
    .chat-input textarea{ resize:vertical; min-height:44px; }

    .dropdown-checklist{ min-width:240px; max-height:260px; overflow:auto; }
    .filter-pills .badge{ margin-right:.4rem; margin-bottom:.4rem; }

    .def-list dt{ font-weight:600; }
    .def-list dd{ margin-bottom:.75rem; color:#475569; }

    footer{ margin-top:32px; color:#6b7280; }
  </style>
</head>
<body>

  <div class="container py-3">
    <header class="d-flex align-items-center justify-content-between mb-3">
      <h3 class="mb-0">Contr√¥le ATEX</h3>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary" href="dashboard.html"><i data-lucide="home"></i> Menu</a>
        <a class="btn btn-outline-secondary" href="atex-risk.html"><i data-lucide="scan-search"></i> Analyse</a>
        <a class="btn btn-outline-secondary" href="epd.html"><i data-lucide="file-text"></i> EPD</a>
        <a class="btn btn-outline-secondary" href="is-loop.html"><i data-lucide="circuit-board"></i> Boucles Exi</a>
      </div>
    </header>

    <ul class="nav nav-tabs" id="atexTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list" type="button" role="tab">
          <i data-lucide="list"></i> Liste
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="add-tab" data-bs-toggle="tab" data-bs-target="#add" type="button" role="tab">
          <i data-lucide="plus"></i> Ajouter
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat" type="button" role="tab">
          <i data-lucide="bot"></i> Chat IA
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="import-tab" data-bs-toggle="tab" data-bs-target="#import" type="button" role="tab">
          <i data-lucide="upload"></i> Importer
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="help-tab" data-bs-toggle="tab" data-bs-target="#help" type="button" role="tab">
          <i data-lucide="info"></i> Aide
        </button>
      </li>
    </ul>

    <div class="tab-content mt-3">
      <!-- ====== LISTE ====== -->
      <div class="tab-pane fade show active" id="list" role="tabpanel">
        <div class="card mb-3">
          <div class="card-body">
            <div class="row g-3 align-items-end">
              <div class="col-auto">
                <div class="dropdown">
                  <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                    Secteurs
                  </button>
                  <div class="dropdown-menu p-3 dropdown-checklist" id="dd-secteurs"></div>
                </div>
              </div>
              <div class="col-auto">
                <div class="dropdown">
                  <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                    B√¢timents
                  </button>
                  <div class="dropdown-menu p-3 dropdown-checklist" id="dd-batiments"></div>
                </div>
              </div>
              <div class="col-auto">
                <div class="dropdown">
                  <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                    Conformit√©
                  </button>
                  <div class="dropdown-menu p-3 dropdown-checklist" id="dd-conformite">
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="Conforme" id="c1"><label class="form-check-label" for="c1">Conforme</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="Non conforme" id="c2"><label class="form-check-label" for="c2">Non conforme</label></div>
                  </div>
                </div>
              </div>
              <div class="col-auto">
                <div class="dropdown">
                  <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                    Statut
                  </button>
                  <div class="dropdown-menu p-3 dropdown-checklist" id="dd-statut">
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="late" id="s1"><label class="form-check-label" for="s1">En retard</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="today" id="s2"><label class="form-check-label" for="s2">Aujourd‚Äôhui</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="soon" id="s3"><label class="form-check-label" for="s3">Bient√¥t</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="ok" id="s4"><label class="form-check-label" for="s4">OK</label></div>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <input id="filterText" class="form-control" placeholder="Recherche composant / type / marquage‚Ä¶">
              </div>
              <div class="col-md-6 text-end">
                <div id="activePills" class="filter-pills"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Liste des √âquipements</h5>
            <div class="d-flex gap-2 flex-wrap">
              <button id="btnBulkDelete" class="btn btn-outline-danger" disabled><i data-lucide="trash-2"></i> Supprimer s√©lection</button>
              <button id="btnSync" class="btn btn-info"><i data-lucide="refresh-cw"></i> Sync</button>
            </div>
          </div>
          <div class="card-body table-responsive">
            <table class="table table-striped align-middle">
              <thead>
                <tr>
                  <th><input type="checkbox" id="chkAll"></th>
                  <th>ID</th><th>Composant</th><th>Secteur</th><th>B√¢timent</th>
                  <th>Local</th><th>Zone G</th><th>Zone D</th><th>Conformit√©</th><th>Statut</th><th>Risque</th>
                  <th>Derni√®re</th><th>Prochaine</th><th>Photo</th><th style="min-width:var(--actions-min-width)">Actions</th>
                </tr>
              </thead>
              <tbody id="equipmentsTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ====== AJOUTER ====== -->
      <div class="tab-pane fade" id="add" role="tabpanel">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Ajouter un √©quipement</h5>
            <div class="d-flex gap-2">
              <button class="btn btn-secondary" id="btnCancel"><i data-lucide="x"></i> Annuler</button>
              <button class="btn btn-primary" id="btnSave"><i data-lucide="save"></i> Enregistrer</button>
            </div>
          </div>
          <div class="card-body">
            <input type="hidden" id="equipId" value="">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Secteur*</label>
                <div class="input-group">
                  <select id="secteur-input" class="form-select" required>
                    <option value="" disabled selected>‚Äî S√©lectionner ‚Äî</option>
                  </select>
                  <button class="btn btn-outline-secondary" id="btnAddSecteur" title="Nouveau secteur"><i data-lucide="plus"></i></button>
                </div>
                <div class="form-text">Clique sur + pour cr√©er un nouveau secteur.</div>
              </div>
              <div class="col-md-4">
                <label class="form-label">B√¢timent*</label>
                <input id="batiment-input" class="form-control" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Local</label>
                <input id="local-input" class="form-control">
              </div>
            </div>

            <div class="row mt-3">
              <div class="col-md-6">
                <label class="form-label">Zone Gaz</label>
                <select id="zone-g-input" class="form-select">
                  <option value="">‚Äî</option>
                  <option value="0">0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Zone Poussi√®res</label>
                <select id="zone-d-input" class="form-select">
                  <option value="">‚Äî</option>
                  <option value="20">20</option>
                  <option value="21">21</option>
                  <option value="22">22</option>
                </select>
              </div>
            </div>

            <div class="row mt-3">
              <div class="col-md-6">
                <label class="form-label">Composant*</label>
                <input id="composant-input" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Fournisseur</label>
                <input id="fournisseur-input" class="form-control">
              </div>
            </div>

            <div class="row mt-3">
              <div class="col-md-6">
                <label class="form-label">Type (r√©f√©rence)*</label>
                <input id="type-input" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Identifiant</label>
                <input id="identifiant-input" class="form-control">
              </div>
            </div>

            <div class="row mt-3">
              <div class="col-md-6">
                <label class="form-label">Marquage ATEX*</label>
                <input id="marquage_atex-input" class="form-control" placeholder="Ex: II 2G Ex d IIC T4 Gb / II 1D Ex tb IIIC T135¬∞C Db" required>
                <div class="form-text">Saisis Gaz (G) et/ou Poussi√®res (D). Les cat√©gories 1/2/3 sont valid√©es automatiquement selon les zones.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Derni√®re inspection</label>
                <input type="date" id="last-inspection-input" class="form-control">
                <div class="form-text">La prochaine sera recalcul√©e.</div>
              </div>
            </div>

            <div class="row mt-3">
              <div class="col-md-6">
                <label class="form-label">Photo / Doc</label>
                <input type="file" id="photo-input" class="form-control" accept="image/*,.pdf">
                <div class="form-text">Les images sont compress√©es automatiquement avant envoi.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Commentaires</label>
                <textarea id="comments-input" class="form-control" rows="2"></textarea>
              </div>
            </div>

            <div class="mt-3 d-flex gap-2">
              <button class="btn btn-outline-secondary" id="btnFillBatLocal"><i data-lucide="wand-2"></i> Pr√©-remplir b√¢timent/local depuis le secteur</button>
              <button class="btn btn-outline-secondary" id="btnDupLast"><i data-lucide="copy"></i> Dupliquer le dernier type</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ====== CHAT IA ====== -->
      <div class="tab-pane fade" id="chat" role="tabpanel">
        <div class="row g-3">
          <div class="col-lg-4">
            <div class="card h-100">
              <div class="card-header d-flex justify-content-between align-items-center">
                <strong>Historique d‚Äôanalyses</strong>
                <div class="d-flex gap-2">
                  <button class="btn btn-sm btn-outline-secondary" id="btnSyncHistory"><i data-lucide="refresh-cw"></i></button>
                  <button class="btn btn-sm btn-outline-danger" id="btnClearChat"><i data-lucide="eraser"></i> Effacer</button>
                </div>
              </div>
              <div class="card-body p-0">
                <ul class="list-group list-group-flush" id="iaHistoryList">
                  <li class="list-group-item text-muted">Aucun historique.</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="col-lg-8">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <div><strong id="chatHeader"></strong></div>
                <div class="d-flex gap-2">
                  <button class="btn btn-sm btn-outline-secondary" id="btnCopier"><i data-lucide="copy"></i> Copier</button>
                  <button class="btn btn-sm btn-primary" id="btnReanalyse"><i data-lucide="sparkles"></i> Relancer IA</button>
                </div>
              </div>
              <div class="card-body">
                <div id="chatHtml" class="mb-3"></div>

                <div class="row g-3">
                  <div class="col-md-6">
                    <div class="border rounded p-3 h-100">
                      <strong>Mesures palliatives</strong>
                      <ul id="chatPalliatives" class="mb-0"></ul>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="border rounded p-3 h-100">
                      <strong>Mesures pr√©ventives</strong>
                      <ul id="chatPreventives" class="mb-0"></ul>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="border rounded p-3 h-100">
                      <strong>R√©f√©rences & changements</strong>
                      <ul id="chatRefs" class="mb-0"></ul>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="border rounded p-3 h-100">
                      <strong>Estimation des co√ªts (¬£)</strong>
                      <ul id="chatCosts" class="mb-0"></ul>
                    </div>
                  </div>
                </div>

                <div class="mt-3">
                  <h6>Suggestions d‚Äôachat (automatiques)</h6>
                  <div id="autoLinks" class="link-list"></div>
                </div>

                <div class="mt-3">
                  <h6>Pi√®ces & Liens d‚Äôachat (manuel)</h6>
                  <div class="row g-2 align-items-end">
                    <div class="col-md-7">
                      <label class="form-label">Type de pi√®ce</label>
                      <select id="partType" class="form-select">
                        <option value="capteur">Capteur de pression ATEX (ex: IFM PN7092)</option>
                        <option value="boite_e">Bo√Æte de jonction Ex e (R. STAHL)</option>
                        <option value="boite_d">Bo√Æte de jonction Ex d (R. STAHL)</option>
                        <option value="formation">Formation / Audit ATEX</option>
                      </select>
                    </div>
                    <div class="col-md-5">
                      <button id="btnPartLinks" class="btn btn-outline-primary w-100"><i data-lucide="link"></i> Proposer des liens</button>
                    </div>
                  </div>
                  <div class="mt-2" id="partLinksArea"></div>
                </div>

                <hr class="my-3">

                <div class="chat-thread" id="chatThread"></div>
                <div class="chat-input mt-2">
                  <textarea id="chatPrompt" class="form-control" placeholder="Pose une question √† l‚ÄôIA‚Ä¶"></textarea>
                  <button class="btn btn-primary" id="btnSend"><i data-lucide="send"></i></button>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ====== IMPORT ====== -->
      <div class="tab-pane fade" id="import" role="tabpanel">
        <div class="card">
          <div class="card-header"><h5 class="mb-0">Importer depuis Excel / CSV</h5></div>
          <div class="card-body">
            <div class="row g-3 align-items-end">
              <div class="col-md-6">
                <input type="file" id="excelFile" class="form-control" accept=".xlsx,.csv">
              </div>
              <div class="col-md-6">
                <button class="btn btn-primary" id="btnImport"><i data-lucide="upload"></i> Importer</button>
                <a class="btn btn-outline-secondary" href="/api/atex-import-template">Mod√®le CSV</a>
                <a class="btn btn-outline-secondary" href="/api/atex-import-template.xlsx">Mod√®le XLSX</a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ====== AIDE ====== -->
      <div class="tab-pane fade" id="help" role="tabpanel">
        <div class="card">
          <div class="card-body">
            <h5>Explications des param√®tres</h5>
            <dl class="def-list">
              <dt>√âch√©ance (prochaine inspection)</dt>
              <dd>Calcul√©e √† partir de la derni√®re inspection + fr√©quence (d√©faut 3 ans). Mise √† jour automatiquement √† chaque inspection.</dd>
              <dt>Risque (0‚Äì5)</dt>
              <dd>Bas√© sur la zone la plus s√©v√®re (0/20 ‚Üí 5, 1/21 ‚Üí 4, 2/22 ‚Üí 3 ; aucune ‚Üí 1) augment√© de +1 si Non Conforme. Limit√© entre 1 et 5.</dd>
              <dt>Conformit√©</dt>
              <dd>Comparaison du marquage ATEX avec les exigences Gaz (G) et Poussi√®res (D) + cat√©gories (1/2/3). Le verdict est **Non conforme** si l‚Äôune des deux fili√®res (G/D) ou la cat√©gorie minimale n‚Äôest pas satisfaite.</dd>
            </dl>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Offcanvas IA (ouverture depuis la liste) -->
  <div class="offcanvas offcanvas-end offcanvas-ia" tabindex="-1" id="iaPanel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">Analyse IA</h5>
      <button class="btn btn-sm btn-outline-danger" id="btnClearChat2"><i data-lucide="eraser"></i> Effacer discussion</button>
      <button class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <div id="iaHeader" class="fw-semibold"></div>
      <div id="iaLoading" class="text-muted">Chargement‚Ä¶</div>
      <div id="iaDetails" class="ia-details"></div>

      <div class="chat-thread" id="iaThread"></div>
      <div class="chat-input mt-2">
        <textarea id="iaPrompt" class="form-control" placeholder="Question rapide‚Ä¶"></textarea>
        <button class="btn btn-primary" id="iaSend"><i data-lucide="send"></i></button>
      </div>

      <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary" id="btnOpenInChat"><i data-lucide="panel-right"></i> Ouvrir dans l‚Äôonglet Chat</button>
      </div>
    </div>
  </div>

  <!-- Modal Photo -->
  <div class="modal fade" id="photoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Photo</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body text-center"><img id="photoModalImg" src="" class="img-fluid" alt="Photo √©quipement"></div>
        <div class="modal-footer"><a id="photoDownload" class="btn btn-primary" download>T√©l√©charger</a><button class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button></div>
      </div>
    </div>
  </div>

  <!-- Modal Suppression -->
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Supprimer</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div id="deleteMsg">Voulez-vous vraiment supprimer ces √©l√©ments ?</div>
          <div id="deleteMeta" class="small text-muted"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button class="btn btn-danger" id="confirmDeleteBtn">Supprimer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Pi√®ces jointes (carrousel simple) -->
  <div class="modal fade" id="attachmentsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Pi√®ces jointes</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div id="attCarousel" class="text-center"></div>
        </div>
        <div class="modal-footer d-flex justify-content-between">
          <div>
            <button class="btn btn-outline-light" id="attPrev"><i data-lucide="chevron-left"></i></button>
            <button class="btn btn-outline-light" id="attNext"><i data-lucide="chevron-right"></i></button>
          </div>
          <a class="btn btn-primary" id="attOpen" href="#" target="_blank" rel="noopener">Ouvrir dans un onglet</a>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- JS -->
  <div id="toasts" class="toast-container position-fixed bottom-0 end-0 p-3"></div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/atex-control.core.js" defer></script>
  <script src="js/atex-control.ui.js" defer></script>
</body>
</html>
