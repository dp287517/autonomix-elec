<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>ATEX — Contrôle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Reset minimal -->
  <style>
    :root{
      --bg:#0f172a;      /* slate-900 */
      --card:#111827;    /* gray-900 */
      --muted:#334155;   /* slate-600 */
      --text:#e5e7eb;    /* gray-200 */
      --accent:#22c55e;  /* green-500 */
      --warn:#f59e0b;    /* amber-500 */
      --danger:#ef4444;  /* red-500 */
      --border:#1f2937;  /* gray-800 */
      --shadow: 0 8px 24px rgba(0,0,0,.35);
      --radius: 16px;
    }
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background:linear-gradient(180deg, #0b1022, #0f172a);
      color:var(--text);
    }
    .container{max-width:1100px; margin:32px auto; padding:0 16px;}
    h1{font-size:28px; margin:0 0 12px;}
    p.lead{color:#cbd5e1; margin:0 0 24px;}
    .tabs{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:16px;}
    .tab-btn{
      border:1px solid var(--border); background:var(--card); color:var(--text);
      padding:10px 14px; border-radius:999px; cursor:pointer; transition:.2s; box-shadow: var(--shadow);
    }
    .tab-btn.active{background:var(--accent); color:#06220f; border-color:transparent; font-weight:600;}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.005));
      border:1px solid var(--border); border-radius:var(--radius); padding:18px; box-shadow: var(--shadow);
    }
    .grid{display:grid; gap:14px;}
    @media(min-width:860px){ .grid-2{ grid-template-columns:1fr 1fr;} .grid-3{ grid-template-columns:repeat(3, 1fr);} }
    label{display:block; font-size:14px; color:#d1d5db; margin-bottom:6px;}
    .help{display:block; font-size:12px; color:#94a3b8; margin-top:6px;}
    input[type="text"], input[type="file"], select, textarea{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border);
      background:#0b1224; color:var(--text); outline:none; transition:border-color .2s;
    }
    input::placeholder, textarea::placeholder{color:#64748b}
    input:focus, select:focus, textarea:focus{border-color:#475569}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .btn{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 14px; border-radius:12px; border:1px solid var(--border);
      background:#0b1224; color:var(--text); cursor:pointer; transition:.2s;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn-primary{ background:var(--accent); color:#06220f; border-color:transparent; font-weight:700;}
    .btn-outline{ background:transparent }
    .btn-danger{ background:var(--danger); color:#fff; border-color:transparent; }
    .section-title{font-weight:700; margin:18px 0 8px; color:#cbd5e1}
    .divider{height:1px; background:var(--border); margin:12px 0 18px}
    .pill{display:inline-block; padding:4px 8px; border-radius:999px; background:#0b1224; border:1px solid var(--border); font-size:12px; color:#a3a3a3}
    table{width:100%; border-collapse:collapse; overflow:auto; border-radius:12px;}
    th, td{border-bottom:1px solid var(--border); padding:10px; text-align:left; font-size:13px;}
    th{color:#cbd5e1; background:#0b1224}
    .muted{color:#9aa4b2}
    .success{color:#34d399}
    .warning{color:var(--warn)}
    .error{color:var(--danger)}
    .hidden{display:none !important}
    .notice{border-left:4px solid var(--accent); background:#06220f; padding:10px 12px; border-radius:10px; color:#c7ffd8}
    .soft{opacity:.9}
    .uploader{border:1px dashed #334155; padding:14px; border-radius:12px; text-align:center; background:#0b1224}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; background:#0b1224; border:1px solid var(--border); padding:2px 6px; border-radius:6px; color:#cbd5e1}
    .small{font-size:12px}
    .right{float:right}
    .link{color:#86efac; text-decoration:underline; cursor:pointer}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>

  <!-- CSV + XLSX libs (CDN). Ok en prod si internet est autorisé; sinon garde le CSV. -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>ATEX — Contrôle</h1>
    <p class="lead soft">Gérer les équipements et leurs marquages ATEX. Ajouter/éditer un équipement unitaire, ou importer en masse.</p>

    <!-- Onglets -->
    <div class="tabs" role="tablist" aria-label="Sections ATEX">
      <button class="tab-btn active" data-tab="addedit" role="tab" aria-selected="true">Ajouter / Éditer</button>
      <button class="tab-btn" data-tab="import" role="tab" aria-selected="false">Importer</button>
      <button class="tab-btn" data-tab="assistant" role="tab" aria-selected="false">Assistance IA</button>
    </div>

    <!-- Ajouter / Éditer -->
    <section id="tab-addedit" class="card" role="tabpanel" aria-labelledby="Ajouter / Éditer">
      <div class="grid grid-2">
        <!-- Secteur de responsabilité -->
        <div>
          <label for="secteur">Secteur de responsabilité</label>
          <div class="row">
            <select id="secteur" aria-describedby="help-secteur">
              <!-- Exemples; ces valeurs devraient venir de l’API -->
              <option value="" disabled selected>— Sélectionner —</option>
              <option>Production</option>
              <option>Utilities</option>
              <option>Maintenance</option>
              <option data-create="true">➕ Ajouter un nouveau secteur…</option>
            </select>
          </div>
          <span id="help-secteur" class="help">Sélectionnez le secteur responsable. Cliquez “Ajouter un nouveau secteur…” pour en créer un.</span>
          <div id="new-secteur-row" class="row hidden" style="margin-top:8px">
            <input type="text" id="new-secteur" placeholder="Nom du nouveau secteur" />
            <button class="btn" id="save-secteur">Enregistrer le secteur</button>
            <button class="btn btn-outline" id="cancel-secteur">Annuler</button>
          </div>
        </div>

        <!-- Local -->
        <div>
          <label for="local">Local</label>
          <input id="local" type="text" placeholder="Entrer le nom ou numéro du local" aria-describedby="help-local" />
          <span id="help-local" class="help">Exemples : “L-203”, “Salle compresseurs”, “Bât. B06 — LT-12”.</span>
        </div>

        <!-- Composant -->
        <div>
          <label for="composant">Composant</label>
          <select id="composant" aria-describedby="help-composant">
            <option value="" disabled selected>— Sélectionner —</option>
            <option>Capteur</option>
            <option>Clapet</option>
            <option>Moteur</option>
            <option>Vanne</option>
            <option>Boîtier de jonction</option>
            <option>Autre</option>
          </select>
          <span id="help-composant" class="help">Type de composant (capteur, clapet, etc.).</span>
        </div>

        <!-- Fabricant -->
        <div>
          <label for="fabricant">Fabricant</label>
          <input id="fabricant" type="text" placeholder="Ex : IFM, Endress+Hauser, Siemens…" aria-describedby="help-fabricant" />
          <span id="help-fabricant" class="help">Ancien libellé “Fournisseur”. Indiquez le nom du <strong>fabricant</strong>.</span>
        </div>

        <!-- Type (référence fabricant) -->
        <div>
          <label for="typeRef">Type (référence fabricant)</label>
          <input id="typeRef" type="text" placeholder="Entrer la référence fabricant" aria-describedby="help-typeRef" />
          <span id="help-typeRef" class="help">Ex : “PN7092”, “E2E-X5ME1”, “3RW40 11-1BB14”.</span>
        </div>

        <!-- Identifiant -->
        <div>
          <label for="identifiant">Identifiant</label>
          <input id="identifiant" type="text" placeholder="Entrer l’identifiant du capteur par exemple" aria-describedby="help-identifiant" />
          <span id="help-identifiant" class="help">Ex : “CAPT-0123”, “MOT-AX07”, “VAN-15A”.</span>
        </div>

        <!-- Marquage ATEX -->
        <div>
          <label for="atex">Marquage ATEX</label>
          <input id="atex" type="text" placeholder="Ex : II 3G IIA T4" aria-describedby="help-atex" />
          <span id="help-atex" class="help">Inscrire ici le marquage ATEX (exemple : <span class="kbd">II 3G IIA T4</span>).</span>
        </div>

        <!-- Photo / Document -->
        <div>
          <label for="files">Photo / Document</label>
          <div class="uploader">
            <input id="files" type="file" multiple aria-describedby="help-files" />
            <div class="small muted" style="margin-top:8px">Formats acceptés : images (PNG/JPG/WebP), PDF, etc. (max ~10 Mo par fichier selon serveur).</div>
          </div>
          <span id="help-files" class="help">Ajoutez une ou plusieurs photos / documents liés au composant.</span>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <button class="btn btn-primary" id="save-one">Enregistrer</button>
        <button class="btn btn-outline" id="reset-one">Réinitialiser</button>
        <span id="save-one-status" class="help"></span>
      </div>
    </section>

    <!-- Importer -->
    <section id="tab-import" class="card hidden" role="tabpanel" aria-labelledby="Importer">
      <div class="notice" style="margin-bottom:12px">
        <strong>Colonnes minimales requises</strong> pour un import qui fonctionne :
        <div class="grid" style="margin-top:8px">
          <span class="pill">Secteur de responsabilité</span>
          <span class="pill">Local</span>
          <span class="pill">Composant</span>
          <span class="pill">Fabricant</span>
          <span class="pill">Type</span>
          <span class="pill">Identifiant</span>
          <span class="pill">Marquage ATEX</span>
        </div>
        <div class="small" style="margin-top:8px">Les autres colonnes éventuelles sont <em>ignorées</em> si non reconnues. Vous pouvez importer un grand nombre de lignes d’un coup.</div>
      </div>

      <div class="row" style="margin-bottom:10px">
        <button class="btn" id="download-template-csv">Télécharger le modèle CSV</button>
        <button class="btn" id="download-template-xlsx">Télécharger le modèle XLSX</button>
        <span class="help">Utilisez ces modèles pour être sûr d’avoir la bonne trame.</span>
      </div>

      <div class="grid grid-2" style="align-items:start">
        <div>
          <label for="import-file">Fichier à importer (CSV ou XLSX)</label>
          <input id="import-file" type="file" accept=".csv,.xlsx,.xls" />
          <span class="help">Le fichier peut contenir plus de colonnes : seules celles reconnues seront utilisées.</span>
          <div class="row" style="margin-top:12px">
            <button class="btn btn-primary" id="parse-file">Prévisualiser</button>
            <button class="btn btn-outline" id="clear-preview">Vider la prévisualisation</button>
          </div>
        </div>

        <div>
          <div class="section-title">État</div>
          <div id="import-status" class="help muted">Aucun fichier chargé.</div>
          <div class="section-title">Validation</div>
          <div id="import-validation" class="help"></div>
        </div>
      </div>

      <div class="divider"></div>

      <div id="preview-wrap" class="hidden">
        <div class="row" style="justify-content:space-between; margin-bottom:8px">
          <div class="section-title">Aperçu des données</div>
          <div class="small muted right">Colonnes supplémentaires ignorées automatiquement.</div>
        </div>
        <div style="overflow:auto">
          <table id="preview-table" aria-label="Aperçu des données importées"></table>
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn btn-primary" id="send-import">Importer maintenant</button>
          <button class="btn btn-outline" id="download-errors" disabled>Télécharger erreurs CSV</button>
          <span id="send-status" class="help"></span>
        </div>
      </div>
    </section>

    <!-- Assistance IA -->
    <section id="tab-assistant" class="card hidden" role="tabpanel" aria-labelledby="Assistance IA">
      <div class="grid">
        <div>
          <label for="ia-question">Question</label>
          <textarea id="ia-question" rows="3" placeholder="Pose ta question sur ATEX, procédures, etc."></textarea>
          <span class="help">Ex : “Quels sont les marquages ATEX typiques pour les zones 2 ?”</span>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn btn-primary" id="ask-ia">Envoyer</button>
          <button class="btn btn-outline" id="clear-ia">Effacer</button>
          <span id="ia-status" class="help"></span>
        </div>
        <div class="divider"></div>
        <div>
          <div class="section-title">Réponse</div>
          <div id="ia-answer" class="muted">—</div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="small muted">
        <strong>Note backend (pour corriger l’erreur “undefined”)</strong> : l’API <span class="kbd">POST /api/atex-chat</span> doit renvoyer un JSON
        <span class="kbd">{ "answer": "..." }</span>. Si le serveur renvoie 500, le message d’erreur s’affiche proprement ici.
        Exemple Express (à adapter) :
        <pre class="small" style="white-space:pre-wrap;background:#0b1224;padding:8px;border-radius:8px;border:1px solid var(--border)">
app.post('/api/atex-chat', async (req, res) =&gt; {
  try {
    const { question } = req.body ?? {};
    if (!question) return res.status(400).json({ error: 'question manquante' });
    // TODO: appeler ton module openai.js et récupérer le texte
    const answer = await askOpenAI(question); // doit retourner une string
    return res.json({ answer });
  } catch (e) {
    console.error('atex-chat error:', e);
    return res.status(500).json({ error: 'internal_error', detail: String(e?.message || e) });
  }
});
        </pre>
      </div>
    </section>
  </div>

  <script>
    // -----------------------
    // Gestion des onglets
    // -----------------------
    const tabButtons = document.querySelectorAll('.tab-btn');
    const panels = {
      'addedit': document.getElementById('tab-addedit'),
      'import': document.getElementById('tab-import'),
      'assistant': document.getElementById('tab-assistant'),
    };
    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        tabButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const key = btn.dataset.tab;
        Object.values(panels).forEach(p => p.classList.add('hidden'));
        panels[key].classList.remove('hidden');
      });
    });

    // -----------------------
    // Ajouter / Éditer
    // -----------------------
    const secteurSelect = document.getElementById('secteur');
    const newSecteurRow = document.getElementById('new-secteur-row');
    const newSecteurInput = document.getElementById('new-secteur');
    const saveSecteurBtn = document.getElementById('save-secteur');
    const cancelSecteurBtn = document.getElementById('cancel-secteur');

    secteurSelect.addEventListener('change', () => {
      const opt = secteurSelect.selectedOptions[0];
      if (opt && opt.dataset.create === 'true') {
        newSecteurRow.classList.remove('hidden');
        newSecteurInput.focus();
      }
    });
    saveSecteurBtn.addEventListener('click', () => {
      const val = (newSecteurInput.value || '').trim();
      if (!val) return;
      // Ajouter localement dans la liste (en prod, POST /api/secteurs puis recharger)
      const newOpt = document.createElement('option');
      newOpt.textContent = val;
      newOpt.value = val;
      secteurSelect.insertBefore(newOpt, secteurSelect.querySelector('option[data-create="true"]'));
      secteurSelect.value = val;
      newSecteurInput.value = '';
      newSecteurRow.classList.add('hidden');
    });
    cancelSecteurBtn.addEventListener('click', () => {
      newSecteurInput.value = '';
      newSecteurRow.classList.add('hidden');
      secteurSelect.value = '';
    });

    const saveOneBtn = document.getElementById('save-one');
    const resetOneBtn = document.getElementById('reset-one');
    const saveOneStatus = document.getElementById('save-one-status');

    function gatherOnePayload() {
      return {
        secteur: (document.getElementById('secteur').value || '').trim(),
        local: (document.getElementById('local').value || '').trim(),
        composant: (document.getElementById('composant').value || '').trim(),
        fabricant: (document.getElementById('fabricant').value || '').trim(),
        type: (document.getElementById('typeRef').value || '').trim(),
        identifiant: (document.getElementById('identifiant').value || '').trim(),
        marquage_atex: (document.getElementById('atex').value || '').trim(),
      };
    }
    function validateOne(p) {
      const missing = [];
      if (!p.secteur) missing.push('Secteur de responsabilité');
      if (!p.local) missing.push('Local');
      if (!p.composant) missing.push('Composant');
      if (!p.fabricant) missing.push('Fabricant');
      if (!p.type) missing.push('Type');
      if (!p.identifiant) missing.push('Identifiant');
      if (!p.marquage_atex) missing.push('Marquage ATEX');
      return missing;
    }

    saveOneBtn.addEventListener('click', async () => {
      saveOneStatus.textContent = '';
      const payload = gatherOnePayload();
      const missing = validateOne(payload);
      if (missing.length) {
        saveOneStatus.innerHTML = 'Champs manquants : <span class="warning">' + missing.join(', ') + '</span>';
        return;
      }

      // Préparer FormData pour joindre les fichiers
      const filesInput = document.getElementById('files');
      const fd = new FormData();
      fd.append('data', new Blob([JSON.stringify(payload)], { type: 'application/json'}));
      if (filesInput?.files?.length) {
        [...filesInput.files].forEach((f, i) => fd.append('files', f, f.name));
      }

      // Envoi API (adapter l’URL selon ton backend)
      try {
        const res = await fetch('/api/atex', { method:'POST', body: fd });
        if (!res.ok) {
          const errText = await res.text().catch(()=> '');
          throw new Error('HTTP ' + res.status + (errText ? (' – '+ errText) : ''));
        }
        saveOneStatus.innerHTML = '<span class="success">Équipement enregistré.</span>';
      } catch(e) {
        console.error(e);
        saveOneStatus.innerHTML = '<span class="error">Erreur lors de l’enregistrement : ' + (e?.message || e) + '</span>';
      }
    });

    resetOneBtn.addEventListener('click', () => {
      ['secteur','local','composant','fabricant','typeRef','identifiant','atex','files'].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        if (el.tagName === 'SELECT') el.value = '';
        if (el.type === 'file') el.value = '';
        else el.value = '';
      });
      saveOneStatus.textContent = '';
    });

    // -----------------------
    // Importer
    // -----------------------
    const REQUIRED = ['Secteur de responsabilité','Local','Composant','Fabricant','Type','Identifiant','Marquage ATEX'];
    const KEYMAP = { // mapping tolerant pour noms de colonnes variés
      'secteur de responsabilité':'Secteur de responsabilité',
      'secteur':'Secteur de responsabilité',
      'local':'Local',
      'composant':'Composant',
      'fabricant':'Fabricant',
      'fournisseur':'Fabricant',
      'type':'Type',
      'référence':'Type',
      'reference':'Type',
      'identifiant':'Identifiant',
      'marquage atex':'Marquage ATEX',
      'atex':'Marquage ATEX'
    };

    const importFile = document.getElementById('import-file');
    const parseBtn = document.getElementById('parse-file');
    const clearPreviewBtn = document.getElementById('clear-preview');
    const previewWrap = document.getElementById('preview-wrap');
    const previewTable = document.getElementById('preview-table');
    const importStatus = document.getElementById('import-status');
    const importValidation = document.getElementById('import-validation');
    const sendBtn = document.getElementById('send-import');
    const sendStatus = document.getElementById('send-status');
    const downloadErrorsBtn = document.getElementById('download-errors');

    let parsedRows = [];
    let invalidRows = [];

    function normalizeHeader(h){
      return (h||'').toString().trim().toLowerCase().replace(/\s+/g,' ');
    }
    function mapHeaders(cols){
      const result = {};
      cols.forEach(c => {
        const n = normalizeHeader(c);
        const mapped = KEYMAP[n] || c; // si pas dans map, garder tel quel
        result[c] = mapped;
      });
      return result;
    }
    function projectRow(row, headerMap){
      // Construit un objet avec uniquement les colonnes supportées (REQUIRED, le reste ignoré)
      const out = {};
      Object.entries(row).forEach(([k,v])=>{
        const dst = headerMap[k] || k;
        if (REQUIRED.includes(dst)) out[dst] = (v ?? '').toString().trim();
      });
      return out;
    }
    function validateRows(rows){
      invalidRows = [];
      const valid = [];
      rows.forEach((r, idx)=>{
        const miss = REQUIRED.filter(k => !(r[k] && r[k].length));
        if (miss.length){ invalidRows.push({index: idx+1, missing: miss}); }
        else valid.push(r);
      });
      return { valid, invalid: invalidRows };
    }
    function renderPreview(rows){
      previewTable.innerHTML = '';
      if (!rows.length){ previewWrap.classList.add('hidden'); return; }
      // header
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      REQUIRED.forEach(h=>{
        const th = document.createElement('th'); th.textContent = h; trh.appendChild(th);
      });
      thead.appendChild(trh);
      previewTable.appendChild(thead);
      // body
      const tbody = document.createElement('tbody');
      rows.forEach((r,i)=>{
        const tr = document.createElement('tr');
        REQUIRED.forEach(h=>{
          const td = document.createElement('td'); td.textContent = r[h] || '';
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      previewTable.appendChild(tbody);
      previewWrap.classList.remove('hidden');
    }
    function setValidationMessage(colsPresent){
      const missingCols = REQUIRED.filter(k => !colsPresent.includes(k));
      if (missingCols.length){
        importValidation.innerHTML = 'Colonnes manquantes dans le fichier : <span class="warning">'+missingCols.join(', ')+'</span>';
      } else {
        importValidation.innerHTML = '<span class="success">Colonnes minimales présentes.</span>';
      }
    }

    parseBtn.addEventListener('click', async () => {
      importStatus.textContent = 'Lecture du fichier…';
      sendStatus.textContent = '';
      parsedRows = []; invalidRows = [];
      const file = importFile.files?.[0];
      if (!file){ importStatus.innerHTML = '<span class="warning">Aucun fichier sélectionné.</span>'; return; }

      const name = file.name.toLowerCase();
      try{
        if (name.endsWith('.csv')){
          await new Promise((resolve, reject)=>{
            Papa.parse(file, {
              header:true,
              skipEmptyLines:'greedy',
              transformHeader: (h)=>h,
              complete: (res)=>{ resolve(res); parsedRows = res.data; },
              error: (err)=> reject(err)
            });
          });
        } else if (name.endsWith('.xlsx') || name.endsWith('.xls')){
          const buf = await file.arrayBuffer();
          const wb = XLSX.read(buf, { type:'array' });
          const ws = wb.Sheets[wb.SheetNames[0]];
          parsedRows = XLSX.utils.sheet_to_json(ws, { defval:'' });
        } else {
          throw new Error('Format non supporté');
        }
        // Mapping d’en-têtes + projection
        const headers = Object.keys(parsedRows[0] || {});
        const headerMap = mapHeaders(headers);
        const projected = parsedRows.map(r=> projectRow(r, headerMap));
        setValidationMessage(Object.values(headerMap));
        const { valid, invalid } = validateRows(projected);
        renderPreview(valid);
        if (invalid.length){
          importStatus.innerHTML = '<span class="warning">'+invalid.length+' ligne(s) incomplète(s) seront ignorées.</span>';
          downloadErrorsBtn.disabled = false;
          downloadErrorsBtn.onclick = () => downloadErrorsCSV(invalid);
        } else {
          importStatus.innerHTML = '<span class="success">Prévisualisation prête. '+valid.length+' ligne(s) valide(s).</span>';
          downloadErrorsBtn.disabled = true;
        }
        // Conserve en mémoire seulement les valides pour l’envoi
        parsedRows = valid;
      } catch(e){
        console.error(e);
        importStatus.innerHTML = '<span class="error">Erreur de lecture : '+(e?.message || e)+'</span>';
        previewWrap.classList.add('hidden');
      }
    });

    clearPreviewBtn.addEventListener('click', ()=>{
      parsedRows = []; invalidRows = [];
      previewWrap.classList.add('hidden');
      previewTable.innerHTML = '';
      importStatus.textContent = 'Aucun fichier chargé.';
      importValidation.textContent = '';
      sendStatus.textContent = '';
      downloadErrorsBtn.disabled = true;
    });

    function chunk(array, size){
      const out = [];
      for (let i=0;i<array.length;i+=size) out.push(array.slice(i, i+size));
      return out;
    }

    sendBtn.addEventListener('click', async ()=>{
      sendStatus.textContent = '';
      if (!parsedRows.length){
        sendStatus.innerHTML = '<span class="warning">Rien à importer.</span>';
        return;
      }
      sendStatus.textContent = 'Import en cours…';
      try{
        // Envoi par paquets (éviter payload trop gros)
        const batches = chunk(parsedRows, 500);
        let imported = 0;
        for (let i=0;i<batches.length;i++){
          const res = await fetch('/api/atex/import', {
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ rows: batches[i] })
          });
          if (!res.ok){
            const t = await res.text().catch(()=> '');
            throw new Error('HTTP '+res.status+(t?(' – '+t):''));
          }
          const json = await res.json().catch(()=> ({}));
          imported += (json?.imported ?? batches[i].length);
        }
        sendStatus.innerHTML = '<span class="success">Import terminé : '+imported+' ligne(s) importée(s).</span>';
      } catch(e){
        console.error(e);
        sendStatus.innerHTML = '<span class="error">Erreur pendant l’import : '+(e?.message || e)+'</span>';
      }
    });

    function downloadErrorsCSV(errs){
      const rows = [['ligne','champs_manquants']];
      errs.forEach(e => rows.push([e.index, e.missing.join('|')]));
      const csv = rows.map(r => r.map(x => `"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'import-erreurs.csv'; a.click();
      setTimeout(()=> URL.revokeObjectURL(url), 1000);
    }

    // Modèles à télécharger
    const MODEL_HEADERS = REQUIRED;
    function generateCSVTemplate(){
      const head = MODEL_HEADERS.join(',');
      const example = [
        'Utilities,L-203,Capteur,IFM,PN7092,CAPT-0123,II 3G IIA T4',
        'Maintenance,Salle compresseurs,Clapet,Siemens,3RW40 11-1BB14,CLAP-0007,II 3G IIB T3'
      ].join('\n');
      return head + '\n' + example + '\n';
    }
    function generateXLSXTemplate(){
      const data = [
        MODEL_HEADERS,
        ['Utilities','L-203','Capteur','IFM','PN7092','CAPT-0123','II 3G IIA T4'],
        ['Maintenance','Salle compresseurs','Clapet','Siemens','3RW40 11-1BB14','CLAP-0007','II 3G IIB T3'],
      ];
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'ATEX-Import');
      return XLSX.write(wb, { type:'array', bookType:'xlsx' });
    }

    document.getElementById('download-template-csv').addEventListener('click', ()=>{
      const csv = generateCSVTemplate();
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'modele-atex.csv'; a.click();
      setTimeout(()=> URL.revokeObjectURL(url), 1000);
    });
    document.getElementById('download-template-xlsx').addEventListener('click', ()=>{
      const arr = generateXLSXTemplate();
      const blob = new Blob([arr], { type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'modele-atex.xlsx'; a.click();
      setTimeout(()=> URL.revokeObjectURL(url), 1000);
    });

    // -----------------------
    // Assistance IA
    // -----------------------
    const askBtn = document.getElementById('ask-ia');
    const clearIaBtn = document.getElementById('clear-ia');
    const iaQuestion = document.getElementById('ia-question');
    const iaAnswer = document.getElementById('ia-answer');
    const iaStatus = document.getElementById('ia-status');

    askBtn.addEventListener('click', async ()=>{
      iaStatus.textContent = 'Envoi…';
      iaAnswer.textContent = '—';
      try{
        const q = (iaQuestion.value || '').trim();
        if (!q){ iaStatus.innerHTML = '<span class="warning">Écris une question.</span>'; return; }
        const res = await fetch('/api/atex-chat', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ question: q })
        });
        const text = await res.text();
        let json = {};
        try { json = JSON.parse(text); } catch {}
        if (!res.ok){
          const msg = json?.error || text || ('HTTP '+res.status);
          throw new Error(msg);
        }
        const answer = json?.answer;
        if (!answer) {
          // éviter “undefined”
          iaAnswer.innerHTML = '<span class="warning">Réponse vide reçue. Vérifier que l’API renvoie { "answer": "..." }.</span>';
        } else {
          iaAnswer.textContent = answer;
        }
        iaStatus.innerHTML = '<span class="success">OK</span>';
      } catch(e){
        console.error(e);
        iaStatus.innerHTML = '<span class="error">Erreur : '+(e?.message || e)+'</span>';
      }
    });
    clearIaBtn.addEventListener('click', ()=>{
      iaQuestion.value = '';
      iaAnswer.textContent = '—';
      iaStatus.textContent = '';
    });
  </script>
</body>
</html>
