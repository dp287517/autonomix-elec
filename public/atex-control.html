<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>ATEX – Contrôle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/lucide-static@0.321.0/font/lucide.css" rel="stylesheet">
  <style>
    body{ background:#f7f7f9; }
    .page-wrap{ max-width: 1320px; margin: 24px auto; }
    .card{ border-radius: 16px; }
    .table thead th{ position:sticky; top:0; background:#fff; z-index:2; }
    .actions .btn{ margin-right:6px; }
    .badge-st{ padding: .35em .6em; border-radius: .65rem; font-weight:600; }
    .badge-st.ok{ background:#e8f7ee; color:#177245; }
    .badge-st.soon{ background:#fff7e0; color:#a26b00; }
    .badge-st.today{ background:#e8f1ff; color:#0b57d0; }
    .badge-st.late{ background:#ffe8e8; color:#b42318; }
    .badge-conf{ padding:.35em .6em; border-radius:.65rem; font-weight:600; }
    .badge-conf.ok{ background:#e8f7ee; color:#177245; }
    .badge-conf.ko{ background:#ffe8e8; color:#b42318; }
    /* miniatures / pièces jointes */
    .last-photo{ width:48px; height:48px; object-fit:cover; border-radius:6px; border:1px solid #ddd; cursor:pointer; }
    .att-thumb{ width:32px; height:32px; object-fit:cover; border-radius:4px; border:1px solid #ddd; margin-left:4px; cursor:pointer; vertical-align:middle; }
    .att-file{ display:inline-block; margin-left:6px; font-size:18px; text-decoration:none; }
    .att-more{ margin-left:6px; font-size:12px; }
    .att-wrap{ display:inline-flex; align-items:center; margin-left:4px; }
    /* offcanvas IA */
    .offcanvas-ia .offcanvas-body{ display:flex; flex-direction:column; gap:12px; }
    .ia-head{ font-weight:600; }
    .ia-box{ background:#fff; border:1px solid #eaeaea; border-radius:12px; padding:12px; }
    .ia-thread .msg{ padding:10px 12px; border-radius:10px; margin-bottom:8px; }
    .ia-thread .msg.user{ background:#eef2ff; }
    .ia-thread .msg.ia{ background:#f6f6f7; }
    .ia-thread{ max-height:210px; overflow:auto; border:1px dashed #ddd; border-radius:10px; padding:8px; background:#fff; }
    /* onglet Chat IA */
    .hist-item{ cursor:pointer; }
    .hist-item.active{ background:#eef2ff; }
    .hist-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    /* form */
    .form-section{ background:#fff; border:1px solid #eaeaea; border-radius:12px; padding:16px; }
    .small-muted{ color:#6b7280; font-size:.925rem; }
  </style>
</head>
<body>

<div class="page-wrap">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">ATEX – Contrôle</h2>
    <div class="d-flex gap-2">
      <button id="btnSync" class="btn btn-outline-secondary"><i class="lucide-refresh-cw"></i> Recharger</button>
    </div>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-3" id="atexTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#tab-list" type="button" role="tab">Liste</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="add-tab" data-bs-toggle="tab" data-bs-target="#tab-add" type="button" role="tab">Ajouter</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="chat-tab" data-bs-toggle="tab" data-bs-target="#tab-chat" type="button" role="tab">Chat IA</button>
    </li>
  </ul>

  <div class="tab-content" id="atexTabsContent">

    <!-- LISTE -->
    <div class="tab-pane fade show active" id="tab-list" role="tabpanel" aria-labelledby="list-tab">
      <div class="card">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div class="d-flex gap-2 align-items-center">
              <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown"><i class="lucide-filter"></i> Filtres</button>
                <div class="dropdown-menu p-3" style="min-width:320px;">
                  <div class="mb-2"><strong>Secteurs</strong></div>
                  <div id="dd-secteurs" class="mb-3"></div>
                  <div class="mb-2"><strong>Bâtiments</strong></div>
                  <div id="dd-batiments" class="mb-3"></div>
                  <div class="mb-2"><strong>Conformité</strong></div>
                  <div id="dd-conformite" class="mb-3">
                    <div class="form-check"><input class="form-check-input" id="conf-ok" type="checkbox" value="Conforme"><label class="form-check-label" for="conf-ok">Conforme</label></div>
                    <div class="form-check"><input class="form-check-input" id="conf-ko" type="checkbox" value="Non conforme"><label class="form-check-label" for="conf-ko">Non conforme</label></div>
                  </div>
                  <div class="mb-2"><strong>Statut</strong></div>
                  <div id="dd-statut" class="mb-3">
                    <div class="form-check"><input class="form-check-input" id="st-late" type="checkbox" value="late"><label class="form-check-label" for="st-late">En retard</label></div>
                    <div class="form-check"><input class="form-check-input" id="st-today" type="checkbox" value="today"><label class="form-check-label" for="st-today">Aujourd’hui</label></div>
                    <div class="form-check"><input class="form-check-input" id="st-soon" type="checkbox" value="soon"><label class="form-check-label" for="st-soon">Bientôt</label></div>
                    <div class="form-check"><input class="form-check-input" id="st-ok" type="checkbox" value="ok"><label class="form-check-label" for="st-ok">OK</label></div>
                  </div>
                  <div class="input-group">
                    <input id="filterText" class="form-control" placeholder="Recherche texte…">
                    <button class="btn btn-outline-secondary" id="btnApplyFilters">Appliquer</button>
                  </div>
                  <button class="btn btn-link mt-2 p-0" id="btnClearFilters">Effacer tous les filtres</button>
                </div>
              </div>
              <div id="activePills" class="d-flex gap-2 flex-wrap"></div>
            </div>
            <div class="d-flex gap-2">
              <input id="chkAll" type="checkbox" class="form-check-input mt-2">
              <button id="btnBulkDelete" class="btn btn-outline-danger" disabled><i class="lucide-trash-2"></i> Supprimer sélection</button>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead>
                <tr>
                  <th style="width:30px;"></th>
                  <th>ID</th>
                  <th>Composant</th>
                  <th>Secteur</th>
                  <th>Bâtiment</th>
                  <th>Local</th>
                  <th>Zone G</th>
                  <th>Zone D</th>
                  <th>Conformité</th>
                  <th>Statut</th>
                  <th>Risque</th>
                  <th>Dernière</th>
                  <th>Prochaine</th>
                  <th>Photo / PJ</th>
                  <th style="width:220px;">Actions</th>
                </tr>
              </thead>
              <tbody id="equipmentsTable"></tbody>
            </table>
          </div>

        </div>
      </div>
    </div>

    <!-- AJOUTER -->
    <div class="tab-pane fade" id="tab-add" role="tabpanel" aria-labelledby="add-tab">
      <div class="form-section mb-3">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h5 class="mb-0">Ajouter / Éditer un équipement</h5>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" id="btnFillBatLocal" title="Rappeler bat/local du secteur"><i class="lucide-sparkles"></i></button>
            <button class="btn btn-outline-secondary" id="btnDupLast" title="Remplir depuis le dernier type utilisé"><i class="lucide-copy"></i></button>
          </div>
        </div>
        <input type="hidden" id="equipId">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Secteur</label>
            <div class="input-group">
              <select id="secteur-input" class="form-select"></select>
              <button class="btn btn-outline-primary" id="btnAddSecteur" title="Nouveau secteur"><i class="lucide-plus"></i></button>
            </div>
          </div>
          <div class="col-md-3">
            <label class="form-label">Bâtiment</label>
            <input id="batiment-input" class="form-control">
          </div>
          <div class="col-md-3">
            <label class="form-label">Local</label>
            <input id="local-input" class="form-control">
          </div>
          <div class="col-md-3">
            <label class="form-label">Photo</label>
            <input id="photo-input" type="file" accept="image/*" class="form-control">
          </div>

          <div class="col-md-3">
            <label class="form-label">Composant</label>
            <input id="composant-input" class="form-control">
          </div>
          <div class="col-md-3">
            <label class="form-label">Fournisseur</label>
            <input id="fournisseur-input" class="form-control">
          </div>
          <div class="col-md-3">
            <label class="form-label">Type</label>
            <input id="type-input" class="form-control">
          </div>
          <div class="col-md-3">
            <label class="form-label">Identifiant</label>
            <input id="identifiant-input" class="form-control">
          </div>

          <div class="col-md-3">
            <label class="form-label">Zone Gaz (0/1/2)</label>
            <input id="zone-g-input" class="form-control" placeholder="0, 1 ou 2">
          </div>
          <div class="col-md-3">
            <label class="form-label">Zone Poussières (20/21/22)</label>
            <input id="zone-d-input" class="form-control" placeholder="20, 21 ou 22">
          </div>
          <div class="col-md-3">
            <label class="form-label">Marquage ATEX</label>
            <input id="marquage_atex-input" class="form-control" placeholder="ex: II 2G Ex d IIC T4 Gb / II 1D Ex t IIIC T80°C Da">
          </div>
          <div class="col-md-3">
            <label class="form-label">Dernière inspection</label>
            <input id="last-inspection-input" type="date" class="form-control">
          </div>

          <div class="col-12">
            <label class="form-label">Commentaires</label>
            <textarea id="comments-input" class="form-control" rows="3"></textarea>
          </div>
        </div>

        <div class="d-flex gap-2 mt-3">
          <button class="btn btn-primary" id="btnSave"><i class="lucide-save"></i> Enregistrer</button>
          <button class="btn btn-outline-secondary" id="btnCancel">Annuler</button>
          <span class="small-muted">Astuce : l’onglet s’appelle <strong>Ajouter</strong> et l’édition se fait via le bouton ✎ dans la liste.</span>
        </div>
      </div>
    </div>

    <!-- CHAT IA -->
    <div class="tab-pane fade" id="tab-chat" role="tabpanel" aria-labelledby="chat-tab">
      <div class="row g-3">
        <div class="col-lg-4">
          <div class="card h-100">
            <div class="card-body">
              <div class="hist-head">
                <h5 class="mb-0">Historique analyses</h5>
                <button id="btnClearChat" class="btn btn-outline-danger btn-sm"><i class="lucide-trash-2"></i> Effacer</button>
              </div>
              <hr>
              <ul id="iaHistoryList" class="list-group small"></ul>
            </div>
          </div>
        </div>
        <div class="col-lg-8">
          <div class="card h-100">
            <div class="card-body d-flex flex-column">
              <h5 id="chatHeader" class="mb-2"></h5>
              <div id="chatHtml" class="ia-box mb-2"></div>
              <div id="chatEnriched" class="row g-2">
                <div class="col-md-6"><div class="ia-box"><h6>Mesures palliatives</h6><div id="cardPalliatives">—</div></div></div>
                <div class="col-md-6"><div class="ia-box"><h6>Mesures préventives</h6><div id="cardPreventives">—</div></div></div>
                <div class="col-md-6"><div class="ia-box"><h6>Références & changements</h6><div id="cardRefs">—</div></div></div>
                <div class="col-md-6"><div class="ia-box"><h6>Estimations des coûts</h6><div id="cardCosts">—</div></div></div>
              </div>
              <div class="ia-thread mt-2 flex-grow-1" id="chatThread"></div>
              <div class="input-group mt-2">
                <input id="chatPrompt" class="form-control" placeholder="Demandez à l’IA…">
                <button class="btn btn-primary" id="btnSend"><i class="lucide-send"></i> Envoyer</button>
                <button class="btn btn-outline-secondary" id="btnCopier"><i class="lucide-clipboard"></i> Copier</button>
                <button class="btn btn-outline-danger" id="btnClearChat2"><i class="lucide-trash-2"></i> Effacer</button>
              </div>
            </div>
          </div>
        </div>
      </div>      
    </div>

  </div>

</div>

<!-- Offcanvas IA (panneau latéral) -->
<div class="offcanvas offcanvas-end offcanvas-ia" tabindex="-1" id="iaPanel" style="width:520px;">
  <div class="offcanvas-header">
    <div class="ia-head" id="iaHeader"></div>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-danger btn-sm" id="btnClearThread"><i class="lucide-trash-2"></i></button>
      <button class="btn btn-outline-secondary btn-sm" id="btnOpenInChat"><i class="lucide-panel-left-open"></i></button>
      <button class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
  </div>
  <div class="offcanvas-body">
    <div id="iaLoading" class="text-center small text-muted">Analyse en cours…</div>
    <div id="iaDetails" class="ia-box" style="display:none;"></div>

    <div class="row g-2">
      <div class="col-6"><div class="ia-box"><h6 class="mb-2">Mesures palliatives</h6><div id="iaPalliatives">—</div></div></div>
      <div class="col-6"><div class="ia-box"><h6 class="mb-2">Mesures préventives</h6><div id="iaPreventives">—</div></div></div>
      <div class="col-6"><div class="ia-box"><h6 class="mb-2">Références & changements</h6><div id="iaRefs">—</div></div></div>
      <div class="col-6"><div class="ia-box"><h6 class="mb-2">Estimations des coûts</h6><div id="iaCosts">—</div></div></div>
    </div>

    <div class="ia-box">
      <h6 class="mb-2">Suggestions d’achats</h6>
      <div id="autoLinks" class="small"></div>
    </div>

    <div class="ia-box">
      <h6>Discussion</h6>
      <div id="iaThread" class="ia-thread mb-2"></div>
      <div class="input-group">
        <input id="iaPrompt" class="form-control" placeholder="Poser une question…">
        <button id="iaSend" class="btn btn-primary"><i class="lucide-send"></i></button>
      </div>
    </div>
  </div>
</div>

<!-- Photo viewer -->
<div class="modal fade" id="photoModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body p-0">
        <img id="photoModalImg" src="" alt="Photo" class="img-fluid w-100">
      </div>
      <div class="modal-footer">
        <a id="photoDownload" href="#" download class="btn btn-primary">Télécharger</a>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Confirmer la suppression</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <p id="deleteMsg">Voulez-vous supprimer ?</p>
        <div id="deleteMeta" class="small text-muted"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button class="btn btn-danger" id="confirmDeleteBtn">Supprimer</button>
      </div>
    </div>
  </div>
</div>

<!-- Toasts -->
<div id="toasts" class="toast-container position-fixed bottom-0 end-0 p-3"></div>

<!-- Bootstrap + App boot -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Détermine l'account_id côté client (expose window.APP_ACCOUNT_ID)
  (function(){
    function qs(name){ const u=new URL(window.location.href); return u.searchParams.get(name); }
    const fromQS = qs('account_id');
    const saved  = localStorage.getItem('app_account_id');
    const guess  = document.body.getAttribute('data-account-id');
    const id = fromQS || saved || guess || '10';
    window.APP_ACCOUNT_ID = id;
    localStorage.setItem('app_account_id', id);
  })();
</script>

<!-- JS atex-control (core) -->
<script src="/js/atex-control.core.js"></script>
<script>
  // Branchage minimal : répare les deux boutons "Effacer discussion"
  document.addEventListener('DOMContentLoaded', () => {
    const clearCurrent = () => {
      if (window.clearCurrentThread) window.clearCurrentThread();
    };
    document.getElementById('btnClearThread')?.addEventListener('click', clearCurrent);
    document.getElementById('btnClearChat')?.addEventListener('click', () => window.clearAllThreads && window.clearAllThreads());
    document.getElementById('btnClearChat2')?.addEventListener('click', () => window.clearAllThreads && window.clearAllThreads());
  });
</script>

</body>
</html>
