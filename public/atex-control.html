<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contrôle ATEX - Équipements</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://unpkg.com/lucide@latest/dist/umd/lucide.min.css" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background-color: #f8f9fa; font-family: 'Poppins', sans-serif; color: #333; }
    .card { margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 15px; background: #fff; }
    .alert-overdue { background-color: #ffc107; color: #333; }
    .risk-low { color: #28a745; } .risk-med { color: #ffc107; } .risk-high { color: #dc3545; }
    .nav-tabs .nav-link { border-radius: 10px 10px 0 0; }
    .fixed-bottom-btns { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; padding: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
    .sparkline { width: 100px; height: 30px; }
    .last-photo { max-width: 50px; border-radius: 5px; }
    .evolution-up { color: green; } .evolution-down { color: red; } .evolution-stable { color: gray; }
    .alert-smart { background-color: #e9ecef; border-left: 5px solid #007bff; margin-bottom: 10px; padding: 10px; border-radius: 5px; }
    .small-muted { font-size: 12px; color: #6c757d; }
  </style>
</head>
<body class="container my-5">
  <h1 class="text-center mb-4">Contrôle des Équipements ATEX</h1>
  <p class="text-center lead">Outil pour inspecter, ajouter et suivre les conformités ATEX. Utilisez sur le terrain pour photos et checks automatisés.</p>
  <a href="atex-risk.html" class="btn btn-info mb-4"><i data-lucide="bar-chart"></i> Voir Risk Assessment Global</a>

  <!-- Smart Alerts -->
  <div id="smartAlerts" class="mb-4"></div>

  <!-- Onglets -->
  <ul class="nav nav-tabs" id="atexTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list" type="button" role="tab"><i data-lucide="list"></i> Liste</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="add-tab" data-bs-toggle="tab" data-bs-target="#add" type="button" role="tab"><i data-lucide="plus"></i> Ajouter/Éditer</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="import-tab" data-bs-toggle="tab" data-bs-target="#import" type="button" role="tab"><i data-lucide="upload"></i> Importer</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat" type="button" role="tab"><i data-lucide="message-circle"></i> Chat IA</button>
    </li>
  </ul>

  <div class="tab-content" id="atexTabContent">

    <!-- LISTE -->
    <div class="tab-pane fade show active" id="list" role="tabpanel">
      <!-- Analyses (graphiques) -->
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h4 class="mb-0">Analyses</h4>
          <span class="small-muted">Données issues de /api/atex-risk-global et /api/atex-equipments</span>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-3">
              <canvas id="chartConformite"></canvas>
              <div class="text-center small-muted mt-2">Conformité (Conformes / Non)</div>
            </div>
            <div class="col-md-3">
              <canvas id="chartRisques"></canvas>
              <div class="text-center small-muted mt-2">Distribution des risques (0 → 5)</div>
            </div>
            <div class="col-md-3">
              <canvas id="chartSecteurs"></canvas>
              <div class="text-center small-muted mt-2">Répartition par secteur</div>
            </div>
            <div class="col-md-3">
              <canvas id="chartEcheances"></canvas>
              <div class="text-center small-muted mt-2">Échéances d’inspection (12 mois)</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Filtres -->
      <div class="card mb-4">
        <div class="card-header"><h4>Filtres</h4></div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3"><input id="filterSecteur" class="form-control" placeholder="Secteur"></div>
            <div class="col-md-3"><input id="filterBatiment" class="form-control" placeholder="Bâtiment"></div>
            <div class="col-md-3">
              <select id="filterConformite" class="form-select">
                <option value="">Conformité (tous)</option>
                <option value="Conforme">Conforme</option>
                <option value="Non Conforme">Non Conforme</option>
              </select>
            </div>
            <div class="col-md-3"><button onclick="applyFilters()" class="btn btn-primary"><i data-lucide="search"></i> Appliquer</button></div>
          </div>
        </div>
      </div>

      <!-- Liste -->
      <div class="card">
        <div class="card-header"><h4>Liste des Équipements</h4></div>
        <div class="card-body">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>ID</th><th>Composant</th><th>Zone</th><th>Conformité</th><th>Risk</th>
                <th>Grade/Fréq.</th><th>Dernière Inspection</th><th>Prochaine</th>
                <th>Risk History</th><th>Last Photo</th><th>Évolution</th><th>Actions</th>
              </tr>
            </thead>
            <tbody id="equipmentsTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- AJOUTER / ÉDITER -->
    <div class="tab-pane fade" id="add" role="tabpanel">
      <div class="card">
        <div class="card-body">
          <form id="equipForm">
            <input type="hidden" id="equipId">
            <div class="row">
              <div class="col-md-6">
                <label>Secteur de responsabilité</label>
                <div class="input-group">
                  <select id="secteur-input" class="form-select" required></select>
                  <button class="btn btn-outline-secondary" type="button" id="btnAddSecteur" title="Ajouter un secteur">➕</button>
                </div>
                <div class="form-text">Clique sur ➕ pour créer un nouveau secteur.</div>
              </div>
              <div class="col-md-6">
                <label>Bâtiment</label>
                <input type="text" id="batiment-input" class="form-control" placeholder="Ex: B06, B11…" required>
              </div>
            </div>

            <div class="row mt-3">
              <div class="col-md-6">
                <label>Local</label>
                <input type="text" id="local-input" class="form-control" placeholder="Entrer le nom ou numéro du local" required>
              </div>
              <div class="col-md-6">
                <label>Composant</label>
                <input type="text" id="composant-input" class="form-control" placeholder="Type de composant (capteur, clapet, etc.)" required>
              </div>
            </div>

            <div class="row mt-3">
              <div class="col-md-6">
                <label>Fabricant</label>
                <input type="text" id="fournisseur-input" class="form-control" placeholder="Ex: IFM, E+H, Siemens…" required>
              </div>
              <div class="col-md-6">
                <label>Type (référence fabricant)</label>
                <input type="text" id="type-input" class="form-control" placeholder="Entrer la référence fabricant" required>
              </div>
            </div>

            <div class="row mt-3">
              <div class="col-md-6">
                <label>Identifiant</label>
                <input type="text" id="identifiant-input" class="form-control" placeholder="Entrer l’identifiant du capteur par exemple" required>
              </div>
              <div class="col-md-6">
                <label>Marquage ATEX</label>
                <input type="text" id="marquage_atex-input" class="form-control" placeholder="Ex : II 3G IIA T4" required>
              </div>
            </div>

            <!-- Photo + Commentaires -->
            <div class="row mt-3">
              <div class="col-md-6">
                <label>Photo / Document</label>
                <input type="file" id="photo-input" class="form-control" accept="image/*,.pdf">
                <div class="form-text">Tu peux ajouter une photo et/ou un document.</div>
              </div>
              <div class="col-md-6">
                <label>Commentaires</label>
                <textarea id="comments-input" class="form-control" placeholder="Note interne, contexte, etc."></textarea>
              </div>
            </div>

            <button type="button" onclick="saveEquipment()" class="btn btn-success mt-4">
              <i data-lucide="save"></i> Enregistrer
            </button>
            <button type="button" onclick="clearForm()" class="btn btn-secondary mt-4">
              <i data-lucide="x"></i> Annuler
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- IMPORTER -->
    <div class="tab-pane fade" id="import" role="tabpanel">
      <div class="card">
        <div class="card-body">
          <p><strong>Colonnes minimales requises</strong> pour un import à minima :</p>
          <div class="mb-2">
            <span class="badge bg-light text-dark">Secteur de responsabilité</span>
            <span class="badge bg-light text-dark">Local</span>
            <span class="badge bg-light text-dark">Composant</span>
            <span class="badge bg-light text-dark">Fabricant</span>
            <span class="badge bg-light text-dark">Type</span>
            <span class="badge bg-light text-dark">Identifiant</span>
            <span class="badge bg-light text-dark">Marquage ATEX</span>
          </div>
          <p class="small-muted">Les autres colonnes sont ignorées si non reconnues. Vous pouvez importer beaucoup de lignes en une fois.</p>

          <div class="mb-3 d-flex gap-2">
            <button id="btnTemplateCSV" class="btn btn-outline-secondary btn-sm">Télécharger modèle CSV</button>
            <button id="btnTemplateXLSX" class="btn btn-outline-secondary btn-sm">Télécharger modèle XLSX</button>
          </div>

          <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" class="form-control mb-2">
          <button onclick="importExcel()" class="btn btn-primary">
            <i data-lucide="upload"></i> Importer
          </button>
        </div>
      </div>
    </div>

    <!-- CHAT IA -->
    <div class="tab-pane fade" id="chat" role="tabpanel">
      <div class="card">
        <div class="card-body">
          <textarea id="chatInput" class="form-control" placeholder="Posez une question sur l'ATEX..."></textarea>
          <button class="btn btn-primary mt-2" id="btnSendChat"><i data-lucide="send"></i> Envoyer</button>
          <div id="chatResponse" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Boutons fixes bas (on garde uniquement Sync) -->
  <div class="fixed-bottom-btns text-center">
    <button onclick="syncData()" class="btn btn-info"><i data-lucide="refresh-cw"></i> Sync</button>
  </div>

  <!-- Modal Ajout Secteur -->
  <div class="modal fade" id="modalSecteur" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Nouveau secteur</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <input id="newSecteurName" class="form-control" placeholder="Nom du secteur">
          <div id="secteurSaveMsg" class="small-muted mt-2"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button class="btn btn-primary" id="saveSecteurBtn">Enregistrer</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Icônes
    if (window.lucide) { window.lucide.createIcons(); }

    // API : on passe en relatif (même host)
    const API = {
      secteurs: '/api/atex-secteurs',
      equipments: '/api/atex-equipments',
      equipment: (id) => '/api/atex-equipments/' + id,
      importExcel: '/api/atex-import-excel',
      analysis: '/api/atex-analysis',
      riskGlobal: '/api/atex-risk-global',
      chat: '/api/atex-chat'
    };

    // État & Charts
    let equipments = [];
    let charts = {};

    // Wiring au chargement
    window.addEventListener('DOMContentLoaded', function(){
      loadSecteurs();
      loadEquipments().then(loadStatsAndBuildCharts);
      loadSmartAlerts();

      document.getElementById('btnAddSecteur').addEventListener('click', openModalSecteur);
      document.getElementById('saveSecteurBtn').addEventListener('click', saveSecteur);
      document.getElementById('btnTemplateCSV').addEventListener('click', downloadTemplateCSV);
      document.getElementById('btnTemplateXLSX').addEventListener('click', downloadTemplateXLSX);
      document.getElementById('btnSendChat').addEventListener('click', sendChat);
    });

    /* ======= LISTE / ANALYSES ======= */
    async function loadSmartAlerts() {
      try {
        const r = await fetch(API.analysis);
        const alerts = await r.json();
        document.getElementById('smartAlerts').innerHTML =
          alerts.map(function(a){ return '<div class="alert-smart">'+a.text+'</div>'; }).join('');
      } catch(e){ console.error('Erreur loadSmartAlerts:', e); }
    }

    async function loadEquipments() {
      try {
        const response = await fetch(API.equipments);
        if (!response.ok) throw new Error('Erreur chargement liste');
        equipments = await response.json();
        renderTable();
      } catch (error) {
        console.error('Erreur loadEquipments:', error);
        alert('Erreur chargement liste: ' + error.message);
      }
    }

    function renderTable(filtered) {
      var list = Array.isArray(filtered) ? filtered : equipments;
      var tableBody = document.getElementById('equipmentsTable');
      tableBody.innerHTML = '';
      list.forEach(function(eq){
        var riskClass = (typeof eq.risque === 'number' && eq.risque <= 1) ? 'risk-low' : ((eq.risque <= 3) ? 'risk-med' : 'risk-high');
        var tr = document.createElement('tr');
        tr.innerHTML =
          '<td>'+ (eq.id||'') +'</td>'+
          '<td>'+ (eq.composant||'') +'</td>'+
          '<td>'+ (eq.interieur || eq.exterieur || 'N/A') +'</td>'+
          '<td>'+ (eq.conformite||'') +'</td>'+
          '<td class="'+riskClass+'">'+ (eq.risque!=null? eq.risque : '') +'</td>'+
          '<td>'+ ((eq.grade||'')+'/'+(eq.frequence||'')) +'</td>'+
          '<td>'+ (eq.last_inspection_date || 'N/A') +'</td>'+
          '<td>'+ (eq.next_inspection_date || 'N/A') +'</td>'+
          '<td><canvas class="sparkline" id="spark-'+eq.id+'"></canvas></td>'+
          '<td><img class="last-photo" src="'+(eq.photo || 'no-photo.jpg')+'" alt="Photo"></td>'+
          '<td class="evolution-stable">'+ (eq.evolution || 'Stable') +'</td>'+
          '<td>'+
            '<button class="btn btn-sm btn-outline-primary" onclick="editEquipment('+eq.id+')">Éditer</button> '+
            '<button class="btn btn-sm btn-outline-danger" onclick="deleteEquipment('+eq.id+')">Supprimer</button>'+
          '</td>';
        tableBody.appendChild(tr);
        // spark
        var canvas = document.getElementById('spark-'+eq.id);
        if (canvas && typeof Chart !== 'undefined') {
          var prev = (typeof eq.risque === 'number') ? Math.max(eq.risque - 1, 0) : 0;
          var next = (typeof eq.risque === 'number') ? Math.min(eq.risque + 1, 5) : 0;
          new Chart(canvas, {
            type: 'line',
            data: { labels: ['1','2','3'], datasets: [{ data: [prev, eq.risque||0, next], borderWidth: 1, fill: false }] },
            options: { responsive:true, maintainAspectRatio:false, scales:{x:{display:false},y:{display:false}}, elements:{point:{radius:0}}, plugins:{legend:{display:false}} }
          });
        }
      });
    }

    function applyFilters() {
      var s = (document.getElementById('filterSecteur').value || '').toLowerCase();
      var b = (document.getElementById('filterBatiment').value || '').toLowerCase();
      var c = document.getElementById('filterConformite').value;
      var filtered = equipments.filter(function(eq){
        var okS = !s || ((eq.secteur||'').toLowerCase().indexOf(s) >= 0);
        var okB = !b || ((eq.batiment||'').toLowerCase().indexOf(b) >= 0);
        var okC = !c || ((eq.conformite||'') === c);
        return okS && okB && okC;
      });
      renderTable(filtered);
    }

    async function loadStatsAndBuildCharts(){
      try{
        var r = await fetch(API.riskGlobal);
        var json = await r.json();
        var stats = json.stats || {};
        // doughnut conformité
        buildOrUpdateChart('chartConformite', 'doughnut', {
          labels: ['Conformes','Non Conformes'],
          datasets: [{ data: [stats.conformes||0, stats.non_conformes||0] }]
        }, {});
        // répartition risques
        var riskBuckets = [0,1,2,3,4,5].map(function(){return 0;});
        equipments.forEach(function(e){
          if (typeof e.risque === 'number' && e.risque>=0 && e.risque<=5) riskBuckets[e.risque]++;
        });
        buildOrUpdateChart('chartRisques', 'bar', {
          labels: ['0','1','2','3','4','5'],
          datasets: [{ label:'Nb', data: riskBuckets }]
        }, { scales: { y: { beginAtZero: true } }});
        // par secteur
        var bySecteur = {};
        equipments.forEach(function(e){ var k = e.secteur || 'N/A'; bySecteur[k] = (bySecteur[k]||0)+1; });
        buildOrUpdateChart('chartSecteurs', 'bar', {
          labels: Object.keys(bySecteur),
          datasets: [{ label:'Équipements', data: Object.values(bySecteur) }]
        }, { indexAxis: 'y', scales:{ x:{ beginAtZero: true } }});
        // échéances 12 mois
        var buckets = new Array(12).fill(0);
        var now = new Date();
        equipments.forEach(function(e){
          if (!e.next_inspection_date) return;
          var d = new Date(e.next_inspection_date);
          var diffM = (d.getFullYear()-now.getFullYear())*12 + (d.getMonth()-now.getMonth());
          if (diffM>=0 && diffM<12) buckets[diffM]++;
        });
        var labelsMonths = [];
        for (var i=0;i<12;i++){
          var dt = new Date(now.getFullYear(), now.getMonth()+i, 1);
          labelsMonths.push(dt.toLocaleString('fr-FR', { month:'short' }));
        }
        buildOrUpdateChart('chartEcheances', 'line', {
          labels: labelsMonths,
          datasets: [{ label:'Contrôles à venir', data: buckets, fill:false }]
        }, {});
      } catch(e){ console.error('Erreur charts:', e); }
    }

    function buildOrUpdateChart(id, type, data, options){
      var ctx = document.getElementById(id);
      if (!ctx || typeof Chart === 'undefined') return;
      if (charts[id]) { charts[id].data = data; charts[id].options = options; charts[id].update(); }
      else { charts[id] = new Chart(ctx, { type: type, data: data, options: options }); }
    }

    /* ======= AJOUTER / ÉDITER ======= */
    async function loadSecteurs() {
      try {
        const response = await fetch(API.secteurs);
        const secteurs = await response.json();
        const select = document.getElementById('secteur-input');
        select.innerHTML = '<option value="" disabled selected>— Sélectionner —</option>';
        secteurs.forEach(function(s){
          var option = document.createElement('option');
          option.value = s.name;
          option.text = s.name;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Erreur loadSecteur:', error);
      }
    }

    function openModalSecteur(){
      var modal = new bootstrap.Modal(document.getElementById('modalSecteur'));
      document.getElementById('newSecteurName').value = '';
      document.getElementById('secteurSaveMsg').textContent = '';
      modal.show();
    }

    async function saveSecteur(){
      var name = (document.getElementById('newSecteurName').value || '').trim();
      if (!name) { document.getElementById('secteurSaveMsg').textContent = 'Nom requis.'; return; }
      try{
        var r = await fetch(API.secteurs, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ name: name })
        });
        if (!r.ok) throw new Error('Erreur API');
        await loadSecteurs();
        document.getElementById('secteur-input').value = name;
        document.getElementById('secteurSaveMsg').textContent = 'Enregistré.';
        setTimeout(function(){ bootstrap.Modal.getInstance(document.getElementById('modalSecteur')).hide(); }, 500);
      } catch(e){
        document.getElementById('secteurSaveMsg').textContent = 'Erreur: ' + (e.message||e);
      }
    }

    function syncData() {
      loadEquipments().then(loadStatsAndBuildCharts);
      alert('Données synchronisées !');
    }

    function clearForm() {
      document.getElementById('equipId').value = '';
      document.getElementById('secteur-input').value = '';
      document.getElementById('batiment-input').value = '';
      document.getElementById('local-input').value = '';
      document.getElementById('composant-input').value = '';
      document.getElementById('fournisseur-input').value = '';
      document.getElementById('type-input').value = '';
      document.getElementById('identifiant-input').value = '';
      document.getElementById('marquage_atex-input').value = '';
      document.getElementById('photo-input').value = '';
      document.getElementById('comments-input').value = '';
    }

    async function saveEquipment() {
      var id = document.getElementById('equipId').value;
      var data = {
        secteur: document.getElementById('secteur-input').value,
        batiment: document.getElementById('batiment-input').value,
        local: document.getElementById('local-input').value,
        composant: document.getElementById('composant-input').value,
        fournisseur: document.getElementById('fournisseur-input').value,
        type: document.getElementById('type-input').value,
        identifiant: document.getElementById('identifiant-input').value,
        marquage_atex: document.getElementById('marquage_atex-input').value,
        comments: document.getElementById('comments-input').value,
        photo: await getBase64(document.getElementById('photo-input').files[0])
      };
      var method = id ? 'PUT' : 'POST';
      var url = id ? API.equipment(id) : API.equipments;
      try {
        var response = await fetch(url, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (!response.ok) throw new Error('Erreur enregistrement');
        alert('Équipement sauvegardé !');
        await loadEquipments();
        await loadStatsAndBuildCharts();
        clearForm();
      } catch (error) {
        alert('Erreur: ' + error.message);
      }
    }

    function getBase64(file) {
      return new Promise(function(resolve, reject){
        if (!file) return resolve(null);
        var reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function(){ resolve(reader.result); };
        reader.onerror = function(err){ reject(err); };
      });
    }

    async function editEquipment(id) {
      try {
        var response = await fetch(API.equipment(id));
        if (!response.ok) throw new Error('Erreur chargement équipement');
        var eq = await response.json();
        document.getElementById('equipId').value = eq.id;
        document.getElementById('secteur-input').value = eq.secteur || '';
        document.getElementById('batiment-input').value = eq.batiment || '';
        document.getElementById('local-input').value = eq.local || '';
        document.getElementById('composant-input').value = eq.composant || '';
        document.getElementById('fournisseur-input').value = eq.fournisseur || '';
        document.getElementById('type-input').value = eq.type || '';
        document.getElementById('identifiant-input').value = eq.identifiant || '';
        document.getElementById('marquage_atex-input').value = eq.marquage_atex || '';
        document.getElementById('comments-input').value = eq.comments || '';
        document.getElementById('add-tab').click();
      } catch (error) {
        alert('Erreur édition: ' + error.message);
      }
    }

    async function deleteEquipment(id) {
      if (!confirm('Confirmer suppression ?')) return;
      try {
        var response = await fetch(API.equipment(id), { method: 'DELETE' });
        if (!response.ok) throw new Error('Erreur suppression');
        alert('Supprimé !');
        await loadEquipments();
        await loadStatsAndBuildCharts();
      } catch (error) {
        alert('Erreur: ' + error.message);
      }
    }

    /* ======= IMPORTER ======= */
    async function importExcel() {
      var file = document.getElementById('excelFile').files[0];
      if (!file) return alert('Sélectionnez un fichier (CSV ou Excel)');
      var formData = new FormData();
      formData.append('excel', file);
      try {
        var response = await fetch(API.importExcel, { method: 'POST', body: formData });
        if (!response.ok) throw new Error('Erreur import');
        alert('Import réussi !');
        await loadEquipments();
        await loadStatsAndBuildCharts();
      } catch (error) {
        alert('Erreur import: ' + error.message);
      }
    }

    function downloadTemplateCSV(){
      var headers = ['Secteur de responsabilité','Local','Composant','Fabricant','Type','Identifiant','Marquage ATEX'];
      var rows = [
        ['Utilities','L-203','Capteur','IFM','PN7092','CAPT-0123','II 3G IIA T4'],
        ['Maintenance','Salle compresseurs','Clapet','Siemens','3RW40 11-1BB14','CLAP-0007','II 3G IIB T3']
      ];
      var out = [headers.join(',')];
      rows.forEach(function(r){
        out.push(r.map(function(x){ return '"' + String(x).replace(/"/g,'""') + '"'; }).join(','));
      });
      var csv = out.join('\n');
      var blob = new Blob([csv], { type:'text/csv;charset=utf-8' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a'); a.href = url; a.download = 'modele-atex.csv'; a.click();
      setTimeout(function(){ URL.revokeObjectURL(url); }, 500);
    }
    function downloadTemplateXLSX(){ downloadTemplateCSV(); } // simple fallback

    /* ======= CHAT IA ======= */
    async function sendChat() {
      var input = (document.getElementById('chatInput').value || '').trim();
      if (!input) return alert('Entrez une question');
      try {
        var response = await fetch(API.chat, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question: input })
        });
        var data = await response.json();
        var text = data && (data.response || data.answer || JSON.stringify(data));
        document.getElementById('chatResponse').textContent = text || '(réponse vide)';
      } catch (error) {
        document.getElementById('chatResponse').textContent = 'Erreur chat: ' + error.message;
      }
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
