<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Contrôle ATEX - Équipements</title>

  <!-- Design conservé -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root{
      --actions-min-width: 280px;
      --offcanvas-w: clamp(400px, 38vw, 560px);
    }
    body{ background:#f8f9fa; font-family:'Poppins',sans-serif; color:#333; }
    .card{ border-radius:14px; box-shadow:0 4px 10px rgba(0,0,0,.06); }
    .table-responsive{ overflow-x:auto; }
    .last-photo{ max-width:52px; border-radius:6px; cursor:zoom-in; }

    /* Actions en tableau : aucune superposition */
    td.actions{
      min-width:var(--actions-min-width);
    }
    @media (max-width: 992px){
      td.actions{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap:.5rem;
      }
      td.actions .btn{ width:100%; }
    }
    @media (max-width: 576px){
      td.actions{ grid-template-columns: 1fr; }
    }

    /* Offcanvas IA : lisible + scrollable, sans backdrop pour garder la visu de la ligne */
    .offcanvas-ia{
      --bs-offcanvas-width: var(--offcanvas-w);
    }
    #iaPanel{
      border-left:1px solid #e5e7eb;
    }
    #iaPanel .offcanvas-body{
      display:flex; flex-direction:column; gap:1rem;
      padding-top:.75rem;
    }
    .ia-history{
      border:1px solid #e9ecef; border-radius:10px; overflow:hidden;
      max-height: 55vh; overflow-y: auto; background:#fff;
    }
    .ia-item{ cursor:pointer; }
    .ia-item.active{ background:#eef2ff; border-left:3px solid #0d6efd; }
    .ia-details{
      border:1px solid #e9ecef; border-radius:10px; background:#fff;
      max-height: 55vh; overflow:auto; padding:1rem;
    }
    .ia-badges .badge{ margin-left:.25rem; }

    /* Petites améliorations lisibilité */
    .small-muted{ font-size:.85rem; color:#6c757d; }
    .form-text{ color:#6c757d; }
  </style>
</head>
<body class="container my-5">

  <h1 class="text-center mb-2">Contrôle des Équipements ATEX</h1>
  <p class="text-center lead mb-4">Inspecter, ajouter et suivre les conformités ATEX.</p>

  <!-- Onglets -->
  <ul class="nav nav-tabs" id="atexTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list" type="button" role="tab">
        <i data-lucide="list"></i> Liste
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="add-tab" data-bs-toggle="tab" data-bs-target="#add" type="button" role="tab">
        <i data-lucide="plus"></i> Ajouter/Éditer
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat" type="button" role="tab">
        <i data-lucide="bot"></i> Chat IA
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="import-tab" data-bs-toggle="tab" data-bs-target="#import" type="button" role="tab">
        <i data-lucide="upload"></i> Importer
      </button>
    </li>
  </ul>

  <div class="tab-content mt-3" id="atexTabContent">
    <!-- LISTE -->
    <div class="tab-pane fade show active" id="list" role="tabpanel">
      <div class="card mb-3">
        <div class="card-header"><h5 class="mb-0">Filtres</h5></div>
        <div class="card-body">
          <div class="row g-2">
            <div class="col-md-3"><input id="filterSecteur" class="form-control" placeholder="Secteur"></div>
            <div class="col-md-3"><input id="filterBatiment" class="form-control" placeholder="Bâtiment"></div>
            <div class="col-md-3">
              <select id="filterConformite" class="form-select">
                <option value="">Conformité (tous)</option>
                <option value="Conforme">Conforme</option>
                <option value="Non Conforme">Non Conforme</option>
              </select>
            </div>
            <div class="col-md-3 d-grid d-md-block">
              <button id="btnApplyFilters" class="btn btn-primary"><i data-lucide="search"></i> Appliquer</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Liste des Équipements</h5>
          <div class="d-flex gap-2 flex-wrap">
            <button id="btnSync" class="btn btn-info"><i data-lucide="refresh-cw"></i> Sync</button>
          </div>
        </div>
        <div class="card-body table-responsive">
          <table class="table table-striped align-middle">
            <thead>
              <tr>
                <th>ID</th><th>Composant</th><th>Secteur</th><th>Bâtiment</th>
                <th>Local</th><th>Zone</th><th>Conformité</th><th>Risque</th>
                <th>Dernière</th><th>Prochaine</th><th>Photo</th><th style="min-width:var(--actions-min-width)">Actions</th>
              </tr>
            </thead>
            <tbody id="equipmentsTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- AJOUTER / ÉDITER -->
    <div class="tab-pane fade" id="add" role="tabpanel">
      <div class="card">
        <div class="card-body">
          <form id="equipForm" novalidate>
            <input type="hidden" id="equipId">
            <div class="row">
              <div class="col-md-6">
                <label class="form-label">Secteur</label>
                <div class="input-group">
                  <select id="secteur-input" class="form-select" required></select>
                  <button class="btn btn-outline-secondary" type="button" id="btnAddSecteur" title="Ajouter un secteur">➕</button>
                </div>
                <div class="form-text">Clique sur ➕ pour créer un nouveau secteur.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Bâtiment</label>
                <input id="batiment-input" class="form-control" required placeholder="Ex: B06, B11…">
              </div>
            </div>

            <div class="row mt-3">
              <div class="col-md-6">
                <label class="form-label">Local</label>
                <input id="local-input" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Zone ATEX</label>
                <select id="zone-input" class="form-select" required>
                  <option value="" disabled selected>— Sélectionner —</option>
                  <option value="0">0 (Gaz)</option>
                  <option value="1">1 (Gaz)</option>
                  <option value="2">2 (Gaz)</option>
                  <option value="20">20 (Poussières)</option>
                  <option value="21">21 (Poussières)</option>
                  <option value="22">22 (Poussières)</option>
                </select>
              </div>
            </div>

            <div class="row mt-3">
              <div class="col-md-6">
                <label class="form-label">Composant*</label>
                <input id="composant-input" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Fabricant*</label>
                <input id="fournisseur-input" class="form-control" required>
              </div>
            </div>

            <div class="row mt-3">
              <div class="col-md-6">
                <label class="form-label">Type (référence)*</label>
                <input id="type-input" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Identifiant</label>
                <input id="identifiant-input" class="form-control">
              </div>
            </div>

            <div class="row mt-3">
              <div class="col-md-6">
                <label class="form-label">Marquage ATEX*</label>
                <input id="marquage_atex-input" class="form-control" placeholder="II 3G IIA T4" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Dernière inspection</label>
                <input type="date" id="last-inspection-input" class="form-control">
                <div class="form-text">La prochaine sera recalculée.</div>
              </div>
            </div>

            <div class="row mt-3">
              <div class="col-md-6">
                <label class="form-label">Photo / Doc</label>
                <input type="file" id="photo-input" class="form-control" accept="image/*,.pdf">
              </div>
              <div class="col-md-6">
                <label class="form-label">Commentaires</label>
                <textarea id="comments-input" class="form-control" rows="2"></textarea>
              </div>
            </div>

            <div class="mt-4 d-flex gap-2 flex-wrap">
              <button type="button" id="btnSave" class="btn btn-success"><i data-lucide="save"></i> Enregistrer</button>
              <button type="button" id="btnClear" class="btn btn-secondary"><i data-lucide="x"></i> Annuler</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- CHAT IA (lecture confortable) -->
    <div class="tab-pane fade" id="chat" role="tabpanel">
      <div class="row g-3">
        <div class="col-lg-4">
          <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
              <strong><i data-lucide="history"></i> Historique</strong>
              <button class="btn btn-sm btn-outline-secondary" id="btnClearChat"><i data-lucide="eraser"></i> Effacer</button>
            </div>
            <div class="card-body p-0">
              <ul class="list-group list-group-flush" id="iaHistoryListChat" style="max-height:60vh; overflow:auto"></ul>
            </div>
          </div>
        </div>
        <div class="col-lg-8">
          <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
              <strong><i data-lucide="bot"></i> Aide AutonomiX IA</strong>
              <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary" id="btnReanalyse"><i data-lucide="sparkles"></i> Ré‑analyser</button>
                <button class="btn btn-sm btn-outline-secondary" id="btnCopier"><i data-lucide="copy"></i> Copier</button>
              </div>
            </div>
            <div class="card-body">
              <div id="chatLoading" class="text-center text-muted" style="display:none">
                <div class="spinner-border" role="status" aria-hidden="true"></div>
                <div class="mt-2">Analyse en cours…</div>
              </div>
              <div id="chatHeader" class="mb-2 small-muted"></div>
              <div id="chatHtml" class="border rounded p-3" style="min-height:220px"></div>
              <hr>
              <div id="chatEnriched" class="mt-3" style="display:none">
                <h6>Synthèse actionnable</h6>
                <div id="chatWhy" class="mb-2"></div>
                <div class="row g-3">
                  <div class="col-md-6">
                    <div class="border rounded p-3 h-100">
                      <strong>Mesures palliatives</strong>
                      <ul id="chatPalliative" class="mb-0"></ul>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="border rounded p-3 h-100">
                      <strong>Mesures préventives</strong>
                      <ul id="chatPreventive" class="mb-0"></ul>
                    </div>
                  </div>
                </div>
                <div class="row g-3 mt-1">
                  <div class="col-md-6">
                    <div class="border rounded p-3 h-100">
                      <strong>Références & changements</strong>
                      <ul id="chatRefs" class="mb-0"></ul>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="border rounded p-3 h-100">
                      <strong>Estimation des coûts</strong>
                      <ul id="chatCosts" class="mb-0"></ul>
                    </div>
                  </div>
                </div>
                <div class="mt-2"><span class="badge text-bg-light">Conseils générés à partir des données actuelles</span></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- IMPORT -->
    <div class="tab-pane fade" id="import" role="tabpanel">
      <div class="card">
        <div class="card-body">
          <p><strong>Colonnes minimales requises</strong> (ordre attendu) :</p>
          <div class="mb-2">
            <span class="badge bg-light text-dark">secteur</span>
            <span class="badge bg-light text-dark">batiment</span>
            <span class="badge bg-light text-dark">local</span>
            <span class="badge bg-light text-dark">composant</span>
            <span class="badge bg-light text-dark">fournisseur</span>
            <span class="badge bg-light text-dark">type</span>
            <span class="badge bg-light text-dark">identifiant</span>
            <span class="badge bg-light text-dark">type_de_zone</span>
            <span class="badge bg-light text-dark">marquage_atex</span>
            <span class="badge bg-light text-dark">last_inspection_date</span>
          </div>
          <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" class="form-control mb-3">
          <button id="btnImport" class="btn btn-primary"><i data-lucide="upload"></i> Importer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Photo -->
  <div class="modal fade" id="photoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Photo</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body text-center"><img id="photoModalImg" src="" class="img-fluid" alt="Photo équipement"></div>
        <div class="modal-footer"><a id="photoDownload" class="btn btn-outline-secondary" download>Télécharger</a><button class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button></div>
      </div>
    </div>
  </div>

  <!-- Modal Suppression -->
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title text-danger"><i data-lucide="trash-2"></i> Confirmer la suppression</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <p>Voulez-vous vraiment supprimer cet équipement ATEX ?</p>
          <div id="deleteMeta" class="small-muted"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button class="btn btn-danger" id="confirmDeleteBtn">Supprimer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Offcanvas IA (latéral, lecture rapide). Aucun chevauchement, boutons rangés. -->
  <div class="offcanvas offcanvas-end offcanvas-ia" tabindex="-1" id="iaPanel" data-bs-scroll="true" data-bs-backdrop="false" aria-labelledby="iaPanelLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="iaPanelLabel"><i data-lucide="bot"></i> Aide AutonomiX IA</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <div class="row g-3">
        <div class="col-12">
          <div id="iaHeader" class="small-muted"></div>
          <div class="ia-badges mb-2"></div>
        </div>
        <div class="col-12">
          <div class="ia-history">
            <ul class="list-group list-group-flush" id="iaHistoryList"></ul>
          </div>
        </div>
        <div class="col-12">
          <div id="iaLoading" class="text-center text-muted" style="display:none">
            <div class="spinner-border" role="status" aria-hidden="true"></div>
            <div class="mt-2">Analyse en cours…</div>
          </div>
          <div id="iaDetails" class="ia-details" style="display:none"></div>
        </div>
        <div class="col-12 d-flex gap-2 flex-wrap">
          <button class="btn btn-outline-primary" id="btnOpenInChat"><i data-lucide="panel-right-open"></i> Ouvrir dans Chat IA</button>
          <button class="btn btn-outline-secondary" id="btnClearChat2"><i data-lucide="eraser"></i> Effacer historique</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toast-container position-fixed top-0 end-0 p-3" id="toasts" style="z-index: 2000;"></div>

  <script>
    if (window.lucide){ window.lucide.createIcons(); }

    // ================== API ==================
    const API = {
      secteurs: '/api/atex-secteurs',
      equipments: '/api/atex-equipments',
      equipment: (id) => '/api/atex-equipments/' + id,
      importExcel: '/api/atex-import-excel',
      inspect: '/api/atex-inspect',
      help: (id) => '/api/atex-help/' + id
    };

    // ================== STATE ==================
    let equipments = [];
    let currentIA = null; // équipement courant pour IA
    const CHAT_KEY = 'atexIAHistoryV3';

    // ================== HELPERS ==================
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    function showToast(message, variant='primary'){
      const id='t'+Date.now();
      const html = `
        <div id="${id}" class="toast text-bg-${variant} border-0 mb-2" role="alert">
          <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        </div>`;
      $('#toasts').insertAdjacentHTML('beforeend', html);
      const t = new bootstrap.Toast($('#'+id), {delay:3000}); t.show();
      setTimeout(()=> $('#'+id)?.remove(), 3500);
    }

    function fmtDate(d){
      if(!d) return 'N/A';
      const date = new Date(d); if(isNaN(date)) return d;
      const dd=String(date.getDate()).padStart(2,'0'), mm=String(date.getMonth()+1).padStart(2,'0'), yyyy=date.getFullYear();
      return `${dd}-${mm}-${yyyy}`;
    }

    function getChatHistory(){ try{ return JSON.parse(localStorage.getItem(CHAT_KEY) || '[]'); }catch{return []} }
    function setChatHistory(h){ localStorage.setItem(CHAT_KEY, JSON.stringify(h)); }
    function addToHistory(item){
      const h=getChatHistory();
      h.unshift(item);
      setChatHistory(h.slice(0,100));
      renderHistory(); renderHistoryChat();
    }

    // ================== STARTUP ==================
    document.addEventListener('DOMContentLoaded', () => {
      // liste
      $('#btnApplyFilters').addEventListener('click', applyFilters);
      $('#btnSync').addEventListener('click', loadEquipments);
      // form
      $('#btnSave').addEventListener('click', saveEquipment);
      $('#btnClear').addEventListener('click', clearForm);
      $('#btnAddSecteur').addEventListener('click', openModalSecteur);
      // import
      $('#btnImport').addEventListener('click', importExcel);
      // chat onglet
      $('#btnClearChat').addEventListener('click', clearChatHistory);
      $('#btnReanalyse').addEventListener('click', () => currentIA && openIA(currentIA, {forceReload:true, openChat:true}));
      $('#btnCopier').addEventListener('click', copyChat);
      // offcanvas
      $('#btnOpenInChat').addEventListener('click', ()=> { bootstrap.Offcanvas.getOrCreateInstance($('#iaPanel')).hide(); $('#chat-tab').click(); });
      $('#btnClearChat2').addEventListener('click', clearChatHistory);

      loadSecteurs();
      loadEquipments();
      renderHistory(); renderHistoryChat();
    });

    // ================== LISTE ==================
    async function loadEquipments(){
      try{
        const r = await fetch(API.equipments);
        if(!r.ok) throw new Error('Erreur chargement');
        equipments = await r.json();
        renderTable();
        showToast('Données synchronisées','info');
      }catch(e){ showToast('Erreur: '+(e.message||e),'danger'); }
    }

    function renderTable(list=equipments){
      const tbody = $('#equipmentsTable'); tbody.innerHTML='';
      list.forEach(eq=>{
        const zone = eq.zone_type || eq.exterieur || eq.interieur || '—';
        const risk = eq.risque ?? '—';
        const isNC = String(eq.conformite||'').toLowerCase().includes('non');

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${eq.id ?? ''}</td>
          <td>${eq.composant || ''}</td>
          <td>${eq.secteur || ''}</td>
          <td>${eq.batiment || ''}</td>
          <td>${eq.local || ''}</td>
          <td>${zone}</td>
          <td>${eq.conformite || ''}</td>
          <td>${risk}</td>
          <td>${fmtDate(eq.last_inspection_date)}</td>
          <td>${fmtDate(eq.next_inspection_date)}</td>
          <td>${eq.photo ? `<img class="last-photo" src="${eq.photo}" alt="Photo" onclick="openPhoto('${encodeURIComponent(eq.photo)}')">` : '<span class="text-muted">—</span>'}</td>
          <td class="actions">
            <button class="btn btn-sm btn-outline-primary" onclick="editEquipment(${eq.id})"><i data-lucide="edit-3"></i> Éditer</button>
            <button class="btn btn-sm btn-outline-danger" onclick="openDeleteModal(${eq.id}, '${(eq.composant||'').replace(/'/g,"\\'")}')"><i data-lucide="trash-2"></i> Supprimer</button>
            <button class="btn btn-sm ${isNC?'btn-warning':'btn-outline-secondary'}" onclick="openIA(${eq.id})"><i data-lucide="sparkles"></i> Aide AutonomiX IA</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      window.lucide?.createIcons();
    }

    function applyFilters(){
      const s = ($('#filterSecteur').value||'').toLowerCase();
      const b = ($('#filterBatiment').value||'').toLowerCase();
      const c = $('#filterConformite').value;
      const filtered = equipments.filter(eq =>
        (!s || (eq.secteur||'').toLowerCase().includes(s)) &&
        (!b || (eq.batiment||'').toLowerCase().includes(b)) &&
        (!c || (eq.conformite||'') === c)
      );
      renderTable(filtered);
    }

    // ================== PHOTO ==================
    function openPhoto(encoded){
      const src = decodeURIComponent(encoded);
      $('#photoModalImg').src = src;
      $('#photoDownload').href = src;
      bootstrap.Modal.getOrCreateInstance($('#photoModal')).show();
    }
    window.openPhoto = openPhoto;

    // ================== SECTEURS ==================
    async function loadSecteurs(){
      try{
        const r = await fetch(API.secteurs);
        const secteurs = await r.json();
        const sel = $('#secteur-input');
        sel.innerHTML = '<option value="" disabled selected>— Sélectionner —</option>';
        secteurs.forEach(s=>{
          const o=document.createElement('option'); o.value=s.name; o.text=s.name; sel.appendChild(o);
        });
      }catch(e){}
    }
    function openModalSecteur(){
      const html=`
      <div class="modal fade" id="modalSecteur" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">Nouveau secteur</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <input id="newSecteurName" class="form-control" placeholder="Nom du secteur">
            <div id="secteurSaveMsg" class="small-muted mt-2"></div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            <button class="btn btn-primary" id="saveSecteurBtn">Enregistrer</button>
          </div>
        </div></div>
      </div>`;
      document.body.insertAdjacentHTML('beforeend', html);
      const el = $('#modalSecteur'), modal = new bootstrap.Modal(el); modal.show();
      el.querySelector('#saveSecteurBtn').addEventListener('click', async ()=>{
        const name=(el.querySelector('#newSecteurName').value||'').trim();
        if(!name){ el.querySelector('#secteurSaveMsg').textContent='Nom requis.'; return; }
        try{
          const r = await fetch(API.secteurs,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name})});
          if(!r.ok) throw new Error('Erreur API');
          await loadSecteurs(); $('#secteur-input').value=name; showToast('Secteur enregistré','success'); modal.hide(); el.remove();
        }catch(err){ el.querySelector('#secteurSaveMsg').textContent='Erreur: '+(err.message||err); }
      }, {once:true});
      el.addEventListener('hidden.bs.modal', ()=> el.remove(), {once:true});
    }

    // ================== FORM ==================
    function clearForm(){
      $('#equipId').value='';
      ['secteur-input','batiment-input','local-input','zone-input','composant-input','fournisseur-input','type-input','identifiant-input','marquage_atex-input','photo-input','comments-input','last-inspection-input']
      .forEach(id=>{ const el=$('#'+id); if(!el) return; el.value = (el.type==='file') ? '' : ''; });
    }

    async function getBase64(file){
      return await new Promise((res,rej)=>{
        if(!file) return res(null);
        const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file);
      });
    }

    async function saveEquipment(){
      const required=['secteur-input','local-input','zone-input','composant-input','fournisseur-input','type-input','marquage_atex-input'];
      const missing=required.filter(id=>!$('#'+id).value);
      if(missing.length){ showToast('Champs manquants : '+missing.join(', '),'warning'); return; }

      const id = $('#equipId').value || null;
      const zone = $('#zone-input').value;
      const data = {
        secteur: $('#secteur-input').value,
        batiment: $('#batiment-input').value,
        local: $('#local-input').value,
        composant: $('#composant-input').value,
        fournisseur: $('#fournisseur-input').value,
        type: $('#type-input').value,
        identifiant: $('#identifiant-input').value,
        marquage_atex: $('#marquage_atex-input').value,
        comments: $('#comments-input').value,
        exterieur: zone,
        interieur: '',
        photo: await getBase64($('#photo-input').files[0])
      };

      const method = id ? 'PUT' : 'POST';
      const url = id ? API.equipment(id) : API.equipments;

      try{
        const r = await fetch(url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
        if(!r.ok) throw new Error('Erreur enregistrement');
        const saved = await r.json();
        const last = $('#last-inspection-input').value;
        if(last){
          await fetch(API.inspect,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({equipment_id:saved.id,status:'done',inspection_date:last})});
        }
        showToast('Équipement sauvegardé.','success');
        await loadEquipments(); clearForm(); $('#list-tab').click();
      }catch(e){ showToast('Erreur: '+(e.message||e),'danger'); }
    }

    async function editEquipment(id){
      try{
        const r = await fetch(API.equipment(id)); if(!r.ok) throw new Error('Erreur chargement équipement');
        const eq = await r.json();
        $('#equipId').value = eq.id;
        $('#secteur-input').value = eq.secteur || '';
        $('#batiment-input').value = eq.batiment || '';
        $('#local-input').value = eq.local || '';
        $('#zone-input').value = (eq.exterieur || eq.interieur || '');
        $('#composant-input').value = eq.composant || '';
        $('#fournisseur-input').value = eq.fournisseur || '';
        $('#type-input').value = eq.type || '';
        $('#identifiant-input').value = eq.identifiant || '';
        $('#marquage_atex-input').value = eq.marquage_atex || '';
        $('#comments-input').value = eq.comments || '';
        $('#last-inspection-input').value = eq.last_inspection_date ? new Date(eq.last_inspection_date).toISOString().slice(0,10) : '';
        $('#add-tab').click();
      }catch(e){ showToast('Erreur édition: '+(e.message||e),'danger'); }
    }

    // ================== SUPPRESSION ==================
    let toDeleteId = null;
    function openDeleteModal(id, label=''){
      toDeleteId=id;
      $('#deleteMeta').textContent = label ? `Équipement : ${label} (ID ${id})` : `ID ${id}`;
      bootstrap.Modal.getOrCreateInstance($('#deleteModal')).show();
      $('#confirmDeleteBtn').onclick = confirmDelete;
    }
    async function confirmDelete(){
      if(!toDeleteId) return;
      try{
        const r = await fetch(API.equipment(toDeleteId), {method:'DELETE'});
        if(!r.ok) throw new Error('Erreur suppression');
        showToast('Supprimé !','success'); await loadEquipments();
      }catch(e){ showToast('Erreur: '+(e.message||e),'danger'); }
      finally{
        bootstrap.Modal.getOrCreateInstance($('#deleteModal')).hide(); toDeleteId=null;
      }
    }
    window.openDeleteModal = openDeleteModal;

    // ================== IMPORT ==================
    async function importExcel(){
      const f = $('#excelFile').files[0];
      if(!f) return showToast('Sélectionnez un fichier (CSV/Excel)','warning');
      const fd = new FormData(); fd.append('excel', f);
      try{
        const r = await fetch(API.importExcel,{method:'POST',body:fd});
        if(!r.ok) throw new Error('Erreur import');
        showToast('Import réussi !','success'); await loadEquipments();
      }catch(e){ showToast('Erreur import: '+(e.message||e),'danger'); }
    }

    // ================== IA (offcanvas + chat tab) ==================
    function renderBadges(eq){
      const box = document.querySelector('#iaPanel .ia-badges'); box.innerHTML='';
      const wrap = document.createElement('div');
      wrap.className='ia-badges';
      wrap.innerHTML = `
        <span class="badge ${String(eq.conformite||'').toLowerCase().includes('non')?'text-bg-danger':'text-bg-success'}">${eq.conformite||'N/A'}</span>
        <span class="badge text-bg-secondary">Risque ${eq.risque ?? '-'}</span>
        <span class="badge text-bg-secondary">Zone ${eq.zone_type || eq.exterieur || eq.interieur || '-'}</span>
      `;
      document.querySelector('#iaPanel .ia-badges').replaceWith(wrap);
    }

    async function openIA(id, opts={}){
      currentIA = id;
      const off = bootstrap.Offcanvas.getOrCreateInstance($('#iaPanel')); off.show();

      // état de chargement
      $('#iaHeader').textContent = '';
      $('#iaDetails').style.display='none';
      $('#iaLoading').style.display='block';

      try{
        const [eqR, helpR] = await Promise.all([ fetch(API.equipment(id)), fetch(API.help(id)) ]);
        if(!eqR.ok) throw new Error('Équipement introuvable');
        const eq = await eqR.json();
        const help = await helpR.json();

        $('#iaHeader').textContent = `${eq.composant || 'Équipement'} — ID ${eq.id} • Dernière: ${fmtDate(eq.last_inspection_date)} • Prochaine: ${fmtDate(eq.next_inspection_date)}`;
        renderBadges(eq);

        const htmlAide = help?.response || '<p class="text-muted mb-0">Aucune analyse IA disponible.</p>';
        $('#iaDetails').innerHTML = htmlAide;

        // Historique partagé
        addToHistory({
          id: eq.id,
          composant: eq.composant || 'Équipement',
          date: new Date().toISOString(),
          content: htmlAide,
          meta: {
            conformite: eq.conformite || 'N/A',
            risque: eq.risque ?? '-',
            zone: eq.zone_type || eq.exterieur || eq.interieur || '-',
            last: fmtDate(eq.last_inspection_date),
            next: fmtDate(eq.next_inspection_date)
          }
        });

        // Affichage
        $('#iaLoading').style.display='none';
        $('#iaDetails').style.display='block';

        // Option : ouvrir directement l’onglet chat
        if(opts.openChat){ $('#chat-tab').click(); selectHistoryChat(0); }

        // Option : forcer rechargement (déjà fait ici)
        if(opts.forceReload){ /* noop, on vient de recharger */ }

        // Enrichissement dans l’onglet Chat
        buildLocalEnrichmentChat(eq);
      }catch(e){
        $('#iaLoading').style.display='none';
        $('#iaDetails').style.display='block';
        $('#iaDetails').innerHTML = `<div class="alert alert-danger">Erreur IA: ${e.message||e}</div>`;
      }
    }
    window.openIA = openIA;

    function renderHistory(activeId=null){
      const list = $('#iaHistoryList'); list.innerHTML='';
      const h=getChatHistory(); if(!h.length){ list.innerHTML='<li class="list-group-item text-muted">Aucun historique.</li>'; return; }
      h.forEach((it,idx)=>{
        const li=document.createElement('li');
        li.className='list-group-item ia-item'+(it.id===activeId?' active':'');
        li.textContent = `${it.composant || 'Équipement'} • ${new Date(it.date).toLocaleString('fr-FR')}`;
        li.title='Réouvrir cette analyse';
        li.onclick = ()=> {
          $('#iaDetails').innerHTML = it.content;
          $$('#iaHistoryList .ia-item').forEach(x=>x.classList.remove('active'));
          li.classList.add('active');
          currentIA = it.id;
          $('#chat-tab').click(); // en plus, ouvre la vue lecture si souhaité
          selectHistoryChat(idx);
        };
        list.appendChild(li);
      });
    }

    function renderHistoryChat(){
      const list = $('#iaHistoryListChat'); list.innerHTML='';
      const h=getChatHistory(); if(!h.length){ list.innerHTML='<li class="list-group-item text-muted">Aucun historique.</li>'; return; }
      h.forEach((it,idx)=>{
        const li=document.createElement('li');
        li.className='list-group-item d-flex flex-column';
        li.style.cursor='pointer';
        li.innerHTML = `
          <div><strong>${it.composant || 'Équipement'}</strong></div>
          <div class="small-muted">${new Date(it.date).toLocaleString('fr-FR')}</div>
        `;
        li.onclick = ()=> selectHistoryChat(idx);
        list.appendChild(li);
      });
    }

    function selectHistoryChat(index){
      const h=getChatHistory(); const it=h[index]; if(!it) return;
      currentIA = it.id;
      $('#chatHeader').textContent = `${it.composant || 'Équipement'} — ID ${it.id} • Dernière: ${it.meta?.last||'-'} • Prochaine: ${it.meta?.next||'-'}`;
      $('#chatHtml').innerHTML = it.content || '<p class="text-muted mb-0">—</p>';
      $('#chatEnriched').style.display='block';
    }

    function clearChatHistory(){
      setChatHistory([]); renderHistory(); renderHistoryChat();
      $('#iaDetails').innerHTML=''; $('#chatHtml').innerHTML='';
      $('#chatHeader').textContent=''; $('#chatEnriched').style.display='none';
      showToast('Historique effacé','info');
    }

    function copyChat(){
      const html = $('#chatHtml').innerText || '';
      navigator.clipboard.writeText(html).then(()=>showToast('Contenu copié','success'));
    }

    // Enrichissement (onglet Chat)
    function buildLocalEnrichmentChat(eq){
      const zone = String(eq.zone_type || eq.exterieur || eq.interieur || '22');
      const conf = String(eq.conformite || 'N/A');
      const marq = String(eq.marquage_atex || '');
      const catNeeded = zone.startsWith('0')||zone.startsWith('20') ? '1' : (zone.startsWith('1')||zone.startsWith('21') ? '2' : '3');

      // Pourquoi / non conformité
      let reasons=[];
      if(conf.toLowerCase().includes('non')){
        if(marq && !/G|D/i.test(marq)) reasons.push('Marquage ATEX incomplet ou invalide.');
        if(catNeeded==='1' && !/G[a]|D[a]/.test(marq)) reasons.push('Catégorie requise 1 (Ga/Da) non respectée pour la zone.');
        if(catNeeded==='2' && !/G[b]|D[b]/.test(marq)) reasons.push('Catégorie requise 2 (Gb/Db) non respectée pour la zone.');
        if(!/T[1-6]/i.test(marq)) reasons.push('Classe de température (T1..T6) absente.');
        if(!reasons.length) reasons.push('Écart entre catégorie minimale requise et marquage.');
      }else{
        reasons.push('Équipement déclaré conforme. Vérifier doc constructeur & adéquation à la zone.');
      }

      const palliatives=[
        'Mettre une signalisation temporaire et limiter l’accès.',
        'Réduire les sources d’inflammation (ESD, débranchements non essentiels).',
        'Inspection rapprochée (< 1 mois) pour confirmer l’état réel.'
      ];
      if(zone.startsWith('1')||zone.startsWith('21')) palliatives.push('Réduire la présence de mélange explosif (ventilation provisoire, nettoyage).');

      const preventives=[
        `Standardiser le marquage : II ${catNeeded}${(zone.includes('0')||zone.includes('1')||zone.includes('2'))?'G':'D'} T4 min.`,
        'Mettre à jour la base de données ATEX (photos, plaques, certificats).',
        'Former le personnel à l’identification des marquages & classe T.'
      ];

      const refs=[
        'Joindre le certificat CE de type à la fiche.',
        `Aligner la catégorie minimale avec la zone (${zone}) dans la GED.`,
        'Tracer la décision (remplacement/dérogation) dans le registre sécurité.'
      ];

      const costs=[
        'Remplacement capteur/équipement : 300–1’500 € selon fabricant.',
        'Main‑d’œuvre (pose, test) : 2–6 h.',
        'Inspection tierce partie (si requis) : 300–900 €.'
      ];

      $('#chatWhy').innerHTML = '<ul>'+reasons.map(r=>`<li>${r}</li>`).join('')+'</ul>';
      $('#chatPalliative').innerHTML = palliatives.map(x=>`<li>${x}</li>`).join('');
      $('#chatPreventive').innerHTML = preventives.map(x=>`<li>${x}</li>`).join('');
      $('#chatRefs').innerHTML = refs.map(x=>`<li>${x}</li>`).join('');
      $('#chatCosts').innerHTML = costs.map(x=>`<li>${x}</li>`).join('');
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
