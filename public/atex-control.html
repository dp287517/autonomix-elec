<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contrôle ATEX - Équipements</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    body { background-color: #f8f9fa; font-family: 'Poppins', sans-serif; color: #333; }
    .card { margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 15px; background: #fff; }
    .risk-low { color: #28a745; } .risk-med { color: #ffc107; } .risk-high { color: #dc3545; }
    .nav-tabs .nav-link { border-radius: 10px 10px 0 0; }
    .small-muted { font-size: 12px; color: #6c757d; }
    .last-photo { max-width: 50px; border-radius: 5px; cursor: zoom-in; }
    .toast-container { position: fixed; top: 16px; right: 16px; z-index: 2000; }
    /* Offcanvas IA - responsive */
    .offcanvas-ia { width: min(860px, 100vw); }
    @media (max-width: 992px){
      .offcanvas-ia { width: 100vw; }
    }
    .ia-history-item { cursor:pointer; }
    .ia-history-item.active { background: #f1f3f5; border-left: 3px solid #0d6efd; }
    .ia-badge { font-size: .75rem; }
    .table-responsive { overflow-x: auto; }
  </style>
</head>
<body class="container my-5">
  <h1 class="text-center mb-4">Contrôle des Équipements ATEX</h1>
  <p class="text-center lead">Outil pour inspecter, ajouter et suivre les conformités ATEX.</p>

  <!-- Onglets (Chat IA retiré de la navigation pour éviter le switch forcé) -->
  <ul class="nav nav-tabs" id="atexTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list" type="button" role="tab"><i data-lucide="list"></i> Liste</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="add-tab" data-bs-toggle="tab" data-bs-target="#add" type="button" role="tab"><i data-lucide="plus"></i> Ajouter/Éditer</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="import-tab" data-bs-toggle="tab" data-bs-target="#import" type="button" role="tab"><i data-lucide="upload"></i> Importer</button>
    </li>
  </ul>

  <div class="tab-content" id="atexTabContent">

    <!-- LISTE -->
    <div class="tab-pane fade show active" id="list" role="tabpanel">

      <!-- Filtres -->
      <div class="card mb-4">
        <div class="card-header"><h4>Filtres</h4></div>
        <div class="card-body">
          <div class="row g-2">
            <div class="col-md-3"><input id="filterSecteur" class="form-control" placeholder="Secteur"></div>
            <div class="col-md-3"><input id="filterBatiment" class="form-control" placeholder="Bâtiment"></div>
            <div class="col-md-3">
              <select id="filterConformite" class="form-select">
                <option value="">Conformité (tous)</option>
                <option value="Conforme">Conforme</option>
                <option value="Non Conforme">Non Conforme</option>
              </select>
            </div>
            <div class="col-md-3 d-grid d-md-block">
              <button id="btnApplyFilters" class="btn btn-primary"><i data-lucide="search"></i> Appliquer</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Liste -->
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h4 class="mb-0">Liste des Équipements</h4>
          <button id="btnSync" class="btn btn-info"><i data-lucide="refresh-cw"></i> Sync</button>
        </div>
        <div class="card-body table-responsive">
          <table class="table table-striped align-middle">
            <thead>
              <tr>
                <th>ID</th><th>Composant</th><th>Secteur</th><th>Bâtiment</th><th>Local</th><th>Zone</th>
                <th>Conformité</th><th>Risque</th>
                <th>Dernière Insp.</th><th>Prochaine</th>
                <th>Photo</th><th style="min-width:260px">Actions</th>
              </tr>
            </thead>
            <tbody id="equipmentsTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- AJOUTER / ÉDITER -->
    <div class="tab-pane fade" id="add" role="tabpanel">
      <div class="card">
        <div class="card-body">
          <form id="equipForm" novalidate>
            <input type="hidden" id="equipId">
            <div class="row">
              <div class="col-md-6">
                <label class="form-label">Secteur de responsabilité</label>
                <div class="input-group">
                  <select id="secteur-input" class="form-select" required></select>
                  <button class="btn btn-outline-secondary" type="button" id="btnAddSecteur" title="Ajouter un secteur">➕</button>
                </div>
                <div class="form-text">Clique sur ➕ pour créer un nouveau secteur.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Bâtiment</label>
                <input type="text" id="batiment-input" class="form-control" placeholder="Ex: B06, B11…" required>
              </div>
            </div>

            <div class="row mt-3">
              <div class="col-md-6">
                <label class="form-label">Local</label>
                <input type="text" id="local-input" class="form-control" placeholder="Entrer le nom ou numéro du local" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Type de zone (ATEX)</label>
                <select id="zone-input" class="form-select" required>
                  <option value="" disabled selected>— Sélectionner —</option>
                  <option value="0">0 (Gaz)</option>
                  <option value="1">1 (Gaz)</option>
                  <option value="2">2 (Gaz)</option>
                  <option value="20">20 (Poussières)</option>
                  <option value="21">21 (Poussières)</option>
                  <option value="22">22 (Poussières)</option>
                </select>
                <div class="form-text">Utilisé pour déterminer la catégorie minimale requise.</div>
              </div>
            </div>

            <div class="row mt-3">
              <div class="col-md-6">
                <label class="form-label">Composant*</label>
                <input type="text" id="composant-input" class="form-control" placeholder="Type de composant (capteur, clapet, etc.)" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Fabricant*</label>
                <input type="text" id="fournisseur-input" class="form-control" placeholder="Ex: IFM, E+H, Siemens…" required>
              </div>
            </div>

            <div class="row mt-3">
              <div class="col-md-6">
                <label class="form-label">Type (référence fabricant)*</label>
                <input type="text" id="type-input" class="form-control" placeholder="Entrer la référence fabricant" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Identifiant</label>
                <input type="text" id="identifiant-input" class="form-control" placeholder="Entrer l’identifiant du capteur par exemple">
              </div>
            </div>

            <div class="row mt-3">
              <div class="col-md-6">
                <label class="form-label">Marquage ATEX*</label>
                <input type="text" id="marquage_atex-input" class="form-control" placeholder="Ex : II 3G IIA T4" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Date de dernière inspection</label>
                <input type="date" id="last-inspection-input" class="form-control">
                <div class="form-text">Si renseignée, la prochaine inspection sera recalculée.</div>
              </div>
            </div>

            <!-- Photo + Commentaires -->
            <div class="row mt-3">
              <div class="col-md-6">
                <label class="form-label">Photo / Document</label>
                <input type="file" id="photo-input" class="form-control" accept="image/*,.pdf">
                <div class="form-text">Ajoutez une photo et/ou un document.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Commentaires</label>
                <textarea id="comments-input" class="form-control" placeholder="Note interne, contexte, etc."></textarea>
              </div>
            </div>

            <div class="mt-4 d-flex gap-2">
              <button type="button" id="btnSave" class="btn btn-success"><i data-lucide="save"></i> Enregistrer</button>
              <button type="button" id="btnClear" class="btn btn-secondary"><i data-lucide="x"></i> Annuler</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- IMPORTER -->
    <div class="tab-pane fade" id="import" role="tabpanel">
      <div class="card">
        <div class="card-body">
          <p><strong>Colonnes minimales requises</strong> (dans le bon ordre) pour que l’import fonctionne :</p>
          <div class="mb-2">
            <span class="badge bg-light text-dark">secteur</span>
            <span class="badge bg-light text-dark">batiment</span>
            <span class="badge bg-light text-dark">local</span>
            <span class="badge bg-light text-dark">composant</span>
            <span class="badge bg-light text-dark">fournisseur</span>
            <span class="badge bg-light text-dark">type</span>
            <span class="badge bg-light text-dark">identifiant</span>
            <span class="badge bg-light text-dark">type_de_zone</span>
            <span class="badge bg-light text-dark">marquage_atex</span>
            <span class="badge bg-light text-dark">last_inspection_date</span>
          </div>
          <p class="small-muted">Le modèle fourni aligne ces champs sur l’ordre attendu par l’API d’import Excel.</p>

          <div class="mb-3 d-flex gap-2">
            <button id="btnTemplateCSV" class="btn btn-outline-secondary btn-sm">Télécharger modèle CSV</button>
            <button id="btnTemplateXLSX" class="btn btn-outline-secondary btn-sm">Télécharger modèle XLSX</button>
          </div>

          <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" class="form-control mb-2">
          <button id="btnImport" class="btn btn-primary">
            <i data-lucide="upload"></i> Importer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Photo -->
  <div class="modal fade" id="photoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Photo</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <img id="photoModalImg" src="" alt="Photo équipement" class="img-fluid">
        </div>
        <div class="modal-footer">
          <a id="photoDownload" class="btn btn-outline-secondary" download>Télécharger</a>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Confirmation Suppression (remplace window.confirm) -->
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-danger"><i data-lucide="trash-2"></i> Confirmer la suppression</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Voulez-vous vraiment supprimer cet équipement ATEX ? Cette action est irréversible.</p>
          <div id="deleteMeta" class="small-muted"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button class="btn btn-danger" id="confirmDeleteBtn">Supprimer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Offcanvas latéral AutonomiX IA -->
  <div class="offcanvas offcanvas-end offcanvas-ia" tabindex="-1" id="iaPanel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title"><i data-lucide="bot"></i> Aide AutonomiX IA</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <div class="row">
        <!-- Historique à gauche -->
        <div class="col-lg-4 mb-3 mb-lg-0">
          <div class="card h-100">
            <div class="card-header d-flex align-items-center justify-content-between">
              <div><i data-lucide="history"></i> Historique</div>
              <button class="btn btn-sm btn-outline-secondary" id="btnClearChat"><i data-lucide="eraser"></i> Effacer</button>
            </div>
            <div class="card-body p-0" style="max-height: 60vh; overflow:auto">
              <ul class="list-group list-group-flush" id="iaHistoryList"></ul>
            </div>
          </div>
        </div>
        <!-- Contenu IA à droite -->
        <div class="col-lg-8">
          <div id="iaContent" class="card">
            <div class="card-body">
              <div id="iaLoading" class="text-center text-muted" style="display:none">
                <div class="spinner-border" role="status" aria-hidden="true"></div>
                <div class="mt-2">Analyse en cours…</div>
              </div>
              <div id="iaDetails" style="display:none"></div>

              <hr>
              <!-- Bloc d’analyse enrichie locale (palliatif, préventif, coûts, réf) -->
              <div id="iaEnriched" style="display:none">
                <h5 class="mb-3">Synthèse actionnable</h5>
                <div id="iaWhy" class="mb-3"></div>
                <div class="row g-3">
                  <div class="col-md-6">
                    <div class="border rounded p-3 h-100">
                      <h6>Mesures palliatives (immédiat)</h6>
                      <ul id="iaPalliative" class="mb-0"></ul>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="border rounded p-3 h-100">
                      <h6>Mesures préventives (durable)</h6>
                      <ul id="iaPreventive" class="mb-0"></ul>
                    </div>
                  </div>
                </div>
                <div class="row g-3 mt-1">
                  <div class="col-md-6">
                    <div class="border rounded p-3 h-100">
                      <h6>Références & changements</h6>
                      <ul id="iaRefs" class="mb-0"></ul>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="border rounded p-3 h-100">
                      <h6>Estimation des coûts</h6>
                      <ul id="iaCosts" class="mb-0"></ul>
                    </div>
                  </div>
                </div>
                <div class="mt-3">
                  <span class="badge text-bg-light ia-badge">Conseils générés à partir des données actuelles</span>
                </div>
              </div>
              <!-- /Bloc enrichi -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toast-container" id="toasts"></div>

  <script>
    if (window.lucide) { window.lucide.createIcons(); }

    // API endpoints (relatifs)
    const API = {
      secteurs: '/api/atex-secteurs',
      equipments: '/api/atex-equipments',
      equipment: (id) => '/api/atex-equipments/' + id,
      importExcel: '/api/atex-import-excel',
      chat: '/api/atex-chat',         // conservé si besoin plus tard
      inspect: '/api/atex-inspect',
      help: (id) => '/api/atex-help/' + id
    };

    // État
    let equipments = [];
    const toastsEl = document.getElementById('toasts');

    // Helpers UI
    function showToast(message, variant='primary') {
      const id = 't' + Date.now();
      const html = `
        <div id="${id}" class="toast align-items-center text-bg-${variant} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        </div>`;
      toastsEl.insertAdjacentHTML('beforeend', html);
      const t = new bootstrap.Toast(document.getElementById(id), { delay: 3000 });
      t.show();
      setTimeout(() => { document.getElementById(id)?.remove(); }, 3500);
    }

    function fmtDate(d) {
      if (!d) return 'N/A';
      const date = new Date(d);
      if (isNaN(date)) return d;
      const dd = String(date.getDate()).padStart(2,'0');
      const mm = String(date.getMonth()+1).padStart(2,'0');
      const yyyy = date.getFullYear();
      return `${dd}-${mm}-${yyyy}`;
    }

    // Démarrage
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('btnApplyFilters').addEventListener('click', applyFilters);
      document.getElementById('btnSync').addEventListener('click', syncData);
      document.getElementById('btnAddSecteur').addEventListener('click', openModalSecteur);
      document.getElementById('btnSave').addEventListener('click', saveEquipment);
      document.getElementById('btnClear').addEventListener('click', clearForm);
      document.getElementById('btnTemplateCSV').addEventListener('click', downloadTemplateCSV);
      document.getElementById('btnTemplateXLSX').addEventListener('click', downloadTemplateXLSX);
      document.getElementById('btnImport').addEventListener('click', importExcel);
      document.getElementById('btnClearChat').addEventListener('click', clearChatHistory);

      loadSecteurs();
      loadEquipments();
    });

    /* ======= LISTE ======= */
    async function loadEquipments() {
      try {
        const response = await fetch(API.equipments);
        if (!response.ok) throw new Error('Erreur chargement liste');
        equipments = await response.json();
        renderTable();
      } catch (error) {
        console.error('Erreur loadEquipments:', error);
        showToast('Erreur chargement liste: ' + error.message, 'danger');
      }
    }

    function renderTable(list = equipments) {
      const tbody = document.getElementById('equipmentsTable');
      tbody.innerHTML = '';
      list.forEach(eq => {
        const riskClass = (typeof eq.risque === 'number' && eq.risque <= 1) ? 'risk-low' : ((eq.risque <= 3) ? 'risk-med' : 'risk-high');
        const zone = eq.zone_type || eq.exterieur || eq.interieur || 'N/A';
        const isNonConf = (eq.conformite || '').toLowerCase().includes('non');

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${eq.id ?? ''}</td>
          <td>${eq.composant || ''}</td>
          <td>${eq.secteur || ''}</td>
          <td>${eq.batiment || ''}</td>
          <td>${eq.local || ''}</td>
          <td>${zone}</td>
          <td>${eq.conformite || ''}</td>
          <td class="${riskClass}">${eq.risque ?? ''}</td>
          <td>${fmtDate(eq.last_inspection_date)}</td>
          <td>${fmtDate(eq.next_inspection_date)}</td>
          <td>
            ${eq.photo ? `<img class="last-photo" src="${eq.photo}" alt="Photo" onclick="openPhoto('${encodeURIComponent(eq.photo)}')">` : '<span class="text-muted">—</span>'}
          </td>
          <td class="d-flex flex-wrap gap-2">
            <button class="btn btn-sm btn-outline-primary" onclick="editEquipment(${eq.id})"><i data-lucide="edit-3"></i> Éditer</button>
            <button class="btn btn-sm btn-outline-danger" onclick="openDeleteModal(${eq.id}, '${(eq.composant||'').replace(/'/g,'\\\'')}')"><i data-lucide="trash-2"></i> Supprimer</button>
            <button class="btn btn-sm ${isNonConf ? 'btn-warning' : 'btn-outline-secondary'}" onclick="openIA(${eq.id})">
              <i data-lucide="sparkles"></i> Aide AutonomiX IA
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      if (window.lucide) window.lucide.createIcons();
    }

    function applyFilters() {
      const s = (document.getElementById('filterSecteur').value || '').toLowerCase();
      const b = (document.getElementById('filterBatiment').value || '').toLowerCase();
      const c = document.getElementById('filterConformite').value;
      const filtered = equipments.filter(eq =>
        (!s || (eq.secteur||'').toLowerCase().includes(s)) &&
        (!b || (eq.batiment||'').toLowerCase().includes(b)) &&
        (!c || (eq.conformite||'') === c)
      );
      renderTable(filtered);
    }

    /* ======= PHOTO ======= */
    function openPhoto(encodedSrc){
      const src = decodeURIComponent(encodedSrc);
      const img = document.getElementById('photoModalImg');
      const a = document.getElementById('photoDownload');
      img.src = src; a.href = src;
      bootstrap.Modal.getOrCreateInstance(document.getElementById('photoModal')).show();
    }
    window.openPhoto = openPhoto;

    /* ======= SECTEURS ======= */
    async function loadSecteurs() {
      try {
        const response = await fetch(API.secteurs);
        const secteurs = await response.json();
        const select = document.getElementById('secteur-input');
        select.innerHTML = '<option value="" disabled selected>— Sélectionner —</option>';
        secteurs.forEach(s => {
          const option = document.createElement('option');
          option.value = s.name; option.text = s.name;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Erreur loadSecteur:', error);
      }
    }
    function openModalSecteur(){
      const modalHtml = `
      <div class="modal fade" id="modalSecteur" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">Nouveau secteur</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <input id="newSecteurName" class="form-control" placeholder="Nom du secteur">
            <div id="secteurSaveMsg" class="small-muted mt-2"></div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            <button class="btn btn-primary" id="saveSecteurBtn">Enregistrer</button>
          </div>
        </div></div>
      </div>`;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      const modalEl = document.getElementById('modalSecteur');
      const modal = new bootstrap.Modal(modalEl);
      modal.show();
      modalEl.querySelector('#saveSecteurBtn').addEventListener('click', async ()=>{
        const name = (modalEl.querySelector('#newSecteurName').value || '').trim();
        if (!name) { modalEl.querySelector('#secteurSaveMsg').textContent = 'Nom requis.'; return; }
        try{
          const r = await fetch(API.secteurs, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name }) });
          if (!r.ok) throw new Error('Erreur API');
          await loadSecteurs();
          document.getElementById('secteur-input').value = name;
          showToast('Secteur enregistré', 'success');
          modal.hide(); modalEl.remove();
        } catch(e){ modalEl.querySelector('#secteurSaveMsg').textContent = 'Erreur: '+(e.message||e); }
      }, { once:true });
      modalEl.addEventListener('hidden.bs.modal', ()=> modalEl.remove(), { once:true });
    }

    /* ======= FORMULAIRE ======= */
    function clearForm() {
      document.getElementById('equipId').value = '';
      ['secteur-input','batiment-input','local-input','zone-input','composant-input','fournisseur-input','type-input','identifiant-input','marquage_atex-input','photo-input','comments-input','last-inspection-input'].forEach(id=>{
        const el = document.getElementById(id);
        if (!el) return;
        if (el.type === 'file') el.value = '';
        else el.value = '';
      });
    }

    async function saveEquipment() {
      // Validation minimale
      const requiredIds = ['secteur-input','local-input','zone-input','composant-input','fournisseur-input','type-input','marquage_atex-input'];
      const missing = requiredIds.filter(id => !document.getElementById(id).value);
      if (missing.length) { showToast('Champs manquants : ' + missing.join(', '), 'warning'); return; }

      const id = document.getElementById('equipId').value || null;
      const zone = document.getElementById('zone-input').value;
      const data = {
        secteur: document.getElementById('secteur-input').value,
        batiment: document.getElementById('batiment-input').value,
        local: document.getElementById('local-input').value,
        composant: document.getElementById('composant-input').value,
        fournisseur: document.getElementById('fournisseur-input').value,
        type: document.getElementById('type-input').value,
        identifiant: document.getElementById('identifiant-input').value,
        marquage_atex: document.getElementById('marquage_atex-input').value,
        comments: document.getElementById('comments-input').value,
        exterieur: zone,
        interieur: '',
        photo: await getBase64(document.getElementById('photo-input').files[0])
      };

      const method = id ? 'PUT' : 'POST';
      const url = id ? API.equipment(id) : API.equipments;

      try {
        const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        if (!response.ok) throw new Error('Erreur enregistrement');
        const saved = await response.json();

        // si date de dernière inspection renseignée -> /api/atex-inspect
        const last = document.getElementById('last-inspection-input').value;
        if (last) {
          await fetch(API.inspect, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ equipment_id: saved.id, status: 'done', inspection_date: last })
          });
        }

        showToast('Équipement sauvegardé.', 'success');
        await loadEquipments();
        clearForm();
        document.getElementById('list-tab').click();
      } catch (error) {
        showToast('Erreur: ' + error.message, 'danger');
      }
    }

    function getBase64(file) {
      return new Promise((resolve, reject) => {
        if (!file) return resolve(null);
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = err => reject(err);
      });
    }

    async function editEquipment(id) {
      try {
        const response = await fetch(API.equipment(id));
        if (!response.ok) throw new Error('Erreur chargement équipement');
        const eq = await response.json();
        document.getElementById('equipId').value = eq.id;
        document.getElementById('secteur-input').value = eq.secteur || '';
        document.getElementById('batiment-input').value = eq.batiment || '';
        document.getElementById('local-input').value = eq.local || '';
        document.getElementById('zone-input').value = (eq.exterieur || eq.interieur || '');
        document.getElementById('composant-input').value = eq.composant || '';
        document.getElementById('fournisseur-input').value = eq.fournisseur || '';
        document.getElementById('type-input').value = eq.type || '';
        document.getElementById('identifiant-input').value = eq.identifiant || '';
        document.getElementById('marquage_atex-input').value = eq.marquage_atex || '';
        document.getElementById('comments-input').value = eq.comments || '';
        document.getElementById('last-inspection-input').value = eq.last_inspection_date ? new Date(eq.last_inspection_date).toISOString().slice(0,10) : '';
        document.getElementById('add-tab').click();
      } catch (error) {
        showToast('Erreur édition: ' + error.message, 'danger');
      }
    }

    /* ======= SUPPRESSION (modal) ======= */
    let toDeleteId = null;
    function openDeleteModal(id, label=''){
      toDeleteId = id;
      const meta = document.getElementById('deleteMeta');
      meta.textContent = label ? 'Équipement : ' + label + ' (ID ' + id + ')' : 'ID ' + id;
      const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('deleteModal'));
      modal.show();
      const btn = document.getElementById('confirmDeleteBtn');
      btn.onclick = confirmDelete;
    }
    async function confirmDelete(){
      if (!toDeleteId) return;
      try {
        const response = await fetch(API.equipment(toDeleteId), { method: 'DELETE' });
        if (!response.ok) throw new Error('Erreur suppression');
        showToast('Supprimé !', 'success');
        await loadEquipments();
      } catch (error) {
        showToast('Erreur: ' + error.message, 'danger');
      } finally {
        bootstrap.Modal.getOrCreateInstance(document.getElementById('deleteModal')).hide();
        toDeleteId = null;
      }
    }
    window.openDeleteModal = openDeleteModal;

    function syncData() {
      loadEquipments();
      showToast('Données synchronisées !', 'info');
    }

    /* ======= IMPORT ======= */
    function downloadTemplateCSV(){
      const head = ['risque','secteur','batiment','local','composant','fournisseur','type','identifiant','interieur','exterieur','categorie_minimum','marquage_atex','photo','conformite','comments','last_inspection_date'];
      const rows = [
        ['', 'Utilities','B06','L-203','Capteur','IFM','PN7092','CAPT-0123','', '22','', 'II 3G IIA T4','', '', '', '2025-06-01'],
        ['', 'Maintenance','B11','Salle compresseurs','Clapet','Siemens','3RW40 11-1BB14','CLAP-0007','', '21','', 'II 2G IIB T3','', '', 'à contrôler', '2025-04-10']
      ];
      const csv = [head.join(','), ...rows.map(r => r.map(x => `"${String(x).replace(/"/g,'""')}"`).join(','))].join('\n');
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob); const a = document.createElement('a');
      a.href = url; a.download = 'modele-atex.csv'; a.click();
      setTimeout(()=> URL.revokeObjectURL(url), 500);
      showToast('Modèle CSV téléchargé', 'success');
    }
    function downloadTemplateXLSX(){ downloadTemplateCSV(); }

    async function importExcel() {
      const file = document.getElementById('excelFile').files[0];
      if (!file) return showToast('Sélectionnez un fichier (CSV ou Excel)', 'warning');
      const formData = new FormData();
      formData.append('excel', file);
      try {
        const response = await fetch(API.importExcel, { method: 'POST', body: formData });
        if (!response.ok) throw new Error('Erreur import');
        showToast('Import réussi !', 'success');
        await loadEquipments();
      } catch (error) {
        showToast('Erreur import: ' + error.message, 'danger');
      }
    }

    /* ======= Aide AutonomiX IA — Offcanvas latéral avec historique ======= */
    const CHAT_KEY = 'atexIAHistoryV2';
    function getChatHistory(){ try{ return JSON.parse(localStorage.getItem(CHAT_KEY) || '[]'); }catch{return []} }
    function setChatHistory(h){ localStorage.setItem(CHAT_KEY, JSON.stringify(h)); }
    function clearChatHistory(){
      setChatHistory([]);
      renderHistory();
      document.getElementById('iaDetails').innerHTML = '';
      document.getElementById('iaEnriched').style.display = 'none';
      showToast('Historique effacé', 'info');
    }

    async function openIA(id){
      // Ouvre le panneau latéral
      const panel = document.getElementById('iaPanel');
      const off = bootstrap.Offcanvas.getOrCreateInstance(panel);
      off.show();

      // Charge équipement + aide back `/api/atex-help/:id`
      const loading = document.getElementById('iaLoading');
      const details = document.getElementById('iaDetails');
      const enriched = document.getElementById('iaEnriched');
      loading.style.display = 'block';
      details.style.display = 'none';
      enriched.style.display = 'none';
      details.innerHTML = '';

      try {
        const [eqResp, helpResp] = await Promise.all([
          fetch(API.equipment(id)),
          fetch(API.help(id))
        ]);
        if (!eqResp.ok) throw new Error('Équipement introuvable');
        const eq = await eqResp.json();
        const help = await helpResp.json();

        const htmlAide = help?.response || '<p class="text-muted">Aucune analyse IA disponible.</p>';
        details.innerHTML = `
          <div class="d-flex align-items-center justify-content-between">
            <h5 class="mb-3">${eq.composant || 'Équipement'} <span class="badge text-bg-light">ID ${eq.id}</span></h5>
            <div>
              <span class="badge ${String(eq.conformite).toLowerCase().includes('non')?'text-bg-danger':'text-bg-success'}">${eq.conformite || 'N/A'}</span>
              <span class="badge text-bg-secondary">Risque ${eq.risque ?? '-'}</span>
              <span class="badge text-bg-secondary">Zone ${eq.zone_type || eq.exterieur || eq.interieur || '-'}</span>
            </div>
          </div>
          <div class="small-muted mb-2">Dernière inspection : ${fmtDate(eq.last_inspection_date)} — Prochaine : ${fmtDate(eq.next_inspection_date)}</div>
          <div class="border rounded p-3 mb-3" id="iaHtml">${htmlAide}</div>
        `;

        // Enrichissement local : "Pourquoi non conforme", palliatif/préventif, refs, coûts.
        buildLocalEnrichment(eq);

        // Historique
        const item = {
          id: eq.id,
          composant: eq.composant || 'Équipement',
          date: new Date().toISOString(),
          content: details.querySelector('#iaHtml').innerHTML
        };
        const hist = getChatHistory();
        hist.unshift(item);
        setChatHistory(hist.slice(0, 50)); // limite
        renderHistory(eq.id);

        loading.style.display = 'none';
        details.style.display = 'block';
        enriched.style.display = 'block';
      } catch(e){
        loading.style.display = 'none';
        details.style.display = 'block';
        details.innerHTML = `<div class="alert alert-danger">Erreur IA: ${e.message || e}</div>`;
      }
    }
    window.openIA = openIA;

    function renderHistory(activeId=null){
      const list = document.getElementById('iaHistoryList');
      const h = getChatHistory();
      list.innerHTML = '';
      if (!h.length){
        list.innerHTML = '<li class="list-group-item text-muted">Aucun historique.</li>';
        return;
      }
      h.forEach((it, idx) => {
        const d = new Date(it.date);
        const label = (it.composant || 'Équipement') + ' • ' + d.toLocaleString('fr-FR');
        const li = document.createElement('li');
        li.className = 'list-group-item ia-history-item' + (it.id===activeId?' active':'');
        li.textContent = label;
        li.title = 'Réouvrir cette analyse';
        li.onclick = () => {
          document.getElementById('iaHtml').innerHTML = it.content;
          // highlight actif
          [...list.children].forEach(c=>c.classList.remove('active'));
          li.classList.add('active');
        };
        list.appendChild(li);
      });
    }

    function buildLocalEnrichment(eq){
      const why = document.getElementById('iaWhy');
      const pal = document.getElementById('iaPalliative');
      const prev = document.getElementById('iaPreventive');
      const refs = document.getElementById('iaRefs');
      const costs = document.getElementById('iaCosts');

      const zone = String(eq.zone_type || eq.exterieur || eq.interieur || '22');
      const conf = String(eq.conformite || 'N/A');
      const marq = String(eq.marquage_atex || '');
      const catNeeded = zone.startsWith('0')||zone.startsWith('20') ? '1' : (zone.startsWith('1')||zone.startsWith('21') ? '2' : '3');

      // Pourquoi non conforme (règles simples, côté front)
      let reasons = [];
      if (conf.toLowerCase().includes('non')) {
        if (marq && !/G|D/i.test(marq)) reasons.push('Marquage ATEX incomplet ou invalide.');
        if (catNeeded === '1' && !/G[a]|D[a]/.test(marq)) reasons.push('Catégorie requise 1 (Ga/Da) non respectée pour la zone.');
        if (catNeeded === '2' && !/G[b]|D[b]/.test(marq)) reasons.push('Catégorie requise 2 (Gb/Db) non respectée pour la zone.');
        if (!/T[1-6]/i.test(marq)) reasons.push('Classe de température (T1..T6) absente : risque de dépassement thermique.');
        if (!reasons.length) reasons.push('Écart entre catégorie minimale requise et le marquage de l’équipement.');
      } else {
        reasons.push('Équipement déclaré conforme. Vérifier tout de même la documentation constructeur et la zone.');
      }

      // Palliatives
      const palliatives = [
        'Mettre en place une signalisation temporaire et limiter l’accès à la zone.',
        'Réduire les sources d’inflammation (débranchements non essentiels, contrôle ESD).',
        'Planifier une inspection rapprochée (< 1 mois) pour confirmer l’état réel.'
      ];
      if (zone.startsWith('1') || zone.startsWith('21')) palliatives.push('Réduire la présence de mélange explosif (ventilation provisoire, nettoyage).');

      // Préventives
      const preventives = [
        'Standardiser le marquage : ex. II ' + (catNeeded) + (zone.startsWith('2')||zone.startsWith('22')? 'G' : (zone.includes('0')||zone.includes('1')?'G':'D')) + ' T4 min.',
        'Mettre à jour la base de données ATEX (photos, plaques signalétiques, certificats).',
        'Former le personnel à l’identification des marquages et à la classe T pertinente.'
      ];

      // Références & changements
      const refList = [
        'Mettre à jour la fiche d’équipement avec certificat CE de type.',
        'Aligner la catégorie minimale avec la zone (' + zone + ') dans la GED.',
        'Tracer la décision (changement matériel / dérogation) dans le registre sécurité.'
      ];

      // Coûts (ordre de grandeur indicatif)
      const costList = [
        'Remplacement capteur/équipement certifié : 300–1’500 € selon fabricant.',
        'Main-d’œuvre (pose, test) : 2–6 h.',
        'Inspection tierce partie (si requis) : 300–900 €.'
      ];

      why.innerHTML = '<strong>Pourquoi ' + (conf.toLowerCase().includes('non')? 'non conforme':'/ points de vigilance') + ' ?</strong><ul>' + reasons.map(r=>'<li>'+r+'</li>').join('') + '</ul>';
      pal.innerHTML = palliatives.map(x=>'<li>'+x+'</li>').join('');
      prev.innerHTML = preventives.map(x=>'<li>'+x+'</li>').join('');
      refs.innerHTML = refList.map(x=>'<li>'+x+'</li>').join('');
      costs.innerHTML = costList.map(x=>'<li>'+x+'</li>').join('');
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
