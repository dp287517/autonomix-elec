<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contrôle ATEX - Équipements</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: Arial, sans-serif; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .alert-overdue { background-color: #ffc107; color: #333; }
        .risk-low { color: green; } .risk-med { color: orange; } .risk-high { color: red; }
        .tooltip-icon { cursor: help; color: #007bff; }
        #globalChart { max-height: 300px; }
    </style>
</head>
<body class="container my-5">
    <h1 class="text-center mb-4">Contrôle des Équipements ATEX</h1>
    <p class="text-center lead">Outil pour inspecter, ajouter et suivre les conformités ATEX. Utilisez sur le terrain pour photos et checks automatisés.</p>

    <!-- Vue Globale -->
    <div class="card">
        <div class="card-header"><h4>Vue Globale</h4></div>
        <div class="card-body">
            <canvas id="globalChart"></canvas>
            <div id="statsSummary" class="mt-3"></div>
        </div>
    </div>

    <!-- Filtres -->
    <div class="card mb-4">
        <div class="card-header"><h4>Filtres</h4></div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3"><input id="filterSecteur" class="form-control" placeholder="Secteur"></div>
                <div class="col-md-3"><input id="filterBatiment" class="form-control" placeholder="Bâtiment"></div>
                <div class="col-md-3">
                    <select id="filterConformite" class="form-select">
                        <option value="">Conformité (tous)</option>
                        <option value="Conforme">Conforme</option>
                        <option value="Non Conforme">Non Conforme</option>
                    </select>
                </div>
                <div class="col-md-3"><button onclick="loadEquipments()" class="btn btn-primary">Appliquer Filtres</button></div>
            </div>
        </div>
    </div>

    <!-- Liste des Équipements -->
    <div class="card">
        <div class="card-header"><h4>Liste des Équipements</h4></div>
        <div class="card-body">
            <table class="table table-striped">
                <thead><tr><th>ID</th><th>Composant</th><th>Zone</th><th>Conformité</th><th>Risk</th><th>Dernière Inspection</th><th>Prochaine</th><th>Actions</th></tr></thead>
                <tbody id="equipmentsTable"></tbody>
            </table>
        </div>
    </div>

    <!-- Formulaire Ajout/Édition -->
    <div class="card mt-4">
        <div class="card-header"><h4>Ajouter/Éditer Équipement</h4></div>
        <div class="card-body">
            <form id="equipForm">
                <input type="hidden" id="equipId">
                <div class="row">
                    <div class="col-md-6">
                        <label>Risque</label><input type="number" id="risque" class="form-control" min="0" max="5" required>
                    </div>
                    <div class="col-md-6">
                        <label>Secteur</label><input type="text" id="secteur" class="form-control" required>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-6">
                        <label>Bâtiment</label><input type="text" id="batiment" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label>Local</label><input type="text" id="local" class="form-control" required>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-6">
                        <label>Composant</label><input type="text" id="composant" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label>Fournisseur</label><input type="text" id="fournisseur" class="form-control" required>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-6">
                        <label>Type</label><input type="text" id="type" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label>Identifiant</label><input type="text" id="identifiant" class="form-control" required>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-3">
                        <label>Intérieur (Zone)</label><input type="text" id="interieur" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label>Extérieur (Zone)</label><input type="text" id="exterieur" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label>Catégorie Minimum</label><input type="text" id="categorie_minimum" class="form-control" required>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-6">
                        <label>Marquage ATEX</label><input type="text" id="marquage_atex" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label>Conformité</label>
                        <select id="conformite" class="form-select" required>
                            <option>Conforme</option>
                            <option>Non Conforme</option>
                        </select>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-12">
                        <label>Commentaires</label><textarea id="comments" class="form-control"></textarea>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-6">
                        <label>Photo (upload)</label><input type="file" id="photo" class="form-control" accept="image/*">
                    </div>
                    <div class="col-md-6">
                        <button type="button" onclick="saveEquipment()" class="btn btn-success mt-4">Enregistrer</button>
                        <button type="button" onclick="clearForm()" class="btn btn-secondary mt-4">Annuler</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Import Excel -->
    <div class="card mt-4">
        <div class="card-header"><h4>Importer Excel</h4></div>
        <div class="card-body">
            <input type="file" id="excelFile" accept=".xlsx" class="form-control mb-2">
            <button onclick="importExcel()" class="btn btn-primary">Importer</button>
        </div>
    </div>

    <!-- Modal Explications "Pour les Nuls" -->
    <div class="modal fade" id="explanationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Explications ATEX</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body" id="modalContent"></div>
            </div>
        </div>
    </div>

    <script>
        let equipments = [];
        let globalChart;

        // Charger équipements au load
        window.onload = () => loadEquipments();

        async function loadEquipments() {
            const secteur = document.getElementById('filterSecteur').value.toLowerCase();
            const batiment = document.getElementById('filterBatiment').value.toLowerCase();
            const conformite = document.getElementById('filterConformite').value;

            const response = await fetch('/api/atex-equipments');
            equipments = await response.json();

            // Filtrer
            equipments = equipments.filter(eq => 
                (!secteur || eq.secteur.toLowerCase().includes(secteur)) &&
                (!batiment || eq.batiment.toLowerCase().includes(batiment)) &&
                (!conformite || eq.conformite === conformite)
            );

            renderTable();
            renderGlobalView();
        }

        function renderTable() {
            const tbody = document.getElementById('equipmentsTable');
            tbody.innerHTML = '';
            equipments.forEach(eq => {
                const row = document.createElement('tr');
                const currentDate = new Date('2025-07-18'); // Date actuelle
                const lastInspection = eq.last_inspection_date ? new Date(eq.last_inspection_date) : null;
                const nextInspection = calculateNextInspection(eq, lastInspection);
                const isOverdue = nextInspection < currentDate;
                const risk = calculateRisk(eq);

                row.innerHTML = `
                    <td>${eq.identifiant}</td>
                    <td>${eq.composant}</td>
                    <td>Int: ${eq.interieur || '-'} / Ext: ${eq.exterieur || '-'}</td>
                    <td class="${eq.conformite === 'Conforme' ? 'text-success' : 'text-danger'}">${eq.conformite}</td>
                    <td class="risk-${risk.level.toLowerCase()}">${risk.level} (${risk.score}/10)</td>
                    <td>${lastInspection ? lastInspection.toLocaleDateString() : 'Aucune'}</td>
                    <td class="${isOverdue ? 'alert-overdue' : ''}">${nextInspection.toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editEquipment('${eq.id}')">Éditer</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteEquipment('${eq.id}')">Suppr</button>
                        <button class="btn btn-sm btn-primary" onclick="inspectEquipment('${eq.id}')">Inspecter/Photo</button>
                        <span class="tooltip-icon" onclick="showExplanation('zone')" title="Explication Zone">?</span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderGlobalView() {
            const total = equipments.length;
            const conforme = equipments.filter(eq => eq.conformite === 'Conforme').length;
            const overdue = equipments.filter(eq => new Date(calculateNextInspection(eq, new Date(eq.last_inspection_date))) < new Date()).length;

            document.getElementById('statsSummary').innerHTML = `
                Total: ${total} | Conformes: ${((conforme / total) * 100).toFixed(1)}% | Inspections Overdue: ${overdue}
            `;

            const ctx = document.getElementById('globalChart').getContext('2d');
            if (globalChart) globalChart.destroy();
            globalChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Conformes', 'Non Conformes', 'Overdue'],
                    datasets: [{ data: [conforme, total - conforme, overdue], backgroundColor: ['#28a745', '#dc3545', '#ffc107'] }]
                },
                options: { responsive: true }
            });
        }

        async function saveEquipment() {
            const data = {
                id: document.getElementById('equipId').value,
                risque: document.getElementById('risque').value,
                secteur: document.getElementById('secteur').value,
                batiment: document.getElementById('batiment').value,
                local: document.getElementById('local').value,
                composant: document.getElementById('composant').value,
                fournisseur: document.getElementById('fournisseur').value,
                type: document.getElementById('type').value,
                identifiant: document.getElementById('identifiant').value,
                interieur: document.getElementById('interieur').value,
                exterieur: document.getElementById('exterieur').value,
                categorie_minimum: document.getElementById('categorie_minimum').value,
                marquage_atex: document.getElementById('marquage_atex').value,
                conformite: document.getElementById('conformite').value,
                comments: document.getElementById('comments').value
            };

            const photoFile = document.getElementById('photo').files[0];
            if (photoFile) {
                const reader = new FileReader();
                reader.onload = async () => {
                    data.photo = reader.result; // Base64
                    await submitEquipment(data);
                };
                reader.readAsDataURL(photoFile);
            } else {
                await submitEquipment(data);
            }
        }

        async function submitEquipment(data) {
            const method = data.id ? 'PUT' : 'POST';
            const url = data.id ? `/api/atex-equipments/${data.id}` : '/api/atex-equipments';
            const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
            if (response.ok) {
                loadEquipments();
                clearForm();
            } else alert('Erreur sauvegarde');
        }

        function editEquipment(id) {
            const eq = equipments.find(e => e.id === id);
            if (!eq) return;
            document.getElementById('equipId').value = eq.id;
            document.getElementById('risque').value = eq.risque;
            document.getElementById('secteur').value = eq.secteur;
            document.getElementById('batiment').value = eq.batiment;
            document.getElementById('local').value = eq.local;
            document.getElementById('composant').value = eq.composant;
            document.getElementById('fournisseur').value = eq.fournisseur;
            document.getElementById('type').value = eq.type;
            document.getElementById('identifiant').value = eq.identifiant;
            document.getElementById('interieur').value = eq.interieur;
            document.getElementById('exterieur').value = eq.exterieur;
            document.getElementById('categorie_minimum').value = eq.categorie_minimum;
            document.getElementById('marquage_atex').value = eq.marquage_atex;
            document.getElementById('conformite').value = eq.conformite;
            document.getElementById('comments').value = eq.comments;
        }

        async function deleteEquipment(id) {
            if (confirm('Confirmer suppression ?')) {
                const response = await fetch(`/api/atex-equipments/${id}`, { method: 'DELETE' });
                if (response.ok) loadEquipments();
                else alert('Erreur suppression');
            }
        }

        async function inspectEquipment(id) {
            const eq = equipments.find(e => e.id === id);
            const status = prompt('Statut Inspection (Conforme/Non Conforme) :');
            const comment = prompt('Commentaire :');
            const photoFile = prompt('Upload photo ? (simulé)'); // Remplacer par input file si besoin
            const data = { equipment_id: id, status, comment, photo: 'base64_simule', inspection_date: new Date().toISOString() };

            const response = await fetch('/api/atex-inspect', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
            if (response.ok) loadEquipments();
            else alert('Erreur inspection');
        }

        async function importExcel() {
            const file = document.getElementById('excelFile').files[0];
            if (!file) return alert('Sélectionnez un fichier Excel');
            const formData = new FormData();
            formData.append('excel', file);
            const response = await fetch('/api/atex-import-excel', { method: 'POST', body: formData });
            if (response.ok) {
                alert('Import réussi');
                loadEquipments();
            } else alert('Erreur import');
        }

        function clearForm() {
            document.getElementById('equipForm').reset();
            document.getElementById('equipId').value = '';
        }

        // Calcul Next Inspection (automatisé)
        function calculateNextInspection(eq, lastDate) {
            const zone = eq.exterieur || eq.interieur || '22'; // Default Zone 22
            const isIC = eq.composant.includes('moteur') || eq.composant.includes('interrupteur'); // Exemple simple; adapter
            const frequency = isIC ? 1 : 3; // Ans
            const grade = zone.startsWith('0') || zone.startsWith('20') ? 'D' : (zone.startsWith('1') || zone.startsWith('21') ? 'C' : 'V');
            lastDate = lastDate || new Date();
            const next = new Date(lastDate);
            next.setFullYear(next.getFullYear() + frequency);
            return next;
        }

        // Calcul Risk (simple algo)
        function calculateRisk(eq) {
            let score = eq.risque * 2; // 0-10
            if (eq.conformite !== 'Conforme') score += 4;
            const level = score < 4 ? 'Low' : (score < 7 ? 'Med' : 'High');
            return { score, level };
        }

        // Explications
        function showExplanation(type) {
            let content = '';
            if (type === 'zone') content = 'Zones ATEX : 0/1/2 pour gaz (risque permanent/fréquent/rare), 20/21/22 pour poussières. Vérifiez marquage II 3G/D pour Zone 2/22.';
            // Ajouter plus...
            document.getElementById('modalContent').innerHTML = content;
            new bootstrap.Modal(document.getElementById('explanationModal')).show();
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
