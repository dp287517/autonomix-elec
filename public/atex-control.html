<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contrôle ATEX - Équipements</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/lucide@latest/dist/umd/lucide.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: 'Poppins', sans-serif; color: #333; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 15px; background: #fff; }
        .alert-overdue { background-color: #ffc107; color: #333; }
        .risk-low { color: #28a745; } .risk-med { color: #ffc107; } .risk-high { color: #dc3545; }
        .tooltip-icon { cursor: help; color: #007bff; }
        #globalChart { max-height: 300px; }
        .nav-tabs .nav-link { border-radius: 10px 10px 0 0; }
        .fixed-bottom-btns { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; padding: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .sparkline { width: 100px; height: 30px; }
        .last-photo { max-width: 50px; border-radius: 5px; }
        .evolution-up { color: green; } .evolution-down { color: red; } .evolution-stable { color: gray; }
        .alert-smart { background-color: #e9ecef; border-left: 5px solid #007bff; margin-bottom: 10px; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body class="container my-5">
    <h1 class="text-center mb-4">Contrôle des Équipements ATEX</h1>
    <p class="text-center lead">Outil pour inspecter, ajouter et suivre les conformités ATEX. Utilisez sur le terrain pour photos et checks automatisés.</p>
    <a href="atex-risk.html" class="btn btn-info mb-4"><i data-lucide="bar-chart"></i> Voir Risk Assessment Global</a>

    <!-- Smart Alerts -->
    <div id="smartAlerts" class="mb-4"></div>

    <!-- Tabs -->
    <ul class="nav nav-tabs" id="atexTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list" type="button" role="tab"><i data-lucide="list"></i> Liste</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="add-tab" data-bs-toggle="tab" data-bs-target="#add" type="button" role="tab"><i data-lucide="plus"></i> Ajouter/Éditer</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="import-tab" data-bs-toggle="tab" data-bs-target="#import" type="button" role="tab"><i data-lucide="upload"></i> Importer</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat" type="button" role="tab"><i data-lucide="message-circle"></i> Chat IA</button>
        </li>
    </ul>
    <div class="tab-content" id="atexTabContent">
        <div class="tab-pane fade show active" id="list" role="tabpanel">
            <!-- Filtres -->
            <div class="card mb-4">
                <div class="card-header"><h4>Filtres</h4></div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3"><input id="filterSecteur" class="form-control" placeholder="Secteur"></div>
                        <div class="col-md-3"><input id="filterBatiment" class="form-control" placeholder="Bâtiment"></div>
                        <div class="col-md-3">
                            <select id="filterConformite" class="form-select">
                                <option value="">Conformité (tous)</option>
                                <option value="Conforme">Conforme</option>
                                <option value="Non Conforme">Non Conforme</option>
                            </select>
                        </div>
                        <div class="col-md-3"><button onclick="loadEquipments()" class="btn btn-primary"><i data-lucide="search"></i> Appliquer</button></div>
                    </div>
                </div>
            </div>

            <!-- Liste -->
            <div class="card">
                <div class="card-header"><h4>Liste des Équipements</h4></div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead><tr><th>ID</th><th>Composant</th><th>Zone</th><th>Conformité</th><th>Risk</th><th>Grade/Fréq.</th><th>Dernière Inspection</th><th>Prochaine</th><th>Risk History</th><th>Last Photo</th><th>Evolution</th><th>Actions</th></tr></thead>
                        <tbody id="equipmentsTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="add" role="tabpanel">
            <!-- Formulaire (sans risque input) -->
            <div class="card">
                <div class="card-body">
                    <form id="equipForm">
                        <input type="hidden" id="equipId">
                        <div class="row">
                            <div class="col-md-6">
                                <label>Secteur</label>
                                <select id="secteur" class="form-select" required></select>
                            </div>
                            <div class="col-md-6">
                                <label>Bâtiment</label><input type="text" id="batiment" class="form-control" required>
                            </div>
                        </div>
                        <!-- ... (rest of form, remove risque input) -->
                        <button type="button" onclick="saveEquipment()" class="btn btn-success mt-4"><i data-lucide="save"></i> Enregistrer</button>
                        <button type="button" onclick="clearForm()" class="btn btn-secondary mt-4"><i data-lucide="x"></i> Annuler</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="import" role="tabpanel">
            <!-- Import -->
            <div class="card">
                <div class="card-body">
                    <input type="file" id="excelFile" accept=".xlsx" class="form-control mb-2">
                    <button onclick="importExcel()" class="btn btn-primary"><i data-lucide="upload"></i> Importer</button>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="chat" role="tabpanel">
            <!-- Chat IA -->
            <div class="card">
                <div class="card-body">
                    <textarea id="chatInput" class="form-control" placeholder="Posez une question sur l'ATEX..."></textarea>
                    <button onclick="sendChat()" class="btn btn-primary mt-2"><i data-lucide="send"></i> Envoyer</button>
                    <div id="chatResponse" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fixed Bottom Buttons -->
    <div class="fixed-bottom-btns text-center">
        <button onclick="addNew()" class="btn btn-success"><i data-lucide="plus"></i> Ajouter</button>
        <button onclick="syncData()" class="btn btn-info"><i data-lucide="refresh-cw"></i> Sync</button>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="explanationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="modalTitle">Détails</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body" id="modalContent"></div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        let equipments = [];
        let globalChart;

        window.onload = () => {
            loadSecteurs(); // For dropdown
            loadEquipments();
            loadSmartAlerts();
        };

        async function loadSecteurs() {
            const response = await fetch('/api/atex-secteurs');
            const secteurs = await response.json();
            const select = document.getElementById('secteur');
            secteurs.forEach(s => {
                const option = document.createElement('option');
                option.value = s.name;
                option.text = s.name;
                select.appendChild(option);
            });
        }

        // ... (rest of script from previous, with updates for no risk input, auto calls, sparklines, photos, evolution)
        async function loadSmartAlerts() {
            const response = await fetch('/api/atex-analysis');
            const alerts = await response.json();
            const alertsDiv = document.getElementById('smartAlerts');
            alertsDiv.innerHTML = alerts.map(a => `<div class="alert-smart">${a.text}</div>`).join('');
        }

        async function sendChat() {
            const input = document.getElementById('chatInput').value;
            const response = await fetch('/api/atex-chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ question: input }) });
            const answer = await response.json();
            document.getElementById('chatResponse').innerHTML = answer.response;
        }

        function addNew() {
            document.getElementById('add-tab').click();
            clearForm();
        }

        function syncData() {
            loadEquipments();
            alert('Données synchronisées !');
        }

        // For sparkline: In renderTable, add <canvas id="spark-${eq.id}"></canvas>, then new Chart for line with risk history (fetch from inspections).
    </script>
</body>
</html>
