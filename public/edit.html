<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autonomix Elec - Modifier un tableau</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="/styles.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
    <style>
        .conflict { color: #dc2626; font-weight: bold; }
        .disjoncteur-principal { background-color: #fefcbf; }
        .touch-friendly { min-height: 44px; padding: 0.5rem 1rem; }
        .animate-fade-in { animation: fadeIn 0.8s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @media (max-width: 640px) {
            .container { padding: 0.5rem; }
            input, select, button { font-size: 0.875rem; }
            table th, table td { font-size: 0.875rem; padding: 0.5rem; }
        }
        select[multiple] { height: 120px; }
        #popup { z-index: 1000; }
        #disjoncteurs-table { 
            display: table !important; 
            visibility: visible !important; 
            opacity: 1 !important; 
            position: relative; 
            z-index: 10; 
            border: 2px solid red; /* Bordure de débogage */
            background-color: #1f2937; /* Fond gris foncé */
        }
        #disjoncteurs-table tbody { 
            display: table-row-group !important; 
            border: 1px solid green; /* Bordure de débogage */
        }
        #disjoncteurs-table tbody tr { 
            display: table-row !important; 
            opacity: 1 !important; 
            border: 1px solid blue; /* Bordure de débogage */
        }
        #disjoncteurs-table td, #disjoncteurs-table th {
            color: #ffffff !important; /* Texte blanc */
            background-color: #374151; /* Fond gris */
            border: 1px solid #4b5563 !important;
            padding: 8px;
            text-align: left;
        }
        #disjoncteurs-table .disjoncteur-principal td {
            background-color: #fefcbf !important; /* Fond jaune */
            color: #000000 !important; /* Texte noir */
        }
        #disjoncteurs-table .conflict {
            color: #dc2626 !important; /* Rouge pour conflits */
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <nav class="bg-blue-700 p-4 sticky top-0 z-50 shadow-lg">
        <ul class="flex flex-wrap space-x-6 text-white font-semibold text-sm sm:text-base">
            <li><a href="index.html" class="hover:text-yellow-300 transition"><i class="fas fa-home mr-2"></i>Accueil</a></li>
            <li><a href="create.html" class="hover:text-yellow-300 transition"><i class="fas fa-plus-circle mr-2"></i>Créer un tableau</a></li>
            <li><a href="view.html" class="hover:text-yellow-300 transition"><i class="fas fa-table mr-2"></i>Voir les tableaux</a></li>
            <li><a href="selectivity.html" class="hover:text-yellow-300 transition"><i class="fas fa-shield-alt mr-2"></i>Sélectivité</a></li>
            <li><a href="obsolescence.html" class="hover:text-yellow-300 transition"><i class="fas fa-clock mr-2"></i>Obsolescence</a></li>
            <li><a href="fault_level_assessment.html" class="hover:text-yellow-300 transition"><i class="fas fa-bolt mr-2"></i>Évaluation du Niveau de Défaut</a></li>
            <li><a href="hazards_assessment.html" class="hover:text-yellow-300 transition"><i class="fas fa-exclamation-triangle mr-2"></i>Évaluation des Risques</a></li>
            <li><a href="maintenance_org.html" class="hover:text-yellow-300 transition"><i class="fas fa-sitemap mr-2"></i>Organigramme Maintenance</a></li>
            <li><a href="distribution_emergency.html" class="hover:text-yellow-300 transition"><i class="fas fa-plug mr-2"></i>Urgence Distribution</a></li>
            <li><a href="reports.html" class="hover:text-yellow-300 transition"><i class="fas fa-file-alt mr-2"></i>Rapports</a></li>
            <li><a href="electrical_safety_program.html" class="hover:text-yellow-300 transition"><i class="fas fa-hard-hat mr-2"></i>Programme de Sécurité Électrique</a></li>
            <li><a href="breaker_control.html" class="hover:text-yellow-300 transition"><i class="fas fa-cogs mr-2"></i>Contrôle des Disjoncteurs</a></li>
        </ul>
    </nav>

    <div class="container mx-auto p-4 sm:p-6">
        <h1 class="text-2xl sm:text-3xl font-bold text-center mb-4 sm:mb-6 flex items-center"><i class="fas fa-edit mr-2 sm:mr-3"></i>Modifier un tableau électrique</h1>

        <div class="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg mb-4 sm:mb-6 animate-fade-in">
            <h2 class="text-lg sm:text-xl font-semibold mb-4 flex items-center"><i class="fas fa-info-circle mr-2"></i>Étapes pour modifier un tableau</h2>
            <ol class="list-decimal list-inside space-y-2 text-sm sm:text-base text-gray-300">
                <li>Vérifiez l'identifiant du tableau (modifiable, doit être unique).</li>
                <li>Indiquez si le tableau est le général principal du site (enregistré automatiquement).</li>
                <li>Indiquez si le tableau est alimenté par une cellule HTA et configurez les paramètres HTA si nécessaire.</li>
                <li>Modifiez les disjoncteurs existants via le bouton "Modifier" (enregistré immédiatement).</li>
                <li>Ajoutez des disjoncteurs en :
                    <ul class="list-disc list-inside ml-6">
                        <li>Recherchant avec OpenAI (marque et référence).</li>
                        <li>Sélectionnant un disjoncteur existant (marque et référence).</li>
                        <li>Entrant les données manuellement.</li>
                    </ul>
                </li>
                <li>Transférer un disjoncteur vers un autre tableau via le bouton "Transférer".</li>
                <li>Lier un disjoncteur non principal à un ou plusieurs tableaux BT avals via le champ "Tableaux avals".</li>
                <li>Vérifiez les conflits d'ID (en rouge).</li>
                <li>Désignez un disjoncteur comme principal.</li>
                <li>Enregistrez les modifications pour les nouveaux disjoncteurs ou l'ID du tableau.</li>
            </ol>
        </div>

        <div class="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg">
            <h2 class="text-lg sm:text-xl font-semibold mb-4 flex items-center"><i class="fas fa-table mr-2"></i>Informations du tableau</h2>
            <div class="mb-4">
                <label for="tableau-id" class="block text-sm font-medium">Identifiant du tableau</label>
                <input id="tableau-id" type="text" class="mt-1 w-full p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Ex. 40-8-G ou HTA-01">
            </div>
            <div class="mb-4">
                <label class="inline-flex items-center">
                    <input id="tableau-issitemain" type="checkbox" class="form-checkbox h-5 w-5 text-blue-600" onchange="saveIsSiteMain()">
                    <span class="ml-2 text-sm font-medium">Tableau général principal du site</span>
                </label>
                <p class="text-xs text-gray-500">Cochez si ce tableau est le principal du site (pas de disjoncteur amont). Modification enregistrée automatiquement.</p>
                <div id="issitemain-message" class="mt-2 p-2 rounded text-sm hidden"></div>
            </div>
            <div class="mb-4">
                <label class="inline-flex items-center">
                    <input id="tableau-isHTA" type="checkbox" class="form-checkbox h-5 w-5 text-blue-600" onchange="toggleHTAFields()">
                    <span class="ml-2 text-sm font-medium">Tableau alimenté par une cellule HTA</span>
                </label>
                <p class="text-xs text-gray-500">Cochez si ce tableau est HTA.</p>
            </div>
            <div id="hta-fields" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="hta-transformerPower" class="block text-sm font-medium">Puissance du transformateur (kVA)</label>
                    <input id="hta-transformerPower" type="number" step="0.01" class="mt-1 w-full p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Ex. 1600">
                </div>
                <div>
                    <label for="hta-voltage" class="block text-sm font-medium">Tension HTA (kV)</label>
                    <input id="hta-voltage" type="number" step="0.01" class="mt-1 w-full p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Ex. 20">
                </div>
                <div>
                    <label for="hta-in" class="block text-sm font-medium">Courant nominal (In, A)</label>
                    <input id="hta-in" type="number" step="0.01" class="mt-1 w-full p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Ex. 50">
                </div>
                <div>
                    <label for="hta-ir" class="block text-sm font-medium">Courant réglable (Ir, A)</label>
                    <input id="hta-ir" type="number" step="0.01" class="mt-1 w-full p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Ex. 40">
                </div>
                <div>
                    <label for="hta-triptime" class="block text-sm font-medium">Temps de déclenchement (s)</label>
                    <input id="hta-triptime" type="number" step="0.01" class="mt-1 w-full p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Ex. 0.2">
                </div>
                <div>
                    <label for="hta-icn" class="block text-sm font-medium">Pouvoir de coupure (Icn, kA)</label>
                    <input id="hta-icn" type="number" step="0.01" class="mt-1 w-full p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Ex. 16">
                </div>
            </div>

            <h2 class="text-lg sm:text-xl font-semibold mb-4 flex items-center"><i class="fas fa-cogs mr-2"></i>Ajouter un disjoncteur</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="disjoncteur-marque" class="block text-sm font-medium">Marque</label>
                    <input id="disjoncteur-marque" type="text" class="mt-1 w-full p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Ex. Schneider Electric">
                </div>
                <div>
                    <label for="disjoncteur-ref" class="block text-sm font-medium">Référence</label>
                    <input id="disjoncteur-ref" type="text" class="mt-1 w-full p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Ex. C60N">
                </div>
            </div>
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 mb-4">
                <button onclick="rechercherDisjoncteur()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 touch-friendly"><i class="fas fa-search mr-2"></i>Rechercher via OpenAI</button>
                <button onclick="ajouterManuel()" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 touch-friendly"><i class="fas fa-plus mr-2"></i>Ajouter manuellement</button>
            </div>
            <div class="mb-4">
                <label for="disjoncteur-existant" class="block text-sm font-medium">Sélectionner un disjoncteur existant</label>
                <select id="disjoncteur-existant" class="mt-1 w-full p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base">
                    <option value="">-- Choisir un disjoncteur --</option>
                </select>
                <button onclick="ajouterDisjoncteurExistant()" class="bg-green-600 text-white px-4 py-2 rounded mt-2 hover:bg-green-700 touch-friendly"><i class="fas fa-plus-circle mr-2"></i>Ajouter</button>
            </div>

            <div id="disjoncteur-form" class="mt-4 hidden">
                <h3 class="text-lg font-semibold mb-2 flex items-center"><i class="fas fa-cog mr-2"></i>Caractéristiques du disjoncteur</h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label for="disjoncteur-id" class="block text-sm font-medium">ID <span class="text-red-600">*</span></label>
                        <input id="disjoncteur-id" type="text" class="mt-1 w-full p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Ex. 11F1 Compresseur">
                        <p class="text-xs text-gray-500">Obligatoire, unique dans ce tableau, ex. 11F1 Compresseur</p>
                    </div>
                    <div>
                        <label for="disjoncteur-type" class="block text-sm font-medium">Type</label>
                        <input id="disjoncteur-type" type="text" class="mt-1 w-full p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Ex. disjoncteur">
                        <p class="text-xs text-gray-500">Type d'appareil, ex. disjoncteur</p>
                    </div>
                    <div>
                        <label for="disjoncteur-poles" class="block text-sm font-medium">Pôles</label>
                        <input id="disjoncteur-poles" type="text" class="mt-1 w-full p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Ex. 2P">
                        <p class="text-xs text-gray-500">Ex. 1P, 2P, 3P ou 4P</p>
                    </div>
                    <div>
                        <label for="disjoncteur-montage" class="block text-sm font-medium">Montage</label>
                        <input id="disjoncteur-montage" type="text" class="mt-1 w-full p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Ex. rail DIN">
                        <p class="text-xs text-gray-500">Type de montage, ex. rail DIN</p>
                    </div>
                    <div>
                        <label for="disjoncteur-ue" class="block text-sm font-medium">Ue</label>
                        <input id="disjoncteur-ue" type="text" class="mt-1 w-full p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Ex. 230/400 V AC">
                        <p class="text-xs text-gray-500">Tension nominale, ex. 230/400 V AC</p>
                    </div>
                    <div>
                        <label for="disjoncteur-ui" class="block text-sm font-medium">Ui</label>
                        <input id="disjoncteur-ui" type="text" class="mt-1 w-full p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Ex. 500 V">
                        <p class="text-xs text-gray-500">Tension d'isolation, ex. 500 V</p>
                    </div>
                    <div>
                        <label for="disjoncteur-uimp" class="block text-sm font-medium">Uimp</label>
                        <input id="disjoncteur-uimp" type="text" class="mt-1 w-full p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Ex. 6 kV">
                        <p class="text-xs text-gray-500">Tension de choc, ex. 6 kV</p>
                    </div>
                    <div>
                        <label for="disjoncteur-frequence" class="block text-sm font-medium">Fréquence</label>
                        <input id="disjoncteur-frequence" type="text" class="mt-1 w-full p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Ex. 50/60 Hz">
                        <p class="text-xs text-gray-500">Ex. 50/60 Hz</p>
                    </div>
                    <div>
                        <label for="disjoncteur-in" class="block text-sm font-medium">In</label>
                        <input id="disjoncteur-in" type="text" class="mt-1 w-full p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Ex. 16 A">
                        <p class="text-xs text-gray-500">Courant nominal, ex. 16 A</p>
                    </div>
                    <div>
                        <label for="disjoncteur-ir" class="block text-sm font-medium">Ir</label>
                        <input id="disjoncteur-ir" type="text" class="mt-1 w-full p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Ex. 63 A">
                        <p class="text-xs text-gray-500">Courant réglable, ex. 63 A</p>
                    </div>
                    <div>
                        <label for="disjoncteur-courbe" class="block text-sm font-medium">Courbe</label>
                        <input id="disjoncteur-courbe" type="text" class="mt-1 w-full p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Ex. C">
                        <p class="text-xs text-gray-500">Une valeur : B, C ou D</p>
                    </div>
                    <div>
                        <label for="disjoncteur-triptime" class="block text-sm font-medium">TripTime</label>
                        <input id="disjoncteur-triptime" type="text" class="mt-1 w-full p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Ex. 0.1 s">
                        <p class="text-xs text-gray-500">Temps de déclenchement, ex. 0.1 s</p>
                    </div>
                    <div>
                        <label for="disjoncteur-icn" class="block text-sm font-medium">Icn</label>
                        <input id="disjoncteur-icn" type="text" class="mt-1 w-full p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Ex. 6 kA">
                        <p class="text-xs text-gray-500">Pouvoir de coupure, ex. 6 kA</p>
                    </div>
                    <div>
                        <label for="disjoncteur-ics" class="block text-sm font-medium">Ics</label>
                        <input id="disjoncteur-ics" type="text" class="mt-1 w-full p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Ex. 4.5 kA">
                        <p class="text-xs text-gray-500">Pouvoir de coupure de service, ex. 4.5 kA</p>
                    </div>
                    <div>
                        <label for="disjoncteur-ip" class="block text-sm font-medium">IP</label>
                        <input id="disjoncteur-ip" type="text" class="mt-1 w-full p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Ex. IP20">
                        <p class="text-xs text-gray-500">Indice de protection, ex. IP20</p>
                    </div>
                    <div>
                        <label for="disjoncteur-temp" class="block text-sm font-medium">Température</label>
                        <input id="disjoncteur-temp" type="text" class="mt-1 w-full p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Ex. -25°C à +70°C">
                        <p class="text-xs text-gray-500">Plage de température, ex. -25°C à +70°C</p>
                    </div>
                    <div>
                        <label for="disjoncteur-dimensions" class="block text-sm font-medium">Dimensions</label>
                        <input id="disjoncteur-dimensions" type="text" class="mt-1 w-full p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Ex. 18 x 85 x 70 mm">
                        <p class="text-xs text-gray-500">L x H x P, ex. 18 x 85 x 70 mm</p>
                    </div>
                    <div>
                        <label for="disjoncteur-section" class="block text-sm font-medium">Section</label>
                        <input id="disjoncteur-section" type="text" class="mt-1 w-full p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Ex. 2.5 mm²">
                        <p class="text-xs text-gray-500">Section de câble, ex. 2.5 mm²</p>
                    </div>
                    <div>
                        <label for="disjoncteur-date" class="block text-sm font-medium">Date de fabrication</label>
                        <input id="disjoncteur-date" type="text" class="mt-1 w-full p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Ex. 2023-01">
                        <p class="text-xs text-gray-500">Année ou mois/année, ex. 2023-01</p>
                    </div>
                    <div>
                        <label for="disjoncteur-tension" class="block text-sm font-medium">Type de tension</label>
                        <input id="disjoncteur-tension" type="text" class="mt-1 w-full p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Ex. AC">
                        <p class="text-xs text-gray-500">Ex. AC ou DC</p>
                    </div>
                    <div>
                        <label for="disjoncteur-selectivite" class="block text-sm font-medium">Sélectivité</label>
                        <input id="disjoncteur-selectivite" type="text" class="mt-1 w-full p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base" placeholder="Ex. sélectif">
                        <p class="text-xs text-gray-500">Type de sélectivité, ex. sélectif</p>
                    </div>
                    <div>
                        <label for="disjoncteur-linked-tableaux" class="block text-sm font-medium">Tableaux avals</label>
                        <select id="disjoncteur-linked-tableaux" multiple class="mt-1 w-full p-2 rounded bg-gray-700 text-white border-gray-600 text-sm sm:text-base">
                            <option value="">-- Aucun tableau aval --</option>
                        </select>
                        <p class="text-xs text-gray-500">Sélectionnez un ou plusieurs tableaux BT avals (non principal uniquement). Utilisez Ctrl/Cmd pour sélection multiple.</p>
                    </div>
                </div>
                <div class="flex space-x-4 mt-4">
                    <button id="disjoncteur-action" onclick="ajouterDisjoncteur()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 touch-friendly"><i class="fas fa-save mr-2"></i>Ajouter au tableau</button>
                </div>
            </div>
        </div>

        <div class="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg mt-4 sm:mt-6">
            <h2 class="text-lg sm:text-xl font-semibold mb-4 flex items-center"><i class="fas fa-list mr-2"></i>Disjoncteurs du tableau</h2>
            <div class="overflow-x-auto">
                <table id="disjoncteurs-table" class="w-full text-sm sm:text-base">
                    <thead>
                        <tr class="bg-gray-700">
                            <th class="p-2">ID</th>
                            <th class="p-2">Marque</th>
                            <th class="p-2">Référence</th>
                            <th class="p-2">Principal</th>
                            <th class="p-2">Liaisons</th>
                            <th class="p-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="6" class="p-2 text-center">Ligne statique manuelle</td></tr>
                    </tbody>
                </table>
            </div>
            <button onclick="enregistrerModifications()" class="bg-blue-600 text-white px-4 py-2 rounded mt-4 hover:bg-blue-700 touch-friendly"><i class="fas fa-save mr-2"></i>Enregistrer les modifications</button>
        </div>

        <div id="popup" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full">
                <p id="popup-message" class="mb-4 text-sm sm:text-base"></p>
                <div id="popup-content" class="mb-4"></div>
                <div class="flex space-x-4">
                    <button id="popup-confirm" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 touch-friendly"><i class="fas fa-check mr-2"></i>Confirmer</button>
                    <button id="popup-cancel" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 touch-friendly"><i class="fas fa-times mr-2"></i>Annuler</button>
                </div>
            </div>
        </div>

        <script>
            let disjoncteurs = [];
            let disjoncteurPrincipalIndex = null;
            let tableauId = new URLSearchParams(window.location.search).get('id');
            let editIndex = null;
            let tableaux = [];
            let issitemain = false;
            let isSiteMainError = false;
            let isHTA = false;

            function normalizeNumericValue(value) {
                if (!value) return '';
                if (typeof value === 'number' && !isNaN(value)) {
                    if (value.toString().includes('.')) return `${value} kA`;
                    return `${value} A`;
                }
                if (typeof value === 'string') {
                    const match = value.match(/[\d.]+/);
                    if (!match) return '';
                    const num = parseFloat(match[0]);
                    if (value.includes('kA')) return `${num} kA`;
                    if (value.includes('s')) return `${num} s`;
                    return `${num} A`;
                }
                return '';
            }

            function validateDisjoncteurId(id) {
                const validIdRegex = /^[\p{L}0-9\s\-_:]+$/u;
                return validIdRegex.test(id);
            }

            function showPopup(message, content = '', confirmCallback = () => {}) {
                console.log('[Edit] Affichage pop-up:', message);
                document.getElementById('popup-message').textContent = message;
                document.getElementById('popup-content').innerHTML = content;
                document.getElementById('popup').classList.remove('hidden');
                document.getElementById('popup-confirm').onclick = () => {
                    console.log('[Edit] Pop-up confirmé:', message);
                    confirmCallback();
                    hidePopup();
                };
                document.getElementById('popup-cancel').onclick = () => {
                    console.log('[Edit] Pop-up annulé:', message);
                    hidePopup();
                };
                gsap.from('#popup > div', { opacity: 0, scale: 0.8, duration: 0.5, ease: 'power2.out' });
            }

            function hidePopup() {
                console.log('[Edit] Masquage pop-up');
                document.getElementById('popup').classList.add('hidden');
            }

            function toggleHTAFields() {
                isHTA = document.getElementById('tableau-isHTA').checked;
                const htaFields = document.getElementById('hta-fields');
                console.log('[Edit] Bascule champs HTA:', isHTA);
                htaFields.classList.toggle('hidden', !isHTA);
                if (!isHTA) {
                    document.getElementById('hta-transformerPower').value = '';
                    document.getElementById('hta-voltage').value = '';
                    document.getElementById('hta-in').value = '';
                    document.getElementById('hta-ir').value = '';
                    document.getElementById('hta-triptime').value = '';
                    document.getElementById('hta-icn').value = '';
                }
            }

            function collectHTAData() {
                if (!document.getElementById('tableau-isHTA').checked) {
                    console.log('[Edit] HTA non sélectionné, retour null');
                    return null;
                }
                const transformerPower = parseFloat(document.getElementById('hta-transformerPower').value);
                const voltage = parseFloat(document.getElementById('hta-voltage').value);
                const inCurrent = parseFloat(document.getElementById('hta-in').value);
                const irCurrent = parseFloat(document.getElementById('hta-ir').value);
                const triptime = parseFloat(document.getElementById('hta-triptime').value);
                const icn = parseFloat(document.getElementById('hta-icn').value);
                console.log('[Edit] Collecte données HTA:', { transformerPower, voltage, inCurrent, irCurrent, triptime, icn });
                const errors = [];
                if (isNaN(transformerPower) || transformerPower <= 0) errors.push('Puissance du transformateur');
                if (isNaN(voltage) || voltage <= 0) errors.push('Tension HTA');
                if (isNaN(inCurrent) || inCurrent <= 0) errors.push('Courant nominal');
                if (isNaN(irCurrent) || irCurrent <= 0) errors.push('Courant réglable');
                if (isNaN(triptime) || triptime <= 0) errors.push('Temps de déclenchement');
                if (isNaN(icn) || icn <= 0) errors.push('Pouvoir de coupure');
                if (errors.length > 0) {
                    console.log('[Edit] Erreurs validation HTA:', errors);
                    showPopup(`Veuillez remplir correctement les champs HTA suivants : ${errors.join(', ')}.`, '', () => {});
                    return null;
                }
                return {
                    transformerPower: `${transformerPower} kVA`,
                    voltage: `${voltage} kV`,
                    in: `${inCurrent} A`,
                    ir: `${irCurrent} A`,
                    triptime: `${triptime} s`,
                    icn: `${icn} kA`
                };
            }

            async function chargerTableau() {
                console.log('[Edit] Chargement tableau:', tableauId);
                try {
                    if (!tableauId) {
                        console.log('[Edit] Aucun ID de tableau fourni, initialisation vide');
                        disjoncteurs = [];
                        document.getElementById('tableau-id').value = '';
                        document.getElementById('tableau-issitemain').checked = false;
                        document.getElementById('tableau-isHTA').checked = false;
                        toggleHTAFields();
                        issitemain = false;
                        isHTA = false;
                        afficherDisjoncteurs();
                        return;
                    }
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);
                    const response = await fetch(`/api/tableaux/${encodeURIComponent(tableauId)}`, { signal: controller.signal });
                    clearTimeout(timeoutId);
                    if (!response.ok) {
                        console.log('[Edit] Tableau non trouvé:', tableauId, 'Statut:', response.status);
                        showPopup('Tableau non trouvé. Initialisation avec un tableau vide.', '', () => {
                            disjoncteurs = [];
                            afficherDisjoncteurs();
                        });
                        return;
                    }
                    const tableau = await response.json();
                    console.log('[Edit] Tableau reçu:', { id: tableau.id, issitemain: tableau.issitemain, isHTA: tableau.isHTA, htaData: tableau.htaData, disjoncteurs: tableau.disjoncteurs.length });
                    document.getElementById('tableau-id').value = tableau.id;
                    document.getElementById('tableau-issitemain').checked = tableau.issitemain || false;
                    document.getElementById('tableau-isHTA').checked = tableau.isHTA || false;
                    toggleHTAFields();
                    issitemain = tableau.issitemain || false;
                    isHTA = tableau.isHTA || false;
                    if (tableau.isHTA && tableau.htaData) {
                        console.log('[Edit] Remplissage champs HTA:', tableau.htaData);
                        document.getElementById('hta-transformerPower').value = parseFloat(tableau.htaData.transformerPower) || '';
                        document.getElementById('hta-voltage').value = parseFloat(tableau.htaData.voltage) || '';
                        document.getElementById('hta-in').value = parseFloat(tableau.htaData.in) || '';
                        document.getElementById('hta-ir').value = parseFloat(tableau.htaData.ir) || '';
                        document.getElementById('hta-triptime').value = parseFloat(tableau.htaData.triptime) || '';
                        document.getElementById('hta-icn').value = parseFloat(tableau.htaData.icn) || '';
                    } else {
                        console.log('[Edit] Pas de données HTA à charger');
                        document.getElementById('hta-transformerPower').value = '';
                        document.getElementById('hta-voltage').value = '';
                        document.getElementById('hta-in').value = '';
                        document.getElementById('hta-ir').value = '';
                        document.getElementById('hta-triptime').value = '';
                        document.getElementById('hta-icn').value = '';
                    }
                    disjoncteurs = (tableau.disjoncteurs || []).map(d => ({
                        ...d,
                        id: d.id || d.disjoncteur_id || `unknown_${Math.random().toString(36).substring(2, 9)}`,
                        icn: normalizeNumericValue(d.icn),
                        ics: normalizeNumericValue(d.ics),
                        in: normalizeNumericValue(d.in),
                        ir: normalizeNumericValue(d.ir),
                        triptime: normalizeNumericValue(d.triptime),
                        isPrincipal: d.isPrincipal || false,
                        linkedTableauIds: d.linkedTableauIds || (d.linkedTableauId ? [d.linkedTableauId] : [])
                    }));
                    disjoncteurPrincipalIndex = disjoncteurs.findIndex(d => d.isPrincipal);
                    console.log('[Edit] Disjoncteurs normalisés:', disjoncteurs);
                    afficherDisjoncteurs();
                    console.log('[Edit] Tableau chargé:', tableau.id, 'Principal index:', disjoncteurPrincipalIndex, 'issitemain:', issitemain, 'isHTA:', isHTA);
                } catch (error) {
                    console.error('[Edit] Erreur chargement tableau:', error);
                    showPopup('Erreur lors du chargement du tableau: ' + error.message, '', () => {});
                }
            }

            async function saveIsSiteMain() {
                console.log('[Edit] Sauvegarde issitemain');
                const newIsSiteMain = document.getElementById('tableau-issitemain').checked;
                const messageDiv = document.getElementById('issitemain-message');
                if (isSiteMainError) {
                    messageDiv.classList.add('hidden');
                    isSiteMainError = false;
                }
                try {
                    console.log('[Edit] Envoi requête PUT /api/tableaux/', tableauId, { issitemain: newIsSiteMain });
                    const htaData = collectHTAData();
                    const normalizedDisjoncteurs = disjoncteurs.map(d => ({
                        ...d,
                        icn: normalizeNumericValue(d.icn),
                        ics: normalizeNumericValue(d.ics),
                        in: normalizeNumericValue(d.in),
                        ir: normalizeNumericValue(d.ir),
                        triptime: normalizeNumericValue(d.triptime)
                    }));
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);
                    const response = await fetch(`/api/tableaux/${encodeURIComponent(tableauId)}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: tableauId, disjoncteurs: normalizedDisjoncteurs, issitemain: newIsSiteMain, isHTA, htaData }),
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    const data = await response.json();
                    console.log('[Edit] Réponse serveur issitemain:', { status: response.status, data });
                    if (!response.ok) {
                        throw new Error(data.error || `Erreur serveur (statut ${response.status})`);
                    }
                    issitemain = newIsSiteMain;
                    messageDiv.textContent = 'Statut de tableau principal du site mis à jour.';
                    messageDiv.className = 'bg-green-100 text-green-800 mt-2 p-2 rounded text-sm';
                    messageDiv.classList.remove('hidden');
                    setTimeout(() => {
                        if (!isSiteMainError) messageDiv.classList.add('hidden');
                    }, 5000);
                    await chargerTableau();
                } catch (error) {
                    console.error('[Edit] Erreur sauvegarde issitemain:', error);
                    isSiteMainError = true;
                    document.getElementById('tableau-issitemain').checked = issitemain;
                    messageDiv.innerHTML = `Erreur lors de la mise à jour du statut: ${error.message}. <button onclick="saveIsSiteMain()" class="underline text-blue-600">Réessayer</button>`;
                    messageDiv.className = 'bg-red-100 text-red-800 mt-2 p-2 rounded text-sm';
                    messageDiv.classList.remove('hidden');
                }
            }

            async function chargerDisjoncteursExistants() {
                console.log('[Edit] Chargement disjoncteurs existants');
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);
                    const response = await fetch('/api/disjoncteurs', { signal: controller.signal });
                    clearTimeout(timeoutId);
                    if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
                    const disjoncteursExistants = await response.json();
                    console.log('[Edit] Disjoncteurs existants reçus:', disjoncteursExistants.length);
                    const select = document.getElementById('disjoncteur-existant');
                    select.innerHTML = '<option value="">-- Choisir un disjoncteur --</option>';
                    disjoncteursExistants.forEach(d => {
                        const normalizedDisjoncteur = {
                            ...d,
                            icn: normalizeNumericValue(d.icn),
                            ics: normalizeNumericValue(d.ics),
                            in: normalizeNumericValue(d.in),
                            ir: normalizeNumericValue(d.ir),
                            triptime: normalizeNumericValue(d.triptime)
                        };
                        const option = document.createElement('option');
                        option.value = JSON.stringify(normalizedDisjoncteur);
                        option.textContent = `${d.marque} ${d.ref}`;
                        select.appendChild(option);
                    });
                } catch (error) {
                    console.error('[Edit] Erreur chargement disjoncteurs existants:', error);
                    showPopup('Erreur lors du chargement des disjoncteurs existants: ' + error.message, '', () => {});
                }
            }

            async function chargerTableaux() {
                console.log('[Edit] Chargement liste tableaux');
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);
                    const response = await fetch('/api/tableaux', { signal: controller.signal });
                    clearTimeout(timeoutId);
                    if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
                    tableaux = await response.json();
                    console.log('[Edit] Tableaux chargés:', tableaux.length);
                    const select = document.getElementById('disjoncteur-linked-tableaux');
                    select.innerHTML = '<option value="">-- Aucun tableau aval --</option>';
                    tableaux
                        .filter(t => t.id !== tableauId && !t.isHTA)
                        .forEach(t => {
                            const option = document.createElement('option');
                            option.value = t.id;
                            option.textContent = t.id + (t.issitemain ? ' (Principal)' : '');
                            select.appendChild(option);
                        });
                } catch (error) {
                    console.error('[Edit] Erreur chargement tableaux:', error);
                    showPopup('Erreur lors du chargement des tableaux: ' + error.message, '', () => {});
                }
            }

            function afficherDisjoncteurs() {
                console.log('[Edit] Affichage disjoncteurs, total:', disjoncteurs.length, 'principal index:', disjoncteurPrincipalIndex);
                const tbody = document.querySelector('#disjoncteurs-table tbody');
                if (!tbody) {
                    console.error('[Edit] Erreur: tbody non trouvé pour #disjoncteurs-table');
                    showPopup('Erreur: Impossible d\'afficher les disjoncteurs. Vérifiez la structure HTML.', '', () => {});
                    return;
                }
                tbody.innerHTML = '';
                console.log('[Edit] tbody vidé');
                const testRow = document.createElement('tr');
                testRow.innerHTML = '<td colspan="6" class="p-2 text-center">Ligne de test pour vérifier l’affichage</td>';
                tbody.appendChild(testRow);
                console.log('[Edit] Ligne de test ajoutée');
                const idCounts = {};
                disjoncteurs.forEach(d => {
                    idCounts[d.id] = (idCounts[d.id] || 0) + 1;
                });
                disjoncteurs.sort((a, b) => (a.id || '').localeCompare(b.id || ''));
                let rowCount = 0;
                disjoncteurs.forEach((d, index) => {
                    if (!d.id) {
                        console.warn('[Edit] Disjoncteur sans ID à l\'index:', index, d);
                        return;
                    }
                    const isPrincipal = d.isPrincipal || false;
                    console.log('[Edit] Disjoncteur', d.id, 'index:', index, 'isPrincipal:', isPrincipal, 'linkedTableauIds:', d.linkedTableauIds || []);
                    const hasConflict = idCounts[d.id] > 1;
                    const row = document.createElement('tr');
                    if (isPrincipal) row.className = 'disjoncteur-principal';
                    const idCell = document.createElement('td');
                    idCell.className = `p-2 ${hasConflict ? 'conflict' : ''}`;
                    idCell.textContent = `${d.id}${hasConflict ? ' (Conflit)' : ''}`;
                    row.appendChild(idCell);
                    const marqueCell = document.createElement('td');
                    marqueCell.className = 'p-2';
                    marqueCell.textContent = d.marque || 'N/A';
                    row.appendChild(marqueCell);
                    const refCell = document.createElement('td');
                    refCell.className = 'p-2';
                    refCell.textContent = d.ref || 'N/A';
                    row.appendChild(refCell);
                    const principalCell = document.createElement('td');
                    principalCell.className = 'p-2 text-center';
                    principalCell.textContent = isPrincipal ? '⭐ Principal' : '';
                    row.appendChild(principalCell);
                    const liaisonCell = document.createElement('td');
                    liaisonCell.className = 'p-2';
                    liaisonCell.textContent = isPrincipal ? 'Lié à tous les avals' : (d.linkedTableauIds?.length > 0 ? `Lié à ${d.linkedTableauIds.join(', ')}` : 'Non lié');
                    row.appendChild(liaisonCell);
                    const actionsCell = document.createElement('td');
                    actionsCell.className = 'p-2 flex space-x-2';
                    const modifierBtn = document.createElement('button');
                    modifierBtn.className = 'bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700 touch-friendly';
                    modifierBtn.innerHTML = '<i class="fas fa-edit"></i>';
                    modifierBtn.onclick = () => modifierDisjoncteur(index);
                    actionsCell.appendChild(modifierBtn);
                    const supprimerBtn = document.createElement('button');
                    supprimerBtn.className = 'bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700 touch-friendly';
                    supprimerBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    supprimerBtn.onclick = () => supprimerDisjoncteur(index);
                    actionsCell.appendChild(supprimerBtn);
                    const transfererBtn = document.createElement('button');
                    transfererBtn.className = 'bg-purple-600 text-white px-2 py-1 rounded hover:bg-purple-700 touch-friendly';
                    transfererBtn.innerHTML = '<i class="fas fa-exchange-alt"></i>';
                    transfererBtn.onclick = () => transfererDisjoncteur(index);
                    actionsCell.appendChild(transfererBtn);
                    if (!isPrincipal) {
                        const principalBtn = document.createElement('button');
                        principalBtn.className = 'bg-yellow-600 text-white px-2 py-1 rounded hover:bg-yellow-700 touch-friendly';
                        principalBtn.innerHTML = '<i class="fas fa-star"></i>';
                        principalBtn.onclick = () => designerPrincipal(index);
                        actionsCell.appendChild(principalBtn);
                    }
                    row.appendChild(actionsCell);
                    tbody.appendChild(row);
                    rowCount++;
                    console.log('[Edit] Ligne ajoutée pour disjoncteur', d.id, 'index:', index);
                });
                console.log('[Edit] Total lignes ajoutées:', rowCount);
                if (rowCount === 0) {
                    const emptyRow = document.createElement('tr');
                    emptyRow.innerHTML = '<td colspan="6" class="p-2 text-center text-gray-500">Aucun disjoncteur à afficher</td>';
                    tbody.appendChild(emptyRow);
                    console.log('[Edit] Ligne vide ajoutée pour table vide');
                }
                console.log('[Edit] Contenu tbody:', tbody.innerHTML);
            }

            async function rechercherDisjoncteur() {
                console.log('[Edit] Bouton Rechercher via OpenAI cliqué');
                const marque = document.getElementById('disjoncteur-marque').value.trim();
                const ref = document.getElementById('disjoncteur-ref').value.trim();
                if (!marque || !ref) {
                    console.log('[Edit] Erreur: Marque ou référence vide');
                    showPopup('Veuillez entrer la marque et la référence.', '', () => {});
                    return;
                }
                try {
                    console.log('[Edit] Envoi requête OpenAI pour', { marque, ref });
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);
                    const response = await fetch('/api/disjoncteur', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ marque, ref }),
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    const data = await response.json();
                    console.log('[Edit] Données OpenAI reçues:', data);
                    if (response.ok && data && Object.keys(data).length > 0) {
                        document.getElementById('disjoncteur-form').classList.remove('hidden');
                        document.getElementById('disjoncteur-id').value = '';
                        document.getElementById('disjoncteur-type').value = data.type || '';
                        document.getElementById('disjoncteur-poles').value = data.poles || '';
                        document.getElementById('disjoncteur-montage').value = data.montage || '';
                        document.getElementById('disjoncteur-ue').value = data.ue || '';
                        document.getElementById('disjoncteur-ui').value = data.ui || '';
                        document.getElementById('disjoncteur-uimp').value = data.uimp || '';
                        document.getElementById('disjoncteur-frequence').value = data.frequence || '';
                        document.getElementById('disjoncteur-in').value = normalizeNumericValue(data.in) || '';
                        document.getElementById('disjoncteur-ir').value = normalizeNumericValue(data.ir) || '';
                        document.getElementById('disjoncteur-courbe').value = data.courbe || '';
                        document.getElementById('disjoncteur-triptime').value = normalizeNumericValue(data.triptime) || '';
                        document.getElementById('disjoncteur-icn').value = normalizeNumericValue(data.icn) || '';
                        document.getElementById('disjoncteur-ics').value = normalizeNumericValue(data.ics) || '';
                        document.getElementById('disjoncteur-ip').value = data.ip || '';
                        document.getElementById('disjoncteur-temp').value = data.temp || '';
                        document.getElementById('disjoncteur-dimensions').value = data.dimensions || '';
                        document.getElementById('disjoncteur-section').value = data.section || '';
                        document.getElementById('disjoncteur-date').value = data.date || '';
                        document.getElementById('disjoncteur-tension').value = data.tension || '';
                        document.getElementById('disjoncteur-selectivite').value = data.selectivite || '';
                        document.getElementById('disjoncteur-marque').value = marque;
                        document.getElementById('disjoncteur-ref').value = ref;
                        document.getElementById('disjoncteur-action').textContent = 'Ajouter au tableau';
                        const linkedSelect = document.getElementById('disjoncteur-linked-tableaux');
                        Array.from(linkedSelect.options).forEach(opt => opt.selected = false);
                        linkedSelect.disabled = false;
                        editIndex = null;
                    } else {
                        console.log('[Edit] Aucune donnée OpenAI reçue');
                        showPopup('Aucune donnée trouvée pour ce disjoncteur. Essayez manuellement ou vérifiez la marque/référence.', '', () => {});
                    }
                } catch (error) {
                    console.error('[Edit] Erreur recherche OpenAI:', error);
                    showPopup('Erreur lors de la recherche OpenAI: ' + error.message, '', () => {});
                }
            }

            function ajouterManuel() {
                console.log('[Edit] Bouton Ajouter manuellement cliqué');
                document.getElementById('disjoncteur-form').classList.remove('hidden');
                document.getElementById('disjoncteur-id').value = '';
                document.getElementById('disjoncteur-type').value = '';
                document.getElementById('disjoncteur-poles').value = '';
                document.getElementById('disjoncteur-montage').value = '';
                document.getElementById('disjoncteur-ue').value = '';
                document.getElementById('disjoncteur-ui').value = '';
                document.getElementById('disjoncteur-uimp').value = '';
                document.getElementById('disjoncteur-frequence').value = '';
                document.getElementById('disjoncteur-in').value = '';
                document.getElementById('disjoncteur-ir').value = '';
                document.getElementById('disjoncteur-courbe').value = '';
                document.getElementById('disjoncteur-triptime').value = '';
                document.getElementById('disjoncteur-icn').value = '';
                document.getElementById('disjoncteur-ics').value = '';
                document.getElementById('disjoncteur-ip').value = '';
                document.getElementById('disjoncteur-temp').value = '';
                document.getElementById('disjoncteur-dimensions').value = '';
                document.getElementById('disjoncteur-section').value = '';
                document.getElementById('disjoncteur-date').value = '';
                document.getElementById('disjoncteur-tension').value = '';
                document.getElementById('disjoncteur-selectivite').value = '';
                document.getElementById('disjoncteur-marque').value = '';
                document.getElementById('disjoncteur-ref').value = '';
                document.getElementById('disjoncteur-action').textContent = 'Ajouter au tableau';
                const linkedSelect = document.getElementById('disjoncteur-linked-tableaux');
                Array.from(linkedSelect.options).forEach(opt => opt.selected = false);
                linkedSelect.disabled = false;
                editIndex = null;
            }

            async function ajouterDisjoncteurExistant() {
                console.log('[Edit] Bouton Ajouter (liste déroulante) cliqué');
                const select = document.getElementById('disjoncteur-existant');
                const selected = select.value;
                if (!selected) {
                    console.log('[Edit] Erreur: Aucun disjoncteur sélectionné');
                    showPopup('Veuillez sélectionner un disjoncteur.', '', () => {});
                    return;
                }
                try {
                    const disjoncteurBase = JSON.parse(selected);
                    console.log('[Edit] Disjoncteur sélectionné:', disjoncteurBase);
                    document.getElementById('disjoncteur-form').classList.remove('hidden');
                    document.getElementById('disjoncteur-id').value = '';
                    document.getElementById('disjoncteur-marque').value = disjoncteurBase.marque || '';
                    document.getElementById('disjoncteur-ref').value = disjoncteurBase.ref || '';
                    document.getElementById('disjoncteur-type').value = disjoncteurBase.type || '';
                    document.getElementById('disjoncteur-poles').value = disjoncteurBase.poles || '';
                    document.getElementById('disjoncteur-montage').value = disjoncteurBase.montage || '';
                    document.getElementById('disjoncteur-ue').value = disjoncteurBase.ue || '';
                    document.getElementById('disjoncteur-ui').value = disjoncteurBase.ui || '';
                    document.getElementById('disjoncteur-uimp').value = disjoncteurBase.uimp || '';
                    document.getElementById('disjoncteur-frequence').value = disjoncteurBase.frequence || '';
                    document.getElementById('disjoncteur-in').value = normalizeNumericValue(disjoncteurBase.in) || '';
                    document.getElementById('disjoncteur-ir').value = normalizeNumericValue(disjoncteurBase.ir) || '';
                    document.getElementById('disjoncteur-courbe').value = disjoncteurBase.courbe || '';
                    document.getElementById('disjoncteur-triptime').value = normalizeNumericValue(disjoncteurBase.triptime) || '';
                    document.getElementById('disjoncteur-icn').value = normalizeNumericValue(disjoncteurBase.icn) || '';
                    document.getElementById('disjoncteur-ics').value = normalizeNumericValue(disjoncteurBase.ics) || '';
                    document.getElementById('disjoncteur-ip').value = disjoncteurBase.ip || '';
                    document.getElementById('disjoncteur-temp').value = disjoncteurBase.temp || '';
                    document.getElementById('disjoncteur-dimensions').value = disjoncteurBase.dimensions || '';
                    document.getElementById('disjoncteur-section').value = disjoncteurBase.section || '';
                    document.getElementById('disjoncteur-date').value = disjoncteurBase.date || '';
                    document.getElementById('disjoncteur-tension').value = disjoncteurBase.tension || '';
                    document.getElementById('disjoncteur-selectivite').value = disjoncteurBase.selectivite || '';
                    document.getElementById('disjoncteur-action').textContent = 'Ajouter au tableau';
                    const linkedSelect = document.getElementById('disjoncteur-linked-tableaux');
                    Array.from(linkedSelect.options).forEach(opt => opt.selected = false);
                    linkedSelect.disabled = false;
                    editIndex = null;
                } catch (error) {
                    console.error('[Edit] Erreur parsing disjoncteur:', error);
                    showPopup('Erreur lors de la sélection du disjoncteur: ' + error.message, '', () => {});
                }
            }

            function modifierDisjoncteur(index) {
                console.log('[Edit] Bouton Modifier cliqué, index:', index);
                const disjoncteur = disjoncteurs[index];
                if (!disjoncteur) {
                    console.error('[Edit] Disjoncteur non trouvé à l\'index:', index);
                    showPopup('Erreur: Disjoncteur non trouvé.', '', () => {});
                    return;
                }
                console.log('[Edit] Disjoncteur à modifier:', disjoncteur);
                document.getElementById('disjoncteur-form').classList.remove('hidden');
                document.getElementById('disjoncteur-id').value = disjoncteur.id || '';
                document.getElementById('disjoncteur-marque').value = disjoncteur.marque || '';
                document.getElementById('disjoncteur-ref').value = disjoncteur.ref || '';
                document.getElementById('disjoncteur-type').value = disjoncteur.type || '';
                document.getElementById('disjoncteur-poles').value = disjoncteur.poles || '';
                document.getElementById('disjoncteur-montage').value = disjoncteur.montage || '';
                document.getElementById('disjoncteur-ue').value = disjoncteur.ue || '';
                document.getElementById('disjoncteur-ui').value = disjoncteur.ui || '';
                document.getElementById('disjoncteur-uimp').value = disjoncteur.uimp || '';
                document.getElementById('disjoncteur-frequence').value = disjoncteur.frequence || '';
                document.getElementById('disjoncteur-in').value = normalizeNumericValue(disjoncteur.in) || '';
                document.getElementById('disjoncteur-ir').value = normalizeNumericValue(disjoncteur.ir) || '';
                document.getElementById('disjoncteur-courbe').value = disjoncteur.courbe || '';
                document.getElementById('disjoncteur-triptime').value = normalizeNumericValue(disjoncteur.triptime) || '';
                document.getElementById('disjoncteur-icn').value = normalizeNumericValue(disjoncteur.icn) || '';
                document.getElementById('disjoncteur-ics').value = normalizeNumericValue(disjoncteur.ics) || '';
                document.getElementById('disjoncteur-ip').value = disjoncteur.ip || '';
                document.getElementById('disjoncteur-temp').value = disjoncteur.temp || '';
                document.getElementById('disjoncteur-dimensions').value = disjoncteur.dimensions || '';
                document.getElementById('disjoncteur-section').value = disjoncteur.section || '';
                document.getElementById('disjoncteur-date').value = disjoncteur.date || '';
                document.getElementById('disjoncteur-tension').value = disjoncteur.tension || '';
                document.getElementById('disjoncteur-selectivite').value = disjoncteur.selectivite || '';
                document.getElementById('disjoncteur-action').textContent = 'Modifier le disjoncteur';
                const linkedSelect = document.getElementById('disjoncteur-linked-tableaux');
                Array.from(linkedSelect.options).forEach(opt => {
                    opt.selected = disjoncteur.linkedTableauIds?.includes(opt.value);
                });
                linkedSelect.disabled = disjoncteur.isPrincipal;
                editIndex = index;
            }

            function transfererDisjoncteur(index) {
                console.log('[Edit] Bouton Transférer cliqué, index:', index);
                const disjoncteur = disjoncteurs[index];
                if (!disjoncteur) {
                    console.error('[Edit] Disjoncteur non trouvé à l\'index:', index);
                    showPopup('Erreur: Disjoncteur non trouvé.', '', () => {});
                    return;
                }
                const options = tableaux
                    .filter(t => t.id !== tableauId)
                    .map(t => `<option value="${t.id}">${t.id}${t.issitemain ? ' (Principal)' : ''}${t.isHTA ? ' (HTA)' : ''}</option>`).join('');
                if (!options.length) {
                    console.log('[Edit] Aucun autre tableau disponible pour le transfert');
                    showPopup('Aucun autre tableau disponible pour le transfert.', '', () => {});
                    return;
                }
                showPopup(`Transférer le disjoncteur ${disjoncteur.id} vers un autre tableau ?`,
                    `<select id="transfer-tableau" class="w-full p-2 border rounded bg-gray-700 text-white text-sm sm:text-base"><option value="">-- Choisir un tableau --</option>${options}</select>`,
                    async () => {
                        const targetId = document.getElementById('transfer-tableau').value;
                        if (!targetId) {
                            console.log('[Edit] Erreur: Aucun tableau cible sélectionné');
                            showPopup('Veuillez sélectionner un tableau.', '', () => {});
                            return;
                        }
                        console.log('[Edit] Transfert vers tableau:', targetId);
                        try {
                            const normalizedDisjoncteur = {
                                ...disjoncteur,
                                icn: normalizeNumericValue(disjoncteur.icn),
                                ics: normalizeNumericValue(disjoncteur.ics),
                                in: normalizeNumericValue(disjoncteur.in),
                                ir: normalizeNumericValue(disjoncteur.ir),
                                triptime: normalizeNumericValue(disjoncteur.triptime)
                            };
                            disjoncteurs.splice(index, 1);
                            if (index === disjoncteurPrincipalIndex) {
                                disjoncteurPrincipalIndex = null;
                                console.log('[Edit] Disjoncteur principal transféré, réinitialisation index');
                            } else if (disjoncteurPrincipalIndex > index) {
                                disjoncteurPrincipalIndex--;
                                console.log('[Edit] Ajustement disjoncteurPrincipalIndex:', disjoncteurPrincipalIndex);
                            }
                            const htaData = collectHTAData();
                            const normalizedDisjoncteurs = disjoncteurs.map(d => ({
                                ...d,
                                icn: normalizeNumericValue(d.icn),
                                ics: normalizeNumericValue(d.ics),
                                in: normalizeNumericValue(d.in),
                                ir: normalizeNumericValue(d.ir),
                                triptime: normalizeNumericValue(d.triptime)
                            }));
                            const controller = new AbortController();
                            const timeoutId = setTimeout(() => controller.abort(), 5000);
                            await fetch(`/api/tableaux/${encodeURIComponent(tableauId)}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ id: tableauId, disjoncteurs: normalizedDisjoncteurs, issitemain, isHTA, htaData }),
                                signal: controller.signal
                            });
                            clearTimeout(timeoutId);
                            console.log('[Edit] Tableau', tableauId, 'mis à jour après suppression');
                            const response = await fetch(`/api/tableaux/${encodeURIComponent(targetId)}`, { signal: controller.signal });
                            const targetTableau = await response.json();
                            const targetDisjoncteurs = targetTableau.disjoncteurs || [];
                            targetDisjoncteurs.push(normalizedDisjoncteur);
                            await fetch(`/api/tableaux/${encodeURIComponent(targetId)}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ id: targetId, disjoncteurs: targetDisjoncteurs, issitemain: targetTableau.issitemain, isHTA: targetTableau.isHTA, htaData: targetTableau.htaData }),
                                signal: controller.signal
                            });
                            console.log('[Edit] Disjoncteur', disjoncteur.id, 'transféré vers', targetId);
                            await chargerTableau();
                            hidePopup();
                            showPopup('Disjoncteur transféré avec succès.', '', () => {});
                        } catch (error) {
                            console.error('[Edit] Erreur transfert:', error);
                            showPopup('Erreur lors du transfert: ' + error.message, '', () => {});
                        }
                    });
            }

            async function ajouterDisjoncteur() {
                console.log('[Edit] Bouton Ajouter/Modifier cliqué, editIndex:', editIndex);
                const disjoncteur = {
                    id: document.getElementById('disjoncteur-id').value.trim(),
                    marque: document.getElementById('disjoncteur-marque').value.trim(),
                    ref: document.getElementById('disjoncteur-ref').value.trim(),
                    type: document.getElementById('disjoncteur-type').value.trim(),
                    poles: document.getElementById('disjoncteur-poles').value.trim(),
                    montage: document.getElementById('disjoncteur-montage').value.trim(),
                    ue: document.getElementById('disjoncteur-ue').value.trim(),
                    ui: document.getElementById('disjoncteur-ui').value.trim(),
                    uimp: document.getElementById('disjoncteur-uimp').value.trim(),
                    frequence: document.getElementById('disjoncteur-frequence').value.trim(),
                    in: normalizeNumericValue(document.getElementById('disjoncteur-in').value),
                    ir: normalizeNumericValue(document.getElementById('disjoncteur-ir').value),
                    courbe: document.getElementById('disjoncteur-courbe').value.trim(),
                    triptime: normalizeNumericValue(document.getElementById('disjoncteur-triptime').value),
                    icn: normalizeNumericValue(document.getElementById('disjoncteur-icn').value),
                    ics: normalizeNumericValue(document.getElementById('disjoncteur-ics').value),
                    ip: document.getElementById('disjoncteur-ip').value.trim(),
                    temp: document.getElementById('disjoncteur-temp').value.trim(),
                    dimensions: document.getElementById('disjoncteur-dimensions').value.trim(),
                    section: document.getElementById('disjoncteur-section').value.trim(),
                    date: document.getElementById('disjoncteur-date').value.trim(),
                    tension: document.getElementById('disjoncteur-tension').value.trim(),
                    selectivite: document.getElementById('disjoncteur-selectivite').value.trim(),
                    isPrincipal: editIndex !== null ? disjoncteurs[editIndex]?.isPrincipal || false : false,
                    linkedTableauIds: editIndex !== null && !disjoncteurs[editIndex]?.isPrincipal 
                        ? Array.from(document.getElementById('disjoncteur-linked-tableaux').selectedOptions).map(opt => opt.value).filter(Boolean) 
                        : []
                };
                console.log('[Edit] Disjoncteur à ajouter/modifier:', disjoncteur);
                if (!disjoncteur.id) {
                    console.log('[Edit] Erreur: ID vide');
                    showPopup('L\'ID du disjoncteur est obligatoire (ex. 11F1 Compresseur).', '', () => {});
                    return;
                }
                if (!validateDisjoncteurId(disjoncteur.id)) {
                    console.log('[Edit] Erreur: ID invalide', disjoncteur.id);
                    showPopup('L\'ID du disjoncteur contient des caractères non autorisés. Utilisez lettres (y compris accentuées), chiffres, espaces, tirets, underscores ou deux-points.', '', () => {});
                    return;
                }
                if (!disjoncteur.marque || !disjoncteur.ref) {
                    console.log('[Edit] Erreur: Marque ou référence vide');
                    showPopup('Veuillez entrer la marque et la référence.', '', () => {});
                    return;
                }
                if (disjoncteur.courbe && !['B', 'C', 'D'].includes(disjoncteur.courbe)) {
                    console.log('[Edit] Erreur: Courbe invalide', disjoncteur.courbe);
                    showPopup('La courbe doit être B, C ou D.', '', () => {});
                    return;
                }
                if (disjoncteur.ir && !disjoncteur.ir.match(/^\d+(\.?\d+)?(\s*A)?$/)) {
                    console.log('[Edit] Erreur: Ir invalide', disjoncteur.ir);
                    showPopup('Ir doit être une valeur numérique, ex. 60 ou 60 A.', '', () => {});
                    return;
                }
                if (disjoncteur.icn && !disjoncteur.icn.match(/^\d+(\.?\d+)?(\s*kA)?$/)) {
                    console.log('[Edit] Erreur: Icn invalide', disjoncteur.icn);
                    showPopup('Icn doit être une valeur numérique, ex. 6 ou 6 kA.', '', () => {});
                    return;
                }
                if (disjoncteur.ics && !disjoncteur.ics.match(/^\d+(\.?\d+)?(\s*kA)?$/)) {
                    console.log('[Edit] Erreur: Ics invalide', disjoncteur.ics);
                    showPopup('Ics doit être une valeur numérique, ex. 4.5 ou 4.5 kA.', '', () => {});
                    return;
                }
                if (disjoncteur.in && !disjoncteur.in.match(/^\d+(\.?\d+)?(\s*A)?$/)) {
                    console.log('[Edit] Erreur: In invalide', disjoncteur.in);
                    showPopup('In doit être une valeur numérique, ex. 16 ou 16 A.', '', () => {});
                    return;
                }
                if (disjoncteur.triptime && !disjoncteur.triptime.match(/^\d+(\.?\d+)?(\s*s)?$/)) {
                    console.log('[Edit] Erreur: TripTime invalide', disjoncteur.triptime);
                    showPopup('TripTime doit être une valeur numérique, ex. 0.1 ou 0.1 s.', '', () => {});
                    return;
                }
                if (disjoncteur.linkedTableauIds.includes(tableauId)) {
                    console.log('[Edit] Erreur: Tableau parent inclus dans linkedTableauIds', tableauId);
                    showPopup('Un disjoncteur ne peut pas être lié à son propre tableau parent.', '', () => {});
                    return;
                }
                if (disjoncteur.linkedTableauIds.some(id => tableaux.find(t => t.id === id)?.isHTA)) {
                    console.log('[Edit] Erreur: Liaison à un tableau HTA détectée', disjoncteur.linkedTableauIds);
                    showPopup('Un disjoncteur ne peut être lié qu’à des tableaux BT.', '', () => {});
                    return;
                }
                if (editIndex === null || disjoncteurs[editIndex].id !== disjoncteur.id) {
                    if (disjoncteurs.some(d => d.id === disjoncteur.id)) {
                        console.log('[Edit] Erreur: ID déjà utilisé dans ce tableau', disjoncteur.id);
                        showPopup('Cet ID est déjà utilisé dans ce tableau. Choisissez un ID unique.', '', () => {});
                        return;
                    }
                }
                try {
                    const htaData = collectHTAData();
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);
                    if (editIndex !== null) {
                        const oldId = disjoncteurs[editIndex].id;
                        console.log('[Edit] Envoi requête PUT /api/disjoncteur/', tableauId, '/', oldId, 'avec nouvel ID:', disjoncteur.id);
                        const response = await fetch(`/api/disjoncteur/${encodeURIComponent(tableauId)}/${encodeURIComponent(oldId)}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ ...disjoncteur, newId: disjoncteur.id }),
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);
                        const responseData = await response.json();
                        console.log('[Edit] Réponse serveur modification disjoncteur:', { status: response.status, data: responseData });
                        if (!response.ok) {
                            throw new Error(responseData.error || `Erreur serveur (statut ${response.status})`);
                        }
                        console.log('[Edit] Disjoncteur modifié:', disjoncteur.id);
                        await chargerTableau();
                        showPopup('Disjoncteur modifié avec succès.', '', () => {});
                    } else {
                        console.log('[Edit] Tentative d\'ajout disjoncteur:', disjoncteur.id);
                        const tempDisjoncteurs = [...disjoncteurs, disjoncteur];
                        const response = await fetch(`/api/tableaux/${encodeURIComponent(tableauId)}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ id: tableauId, disjoncteurs: tempDisjoncteurs, issitemain, isHTA, htaData }),
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);
                        const responseData = await response.json();
                        console.log('[Edit] Réponse serveur ajout disjoncteur:', { status: response.status, data: responseData });
                        if (!response.ok) {
                            throw new Error(responseData.error || `Erreur serveur (statut ${response.status})`);
                        }
                        console.log('[Edit] Tableau mis à jour sur le serveur:', tableauId);
                        const select = document.getElementById('disjoncteur-existant');
                        const existingOptions = Array.from(select.options).map(opt => opt.value);
                        if (!existingOptions.includes(JSON.stringify(disjoncteur))) {
                            const option = document.createElement('option');
                            option.value = JSON.stringify(disjoncteur);
                            option.textContent = `${disjoncteur.marque} ${disjoncteur.ref}`;
                            select.appendChild(option);
                            console.log('[Edit] Disjoncteur ajouté à la liste déroulante:', `${disjoncteur.marque} ${disjoncteur.ref}`);
                        }
                        await chargerTableau();
                        showPopup('Disjoncteur ajouté avec succès.', '', () => {});
                    }
                    document.getElementById('disjoncteur-form').classList.add('hidden');
                    document.getElementById('disjoncteur-marque').value = '';
                    document.getElementById('disjoncteur-ref').value = '';
                    document.getElementById('disjoncteur-action').textContent = 'Ajouter au tableau';
                    const linkedSelect = document.getElementById('disjoncteur-linked-tableaux');
                    Array.from(linkedSelect.options).forEach(opt => opt.selected = false);
                    editIndex = null;
                    console.log('[Edit] Formulaire réinitialisé');
                } catch (error) {
                    console.error('[Edit] Erreur mise à jour:', error.message);
                    showPopup('Erreur lors de l\'opération : ' + error.message, '', () => {});
                }
            }

            function designerPrincipal(index) {
                console.log('[Edit] Bouton Principal cliqué, index:', index);
                const disjoncteur = disjoncteurs[index];
                if (!disjoncteur) {
                    console.error('[Edit] Disjoncteur non trouvé à l\'index:', index);
                    showPopup('Erreur: Disjoncteur non trouvé.', '', () => {});
                    return;
                }
                showPopup(`Voulez-vous désigner le disjoncteur ${disjoncteur.id} comme principal ?`, '', async () => {
                    console.log('[Edit] Confirmation principal pour index:', index);
                    disjoncteurs.forEach(d => d.isPrincipal = false);
                    disjoncteurs[index].isPrincipal = true;
                    disjoncteurs[index].linkedTableauIds = [];
                    disjoncteurPrincipalIndex = index;
                    disjoncteurs.forEach((d, i) => {
                        console.log('[Edit] Disjoncteur', d.id, 'isPrincipal:', d.isPrincipal);
                    });
                    try {
                        const htaData = collectHTAData();
                        const normalizedDisjoncteurs = disjoncteurs.map(d => ({
                            ...d,
                            icn: normalizeNumericValue(d.icn),
                            ics: normalizeNumericValue(d.ics),
                            in: normalizeNumericValue(d.in),
                            ir: normalizeNumericValue(d.ir),
                            triptime: normalizeNumericValue(d.triptime)
                        }));
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 5000);
                        await fetch(`/api/tableaux/${encodeURIComponent(tableauId)}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ id: tableauId, disjoncteurs: normalizedDisjoncteurs, issitemain, isHTA, htaData }),
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);
                        console.log('[Edit] Tableau mis à jour avec nouveau disjoncteur principal');
                        await chargerTableau();
                        hidePopup();
                        showPopup('Disjoncteur désigné comme principal avec succès.', '', () => {});
                    } catch (error) {
                        console.error('[Edit] Erreur mise à jour principal:', error);
                        showPopup('Erreur lors de la désignation du principal: ' + error.message, '', () => {});
                    }
                });
            }

            function supprimerDisjoncteur(index) {
                console.log('[Edit] Bouton Supprimer cliqué, index:', index);
                const disjoncteur = disjoncteurs[index];
                if (!disjoncteur) {
                    console.error('[Edit] Disjoncteur non trouvé à l\'index:', index);
                    showPopup('Erreur: Disjoncteur non trouvé.', '', () => {});
                    return;
                }
                showPopup(`Voulez-vous supprimer le disjoncteur ${disjoncteur.id} ?`, '', async () => {
                    console.log('[Edit] Confirmation suppression disjoncteur:', disjoncteur.id);
                    disjoncteurs.splice(index, 1);
                    if (index === disjoncteurPrincipalIndex) {
                        disjoncteurPrincipalIndex = null;
                        console.log('[Edit] Disjoncteur principal supprimé, réinitialisation index');
                    } else if (disjoncteurPrincipalIndex > index) {
                        disjoncteurPrincipalIndex--;
                        console.log('[Edit] Ajustement disjoncteurPrincipalIndex:', disjoncteurPrincipalIndex);
                    }
                    try {
                        const htaData = collectHTAData();
                        const normalizedDisjoncteurs = disjoncteurs.map(d => ({
                            ...d,
                            icn: normalizeNumericValue(d.icn),
                            ics: normalizeNumericValue(d.ics),
                            in: normalizeNumericValue(d.in),
                            ir: normalizeNumericValue(d.ir),
                            triptime: normalizeNumericValue(d.triptime)
                        }));
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 5000);
                        const response = await fetch(`/api/tableaux/${encodeURIComponent(tableauId)}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ id: tableauId, disjoncteurs: normalizedDisjoncteurs, issitemain, isHTA, htaData }),
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);
                        console.log('[Edit] Réponse serveur suppression disjoncteur:', { status: response.status });
                        if (!response.ok) {
                            const responseData = await response.json();
                            throw new Error(responseData.error || `Erreur serveur (statut ${response.status})`);
                        }
                        await chargerTableau();
                        hidePopup();
                        showPopup('Disjoncteur supprimé avec succès.', '', () => {});
                    } catch (error) {
                        console.error('[Edit] Erreur suppression:', error);
                        showPopup('Erreur lors de la suppression: ' + error.message, '', () => {});
                    }
                });
            }

            async function enregistrerModifications() {
                console.log('[Edit] Bouton Enregistrer les modifications cliqué');
                const newTableauId = document.getElementById('tableau-id').value.trim();
                const isHTAChecked = document.getElementById('tableau-isHTA').checked;
                console.log('[Edit] Nouveau tableau ID:', newTableauId, 'Disjoncteurs:', disjoncteurs.length, 'issitemain:', issitemain, 'isHTA:', isHTAChecked);
                if (!newTableauId) {
                    console.log('[Edit] Erreur: ID tableau vide');
                    showPopup('Veuillez entrer un identifiant pour le tableau.', '', () => {});
                    return;
                }
                if (!validateDisjoncteurId(newTableauId)) {
                    console.log('[Edit] Erreur: ID tableau invalide', newTableauId);
                    showPopup('L\'ID du tableau contient des caractères non autorisés. Utilisez lettres (y compris accentuées), chiffres, espaces, tirets, underscores ou deux-points.', '', () => {});
                    return;
                }
                if (disjoncteurs.length === 0) {
                    console.log('[Edit] Erreur: Aucun disjoncteur');
                    showPopup('Veuillez ajouter au moins un disjoncteur.', '', () => {});
                    return;
                }
                try {
                    const htaData = collectHTAData();
                    console.log('[Edit] Données HTA collectées:', htaData);
                    if (isHTAChecked && !htaData) {
                        console.log('[Edit] Erreur: Données HTA invalides, annulation enregistrement');
                        return;
                    }
                    const normalizedDisjoncteurs = disjoncteurs.map(d => ({
                        ...d,
                        icn: normalizeNumericValue(d.icn),
                        ics: normalizeNumericValue(d.ics),
                        in: normalizeNumericValue(d.in),
                        ir: normalizeNumericValue(d.ir),
                        triptime: normalizeNumericValue(d.triptime)
                    }));
                    console.log('[Edit] Envoi requête PUT /api/tableaux/', tableauId, 'avec:', {
                        id: newTableauId,
                        disjoncteurs: normalizedDisjoncteurs.length,
                        issitemain,
                        isHTA: isHTAChecked,
                        htaData
                    });
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);
                    const response = await fetch(`/api/tableaux/${encodeURIComponent(tableauId)}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: newTableauId, disjoncteurs: normalizedDisjoncteurs, issitemain, isHTA: isHTAChecked, htaData }),
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    const data = await response.json();
                    console.log('[Edit] Réponse serveur:', { status: response.status, data });
                    if (!response.ok) {
                        console.log('[Edit] Erreur serveur:', data.error);
                        throw new Error(data.error || `Erreur serveur (statut ${response.status})`);
                    }
                    showPopup('Modifications enregistrées avec succès !', '', () => {
                        console.log('[Edit] Modifications enregistrées, redirection vers view.html');
                        window.location.href = 'view.html';
                    });
                } catch (error) {
                    console.error('[Edit] Erreur enregistrement:', error);
                    showPopup('Erreur lors de l\'enregistrement: ' + error.message, '', () => {});
                }
            }

            window.onload = () => {
                console.log('[Edit] Initialisation page edit à', new Date().toLocaleString('fr-FR'));
                if (window.location.protocol === 'file:') {
                    showPopup('Erreur : Veuillez exécuter cette page via un serveur web (ex. http://localhost:3000/edit.html) pour accéder à l\'API.', '', () => {});
                    return;
                }
                if (!tableauId) {
                    console.log('[Edit] Aucun ID de tableau fourni dans l\'URL');
                    showPopup('Aucun tableau spécifié. Veuillez sélectionner un tableau depuis la page de visualisation.', '', () => {
                        window.location.href = 'view.html';
                    });
                    return;
                }
                document.getElementById('tableau-id').value = '';
                document.getElementById('tableau-issitemain').checked = false;
                document.getElementById('tableau-isHTA').checked = false;
                toggleHTAFields();
                issitemain = false;
                isHTA = false;
                chargerTableau();
                chargerDisjoncteursExistants();
                chargerTableaux();
            };
        </script>
    </body>
</html>