<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contrôle des Disjoncteurs - Autonomix Elec</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="/styles.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>
<body class="bg-gray-900 text-white">
    <nav class="bg-blue-700 p-4 sticky top-0 z-50 shadow-lg">
        <ul class="flex flex-wrap space-x-6 text-white font-semibold text-sm sm:text-base">
            <li><a href="index.html" class="hover:text-yellow-300 transition"><i class="fas fa-home mr-2"></i>Accueil</a></li>
            <li><a href="create.html" class="hover:text-yellow-300 transition"><i class="fas fa-plus-circle mr-2"></i>Créer un tableau</a></li>
            <li><a href="view.html" class="hover:text-yellow-300 transition"><i class="fas fa-table mr-2"></i>Voir les tableaux</a></li>
            <li><a href="selectivity.html" class="hover:text-yellow-300 transition"><i class="fas fa-shield-alt mr-2"></i>Sélectivité</a></li>
            <li><a href="obsolescence.html" class="hover:text-yellow-300 transition"><i class="fas fa-clock mr-2"></i>Obsolescence</a></li>
            <li><a href="fault_level_assessment.html" class="hover:text-yellow-300 transition"><i class="fas fa-bolt mr-2"></i>Évaluation du Niveau de Défaut</a></li>
            <li><a href="hazards_assessment.html" class="hover:text-yellow-300 transition"><i class="fas fa-exclamation-triangle mr-2"></i>Évaluation des Risques</a></li>
            <li><a href="maintenance_org.html" class="hover:text-yellow-300 transition"><i class="fas fa-sitemap mr-2"></i>Organigramme Maintenance</a></li>
            <li><a href="distribution_emergency.html" class="hover:text-yellow-300 transition"><i class="fas fa-plug mr-2"></i>Urgence Distribution</a></li>
            <li><a href="reports.html" class="hover:text-yellow-300 transition"><i class="fas fa-file-alt mr-2"></i>Rapports</a></li>
            <li><a href="electrical_safety_program.html" class="hover:text-yellow-300 transition"><i class="fas fa-hard-hat mr-2"></i>Programme de Sécurité Électrique</a></li>
            <li><a href="breaker_control.html" class="text-yellow-300"><i class="fas fa-cogs mr-2"></i>Contrôle des Disjoncteurs</a></li>
        </ul>
    </nav>

    <div class="container mx-auto p-6">
        <h1 class="text-3xl font-bold mb-6 flex items-center"><i class="fas fa-cogs mr-3"></i>Contrôle des Disjoncteurs</h1>

        <!-- Filtres -->
        <div class="bg-gray-800 p-4 rounded-lg mb-6 shadow-lg flex space-x-4">
            <div>
                <label for="building-filter" class="block text-sm font-medium">Filtrer par bâtiment</label>
                <select id="building-filter" class="mt-1 p-2 rounded bg-gray-700 text-white border-gray-600">
                    <option value="">Tous les bâtiments</option>
                </select>
            </div>
            <div>
                <label for="tableau-filter" class="block text-sm font-medium">Filtrer par tableau</label>
                <select id="tableau-filter" class="mt-1 p-2 rounded bg-gray-700 text-white border-gray-600">
                    <option value="">Tous les tableaux</option>
                </select>
            </div>
        </div>

        <!-- Instructions -->
        <div class="bg-gray-800 p-4 rounded-lg mb-6 shadow-lg animate-fade-in">
            <h2 class="text-xl font-semibold mb-2 flex items-center"><i class="fas fa-info-circle mr-2"></i>Comment utiliser cette page</h2>
            <ul class="list-disc pl-6 text-gray-300">
                <li>Utilisez les filtres pour sélectionner un bâtiment ou un tableau spécifique.</li>
                <li>Après sélection d’un tableau, un diagramme de Gantt affiche les disjoncteurs avec leur dernier statut de contrôle (Conforme, Non conforme, Non applicable, Mixte, En attente, Non contrôlé).</li>
                <li>Utilisez le bouton "Créer une checklist" pour définir jusqu’à 10 points de contrôle (sans statuts, commentaire, ni photo), appliqués à tous les disjoncteurs.</li>
                <li>Cliquez sur un disjoncteur dans le Gantt pour voir ses checklists et compléter une checklist en attente en assignant un statut par point, un commentaire, et une photo.</li>
                <li>Les graphiques en anneau montrent la répartition des statuts par bâtiment et tableau.</li>
            </ul>
        </div>

        <!-- Diagramme de Gantt des disjoncteurs -->
        <div class="bg-gray-800 p-4 rounded-lg mb-6 shadow-lg animate-slide-up">
            <h2 class="text-xl font-semibold mb-2 flex items-center"><i class="fas fa-calendar-alt mr-2"></i>Statut des Disjoncteurs</h2>
            <div class="overflow-x-auto relative">
                <table class="gantt" id="gantt-table">
                    <thead>
                        <tr>
                            <th class="sticky left-0 bg-gray-700">Disjoncteur</th>
                            <th class="text-gray-300">Statut</th>
                        </tr>
                    </thead>
                    <tbody id="gantt-body"></tbody>
                </table>
            </div>
            <p id="no-data-message" class="text-red-500 mt-4 hidden">Aucun disjoncteur trouvé pour les critères sélectionnés.</p>
        </div>

        <!-- Bouton Créer une Checklist -->
        <div id="add-checklist-container" class="flex justify-end mb-4 hidden">
            <button id="add-checklist" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                <i class="fas fa-plus-circle mr-2"></i>Créer une Checklist
            </button>
        </div>

        <!-- Graphiques en anneau -->
        <div class="bg-gray-800 p-4 rounded-lg mb-6 shadow-lg animate-slide-up">
            <h2 class="text-xl font-semibold mb-2 flex items-center"><i class="fas fa-chart-pie mr-2"></i>Répartition des Statuts</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="doughnut-container"></div>
        </div>

        <!-- Modal pour voir l’historique des checklists -->
        <div id="modal-breaker" class="fixed inset-0 bg-black bg-opacity-70 flex items-start justify-center z-50 overflow-y-auto pt-4 pb-4 hidden">
            <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-4xl w-full my-4 max-h-[90vh] overflow-y-auto">
                <h2 class="text-xl font-semibold mb-4 flex items-center"><i class="fas fa-cogs mr-2"></i>Historique des Contrôles</h2>
                <div id="modal-content" class="mb-4 text-gray-300"></div>
                <button id="close-modal" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 transition"><i class="fas fa-times mr-2"></i>Fermer</button>
            </div>
        </div>

        <!-- Modal pour créer une checklist -->
        <div id="modal-create-checklist" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
            <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-2xl w-full">
                <h2 class="text-xl font-semibold mb-4 flex items-center"><i class="fas fa-plus-circle mr-2"></i>Créer une Checklist</h2>
                <form id="create-checklist-form" class="grid gap-4">
                    <div id="checklist-points" class="grid gap-2">
                        <!-- Points de contrôle ajoutés dynamiquement -->
                    </div>
                    <button type="button" id="add-point" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                        <i class="fas fa-plus mr-2"></i>Ajouter un point de contrôle
                    </button>
                    <div class="flex space-x-4">
                        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition"><i class="fas fa-save mr-2"></i>Enregistrer</button>
                        <button type="button" id="close-create-checklist-modal" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition"><i class="fas fa-times mr-2"></i>Fermer</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal pour compléter une checklist -->
        <div id="modal-complete-checklist" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
            <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-2xl w-full">
                <h2 class="text-xl font-semibold mb-4 flex items-center"><i class="fas fa-check-circle mr-2"></i>Compléter la Checklist</h2>
                <form id="complete-checklist-form" class="grid gap-4">
                    <div id="complete-checklist-points" class="grid gap-2">
                        <!-- Points de contrôle avec statuts -->
                    </div>
                    <div>
                        <label for="complete-checklist-comment" class="block text-sm font-medium">Commentaire global</label>
                        <textarea id="complete-checklist-comment" class="mt-1 p-2 rounded bg-gray-700 text-white border-gray-600 w-full" rows="4"></textarea>
                    </div>
                    <div>
                        <label for="complete-checklist-photo" class="block text-sm font-medium">Photo globale</label>
                        <input type="file" id="complete-checklist-photo" accept="image/*" class="mt-1 p-2 rounded bg-gray-700 text-white border-gray-600 w-full">
                    </div>
                    <div class="flex space-x-4">
                        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition"><i class="fas fa-save mr-2"></i>Enregistrer</button>
                        <button type="button" id="close-complete-checklist-modal" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 transition"><i class="fas fa-times mr-2"></i>Fermer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let tableauxData = [];
        let checklistsData = [];
        let currentTableauId = '';
        let currentCheckId = null;

        // Fonction pour encoder les ID en slug sécurisé
        function sanitizeId(id) {
            return id.replace(/[^a-zA-Z0-9-_]/g, '-').replace(/-+/g, '-').toLowerCase();
        }

        // Déterminer le statut global d’une checklist
        function determineGlobalStatus(points) {
            const statuses = points.map(p => p.status).filter(s => s);
            if (statuses.length === 0) return 'Non applicable'; // Utilisé pour "En attente"
            if (statuses.every(s => s === 'Conforme')) return 'Conforme';
            if (statuses.includes('Non conforme')) return 'Non conforme';
            if (statuses.every(s => s === 'Non applicable')) return 'Non applicable';
            return 'Mixte';
        }

        // Charger les données
        async function loadData() {
            try {
                const tableauxResponse = await fetch('/api/tableaux');
                if (!tableauxResponse.ok) throw new Error(`Erreur lors du chargement des tableaux: ${tableauxResponse.statusText}`);
                tableauxData = await tableauxResponse.json();
                console.log('[Client] Tableaux chargés:', tableauxData.length);

                const checklistsResponse = await fetch('/api/breaker-checklists');
                if (!checklistsResponse.ok) throw new Error(`Erreur lors du chargement des checklists: ${checklistsResponse.statusText}`);
                checklistsData = await checklistsResponse.json();
                console.log('[Client] Checklists chargées:', checklistsData.length);

                populateFilters();
                renderGanttChart();
                renderDoughnuts();
            } catch (error) {
                console.error('[Client] Erreur chargement:', error);
                alert('Erreur lors du chargement des données: ' + error.message);
                document.getElementById('no-data-message').classList.remove('hidden');
            }
        }

        // Remplir les filtres
        function populateFilters() {
            const buildingFilter = document.getElementById('building-filter');
            const tableauFilter = document.getElementById('tableau-filter');
            const buildings = [...new Set(tableauxData.map(t => t.id.split('-')[0] || 'Inconnu'))].sort();
            buildings.forEach(b => {
                const option = document.createElement('option');
                option.value = b;
                option.textContent = b;
                buildingFilter.appendChild(option);
            });
            tableauxData.forEach(t => {
                const option = document.createElement('option');
                option.value = t.id;
                option.textContent = t.id;
                tableauFilter.appendChild(option);
            });
            buildingFilter.onchange = filterData;
            tableauFilter.onchange = filterData;
        }

        // Filtrer les données
        function filterData() {
            currentTableauId = document.getElementById('tableau-filter').value;
            const building = document.getElementById('building-filter').value;
            const filteredData = tableauxData.filter(t => (!building || t.id.split('-')[0] === building) && (!currentTableauId || t.id === currentTableauId));
            renderGanttChart(filteredData);
            renderDoughnuts(filteredData);
            toggleAddChecklistButton();
        }

        // Afficher/masquer le bouton Créer une Checklist
        function toggleAddChecklistButton() {
            const container = document.getElementById('add-checklist-container');
            if (currentTableauId) {
                container.classList.remove('hidden');
                document.getElementById('add-checklist').onclick = () => openCreateChecklistModal();
            } else {
                container.classList.add('hidden');
            }
        }

        // Rendre le diagramme de Gantt
        function renderGanttChart(data = tableauxData) {
            const table = document.getElementById('gantt-table');
            const tbody = document.getElementById('gantt-body');
            const noDataMessage = document.getElementById('no-data-message');
            tbody.innerHTML = '';

            let hasData = false;
            const filteredData = currentTableauId ? data.filter(t => t.id === currentTableauId) : data;

            filteredData.forEach(tableau => {
                tableau.disjoncteurs.forEach(breaker => {
                    const tr = document.createElement('tr');
                    const tdBreaker = document.createElement('td');
                    const sanitizedId = sanitizeId(breaker.id);
                    tdBreaker.innerHTML = `${breaker.id}`;
                    tdBreaker.className = 'sticky left-0 bg-gray-700 font-medium';
                    tr.appendChild(tdBreaker);

                    const tdStatus = document.createElement('td');
                    const latestCheck = checklistsData
                        .filter(c => c.tableau_id === tableau.id && c.disjoncteur_id === breaker.id)
                        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
                    let statusClass = 'task-bar';
                    let statusText = 'Non contrôlé';
                    if (latestCheck) {
                        let points;
                        try {
                            points = JSON.parse(latestCheck.comment || '{}').points || [];
                        } catch (e) {
                            points = [];
                        }
                        statusText = latestCheck.status === 'Non applicable' && points.every(p => !p.status) ? 'En attente' : latestCheck.status;
                        if (statusText === 'Conforme') statusClass += ' task-bar-green';
                        else if (statusText === 'Non conforme') statusClass += ' task-bar-red';
                        else if (statusText === 'Non applicable') statusClass += ' task-bar-orange';
                        else if (statusText === 'Mixte') statusClass += ' task-bar-blue';
                        else statusClass += ' task-bar-purple'; // En attente
                    } else {
                        statusClass += ' task-bar-gray';
                    }
                    const bar = document.createElement('div');
                    bar.className = statusClass;
                    bar.dataset.tableauId = tableau.id;
                    bar.dataset.breakerId = breaker.id;
                    bar.dataset.sanitizedId = sanitizedId;
                    bar.onclick = () => openBreakerModal(tableau.id, breaker.id, sanitizedId);
                    bar.textContent = statusText;
                    tdStatus.appendChild(bar);
                    tr.appendChild(tdStatus);

                    tbody.appendChild(tr);
                    hasData = true;
                });
            });

            if (!hasData) {
                noDataMessage.classList.remove('hidden');
            } else {
                noDataMessage.classList.add('hidden');
            }

            // Vérifier si des .task-bar existent avant d’animer
            if (document.querySelectorAll('.task-bar').length > 0) {
                gsap.from('.task-bar', { scaleX: 0, duration: 1, stagger: 0.1, ease: 'power2.out' });
            } else {
                console.warn('[Client] Aucun élément .task-bar trouvé pour l’animation GSAP');
            }
        }

        // Rendre les graphiques en anneau
        function renderDoughnuts(data = tableauxData) {
            const container = document.getElementById('doughnut-container');
            container.innerHTML = '';

            const categories = ['Conforme', 'Non conforme', 'Non applicable', 'Mixte', 'En attente', 'Non contrôlé'];
            const colors = ['#22c55e', '#dc2626', '#f4b400', '#3b82f6', '#9333ea', '#6B7280'];
            const icons = ['fa-check-circle', 'fa-times-circle', 'fa-hourglass-half', 'fa-balance-scale', 'fa-clock', 'fa-question-circle'];

            const groups = currentTableauId
                ? data.filter(t => t.id === currentTableauId).map(t => ({
                      id: t.id,
                      building: t.id.split('-')[0] || 'Inconnu',
                      disjoncteurs: t.disjoncteurs
                  }))
                : [...new Set(data.map(t => t.id.split('-')[0] || 'Inconnu'))].map(b => ({
                      id: b,
                      building: b,
                      disjoncteurs: data.filter(t => t.id.split('-')[0] === b).flatMap(t => t.disjoncteurs)
                  }));

            groups.forEach((group, index) => {
                const div = document.createElement('div');
                div.className = 'bg-gray-700 p-4 rounded-lg shadow';
                const canvas = document.createElement('canvas');
                canvas.id = `doughnut-${index}`;
                div.appendChild(canvas);
                const title = document.createElement('h3');
                title.className = 'text-lg font-semibold mb-2';
                title.innerHTML = `<i class="fas ${group.building === group.id ? 'fa-table' : 'fa-building'} mr-2"></i>${group.building === group.id ? `Tableau ${group.id}` : `Bâtiment ${group.building}`}`;
                div.insertBefore(title, canvas);
                container.appendChild(div);

                const counts = categories.reduce((acc, cat, i) => {
                    acc[cat] = group.disjoncteurs.filter(d => {
                        const latestCheck = checklistsData
                            .filter(c => c.tableau_id === (group.building === group.id ? group.id : data.find(t => t.disjoncteurs.includes(d)).id) && c.disjoncteur_id === d.id)
                            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
                        let status = latestCheck ? latestCheck.status : 'Non contrôlé';
                        if (latestCheck && status === 'Non applicable') {
                            let points;
                            try {
                                points = JSON.parse(latestCheck.comment || '{}').points || [];
                            } catch (e) {
                                points = [];
                            }
                            status = points.every(p => !p.status) ? 'En attente' : status;
                        }
                        return (i === 0 && status === 'Conforme') ||
                               (i === 1 && status === 'Non conforme') ||
                               (i === 2 && status === 'Non applicable') ||
                               (i === 3 && status === 'Mixte') ||
                               (i === 4 && status === 'En attente') ||
                               (i === 5 && status === 'Non contrôlé');
                    }).length;
                    return acc;
                }, {});

                new Chart(canvas, {
                    type: 'doughnut',
                    data: {
                        labels: categories,
                        datasets: [{ data: categories.map(c => counts[c]), backgroundColor: colors }]
                    },
                    options: {
                        plugins: {
                            legend: {
                                labels: {
                                    generateLabels: chart => chart.data.labels.map((label, i) => ({
                                        text: label,
                                        fillStyle: colors[i],
                                        fontColor: '#FFF',
                                        icon: `<i class="fas ${icons[i]}"></i>`
                                    }))
                                }
                            }
                        },
                        animation: { duration: 1500, easing: 'easeOutBounce' }
                    }
                });

                gsap.from(`#doughnut-${index}`, { opacity: 0, y: 20, duration: 1, delay: index * 0.2 });
            });
        }

        // Ouvrir le modal pour voir l’historique des checklists
        function openBreakerModal(tableauId, breakerId, sanitizedId) {
            const modal = document.getElementById('modal-breaker');
            const tableau = tableauxData.find(t => t.id === tableauId);
            if (!tableau) {
                console.error('[Client] Tableau non trouvé:', tableauId);
                alert('Erreur: Tableau non trouvé');
                return;
            }
            const breaker = tableau.disjoncteurs.find(d => d.id === breakerId);
            if (!breaker) {
                console.error('[Client] Disjoncteur non trouvé:', breakerId);
                alert('Erreur: Disjoncteur non trouvé');
                return;
            }

            const breakerChecks = checklistsData
                .filter(c => c.tableau_id === tableauId && c.disjoncteur_id === breakerId)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            let content = `
                <p><strong>Tableau :</strong> ${tableau.id}</p>
                <p><strong>Disjoncteur :</strong> ${breaker.id}</p>
                <p><strong>Marque :</strong> ${breaker.marque || 'Inconnu'}</p>
                <p><strong>Référence :</strong> ${breaker.ref || 'Inconnu'}</p>
                <p><strong>Courant nominal :</strong> ${breaker.in || 'Inconnu'}</p>
                <h3 class="text-lg font-semibold mt-4">Historique des contrôles :</h3>
                <div class="space-y-4">
                    ${breakerChecks.length > 0 ? breakerChecks.map(check => {
                        let points;
                        try {
                            points = JSON.parse(check.comment || '{}').points || [];
                        } catch (e) {
                            points = [{ description: check.comment || 'Aucun point défini', status: null }];
                        }
                        const isPending = check.status === 'Non applicable' && points.every(p => !p.status);
                        return `
                            <div class="bg-gray-700 p-4 rounded-lg">
                                <p><strong>Statut global :</strong> <span class="${check.status === 'Conforme' ? 'text-green-500' : check.status === 'Non conforme' ? 'text-red-500' : check.status === 'Non applicable' && !isPending ? 'text-yellow-400' : isPending ? 'text-purple-400' : 'text-blue-400'}">
                                    <i class="fas ${check.status === 'Conforme' ? 'fa-check-circle' : check.status === 'Non conforme' ? 'fa-times-circle' : check.status === 'Non applicable' && !isPending ? 'fa-hourglass-half' : isPending ? 'fa-clock' : 'fa-balance-scale'} mr-1"></i>
                                    ${isPending ? 'En attente' : check.status}
                                </span></p>
                                <p><strong>Date :</strong> ${new Date(check.timestamp).toLocaleString('fr-FR')}</p>
                                <h4 class="text-md font-semibold mt-2">Points de contrôle :</h4>
                                <ul class="list-disc pl-6">
                                    ${points.map(p => `
                                        <li>${p.description} : <span class="${p.status === 'Conforme' ? 'text-green-500' : p.status === 'Non conforme' ? 'text-red-500' : p.status === 'Non applicable' ? 'text-yellow-400' : 'text-gray-400'}">${p.status || 'Non défini'}</span></li>
                                    `).join('')}
                                </ul>
                                <p><strong>Commentaire global :</strong> ${points.comment || 'Aucun'}</p>
                                <p><strong>Photo :</strong> ${check.photo ? `<img src="${check.photo}" alt="Photo contrôle" class="w-32 h-32 object-cover rounded mt-2" />` : 'Aucune'}</p>
                                <div class="flex space-x-2 mt-2">
                                    <button class="${isPending ? 'complete-check' : 'edit-check'} bg-blue-600 text-white p-2 rounded hover:bg-blue-700 transition" data-check-id="${check.id}">
                                        <i class="fas ${isPending ? 'fa-check' : 'fa-edit'}"></i> ${isPending ? 'Compléter' : 'Modifier'}
                                    </button>
                                    <button class="delete-check bg-red-600 text-white p-2 rounded hover:bg-red-700 transition" data-check-id="${check.id}">
                                        <i class="fas fa-trash"></i> Supprimer
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('') : '<p class="p-2 text-center">Aucun contrôle trouvé</p>'}
                </div>
            `;
            document.getElementById('modal-content').innerHTML = content;

            document.getElementById('close-modal').onclick = () => modal.classList.add('hidden');
            document.querySelectorAll('.complete-check, .edit-check').forEach(btn => {
                btn.onclick = () => {
                    const checkId = btn.dataset.checkId;
                    const check = breakerChecks.find(c => c.id == checkId);
                    openCompleteChecklistModal(check, tableauId, breakerId, sanitizedId);
                };
            });
            document.querySelectorAll('.delete-check').forEach(btn => {
                btn.onclick = () => deleteChecklist(btn.dataset.checkId, tableauId, breakerId, sanitizedId);
            });

            modal.classList.remove('hidden');
        }

        // Ouvrir le modal pour créer une checklist
        function openCreateChecklistModal() {
            const modal = document.getElementById('modal-create-checklist');
            const form = document.getElementById('create-checklist-form');
            const pointsContainer = document.getElementById('checklist-points');
            const addPointBtn = document.getElementById('add-point');

            let points = [{ description: '' }];
            let pointCount = 1;

            function renderPoints() {
                pointsContainer.innerHTML = '';
                points.forEach((point, index) => {
                    const div = document.createElement('div');
                    div.className = 'flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 items-center';
                    div.innerHTML = `
                        <div class="flex-1">
                            <label class="block text-sm font-medium">Point ${index + 1}</label>
                            <input type="text" class="point-description mt-1 p-2 rounded bg-gray-700 text-white border-gray-600 w-full" value="${point.description}" placeholder="Ex: Est-ce que le tableau est en bon état" required>
                        </div>
                        <button type="button" class="remove-point bg-red-600 text-white p-2 rounded hover:bg-red-700 transition ${pointCount === 1 ? 'invisible' : ''}">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    pointsContainer.appendChild(div);
                });

                pointsContainer.querySelectorAll('.remove-point').forEach((btn, index) => {
                    btn.onclick = () => {
                        points.splice(index, 1);
                        pointCount--;
                        renderPoints();
                    };
                });
            }

            renderPoints();

            addPointBtn.onclick = () => {
                if (pointCount < 10) {
                    points.push({ description: '' });
                    pointCount++;
                    renderPoints();
                } else {
                    alert('Vous ne pouvez pas ajouter plus de 10 points de contrôle.');
                }
            };

            form.onsubmit = async (e) => {
                e.preventDefault();
                points = Array.from(pointsContainer.children).map(div => ({
                    description: div.querySelector('.point-description').value,
                    status: null
                }));

                if (points.some(p => !p.description)) {
                    alert('Tous les points de contrôle doivent avoir une description.');
                    return;
                }

                try {
                    const tableau = tableauxData.find(t => t.id === currentTableauId);
                    if (!tableau) throw new Error('Tableau non trouvé');

                    const commentJson = JSON.stringify({ points });
                    const comment = `Checklist vide: ${commentJson}`; // Simplification pour éviter validation

                    // Créer une checklist vide pour chaque disjoncteur
                    for (const breaker of tableau.disjoncteurs) {
                        console.log('[Client] Envoi POST /api/breaker-checklists:', {
                            tableau_id: currentTableauId,
                            disjoncteur_id: breaker.id,
                            encoded_disjoncteur_id: encodeURIComponent(breaker.id),
                            status: 'Non applicable',
                            comment,
                            photo: null
                        });
                        const body = {
                            tableau_id: currentTableauId,
                            disjoncteur_id: breaker.id,
                            status: 'Non applicable',
                            comment,
                            photo: null
                        };

                        const response = await fetch('/api/breaker-checklists', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(body)
                        });
                        const responseData = await response.json();
                        if (!response.ok) throw new Error(`Erreur lors de l’enregistrement du contrôle pour ${breaker.id}: ${responseData.error || response.statusText}`);
                    }

                    modal.classList.add('hidden');
                    await loadData();
                } catch (error) {
                    console.error('[Client] Erreur enregistrement checklist:', error);
                    alert('Erreur lors de la création de la checklist: ' + error.message);
                }
            };

            document.getElementById('close-create-checklist-modal').onclick = () => modal.classList.add('hidden');
            modal.classList.remove('hidden');
        }

        // Ouvrir le modal pour compléter ou modifier une checklist
        function openCompleteChecklistModal(check, tableauId, breakerId, sanitizedId) {
            const modal = document.getElementById('modal-complete-checklist');
            const form = document.getElementById('complete-checklist-form');
            const pointsContainer = document.getElementById('complete-checklist-points');
            const commentInput = document.getElementById('complete-checklist-comment');
            const photoInput = document.getElementById('complete-checklist-photo');

            currentCheckId = check.id;
            let points;
            try {
                points = JSON.parse(check.comment || '{}').points || [];
            } catch (e) {
                points = [{ description: check.comment || 'Aucun point défini', status: null }];
            }
            commentInput.value = points.comment || '';
            photoInput.value = '';

            pointsContainer.innerHTML = '';
            points.forEach((point, index) => {
                const div = document.createElement('div');
                div.className = 'flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 items-center';
                div.innerHTML = `
                    <div class="flex-1">
                        <label class="block text-sm font-medium">Point ${index + 1}</label>
                        <p class="mt-1 p-2 rounded bg-gray-700 text-white border-gray-600 w-full">${point.description}</p>
                    </div>
                    <div class="w-32">
                        <label class="block text-sm font-medium">Statut</label>
                        <select class="point-status mt-1 p-2 rounded bg-gray-700 text-white border-gray-600 w-full" required>
                            <option value="" ${!point.status ? 'selected' : ''}>Sélectionner</option>
                            <option value="Conforme" ${point.status === 'Conforme' ? 'selected' : ''}>Conforme</option>
                            <option value="Non conforme" ${point.status === 'Non conforme' ? 'selected' : ''}>Non conforme</option>
                            <option value="Non applicable" ${point.status === 'Non applicable' ? 'selected' : ''}>Non applicable</option>
                        </select>
                    </div>
                `;
                pointsContainer.appendChild(div);
            });

            form.onsubmit = async (e) => {
                e.preventDefault();
                const comment = commentInput.value;
                const photo = photoInput.files[0];

                const updatedPoints = Array.from(pointsContainer.children).map(div => ({
                    description: div.querySelector('p').textContent,
                    status: div.querySelector('.point-status').value
                }));

                if (updatedPoints.some(p => !p.status)) {
                    alert('Tous les points de contrôle doivent avoir un statut.');
                    return;
                }

                try {
                    let photoBase64 = check.photo;
                    if (photo) {
                        photoBase64 = await toBase64(photo);
                    }

                    const globalStatus = determineGlobalStatus(updatedPoints);
                    const commentJson = JSON.stringify({ comment, points: updatedPoints });

                    console.log('[Client] Envoi PUT /api/breaker-checklists:', {
                        tableau_id: tableauId,
                        disjoncteur_id: breakerId,
                        encoded_disjoncteur_id: encodeURIComponent(breakerId),
                        status: globalStatus,
                        comment: commentJson,
                        photo: photoBase64 ? 'Présente' : 'Absente'
                    });

                    const body = {
                        tableau_id: tableauId,
                        disjoncteur_id: breakerId,
                        status: globalStatus,
                        comment: commentJson,
                        photo: photoBase64
                    };

                    const response = await fetch(`/api/breaker-checklists/${currentCheckId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    const responseData = await response.json();
                    if (!response.ok) throw new Error(`Erreur lors de la mise à jour du contrôle: ${responseData.error || response.statusText}`);

                    modal.classList.add('hidden');
                    await loadData();
                    openBreakerModal(tableauId, breakerId, sanitizedId);
                } catch (error) {
                    console.error('[Client] Erreur mise à jour checklist:', error);
                    alert('Erreur lors de la mise à jour de la checklist: ' + error.message);
                }
            };

            document.getElementById('close-complete-checklist-modal').onclick = () => modal.classList.add('hidden');
            modal.classList.remove('hidden');
        }

        // Supprimer une checklist
        async function deleteChecklist(checkId, tableauId, breakerId, sanitizedId) {
            if (!confirm('Voulez-vous supprimer ce contrôle ?')) return;
            try {
                const response = await fetch(`/api/breaker-checklists/${checkId}`, { method: 'DELETE' });
                if (!response.ok) throw new Error(`Erreur lors de la suppression du contrôle: ${response.statusText}`);
                await loadData();
                openBreakerModal(tableauId, breakerId, sanitizedId);
            } catch (error) {
                console.error('[Client] Erreur suppression checklist:', error);
                alert('Erreur lors de la suppression de la checklist: ' + error.message);
            }
        }

        // Convertir fichier en base64
        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // Initialisation
        window.onload = () => {
            const breakerModal = document.getElementById('modal-breaker');
            const createChecklistModal = document.getElementById('modal-create-checklist');
            const completeChecklistModal = document.getElementById('modal-complete-checklist');
            if (breakerModal) breakerModal.classList.add('hidden');
            if (createChecklistModal) createChecklistModal.classList.add('hidden');
            if (completeChecklistModal) completeChecklistModal.classList.add('hidden');
            loadData();
        };
    </script>

    <style>
        .task-bar {
            height: 20px;
            border-radius: 4px;
            margin: 2px 0;
            cursor: pointer;
            text-align: center;
            line-height: 20px;
            color: #FFF;
            font-size: 0.875rem;
        }
        .task-bar-green { background-color: #22c55e; }
        .task-bar-red { background-color: #dc2626; }
        .task-bar-orange { background-color: #f4b400; }
        .task-bar-blue { background-color: #3b82f6; }
        .task-bar-purple { background-color: #9333ea; }
        .task-bar-gray { background-color: #6B7280; }
        #modal-breaker > div, #modal-create-checklist > div, #modal-complete-checklist > div {
            scrollbar-width: thin;
            scrollbar-color: #6B7280 #1F2937;
        }
        #modal-breaker > div::-webkit-scrollbar, #modal-create-checklist > div::-webkit-scrollbar, #modal-complete-checklist > div::-webkit-scrollbar {
            width: 8px;
        }
        #modal-breaker > div::-webkit-scrollbar-track, #modal-create-checklist > div::-webkit-scrollbar-track, #modal-complete-checklist > div::-webkit-scrollbar-track {
            background: #1F2937;
        }
        #modal-breaker > div::-webkit-scrollbar-thumb, #modal-create-checklist > div::-webkit-scrollbar-thumb, #modal-complete-checklist > div::-webkit-scrollbar-thumb {
            background: #6B7280;
            border-radius: 4px;
        }
        .animate-fade-in { animation: fadeIn 0.8s ease-out; }
        .animate-slide-up { animation: slideUp 0.8s ease-out; }
        .animate-zoom-in { animation: zoomIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        @media (max-width: 640px) {
            .container { padding: 1rem; }
            table th, table td { font-size: 0.75rem; padding: 0.5rem; }
            canvas { height: 200px !important; }
        }
    </style>
</body>
</html>