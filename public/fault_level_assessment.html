<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autonomix Elec - Évaluation du Niveau de Défaut</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vis-network@9.1.9/dist/vis-network.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/vis-network@9.1.9/styles/vis-network.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        .alert-missing { background-color: #7f1d1d; color: #fecaca; padding: 0.75rem; border-radius: 0.375rem; }
        .gantt th, .gantt td { border: 1px solid #4B5563; padding: 0.5rem; text-align: left; }
        .gantt th { background-color: #374151; }
        .error-message { color: #ef4444; }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans">
    <!-- Navigation harmonisée avec les autres fichiers -->
    <nav class="bg-blue-700 p-4 shadow-lg fixed w-full top-0 z-50">
        <ul class="flex flex-wrap space-x-6 justify-center text-sm sm:text-base">
            <li><a href="index.html" class="hover:text-yellow-300 transition"><i class="fas fa-home mr-2"></i>Accueil</a></li>
            <li><a href="create.html" class="hover:text-yellow-300 transition"><i class="fas fa-plus-circle mr-2"></i>Créer un tableau</a></li>
            <li><a href="view.html" class="hover:text-yellow-300 transition"><i class="fas fa-table mr-2"></i>Voir les tableaux</a></li>
            <li><a href="selectivity.html" class="hover:text-yellow-300 transition"><i class="fas fa-shield-alt mr-2"></i>Sélectivité</a></li>
            <li><a href="obsolescence.html" class="hover:text-yellow-300 transition"><i class="fas fa-clock mr-2"></i>Obsolescence</a></li>
            <li><a href="fault_level_assessment.html" class="text-yellow-300 font-bold"><i class="fas fa-bolt mr-2"></i>Évaluation du Niveau de Défaut</a></li>
            <li><a href="hazards_assessment.html" class="hover:text-yellow-300 transition"><i class="fas fa-exclamation-triangle mr-2"></i>Évaluation des Risques</a></li>
            <li><a href="maintenance_org.html" class="hover:text-yellow-300 transition"><i class="fas fa-sitemap mr-2"></i>Organigramme Maintenance</a></li>
            <li><a href="distribution_emergency.html" class="hover:text-yellow-300 transition"><i class="fas fa-plug mr-2"></i>Urgence Distribution</a></li>
            <li><a href="reports.html" class="hover:text-yellow-300 transition"><i class="fas fa-file-alt mr-2"></i>Rapports</a></li>
            <li><a href="electrical_safety_program.html" class="hover:text-yellow-300 transition"><i class="fas fa-hard-hat mr-2"></i>Programme de Sécurité Électrique</a></li>
            <li><a href="breaker_control.html" class="hover:text-yellow-300 transition"><i class="fas fa-cogs mr-2"></i>Contrôle des Disjoncteurs</a></li>
        </ul>
    </nav>

    <div class="container mx-auto mt-28 p-6 flex">
        <!-- Tableau principal -->
        <div class="flex-1 pr-4">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold">Évaluation du Niveau de Défaut</h1>
                <button id="export-csv-btn" onclick="exportToCSV()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 flex items-center hidden">
                    <i class="fas fa-file-csv mr-2"></i>Exporter en CSV
                </button>
            </div>
            <div id="api-error" class="hidden bg-red-900 text-red-200 p-3 rounded mb-6">
                <p><i class="fas fa-exclamation-triangle mr-2"></i>Erreur lors du chargement des données. Veuillez réessayer plus tard.</p>
            </div>
            <div class="mb-6 bg-gray-800 p-4 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold mb-4">Qu’est-ce que l’évaluation du niveau de défaut ?</h2>
                <p class="mb-2">Cette page évalue la capacité des disjoncteurs BT et des cellules HTA à supporter un court-circuit (Ik) par rapport à leur pouvoir de coupure (Icn).</p>
                <p class="mb-2"><strong>Ik (courant de court-circuit)</strong> : Le courant maximal en cas de court-circuit, en kA. Pour les tableaux BT, il dépend de la tension (Ue), de la longueur et de la section du câble. Pour les tableaux HTA, il dépend de la puissance du transformateur et de la tension HTA.</p>
                <p class="mb-2"><strong>Icn (pouvoir de coupure)</strong> : La capacité du disjoncteur ou de la cellule HTA à interrompre un court-circuit, en kA.</p>
                <p class="mb-2"><strong>Risque</strong> : Si Ik > Icn, le disjoncteur ou la cellule risque de ne pas tenir (KO). Sinon, le statut est OK.</p>
                <p><strong>Exemple</strong> : Un disjoncteur avec Icn = 4,5 kA et Ik = 6 kA est KO. Pour un tableau HTA avec un transformateur de 1600 kVA, Ik peut atteindre 20 kA, à comparer avec Icn de la cellule HTA.</p>
            </div>

            <div class="mb-6 flex space-x-4">
                <div>
                    <label for="building-filter" class="block text-sm mb-1">Filtrer par bâtiment</label>
                    <select id="building-filter" class="bg-gray-700 text-white p-2 rounded">
                        <option value="">Tous les bâtiments</option>
                    </select>
                </div>
                <div>
                    <label for="tableau-filter" class="block text-sm mb-1">Filtrer par tableau</label>
                    <select id="tableau-filter" class="bg-gray-700 text-white p-2 rounded">
                        <option value="">Tous les tableaux</option>
                    </select>
                </div>
            </div>

            <div id="no-building-selected" class="bg-gray-800 p-4 rounded-lg shadow-lg mb-6">
                <p class="text-gray-300">Veuillez sélectionner un bâtiment pour afficher les données.</p>
            </div>

            <div id="data-section" class="hidden">
                <div class="mb-6 bg-gray-800 p-4 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold mb-4"><i class="fas fa-info-circle"></i> Comment utiliser cette page</h2>
                    <ul class="list-disc list-inside space-y-2">
                        <li>Filtrez par bâtiment ou tableau pour cibler les disjoncteurs et cellules HTA.</li>
                        <li>Le tableau indique Ik, Icn (BT et HTA si applicable), et le statut (OK/KO/Incomplet).</li>
                        <li>Cliquez sur <i class="fas fa-chart-line"></i> pour modifier Ue, section, longueur de câble, ou impédance dans le panneau latéral.</li>
                        <li>Pour les tableaux HTA, Ik est calculé à partir du transformateur (puissance, tension).</li>
                        <li>Les disjoncteurs principaux ont un câble minimum de 5 m, les autres de 20 m pour limiter Ik.</li>
                        <li>Le schéma montre les connexions entre tableaux (ex. 01-9-G sous 02-9-G). Les tableaux HTA sont en rouge.</li>
                        <li>Le graphique à bulles montre Ik vs Icn pour les disjoncteurs BT. Les bulles rouges indiquent un risque (Ik > Icn).</li>
                        <li>Si des données manquent, complétez-les via le panneau latéral ou <a href="edit.html" class="text-blue-400 underline">Modifier</a>.</li>
                        <li>Exportez les données en CSV, incluant les paramètres HTA et l’impédance.</li>
                    </ul>
                </div>

                <div id="missing-data-alert" class="alert-missing hidden mb-6">
                    <p>Certaines données (Ue, section, longueur de câble, paramètres HTA) sont manquantes pour <span id="missing-count"></span> disjoncteurs ou tableaux. Cliquez sur <i class="fas fa-chart-line"></i> ou <a href="edit.html" class="text-blue-400 underline">Modifier</a> pour les compléter.</p>
                </div>

                <div id="no-linked-tableau-alert" class="alert-missing hidden mb-6">
                    <p>Aucune liaison entre tableaux n’a été détectée. Utilisez <a href="edit.html" class="text-blue-400 underline">Modifier</a> pour ajouter des tableaux avals.</p>
                </div>

                <div id="high-ik-alert" class="alert-missing hidden mb-6">
                    <p>Certains disjoncteurs ou cellules HTA ont un Ik > 50 kA, ce qui peut être irréaliste. Vérifiez les données (longueur de câble, section, impédance, paramètres HTA) dans le panneau latéral ou <a href="edit.html" class="text-blue-400 underline">Modifier</a>.</p>
                </div>

                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-4"><i class="fas fa-table"></i> Tableau des disjoncteurs et cellules HTA</h2>
                    <table class="w-full gantt">
                        <thead>
                            <tr>
                                <th>Tableau</th>
                                <th>Disjoncteur ID</th>
                                <th>Marque</th>
                                <th>Référence</th>
                                <th title="Tension nominale (V)">Ue (V)</th>
                                <th title="Pouvoir de coupure (kA)">Icn (kA)</th>
                                <th title="Courant de court-circuit calculé (kA)">Ik (kA)</th>
                                <th title="Pouvoir de coupure HTA (kA)">Icn HTA (kA)</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="disjoncteurs-table"></tbody>
                    </table>
                </div>

                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-4"><i class="fas fa-chart-scatter"></i> Graphique à bulles : Ik vs Icn (BT)</h2>
                    <p class="mb-4">Ce graphique montre les disjoncteurs BT avec Ik (axe X) et Icn (axe Y). Les bulles rouges indiquent un risque (Ik > Icn), les vertes sont sécurisées (Ik ≤ Icn). La ligne diagonale représente Icn = Ik.</p>
                    <canvas id="bubble-chart" class="bg-gray-800 p-4 rounded-lg" style="height: 400px;"></canvas>
                </div>

                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-4"><i class="fas fa-sitemap"></i> Schéma électrique</h2>
                    <p class="mb-4">Ce schéma montre les connexions entre tableaux et disjoncteurs. Les tableaux HTA sont en rouge, les disjoncteurs principaux en vert, les disjoncteurs à risque (Ik > Icn) en rouge, et ceux sans données en gris.</p>
                    <div id="network-schema" class="bg-white p-4 rounded-lg border border-gray-300" style="height: 400px;"></div>
                </div>
            </div>
        </div>

        <!-- Panneau latéral pour les détails -->
        <div id="details-panel" class="w-1/3 bg-gray-800 p-4 rounded-lg shadow-lg hidden">
            <h2 class="text-xl font-bold mb-4">Détails du disjoncteur</h2>
            <button id="close-panel" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 mb-4">Fermer</button>
            <div id="panel-content"></div>
            <div id="panel-error" class="text-red-600 hidden mt-2"></div>
            <div id="panel-success" class="text-green-600 hidden mt-2"></div>
            <div id="panel-impedance-info" class="text-gray-400 hidden mt-2"></div>
            <div class="mt-4">
                <h3 class="text-lg font-semibold mb-2">Graphique Ik vs Icn</h3>
                <p class="mb-2">Ce graphique compare Ik à Icn pour le disjoncteur BT (et la cellule HTA si applicable). Une barre rouge indique un risque (Ik > Icn).</p>
                <canvas id="disjoncteur-chart" style="max-height: 200px;"></canvas>
            </div>
            <div class="mt-4 flex justify-end space-x-2">
                <button id="update-cable-data" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Mettre à jour</button>
            </div>
        </div>
    </div>

    <script>
        let tableauxData = [];
        let panelChartInstance = null;
        let bubbleChartInstance = null;
        let networkInstance = null;
        let lastClickTime = 0;

        // Normaliser les valeurs
        function normalizeIcn(icn) {
            if (!icn) return null;
            if (typeof icn === 'number' && !isNaN(icn)) return icn;
            if (typeof icn === 'string') {
                const match = icn.match(/[\d.]+/);
                return match ? parseFloat(match[0]) : null;
            }
            return null;
        }

        function normalizeVoltage(ue) {
            if (!ue) return null;
            const match = ue.match(/[\d.]+/);
            return match ? parseFloat(match[0]) : null;
        }

        function normalizeSection(section) {
            if (!section) return null;
            const match = section.match(/[\d.]+/);
            return match ? parseFloat(match[0]) : null;
        }

        // Initialisation
        window.onload = () => {
            console.log('[Client] Initialisation de la page');
            if (typeof Chart === 'undefined') console.error('[Client] Chart.js non chargé');
            if (typeof vis === 'undefined') console.error('[Client] Vis.js non chargé');
            const panel = document.getElementById('details-panel');
            if (panel) {
                panel.classList.add('hidden');
                console.log('[Client] Panneau caché au chargement');
            }
            document.removeEventListener('click', handleActionClick);
            document.addEventListener('click', handleActionClick);
            console.log('[Client] Gestionnaire d\'événements attaché au document');
            loadTableaux();
        };

        // Charger les tableaux
        async function loadTableaux() {
            try {
                console.log('[Client] Chargement des données FLA');
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 2000);
                const response = await fetch('/api/fault-level', { 
                    method: 'GET',
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
                const data = await response.json();
                console.log('[Client] Données reçues:', data);
                tableauxData = data.data || [];
                document.getElementById('api-error').classList.add('hidden');
                populateFilters();
                showNoBuildingMessage();
            } catch (error) {
                console.error('[Client] Erreur chargement:', error);
                document.getElementById('api-error').classList.remove('hidden');
                tableauxData = [];
                showNoBuildingMessage();
            }
        }

        // Charger un tableau spécifique
        async function loadTableauById(tableauId) {
            try {
                console.log('[Client] Chargement tableau', tableauId);
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 2000);
                const response = await fetch(`/api/tableaux/${tableauId}`, { 
                    method: 'GET',
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
                const data = await response.json();
                console.log('[Client] Tableau reçu:', data.id);
                return {
                    id: data.id,
                    building: data.id.split('-')[0] || 'Inconnu',
                    disjoncteurs: data.disjoncteurs.map(d => ({
                        ...d,
                        ik: d.ik || null,
                        icn: normalizeIcn(d.icn),
                        tableauId: data.id
                    })),
                    isHTA: data.isHTA || false,
                    htaData: data.htaData || null
                };
            } catch (error) {
                console.error('[Client] Erreur chargement tableau:', error);
                return null;
            }
        }

        // Remplir les filtres
        function populateFilters() {
            const buildings = [...new Set(tableauxData.map(t => t.building))].sort();
            const buildingFilter = document.getElementById('building-filter');
            buildingFilter.innerHTML = '<option value="">Tous les bâtiments</option>';
            buildings.forEach(b => {
                const option = document.createElement('option');
                option.value = b;
                option.textContent = b;
                buildingFilter.appendChild(option);
            });

            function updateTableauFilter(selectedBuilding) {
                const tableauFilter = document.getElementById('tableau-filter');
                tableauFilter.innerHTML = '<option value="">Tous les tableaux</option>';
                const filteredTableaux = selectedBuilding
                    ? tableauxData.filter(t => t.building === selectedBuilding)
                    : tableauxData;
                filteredTableaux.forEach(t => {
                    const option = document.createElement('option');
                    option.value = t.id;
                    option.textContent = t.id;
                    tableauFilter.appendChild(option);
                });
            }

            updateTableauFilter('');

            buildingFilter.addEventListener('change', () => {
                const selectedBuilding = buildingFilter.value;
                updateTableauFilter(selectedBuilding);
                filterData();
            });
            document.getElementById('tableau-filter').addEventListener('change', filterData);
        }

        // Filtrer les données
        function filterData() {
            const building = document.getElementById('building-filter').value;
            const tableau = document.getElementById('tableau-filter').value;
            let filteredData = tableauxData;

            if (!building) {
                showNoBuildingMessage();
                return;
            }

            filteredData = filteredData.filter(t => t.building === building);
            if (tableau) filteredData = filteredData.filter(t => t.id === tableau);

            renderData(filteredData);
        }

        // Afficher le message "aucun bâtiment sélectionné"
        function showNoBuildingMessage() {
            console.log('[Client] Affichage message aucun bâtiment sélectionné');
            document.getElementById('no-building-selected').classList.remove('hidden');
            document.getElementById('data-section').classList.add('hidden');
            document.getElementById('export-csv-btn').classList.add('hidden');
        }

        // Exporter en CSV
        function exportToCSV() {
            console.log('[Client] Exportation des données en CSV');
            const building = document.getElementById('building-filter').value;
            const tableau = document.getElementById('tableau-filter').value;
            let filteredData = tableauxData;

            if (!building) {
                alert('Veuillez sélectionner un bâtiment pour exporter les données.');
                return;
            }

            filteredData = filteredData.filter(t => t.building === building);
            if (tableau) filteredData = filteredData.filter(t => t.id === tableau);

            if (!filteredData.length) {
                alert('Aucune donnée à exporter pour les critères sélectionnés.');
                return;
            }

            const headers = [
                'Tableau_ID', 'Bâtiment', 'Est_HTA', 'Puissance_Transfo_kVA', 'Tension_HTA_kV', 'Icn_HTA_kA',
                'Disjoncteur_ID', 'Marque', 'Référence', 'Ue_V', 'Icn_kA', 'Ik_kA', 'Cable_Length_m', 'Impedance_Ω', 'Statut'
            ];
            const rows = [];

            filteredData.forEach(tableau => {
                const ikHTA = calculateIkHTA(tableau);
                const icnHTA = tableau.isHTA && tableau.htaData ? normalizeIcn(tableau.htaData.icn) : null;
                const statusHTA = tableau.isHTA && ikHTA != null && icnHTA ? (ikHTA <= icnHTA ? 'OK' : 'KO') : 'N/A';

                if (tableau.disjoncteurs.length === 0) {
                    rows.push([
                        tableau.id,
                        tableau.building,
                        tableau.isHTA ? 'Oui' : 'Non',
                        tableau.htaData?.transformerPower || 'N/A',
                        tableau.htaData?.voltage || 'N/A',
                        icnHTA ? icnHTA.toFixed(2) : 'N/A',
                        '', '', '', '', '', ikHTA ? ikHTA.toFixed(2) : 'N/A', '', '', statusHTA
                    ]);
                }

                tableau.disjoncteurs.forEach(disjoncteur => {
                    const ik = disjoncteur.ik ? (disjoncteur.ik >= 1 ? disjoncteur.ik.toFixed(2) : disjoncteur.ik.toFixed(3)) : 'N/A';
                    const icn = disjoncteur.icn ? parseFloat(disjoncteur.icn).toFixed(2) : 'N/A';
                    const status = disjoncteur.ik != null && disjoncteur.icn ? (disjoncteur.ik <= disjoncteur.icn ? 'OK' : 'KO') : 'Incomplet';
                    let impedance = disjoncteur.impedance ? parseFloat(disjoncteur.impedance).toFixed(4) : 'N/A';
                    if (disjoncteur.cableLength && disjoncteur.section && !disjoncteur.impedance) {
                        const rho = 0.0175;
                        const L = parseFloat(disjoncteur.cableLength);
                        const sectionMatch = disjoncteur.section.match(/[\d.]+/);
                        const S = sectionMatch ? parseFloat(sectionMatch[0]) : 2.5;
                        const z = (rho * L * 2) / S;
                        impedance = z.toFixed(4);
                    }
                    rows.push([
                        tableau.id,
                        tableau.building,
                        tableau.isHTA ? 'Oui' : 'Non',
                        tableau.htaData?.transformerPower || 'N/A',
                        tableau.htaData?.voltage || 'N/A',
                        icnHTA ? icnHTA.toFixed(2) : 'N/A',
                        disjoncteur.id || 'N/A',
                        disjoncteur.marque || 'N/A',
                        disjoncteur.ref || 'N/A',
                        disjoncteur.ue || 'N/A',
                        icn,
                        ik,
                        disjoncteur.cableLength || 'N/A',
                        impedance,
                        status
                    ]);
                });
            });

            const csvContent = [
                headers.map(h => `"${h}"`).join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `niveau_defaut_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            console.log('[Client] Fichier CSV téléchargé');
        }

        // Calculer Ik pour HTA
        function calculateIkHTA(tableau) {
            if (!tableau.isHTA || !tableau.htaData) return null;
            const power = parseFloat(tableau.htaData.transformerPower) * 1000; // kVA to VA
            const voltage = parseFloat(tableau.htaData.voltage) * 1000; // kV to V
            if (!power || !voltage) return null;
            // Impédance du transformateur (approximation : 6% de la tension nominale)
            const zTransfo = 0.06 * (voltage * voltage) / power;
            // Impédance réseau amont (approximation : 0.01 Ω)
            const zNetwork = 0.01;
            const zTotal = zTransfo + zNetwork;
            const ik = (voltage / (Math.sqrt(3) * zTotal)) / 1000; // kA
            return ik > 50 ? null : ik; // Limite réaliste à 50 kA
        }

        // Vérifier Ik élevé
        function checkHighIk() {
            const highIk = tableauxData.flatMap(t => {
                const disjoncteursHigh = t.disjoncteurs.filter(d => d.ik && d.ik > 50);
                const htaHigh = t.isHTA && calculateIkHTA(t) > 50 ? [t] : [];
                return [...disjoncteursHigh, ...htaHigh];
            });
            const alert = document.getElementById('high-ik-alert');
            alert.classList.toggle('hidden', highIk.length === 0);
        }

        // Rendre le tableau
        function renderTable(data = tableauxData) {
            console.log('[Client] Rendu du tableau avec', data.length, 'tableaux');
            const tbody = document.getElementById('disjoncteurs-table');
            tbody.innerHTML = '';
            data.forEach(tableau => {
                const ikHTA = calculateIkHTA(tableau);
                const icnHTA = tableau.isHTA && tableau.htaData ? normalizeIcn(tableau.htaData.icn) : null;
                const statusHTA = tableau.isHTA && ikHTA != null && icnHTA ? (ikHTA <= icnHTA ? 'OK' : 'KO') : 'N/A';

                // Ligne pour la cellule HTA si applicable
                if (tableau.isHTA) {
                    const row = document.createElement('tr');
                    const cleanTableauId = tableau.id.replace(/"/g, '"').replace(/'/g, "'");
                    row.innerHTML = `
                        <td>${tableau.id} (HTA)</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>${tableau.htaData?.voltage ? tableau.htaData.voltage + ' kV' : 'N/A'}</td>
                        <td>${icnHTA ? icnHTA.toFixed(2) : 'N/A'}</td>
                        <td>${ikHTA ? ikHTA.toFixed(2) : 'N/A'}${ikHTA > 50 ? ' <span class="text-yellow-400">(Aberrant)</span>' : ''}</td>
                        <td>-</td>
                        <td class="${statusHTA === 'OK' ? 'text-green-600' : statusHTA === 'KO' ? 'text-red-600' : ''}">${statusHTA}</td>
                        <td>
                            <a href="edit.html?id=${cleanTableauId}" class="bg-yellow-600 text-white px-2 py-1 rounded hover:bg-yellow-700"><i class="fas fa-edit"></i></a>
                        </td>
                    `;
                    tbody.appendChild(row);
                }

                // Lignes pour les disjoncteurs
                tableau.disjoncteurs.forEach(d => {
                    const row = document.createElement('tr');
                    const ik = d.ik ? (d.ik >= 1 ? d.ik.toFixed(2) : d.ik.toFixed(3)) : 'N/A';
                    const icn = d.icn ? parseFloat(d.icn).toFixed(2) : 'N/A';
                    const status = d.ik != null && d.icn ? (d.ik <= d.icn ? 'OK' : 'KO') : 'Incomplet';
                    const cleanTableauId = tableau.id.replace(/"/g, '"').replace(/'/g, "'");
                    const cleanDisjoncteurId = d.id.replace(/"/g, '"').replace(/'/g, "'");
                    row.innerHTML = `
                        <td>${tableau.id}</td>
                        <td>${d.id}</td>
                        <td>${d.marque || 'N/A'}</td>
                        <td>${d.ref || 'N/A'}</td>
                        <td>${d.ue || 'N/A'}</td>
                        <td>${icn}</td>
                        <td>${ik}${ik !== 'N/A' && d.ik > 50 ? ' <span class="text-yellow-400">(Aberrant)</span>' : ''}</td>
                        <td>-</td>
                        <td class="${status === 'OK' ? 'text-green-600' : status === 'KO' ? 'text-red-600' : ''}">${status}</td>
                        <td>
                            <button class="action-btn bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700" data-tableau-id="${cleanTableauId}" data-disjoncteur-id="${cleanDisjoncteurId}"><i class="fas fa-chart-line"></i></button>
                            <a href="edit.html?id=${cleanTableauId}" class="bg-yellow-600 text-white px-2 py-1 rounded hover:bg-yellow-700"><i class="fas fa-edit"></i></a>
                        </td>
                    `;
                    tbody.appendChild(row);
                    console.log('[Client] Bouton créé pour:', { tableauId: tableau.id, disjoncteurId: d.id });
                });
            });
            console.log('[Client] Tableau rendu avec', tbody.children.length, 'lignes');
        }

        // Gérer les clics sur les boutons d’action
        function handleActionClick(event) {
            const btn = event.target.closest('.action-btn');
            if (!btn) {
                console.log('[Client] Clic ignoré: pas un bouton .action-btn');
                return;
            }

            event.preventDefault();
            event.stopPropagation();
            console.log('[Client] Clic détecté sur bouton d\'action');

            const tableauId = btn.getAttribute('data-tableau-id');
            const disjoncteurId = btn.getAttribute('data-disjoncteur-id');
            console.log('[Client] Données du bouton:', { tableauId, disjoncteurId });

            if (!tableauId || !disjoncteurId) {
                console.error('[Client] Attributs data- manquants ou invalides:', { tableauId, disjoncteurId });
                return;
            }

            const now = Date.now();
            if (now - lastClickTime < 1000) {
                console.log('[Client] Clic ignoré (trop rapide)', { timeSinceLast: now - lastClickTime });
                return;
            }
            lastClickTime = now;

            try {
                const cleanTableauId = tableauId.trim();
                const cleanDisjoncteurId = disjoncteurId.trim();
                console.log('[Client] IDs nettoyés pour recherche:', { cleanTableauId, cleanDisjoncteurId });
                const tableau = tableauxData.find(t => t.id.trim() === cleanTableauId);
                const disjoncteur = tableau?.disjoncteurs.find(d => d.id.trim() === cleanDisjoncteurId);
                if (!tableau || !disjoncteur) {
                    console.error('[Client] Erreur: Tableau ou disjoncteur non trouvé:', { cleanTableauId, cleanDisjoncteurId });
                    return;
                }
                console.log('[Client] Appel de openPanel pour:', { cleanTableauId, cleanDisjoncteurId });
                openPanel(cleanTableauId, cleanDisjoncteurId);
            } catch (error) {
                console.error('[Client] Erreur dans handleActionClick:', error.message);
            }
        }

        // Ouvrir le panneau latéral
        function openPanel(tableauId, disjoncteurId) {
            console.log('[Client] Ouverture panneau pour', tableauId, disjoncteurId);
            try {
                const tableau = tableauxData.find(t => t.id === tableauId);
                const disjoncteur = tableau.disjoncteurs.find(d => d.id === disjoncteurId);
                const panel = document.getElementById('details-panel');
                const content = document.getElementById('panel-content');
                const errorDiv = document.getElementById('panel-error');
                const successDiv = document.getElementById('panel-success');
                const impedanceInfo = document.getElementById('panel-impedance-info');

                if (!tableau || !disjoncteur) {
                    console.error('[Client] Tableau ou disjoncteur non trouvé:', tableauId, disjoncteurId);
                    errorDiv.classList.remove('hidden');
                    errorDiv.textContent = 'Erreur : Disjoncteur ou tableau non trouvé.';
                    return;
                }

                const ik = disjoncteur.ik ? (disjoncteur.ik >= 1 ? disjoncteur.ik.toFixed(2) : disjoncteur.ik.toFixed(3)) : 'N/A';
                const icn = disjoncteur.icn ? parseFloat(disjoncteur.icn).toFixed(2) : 'N/A';
                const status = disjoncteur.ik != null && disjoncteur.icn ? (disjoncteur.ik <= disjoncteur.icn ? 'OK' : 'KO') : 'Incomplet';
                const isPrincipal = disjoncteur.isPrincipal;
                const hasSubTableau = !!disjoncteur.linkedTableauId;
                const ikHTA = calculateIkHTA(tableau);
                const icnHTA = tableau.isHTA && tableau.htaData ? normalizeIcn(tableau.htaData.icn) : null;
                const statusHTA = tableau.isHTA && ikHTA != null && icnHTA ? (ikHTA <= icnHTA ? 'OK' : 'KO') : 'N/A';

                let impedanceDisplay = 'N/A';
                if (disjoncteur.cableLength && disjoncteur.section && !disjoncteur.impedance) {
                    const rho = 0.0175;
                    const L = parseFloat(disjoncteur.cableLength);
                    const sectionMatch = disjoncteur.section.match(/[\d.]+/);
                    const S = sectionMatch ? parseFloat(sectionMatch[0]) : 2.5;
                    const z = (rho * L * 2) / S;
                    impedanceDisplay = z.toFixed(4) + ' Ω';
                } else if (disjoncteur.impedance) {
                    impedanceDisplay = parseFloat(disjoncteur.impedance).toFixed(4) + ' Ω';
                }

                let htaInfo = '';
                if (tableau.isHTA && tableau.htaData) {
                    htaInfo = `
                        <div class="mt-4">
                            <h3 class="text-lg font-semibold mb-2">Cellule HTA</h3>
                            <p><strong>Puissance transformateur :</strong> ${tableau.htaData.transformerPower} kVA</p>
                            <p><strong>Tension HTA :</strong> ${tableau.htaData.voltage} kV</p>
                            <p><strong>Ik HTA :</strong> ${ikHTA ? ikHTA.toFixed(2) : 'N/A'} kA${ikHTA > 50 ? ' (Aberrant)' : ''}</p>
                            <p><strong>Icn HTA :</strong> ${icnHTA ? icnHTA.toFixed(2) : 'N/A'} kA</p>
                            <p><strong>Statut HTA :</strong> <span class="${statusHTA === 'OK' ? 'text-green-600' : statusHTA === 'KO' ? 'text-red-600' : ''}">${statusHTA}</span></p>
                            <p><strong>Explication HTA :</strong> ${statusHTA === 'OK' ? 'La cellule HTA peut supporter le courant de court-circuit.' : statusHTA === 'KO' ? 'Ik dépasse Icn de la cellule HTA. Vérifiez les réglages ou remplacez la cellule.' : 'Complétez les paramètres HTA dans Modifier.'}</p>
                        </div>
                    `;
                }

                content.innerHTML = `
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <p><strong>ID :</strong> ${disjoncteur.id}</p>
                            <p><strong>Tableau :</strong> ${tableau.id}${tableau.isHTA ? ' (HTA)' : ''}</p>
                            <p><strong>Marque :</strong> ${disjoncteur.marque || 'N/A'}</p>
                            <p><strong>Référence :</strong> ${disjoncteur.ref || 'N/A'}</p>
                            <p><strong>Principal :</strong> ${isPrincipal ? 'Oui' : 'Non'}</p>
                            <p><strong>Sous-tableau :</strong> ${disjoncteur.linkedTableauId || 'Aucun'}</p>
                        </div>
                        <div>
                            <p><strong>Ik calculé :</strong> ${ik} kA${ik !== 'N/A' && disjoncteur.ik > 50 ? ' (Aberrant)' : ''}</p>
                            <p><strong>Icn :</strong> ${icn} kA</p>
                            <p><strong>Statut :</strong> <span class="${status === 'OK' ? 'text-green-600' : status === 'KO' ? 'text-red-600' : ''}">${status}</span></p>
                            <p><strong>Explication :</strong> ${status === 'OK' ? 'Le disjoncteur peut supporter le courant de court-circuit.' : status === 'KO' ? 'Ik dépasse Icn. Remplacez le disjoncteur ou ajustez l’installation.' : 'Complétez Ue, section, et longueur pour calculer Ik.'}</p>
                        </div>
                    </div>
                    ${htaInfo}
                    <hr class="my-4">
                    <h3 class="text-lg font-semibold mb-2">Compléter les données BT</h3>
                    <p class="mb-2">Saisissez les données ci-dessous pour calculer Ik. Les paramètres HTA doivent être modifiés via <a href="edit.html?id=${tableau.id}" class="text-blue-400 underline">Modifier</a>.</p>
                    <div class="space-y-4">
                        <div>
                            <label for="ue" class="block text-sm font-medium mb-1">Tension nominale Ue (V) <span class="text-red-600">*</span></label>
                            <input id="ue" type="text" value="${disjoncteur.ue || '400 V'}" class="bg-gray-100 text-gray-900 p-2 rounded w-full border border-gray-300 focus:ring-2 focus:ring-blue-500" placeholder="Ex. 400 V" required>
                        </div>
                        <div>
                            <label for="section" class="block text-sm font-medium mb-1">Section de câble (mm²) <span class="text-red-600">*</span></label>
                            <input id="section" type="text" value="${disjoncteur.section || '2.5 mm²'}" class="bg-gray-100 text-gray-900 p-2 rounded w-full border border-gray-300 focus:ring-2 focus:ring-blue-500" placeholder="Ex. 2.5 mm²" required>
                        </div>
                        <div>
                            <label for="cable-length" class="block text-sm font-medium mb-1">Longueur de câble (m) ${isPrincipal ? '(Min. 5 m)' : hasSubTableau ? '<span class="text-red-600">* (Min. 20 m)</span>' : ''}</label>
                            <input id="cable-length" type="number" value="${disjoncteur.cableLength || (isPrincipal ? 5 : 20)}" class="bg-gray-100 text-gray-900 p-2 rounded w-full border border-gray-300 focus:ring-2 focus:ring-blue-500" placeholder="Ex. ${isPrincipal ? 5 : 20}" ${hasSubTableau && !isPrincipal ? 'required' : ''}>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Mode d'impédance</label>
                            <div class="radio-group">
                                <label><input type="radio" name="impedance-mode" value="auto" ${!disjoncteur.impedance ? 'checked' : ''}> Calcul automatique (Z = ρ × L / S)</label>
                                <label><input type="radio" name="impedance-mode" value="manual" ${disjoncteur.impedance ? 'checked' : ''}> Entrée manuelle</label>
                            </div>
                        </div>
                        <div>
                            <label for="impedance" class="block text-sm font-medium mb-1">Impédance (Ω) ${disjoncteur.impedance ? '' : '(Désactivé en mode automatique)'}</label>
                            <input id="impedance" type="number" step="0.01" value="${disjoncteur.impedance || ''}" class="bg-gray-100 text-gray-900 p-2 rounded w-full border border-gray-300 focus:ring-2 focus:ring-blue-500" placeholder="Ex. 0.35" ${!disjoncteur.impedance ? 'disabled' : ''}>
                        </div>
                    </div>
                    <p class="text-sm text-gray-400 mt-2">* Champs obligatoires pour calculer Ik. ρ = 0.0175 Ω·mm²/m (cuivre).</p>
                    <div class="mt-4">
                        <h3 class="text-lg font-semibold mb-2">Données actuelles</h3>
                        <table class="w-full border-collapse">
                            <tr><th class="border p-2">Champ</th><th class="border p-2">Valeur</th></tr>
                            <tr><td class="border p-2">Tension (Ue)</td><td class="border p-2">${disjoncteur.ue || 'N/A'}</td></tr>
                            <tr><td class="border p-2">Section</td><td class="border p-2">${disjoncteur.section || 'N/A'}</td></tr>
                            <tr><td class="border p-2">Longueur</td><td class="border p-2">${disjoncteur.cableLength || 'N/A'} m</td></tr>
                            <tr><td class="border p-2">Impédance</td><td class="border p-2">${impedanceDisplay}</td></tr>
                        </table>
                    </div>
                `;

                console.log('[Client] Panneau rendu pour:', tableauId, disjoncteurId);
                errorDiv.classList.add('hidden');
                successDiv.classList.add('hidden');
                impedanceInfo.classList.remove('hidden');
                impedanceInfo.textContent = `Impédance actuelle : ${impedanceDisplay}`;
                panel.classList.remove('hidden');

                renderDisjoncteurChart(disjoncteur, tableauId, tableau);

                const impedanceInput = document.getElementById('impedance');
                const radioButtons = document.querySelectorAll('input[name="impedance-mode"]');
                radioButtons.forEach(radio => {
                    radio.addEventListener('click', () => {
                        impedanceInput.disabled = radio.value === 'auto';
                        impedanceInput.value = radio.value === 'auto' ? '' : impedanceInput.value || '0.35';
                    });
                });

                const closePanelBtn = document.getElementById('close-panel');
                closePanelBtn.onclick = () => {
                    panel.classList.add('hidden');
                    console.log('[Client] Panneau fermé');
                };

                document.getElementById('update-cable-data').onclick = async () => {
                    const ue = document.getElementById('ue').value.trim();
                    const section = document.getElementById('section').value.trim();
                    const cableLength = document.getElementById('cable-length').value;
                    const impedanceMode = document.querySelector('input[name="impedance-mode"]:checked').value;
                    const impedance = impedanceMode === 'manual' ? document.getElementById('impedance').value : null;

                    console.log('[Client] Données saisies:', { ue, section, cableLength, impedanceMode, impedance });

                    // Validation renforcée
                    if (!ue || !normalizeVoltage(ue)) {
                        errorDiv.classList.remove('hidden');
                        errorDiv.textContent = 'La tension Ue doit être une valeur numérique positive (ex. 400 V).';
                        successDiv.classList.add('hidden');
                        return;
                    }
                    if (!section || !normalizeSection(section)) {
                        errorDiv.classList.remove('hidden');
                        errorDiv.textContent = 'La section de câble doit être une valeur numérique positive (ex. 2.5 mm²).';
                        successDiv.classList.add('hidden');
                        return;
                    }
                    if (hasSubTableau && !cableLength && !isPrincipal) {
                        errorDiv.classList.remove('hidden');
                        errorDiv.textContent = 'La longueur de câble est obligatoire pour les sous-tableaux.';
                        successDiv.classList.add('hidden');
                        return;
                    }
                    if (cableLength && parseFloat(cableLength) < (isPrincipal ? 5 : 20)) {
                        errorDiv.classList.remove('hidden');
                        errorDiv.textContent = `La longueur de câble doit être d’au moins ${isPrincipal ? 5 : 20} m.`;
                        successDiv.classList.add('hidden');
                        return;
                    }
                    if (impedanceMode === 'manual' && impedance && parseFloat(impedance) <= 0) {
                        errorDiv.classList.remove('hidden');
                        errorDiv.textContent = 'L’impédance manuelle doit être positive.';
                        successDiv.classList.add('hidden');
                        return;
                    }

                    try {
                        console.log('[Client] Envoi mise à jour:', { tableauId, disjoncteurId, ue, section, cableLength, impedanceMode, impedance });
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 2000);
                        const response = await fetch('/api/fault-level/update', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                tableauId,
                                disjoncteurId,
                                ue: ue || null,
                                section: section || null,
                                cableLength: cableLength ? parseFloat(cableLength) : isPrincipal ? 5 : 20,
                                impedance: impedance ? parseFloat(impedance) : null
                            }),
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);
                        const result = await response.json();
                        console.log('[Client] Réponse serveur:', result);
                        if (result.success) {
                            console.log('[Client] Mise à jour réussie');
                            successDiv.classList.remove('hidden');
                            successDiv.textContent = 'Données mises à jour avec succès !';
                            errorDiv.classList.add('hidden');
                            await loadTableaux();
                            setTimeout(() => panel.classList.add('hidden'), 1000);
                        } else {
                            errorDiv.classList.remove('hidden');
                            errorDiv.textContent = result.error || 'Erreur lors de la mise à jour des données.';
                            successDiv.classList.add('hidden');
                            console.error('[Client] Erreur mise à jour:', result.error);
                        }
                    } catch (error) {
                        errorDiv.classList.remove('hidden');
                        errorDiv.textContent = 'Erreur réseau lors de la mise à jour. Vérifiez votre connexion.';
                        successDiv.classList.add('hidden');
                        console.error('[Client] Erreur mise à jour:', error);
                    }
                };
            } catch (error) {
                console.error('[Client] Erreur dans openPanel:', error);
                const errorDiv = document.getElementById('panel-error');
                errorDiv.classList.remove('hidden');
                errorDiv.textContent = 'Erreur lors de l’ouverture du panneau.';
            }
        }

        // Rendre le graphique du panneau latéral
        function renderDisjoncteurChart(disjoncteur, tableauId, tableau) {
            console.log('[Client] Rendu du graphique pour disjoncteur:', disjoncteur.id);
            const canvas = document.getElementById('disjoncteur-chart');
            if (!canvas) {
                console.error('[Client] Canvas disjoncteur-chart non trouvé');
                return;
            }

            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error('[Client] Contexte 2D non disponible');
                return;
            }

            if (panelChartInstance) {
                panelChartInstance.destroy();
                console.log('[Client] Ancien graphique disjoncteur détruit');
            }

            const ik = disjoncteur.ik ? Math.min(disjoncteur.ik, 50) : 0;
            const icn = disjoncteur.icn ? parseFloat(disjoncteur.icn) : 0;
            const ikHTA = calculateIkHTA(tableau);
            const icnHTA = tableau.isHTA && tableau.htaData ? normalizeIcn(tableau.htaData.icn) : null;
            const labels = ['Ik (BT)', 'Icn (BT)'];
            const data = [ik, icn];
            const backgroundColors = [ik > icn ? '#EF4444' : '#10B981', '#FF4500'];

            if (tableau.isHTA && ikHTA != null && icnHTA != null) {
                labels.push('Ik (HTA)', 'Icn (HTA)');
                data.push(Math.min(ikHTA, 50), icnHTA);
                backgroundColors.push(ikHTA > icnHTA ? '#EF4444' : '#10B981', '#B91C1C');
            }

            try {
                panelChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [{
                            label: `Disjoncteur ${disjoncteur.id} (${tableauId})`,
                            data,
                            backgroundColor: backgroundColors
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: Math.max(...data, 50),
                                title: { display: true, text: 'kA', color: '#ffffff' },
                                grid: { color: '#4B5563' },
                                ticks: { color: '#ffffff' }
                            },
                            x: { 
                                grid: { display: false },
                                ticks: { color: '#ffffff' }
                            }
                        },
                        plugins: {
                            legend: { display: true, position: 'top', labels: { color: '#ffffff' } },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const label = context.dataset.label || '';
                                        const value = context.parsed.y;
                                        const index = context.dataIndex;
                                        const type = labels[index].includes('HTA') ? 'HTA' : 'BT';
                                        return `${labels[index]}: ${value} kA ${labels[index] === 'Ik (BT)' && disjoncteur.ik > 50 ? '(Aberrant)' : labels[index] === 'Ik (BT)' && ik > icn ? '(Risque !)' : labels[index] === 'Ik (HTA)' && ikHTA > 50 ? '(Aberrant)' : labels[index] === 'Ik (HTA)' && ikHTA > icnHTA ? '(Risque !)' : ''}`;
                                    }
                                }
                            }
                        }
                    }
                });
                console.log('[Client] Graphique disjoncteur rendu avec succès');
            } catch (error) {
                console.error('[Client] Erreur rendu graphique disjoncteur:', error);
            }
        }

        // Mettre à jour l’alerte de données manquantes
        function updateMissingDataAlert() {
            console.log('[Client] Mise à jour alerte données manquantes');
            const missing = tableauxData.flatMap(t => {
                const disjoncteursMissing = t.disjoncteurs.filter(d => !d.ue || !normalizeVoltage(d.ue) || !d.section || !normalizeSection(d.section) || (!d.cableLength && !d.impedance && !d.isPrincipal && d.linkedTableauId));
                const htaMissing = t.isHTA && (!t.htaData || !t.htaData.transformerPower || !t.htaData.voltage) ? [t] : [];
                return [...disjoncteursMissing, ...htaMissing];
            });
            const alert = document.getElementById('missing-data-alert');
            const countSpan = document.getElementById('missing-count');
            if (missing.length > 0) {
                alert.classList.remove('hidden');
                countSpan.textContent = missing.length;
                console.log('[Client] Données manquantes détectées:', missing.length);
            } else {
                alert.classList.add('hidden');
                console.log('[Client] Aucune donnée manquante');
            }
        }

        // Rendre le graphique à bulles
        function renderBubbleChart(data = tableauxData) {
            console.log('[Client] Rendu du graphique à bulles');
            const canvas = document.getElementById('bubble-chart');
            if (!canvas) {
                console.error('[Client] Canvas bubble-chart non trouvé');
                return;
            }

            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error('[Client] Contexte 2D non disponible pour bubble-chart');
                return;
            }

            if (bubbleChartInstance) {
                bubbleChartInstance.destroy();
                console.log('[Client] Ancien graphique à bulles détruit');
            }

            const datasets = [];
            let maxIk = 0;
            let maxIcn = 0;

            data.forEach(tableau => {
                tableau.disjoncteurs.forEach(disjoncteur => {
                    const ik = disjoncteur.ik ? parseFloat(disjoncteur.ik) : null;
                    const icn = disjoncteur.icn ? parseFloat(disjoncteur.icn) : null;
                    if (ik != null && icn != null && ik <= 50) {
                        datasets.push({
                            label: `${tableau.id} - ${disjoncteur.id}`,
                            data: [{ x: ik, y: icn, r: 8 }],
                            backgroundColor: ik > icn ? 'rgba(220, 38, 38, 0.7)' : 'rgba(34, 197, 94, 0.7)',
                            borderColor: ik > icn ? '#dc2626' : '#22c55e',
                            borderWidth: 1
                        });
                        maxIk = Math.max(maxIk, ik);
                        maxIcn = Math.max(maxIcn, icn);
                    }
                });
            });

            if (datasets.length === 0) {
                console.log('[Client] Aucune donnée valide pour le graphique à bulles');
                const parent = canvas.parentElement;
                const existingError = parent.querySelector('.error-message');
                if (!existingError) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'text-red-600 mt-2 error-message';
                    errorDiv.textContent = 'Aucune donnée valide pour afficher le graphique. Veuillez compléter les données des disjoncteurs.';
                    parent.appendChild(errorDiv);
                }
                return;
            }

            const existingError = canvas.parentElement.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }

            const diagonalData = {
                label: 'Icn = Ik',
                data: [{ x: 0, y: 0 }, { x: maxIk * 1.1, y: maxIcn * 1.1 }],
                type: 'line',
                borderColor: '#4B5563',
                borderWidth: 2,
                fill: false,
                pointRadius: 0
            };

            try {
                bubbleChartInstance = new Chart(ctx, {
                    type: 'bubble',
                    data: { datasets: [...datasets, diagonalData] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => context.dataset.label
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Ik (kA)', color: '#ffffff' },
                                grid: { color: '#4B5563' },
                                ticks: { color: '#ffffff' },
                                min: 0,
                                max: maxIk * 1.1
                            },
                            y: {
                                title: { display: true, text: 'Icn (kA)', color: '#ffffff' },
                                grid: { color: '#4B5563' },
                                ticks: { color: '#ffffff' },
                                min: 0,
                                max: maxIcn * 1.1
                            }
                        }
                    }
                });
                console.log('[Client] Graphique à bulles rendu avec succès');
            } catch (error) {
                console.error('[Client] Erreur rendu graphique à bulles:', error);
            }
        }

        // Rendre le schéma électrique
        function renderNetwork(data = tableauxData) {
            console.log('[Client] Rendu du schéma électrique');
            const container = document.getElementById('network-schema');
            if (!container) {
                console.error('[Client] Conteneur network-schema non trouvé');
                return;
            }

            if (networkInstance) {
                networkInstance.destroy();
                console.log('[Client] Ancien réseau détruit');
            }

            const nodes = [];
            const edges = [];
            const nodeIds = new Set();
            const tableauLevels = new Map();

            // Assigner des niveaux aux tableaux pour la hiérarchie
            function assignTableauLevels(tableauId, level = 0, visited = new Set()) {
                if (visited.has(tableauId)) {
                    console.warn(`[Client] Boucle détectée pour le tableau ${tableauId}`);
                    return;
                }
                visited.add(tableauId);

                if (!tableauLevels.has(tableauId)) {
                    tableauLevels.set(tableauId, level);
                } else {
                    tableauLevels.set(tableauId, Math.max(tableauLevels.get(tableauId), level));
                }

                const tableau = data.find(t => t.id === tableauId);
                if (!tableau) return;

                tableau.disjoncteurs.forEach(disjoncteur => {
                    if (disjoncteur.linkedTableauId) {
                        assignTableauLevels(disjoncteur.linkedTableauId, level + 3, new Set(visited));
                    }
                });
            }

            data.forEach(tableau => assignTableauLevels(tableau.id));

            // Créer les nœuds pour les tableaux et disjoncteurs
            data.forEach(tableau => {
                const tableauId = `tableau-${tableau.id}`;
                if (!nodeIds.has(tableauId)) {
                    const level = tableauLevels.get(tableau.id) || 0;
                    const ikHTA = calculateIkHTA(tableau);
                    const icnHTA = tableau.isHTA && tableau.htaData ? normalizeIcn(tableau.htaData.icn) : null;
                    const statusHTA = tableau.isHTA && ikHTA != null && icnHTA ? (ikHTA <= icnHTA ? 'OK' : 'KO') : 'N/A';
                    let tooltip = `Tableau: ${tableau.id}\nBâtiment: ${tableau.building}\nHTA: ${tableau.isHTA ? 'Oui' : 'Non'}`;
                    if (tableau.isHTA && tableau.htaData) {
                        tooltip += `\nPuissance transfo: ${tableau.htaData.transformerPower} kVA\nTension HTA: ${tableau.htaData.voltage} kV\nIk HTA: ${ikHTA ? ikHTA.toFixed(2) : 'N/A'} kA\nIcn HTA: ${icnHTA ? icnHTA.toFixed(2) : 'N/A'} kA\nStatut HTA: ${statusHTA}`;
                    }
                    nodes.push({
                        id: tableauId,
                        label: `${tableau.id}${tableau.isHTA ? ' (HTA)' : ''}`,
                        shape: 'box',
                        color: tableau.isHTA ? { background: '#fee2e2', border: '#dc2626' } : { background: '#ffffff', border: '#000000' },
                        level: level,
                        title: tooltip
                    });
                    nodeIds.add(tableauId);
                }
            });

            data.forEach(tableau => {
                const tableauId = `tableau-${tableau.id}`;
                const baseLevel = tableauLevels.get(tableau.id) || 0;
                const principaux = tableau.disjoncteurs.filter(d => d.isPrincipal);
                const nonPrincipaux = tableau.disjoncteurs.filter(d => !d.isPrincipal);

                principaux.forEach(disjoncteur => {
                    const disjoncteurId = `disjoncteur-${tableau.id}-${disjoncteur.id}`;
                    if (!nodeIds.has(disjoncteurId)) {
                        const status = disjoncteur.ik != null && disjoncteur.icn ? (disjoncteur.ik <= disjoncteur.icn ? 'OK' : 'KO') : 'Incomplet';
                        nodes.push({
                            id: disjoncteurId,
                            label: disjoncteur.id,
                            shape: 'box',
                            color: { background: '#d4edda', border: '#22c55e' },
                            level: baseLevel + 1,
                            title: `Disjoncteur: ${disjoncteur.id}\nTableau: ${tableau.id}\nMarque: ${disjoncteur.marque || 'N/A'}\nRéférence: ${disjoncteur.ref || 'N/A'}\nIk: ${disjoncteur.ik ? disjoncteur.ik.toFixed(2) : 'N/A'} kA\nIcn: ${disjoncteur.icn ? disjoncteur.icn.toFixed(2) : 'N/A'} kA\nStatut: ${status}`
                        });
                        nodeIds.add(disjoncteurId);
                        edges.push({ from: tableauId, to: disjoncteurId });
                    }
                });

                nonPrincipaux.forEach(disjoncteur => {
                    const disjoncteurId = `disjoncteur-${tableau.id}-${disjoncteur.id}`;
                    if (!nodeIds.has(disjoncteurId)) {
                        let color;
                        const status = disjoncteur.ik != null && disjoncteur.icn ? (disjoncteur.ik <= disjoncteur.icn ? 'OK' : 'KO') : 'Incomplet';
                        if (disjoncteur.ik != null && disjoncteur.icn && disjoncteur.ik > disjoncteur.icn) {
                            color = { background: '#fee2e2', border: '#dc2626' };
                        } else if (!disjoncteur.ik || !disjoncteur.icn) {
                            color = { background: '#D1D5DB', border: '#6B7280' };
                        } else {
                            color = { background: '#ffffff', border: '#000000' };
                        }
                        nodes.push({
                            id: disjoncteurId,
                            label: disjoncteur.id,
                            shape: 'box',
                            color,
                            level: baseLevel + 2,
                            title: `Disjoncteur: ${disjoncteur.id}\nTableau: ${tableau.id}\nMarque: ${disjoncteur.marque || 'N/A'}\nRéférence: ${disjoncteur.ref || 'N/A'}\nIk: ${disjoncteur.ik ? disjoncteur.ik.toFixed(2) : 'N/A'} kA\nIcn: ${disjoncteur.icn ? disjoncteur.icn.toFixed(2) : 'N/A'} kA\nStatut: ${status}`
                        });
                        nodeIds.add(disjoncteurId);

                        if (principaux.length > 0) {
                            const principalId = `disjoncteur-${tableau.id}-${principaux[0].id}`;
                            edges.push({ from: principalId, to: disjoncteurId });
                        } else {
                            edges.push({ from: tableauId, to: disjoncteurId });
                        }
                    }
                });
            });

            // Ajouter les arêtes pour les liaisons entre tableaux
            data.forEach(tableau => {
                tableau.disjoncteurs.forEach(disjoncteur => {
                    if (disjoncteur.linkedTableauId) {
                        const disjoncteurId = `disjoncteur-${tableau.id}-${disjoncteur.id}`;
                        const toId = `tableau-${disjoncteur.linkedTableauId}`;
                        if (nodeIds.has(toId)) {
                            edges.push({ from: disjoncteurId, to: toId, dashes: true });
                        } else {
                            console.warn(`[Client] Sous-tableau ${disjoncteur.linkedTableauId} non trouvé pour ${disjoncteurId}`);
                        }
                    }
                });
            });

            // Afficher une alerte si aucune liaison n’est détectée
            const noLinkedTableauAlert = document.getElementById('no-linked-tableau-alert');
            const hasLinks = edges.some(e => e.dashes);
            noLinkedTableauAlert.classList.toggle('hidden', hasLinks);

            // Vérifier si des données sont disponibles
            if (nodes.length === 0) {
                console.log('[Client] Aucune donnée valide pour le schéma électrique');
                const existingError = container.querySelector('.error-message');
                if (!existingError) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'text-red-600 mt-2 error-message';
                    errorDiv.textContent = 'Aucune donnée valide pour afficher le schéma. Veuillez vérifier les données des tableaux.';
                    container.appendChild(errorDiv);
                }
                return;
            }

            const existingError = container.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }

            try {
                const visData = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
                const options = {
                    nodes: {
                        font: { size: 12, color: '#000000' },
                        borderWidth: 2,
                        widthConstraint: { minimum: 80, maximum: 150 },
                        shapeProperties: { borderRadius: 6 }
                    },
                    edges: {
                        width: 2,
                        color: '#000000',
                        smooth: { type: 'curvedCW', roundness: 0.2 }
                    },
                    physics: {
                        enabled: true,
                        hierarchicalRepulsion: {
                            centralGravity: 0.0,
                            springLength: 100,
                            springConstant: 0.01,
                            nodeDistance: 120,
                            damping: 0.09
                        },
                        solver: 'hierarchicalRepulsion'
                    },
                    layout: {
                        hierarchical: {
                            enabled: true,
                            levelSeparation: 250,
                            nodeSpacing: 120,
                            treeSpacing: 200,
                            direction: 'UD',
                            sortMethod: 'directed',
                            shakeTowards: 'roots'
                        }
                    },
                    interaction: {
                        hover: true,
                        zoomView: true,
                        dragView: true,
                        navigationButtons: true
                    },
                    manipulation: { enabled: false }
                };
                networkInstance = new vis.Network(container, visData, options);
                console.log('[Client] Schéma électrique rendu avec succès', { nodes: nodes.length, edges: edges.length, levels: [...tableauLevels.entries()] });
            } catch (error) {
                console.error('[Client] Erreur rendu schéma électrique:', error);
            }
        }
    </script>
</body>
</html>