<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autonomix Elec - Évaluation du Niveau de Défaut</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="/styles.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vis-network@9.1.9/dist/vis-network.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/vis-network@9.1.9/styles/vis-network.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        .alert-missing { background-color: #7f1d1d; color: #fecaca; padding: 0.75rem; border-radius: 0.375rem; }
        .gantt th, .gantt td { border: 1px solid #4B5563; padding: 0.5rem; text-align: left; font-size: 0.875rem; }
        .gantt th { background-color: #374151; font-size: 0.875rem; }
        .error-message { color: #ef4444; font-size: 0.875rem; }
        .touch-friendly { min-height: 44px; padding: 0.5rem 1rem; }
        .animate-fade-in { animation: fadeIn 0.8s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @media (min-width: 640px) {
            .gantt th, .gantt td { font-size: 1rem; }
            .error-message { font-size: 1rem; }
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans">
    <nav class="bg-blue-700 p-4 shadow-lg fixed w-full top-0 z-50">
        <ul class="flex flex-wrap space-x-6 justify-center text-sm sm:text-base">
            <li><a href="index.html" class="hover:text-yellow-300 transition"><i class="fas fa-home mr-2"></i>Accueil</a></li>
            <li><a href="create.html" class="hover:text-yellow-300 transition"><i class="fas fa-plus-circle mr-2"></i>Créer un tableau</a></li>
            <li><a href="view.html" class="hover:text-yellow-300 transition"><i class="fas fa-table mr-2"></i>Voir les tableaux</a></li>
            <li><a href="selectivity.html" class="hover:text-yellow-300 transition"><i class="fas fa-shield-alt mr-2"></i>Sélectivité</a></li>
            <li><a href="obsolescence.html" class="hover:text-yellow-300 transition"><i class="fas fa-clock mr-2"></i>Obsolescence</a></li>
            <li><a href="fault_level_assessment.html" class="text-yellow-300 font-bold"><i class="fas fa-bolt mr-2"></i>Évaluation du Niveau de Défaut</a></li>
            <li><a href="hazards_assessment.html" class="hover:text-yellow-300 transition"><i class="fas fa-exclamation-triangle mr-2"></i>Évaluation des Risques</a></li>
            <li><a href="maintenance_org.html" class="hover:text-yellow-300 transition"><i class="fas fa-sitemap mr-2"></i>Organigramme Maintenance</a></li>
            <li><a href="distribution_emergency.html" class="hover:text-yellow-300 transition"><i class="fas fa-plug mr-2"></i>Urgence Distribution</a></li>
            <li><a href="reports.html" class="hover:text-yellow-300 transition"><i class="fas fa-file-alt mr-2"></i>Rapports</a></li>
            <li><a href="electrical_safety_program.html" class="hover:text-yellow-300 transition"><i class="fas fa-hard-hat mr-2"></i>Programme de Sécurité Électrique</a></li>
            <li><a href="breaker_control.html" class="hover:text-yellow-300 transition"><i class="fas fa-cogs mr-2"></i>Contrôle des Disjoncteurs</a></li>
        </ul>
    </nav>

    <div class="container mx-auto mt-28 p-4 sm:p-6 flex flex-col sm:flex-row">
        <div class="flex-1 sm:pr-4">
            <div class="flex justify-between items-center mb-4 sm:mb-6">
                <h1 class="text-2xl sm:text-3xl font-bold flex items-center"><i class="fas fa-bolt mr-2 sm:mr-3"></i>Évaluation du Niveau de Défaut</h1>
                <button id="export-csv-btn" onclick="exportToCSV()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 flex items-center touch-friendly hidden">
                    <i class="fas fa-file-csv mr-2"></i>Exporter en CSV
                </button>
            </div>
            <div id="api-error" class="hidden bg-red-900 text-red-200 p-3 rounded mb-4 sm:mb-6 animate-fade-in">
                <p><i class="fas fa-exclamation-triangle mr-2"></i>Erreur lors du chargement des données. Veuillez réessayer plus tard.</p>
            </div>
            <div class="mb-4 sm:mb-6 bg-gray-800 p-4 rounded-lg shadow-lg animate-fade-in">
                <h2 class="text-lg sm:text-xl font-semibold mb-4 flex items-center"><i class="fas fa-info-circle mr-2"></i>Qu’est-ce que l’évaluation du niveau de défaut ?</h2>
                <p class="mb-2 text-sm sm:text-base">Cette page évalue la capacité des disjoncteurs BT et des cellules HTA à supporter un court-circuit (Ik) par rapport à leur pouvoir de coupure (Icn).</p>
                <p class="mb-2 text-sm sm:text-base"><strong>Ik (courant de court-circuit)</strong> : Le courant maximal en cas de court-circuit, en kA. Pour les tableaux BT, il dépend de la tension (Ue), de la longueur et de la section du câble. Pour les tableaux HTA, il dépend de la puissance du transformateur et de la tension HTA.</p>
                <p class="mb-2 text-sm sm:text-base"><strong>Icn (pouvoir de coupure)</strong> : La capacité du disjoncteur ou de la cellule HTA à interrompre un court-circuit, en kA.</p>
                <p class="mb-2 text-sm sm:text-base"><strong>Risque</strong> : Si Ik > Icn, le disjoncteur ou la cellule risque de ne pas tenir (KO). Sinon, le statut est OK.</p>
                <p class="text-sm sm:text-base"><strong>Exemple</strong> : Un disjoncteur avec Icn = 4,5 kA et Ik = 6 kA est KO. Pour un tableau HTA avec un transformateur de 1600 kVA, Ik peut atteindre 20 kA, à comparer avec Icn de la cellule HTA.</p>
            </div>

            <div class="mb-4 sm:mb-6 flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                <div>
                    <label for="building-filter" class="block text-sm font-medium mb-1">Filtrer par bâtiment</label>
                    <select id="building-filter" class="bg-gray-700 text-white p-2 rounded text-sm sm:text-base">
                        <option value="">Tous les bâtiments</option>
                    </select>
                </div>
                <div>
                    <label for="tableau-filter" class="block text-sm font-medium mb-1">Filtrer par tableau</label>
                    <select id="tableau-filter" class="bg-gray-700 text-white p-2 rounded text-sm sm:text-base">
                        <option value="">Tous les tableaux</option>
                    </select>
                </div>
            </div>

            <div id="no-building-selected" class="bg-gray-800 p-4 rounded-lg shadow-lg mb-4 sm:mb-6 animate-fade-in">
                <p class="text-gray-300 text-sm sm:text-base">Veuillez sélectionner un bâtiment pour afficher les données.</p>
            </div>

            <div id="data-section" class="hidden">
                <div class="mb-4 sm:mb-6 bg-gray-800 p-4 rounded-lg shadow-lg animate-fade-in">
                    <h2 class="text-lg sm:text-xl font-semibold mb-4 flex items-center"><i class="fas fa-info-circle mr-2"></i>Comment utiliser cette page</h2>
                    <ul class="list-disc list-inside space-y-2 text-sm sm:text-base">
                        <li>Filtrez par bâtiment ou tableau pour cibler les disjoncteurs et cellules HTA.</li>
                        <li>Le tableau indique Ik, Icn (BT et HTA si applicable), et le statut (OK/KO/Incomplet).</li>
                        <li>Cliquez sur <i class="fas fa-chart-line"></i> pour modifier Ue, section, longueur de câble, ou impédance dans le panneau latéral.</li>
                        <li>Pour les tableaux HTA, Ik est calculé à partir du transformateur (puissance, tension).</li>
                        <li>Les disjoncteurs principaux ont un câble minimum de 5 m, les autres de 20 m pour limiter Ik.</li>
                        <li>Le schéma montre les connexions entre tableaux (ex. 01-9-G sous 02-9-G). Les tableaux HTA sont en rouge.</li>
                        <li>Le graphique à bulles montre Ik vs Icn pour les disjoncteurs BT. Les bulles rouges indiquent un risque (Ik > Icn).</li>
                        <li>Si des données manquent, complétez-les via le panneau latéral ou <a href="edit.html" class="text-blue-400 underline">Modifier</a>.</li>
                        SHARED
                        <li>Exportez les données en CSV, incluant les paramètres HTA et l’impédance.</li>
                    </ul>
                </div>

                <div id="missing-data-alert" class="alert-missing hidden mb-4 sm:mb-6 animate-fade-in">
                    <p class="text-sm sm:text-base">Certaines données (Ue, section, longueur de câble, paramètres HTA) sont manquantes pour <span id="missing-count"></span> disjoncteurs ou tableaux. Cliquez sur <i class="fas fa-chart-line"></i> ou <a href="edit.html" class="text-blue-400 underline">Modifier</a> pour les compléter.</p>
                </div>

                <div id="no-linked-tableau-alert" class="alert-missing hidden mb-4 sm:mb-6 animate-fade-in">
                    <p class="text-sm sm:text-base">Aucune liaison entre tableaux n’a été détectée. Utilisez <a href="edit.html" class="text-blue-400 underline">Modifier</a> pour ajouter des tableaux avals.</p>
                </div>

                <div id="high-ik-alert" class="alert-missing hidden mb-4 sm:mb-6 animate-fade-in">
                    <p class="text-sm sm:text-base">Certains disjoncteurs ou cellules HTA ont un Ik > 50 kA, ce qui peut être irréaliste. Vérifiez les données (longueur de câble, section, impédance, paramètres HTA) dans le panneau latéral ou <a href="edit.html" class="text-blue-400 underline">Modifier</a>.</p>
                </div>

                <div class="mb-4 sm:mb-6">
                    <h2 class="text-lg sm:text-xl font-semibold mb-4 flex items-center"><i class="fas fa-table mr-2"></i>Tableau des disjoncteurs et cellules HTA</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full gantt">
                            <thead>
                                <tr>
                                    <th class="p-2">Tableau</th>
                                    <th class="p-2">Disjoncteur ID</th>
                                    <th class="p-2">Marque</th>
                                    <th class="p-2">Référence</th>
                                    <th class="p-2" title="Tension nominale (V)">Ue (V)</th>
                                    <th class="p-2" title="Pouvoir de coupure (kA)">Icn (kA)</th>
                                    <th class="p-2" title="Courant de court-circuit calculé (kA)">Ik (kA)</th>
                                    <th class="p-2" title="Pouvoir de coupure HTA (kA)">Icn HTA (kA)</th>
                                    <th class="p-2">Statut</th>
                                    <th class="p-2">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="disjoncteurs-table"></tbody>
                        </table>
                    </div>
                </div>

                <div class="mb-4 sm:mb-6">
                    <h2 class="text-lg sm:text-xl font-semibold mb-4 flex items-center"><i class="fas fa-chart-scatter mr-2"></i>Graphique à bulles : Ik vs Icn (BT)</h2>
                    <p class="mb-4 text-sm sm:text-base">Ce graphique montre les disjoncteurs BT avec Ik (axe X) et Icn (axe Y). Les bulles rouges indiquent un risque (Ik > Icn), les vertes sont sécurisées (Ik ≤ Icn). La ligne diagonale représente Icn = Ik.</p>
                    <canvas id="bubble-chart" class="bg-gray-800 p-4 rounded-lg" style="height: 400px;"></canvas>
                </div>

                <div class="mb-4 sm:mb-6">
                    <h2 class="text-lg sm:text-xl font-semibold mb-4 flex items-center"><i class="fas fa-sitemap mr-2"></i>Schéma électrique</h2>
                    <p class="mb-4 text-sm sm:text-base">Ce schéma montre les connexions entre tableaux et disjoncteurs. Les tableaux HTA sont en rouge, les disjoncteurs principaux en vert, les disjoncteurs à risque (Ik > Icn) en rouge, et ceux sans données en gris.</p>
                    <div id="network-schema" class="bg-white p-4 rounded-lg border border-gray-300" style="height: 400px;"></div>
                </div>
            </div>
        </div>

        <div id="details-panel" class="w-full sm:w-1/3 bg-gray-800 p-4 rounded-lg shadow-lg hidden animate-fade-in">
            <h2 class="text-lg sm:text-xl font-bold mb-4 flex items-center"><i class="fas fa-cog mr-2"></i>Détails du disjoncteur</h2>
            <button id="close-panel" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 mb-4 touch-friendly"><i class="fas fa-times mr-2"></i>Fermer</button>
            <div id="panel-content" class="text-sm sm:text-base"></div>
            <div id="panel-error" class="text-red-600 hidden mt-2 text-sm sm:text-base"></div>
            <div id="panel-success" class="text-green-600 hidden mt-2 text-sm sm:text-base"></div>
            <div id="panel-impedance-info" class="text-gray-400 hidden mt-2 text-sm sm:text-base"></div>
            <div class="mt-4">
                <h3 class="text-lg font-semibold mb-2">Graphique Ik vs Icn</h3>
                <p class="mb-2 text-sm sm:text-base">Ce graphique compare Ik à Icn pour le disjoncteur BT (et la cellule HTA si applicable). Une barre rouge indique un risque (Ik > Icn).</p>
                <canvas id="disjoncteur-chart" style="max-height: 200px;"></canvas>
            </div>
            <div class="mt-4 flex justify-end space-x-2">
                <button id="update-cable-data" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 touch-friendly"><i class="fas fa-save mr-2"></i>Mettre à jour</button>
            </div>
        </div>

        <div id="popup" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full animate-fade-in">
                <p id="popup-message" class="mb-4 text-sm sm:text-base"></p>
                <div id="popup-content" class="mb-4"></div>
                <div class="flex space-x-4">
                    <button id="popup-confirm" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 touch-friendly"><i class="fas fa-check mr-2"></i>Confirmer</button>
                    <button id="popup-cancel" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 touch-friendly"><i class="fas fa-times mr-2"></i>Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let tableauxData = [];
        let panelChartInstance = null;
        let bubbleChartInstance = null;
        let networkInstance = null;
        let lastClickTime = 0;

        function showPopup(message, content = '', confirmCallback = () => {}) {
            console.log('[FLA] Affichage pop-up:', message);
            document.getElementById('popup-message').textContent = message;
            document.getElementById('popup-content').innerHTML = content;
            document.getElementById('popup').classList.remove('hidden');
            document.getElementById('popup-confirm').onclick = () => {
                console.log('[FLA] Pop-up confirmé:', message);
                confirmCallback();
                hidePopup();
            };
            document.getElementById('popup-cancel').onclick = () => {
                console.log('[FLA] Pop-up annulé:', message);
                hidePopup();
            };
            gsap.from('#popup > div', { opacity: 0, scale: 0.8, duration: 0.5, ease: 'power2.out' });
        }

        function hidePopup() {
            console.log('[FLA] Masquage pop-up');
            document.getElementById('popup').classList.add('hidden');
        }

        function normalizeIcn(icn) {
            if (!icn) return null;
            if (typeof icn === 'number' && !isNaN(icn)) return icn;
            if (typeof icn === 'string') {
                const match = icn.match(/[\d.]+/);
                return match ? parseFloat(match[0]) : null;
            }
            return null;
        }

        function normalizeVoltage(ue) {
            if (!ue) return null;
            const match = ue.match(/[\d.]+/);
            return match ? parseFloat(match[0]) : null;
        }

        function normalizeSection(section) {
            if (!section) return null;
            const match = section.match(/[\d.]+/);
            return match ? parseFloat(match[0]) : null;
        }

        async function loadTableaux() {
            console.log('[FLA] Chargement des données FLA');
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                const response = await fetch('/api/fault-level', { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
                const data = await response.json();
                console.log('[FLA] Données reçues:', data);
                tableauxData = data.data || [];
                document.getElementById('api-error').classList.add('hidden');
                populateFilters();
                showNoBuildingMessage();
                renderData(tableauxData);
            } catch (error) {
                console.error('[FLA] Erreur chargement:', error);
                showPopup('Erreur lors du chargement des données: ' + error.message, '', () => {});
                tableauxData = [];
                showNoBuildingMessage();
            }
        }

        async function loadTableauById(tableauId) {
            console.log('[FLA] Chargement tableau:', tableauId);
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                const response = await fetch(`/api/tableaux/${encodeURIComponent(tableauId)}`, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
                const data = await response.json();
                console.log('[FLA] Tableau reçu:', data.id);
                return {
                    id: data.id,
                    building: data.id.split('-')[0] || 'Inconnu',
                    disjoncteurs: (data.disjoncteurs || []).map(d => ({
                        ...d,
                        id: d.id || d.disjoncteur_id,
                        ik: d.ik || null,
                        icn: normalizeIcn(d.icn),
                        tableauId: data.id,
                        linkedTableauIds: d.linkedTableauIds || (d.linkedTableauId ? [d.linkedTableauId] : [])
                    })),
                    issitemain: data.issitemain || false,
                    isHTA: data.isHTA || false,
                    htaData: data.htaData || null
                };
            } catch (error) {
                console.error('[FLA] Erreur chargement tableau:', error);
                showPopup('Erreur lors du chargement du tableau: ' + error.message, '', () => {});
                return null;
            }
        }

        function populateFilters() {
            console.log('[FLA] Remplissage des filtres');
            const buildings = [...new Set(tableauxData.map(t => t.building))].sort();
            const buildingFilter = document.getElementById('building-filter');
            buildingFilter.innerHTML = '<option value="">Tous les bâtiments</option>';
            buildings.forEach(b => {
                const option = document.createElement('option');
                option.value = b;
                option.textContent = b;
                buildingFilter.appendChild(option);
            });

            function updateTableauFilter(selectedBuilding) {
                const tableauFilter = document.getElementById('tableau-filter');
                tableauFilter.innerHTML = '<option value="">Tous les tableaux</option>';
                const filteredTableaux = selectedBuilding
                    ? tableauxData.filter(t => t.building === selectedBuilding)
                    : tableauxData;
                filteredTableaux.forEach(t => {
                    const option = document.createElement('option');
                    option.value = t.id;
                    option.textContent = t.id;
                    tableauFilter.appendChild(option);
                });
            }

            updateTableauFilter('');
            buildingFilter.addEventListener('change', () => {
                const selectedBuilding = buildingFilter.value;
                updateTableauFilter(selectedBuilding);
                filterData();
            });
            document.getElementById('tableau-filter').addEventListener('change', filterData);
        }

        function showNoBuildingMessage() {
            console.log('[FLA] Affichage message aucun bâtiment sélectionné');
            document.getElementById('no-building-selected').classList.remove('hidden');
            document.getElementById('data-section').classList.add('hidden');
            document.getElementById('export-csv-btn').classList.add('hidden');
        }

        function filterData() {
            console.log('[FLA] Filtrage des données');
            const building = document.getElementById('building-filter').value;
            const tableau = document.getElementById('tableau-filter').value;
            let filteredData = tableauxData;

            if (!building) {
                showNoBuildingMessage();
                return;
            }

            filteredData = filteredData.filter(t => t.building === building);
            if (tableau) filteredData = filteredData.filter(t => t.id === tableau);

            if (filteredData.length === 0) {
                showPopup('Aucun tableau trouvé pour les critères sélectionnés.', '', () => {});
                showNoBuildingMessage();
                return;
            }

            document.getElementById('no-building-selected').classList.add('hidden');
            document.getElementById('data-section').classList.remove('hidden');
            document.getElementById('export-csv-btn').classList.remove('hidden');
            renderData(filteredData);
        }

        function exportToCSV() {
            console.log('[FLA] Exportation en CSV');
            const building = document.getElementById('building-filter').value;
            const tableau = document.getElementById('tableau-filter').value;
            let filteredData = tableauxData;

            if (!building) {
                showPopup('Veuillez sélectionner un bâtiment pour exporter les données.', '', () => {});
                return;
            }

            filteredData = filteredData.filter(t => t.building === building);
            if (tableau) filteredData = filteredData.filter(t => t.id === tableau);

            if (!filteredData.length) {
                showPopup('Aucune donnée à exporter pour les critères sélectionnés.', '', () => {});
                return;
            }

            const headers = [
                'Tableau_ID', 'Bâtiment', 'Est_HTA', 'Puissance_Transfo_kVA', 'Tension_HTA_kV', 'Icn_HTA_kA',
                'Disjoncteur_ID', 'Marque', 'Référence', 'Ue_V', 'Icn_kA', 'Ik_kA', 'Cable_Length_m', 'Impedance_Ω', 'Statut'
            ];
            const rows = [];

            filteredData.forEach(tableau => {
                const ikHTA = calculateIkHTA(tableau);
                const icnHTA = tableau.isHTA && tableau.htaData ? normalizeIcn(tableau.htaData.icn) : null;
                const statusHTA = tableau.isHTA && ikHTA != null && icnHTA ? (ikHTA <= icnHTA ? 'OK' : 'KO') : 'N/A';

                if (tableau.disjoncteurs.length === 0) {
                    rows.push([
                        tableau.id,
                        tableau.building,
                        tableau.isHTA ? 'Oui' : 'Non',
                        tableau.htaData?.transformerPower || 'N/A',
                        tableau.htaData?.voltage || 'N/A',
                        icnHTA ? icnHTA.toFixed(2) : 'N/A',
                        '', '', '', '', '', ikHTA ? ikHTA.toFixed(2) : 'N/A', '', '', statusHTA
                    ]);
                }

                tableau.disjoncteurs.forEach(disjoncteur => {
                    const ik = disjoncteur.ik ? (disjoncteur.ik >= 1 ? disjoncteur.ik.toFixed(2) : disjoncteur.ik.toFixed(3)) : 'N/A';
                    const icn = disjoncteur.icn ? parseFloat(disjoncteur.icn).toFixed(2) : 'N/A';
                    const status = disjoncteur.ik != null && disjoncteur.icn ? (disjoncteur.ik <= disjoncteur.icn ? 'OK' : 'KO') : 'Incomplet';
                    let impedance = disjoncteur.impedance ? parseFloat(disjoncteur.impedance).toFixed(4) : 'N/A';
                    if (disjoncteur.cableLength && disjoncteur.section && !disjoncteur.impedance) {
                        const rho = 0.0175;
                        const L = parseFloat(disjoncteur.cableLength);
                        const sectionMatch = disjoncteur.section.match(/[\d.]+/);
                        const S = sectionMatch ? parseFloat(sectionMatch[0]) : 2.5;
                        const z = (rho * L * 2) / S;
                        impedance = z.toFixed(4);
                    }
                    rows.push([
                        tableau.id,
                        tableau.building,
                        tableau.isHTA ? 'Oui' : 'Non',
                        tableau.htaData?.transformerPower || 'N/A',
                        tableau.htaData?.voltage || 'N/A',
                        icnHTA ? icnHTA.toFixed(2) : 'N/A',
                        disjoncteur.id || 'N/A',
                        disjoncteur.marque || 'N/A',
                        disjoncteur.ref || 'N/A',
                        disjoncteur.ue || 'N/A',
                        icn,
                        ik,
                        disjoncteur.cableLength || 'N/A',
                        impedance,
                        status
                    ]);
                });
            });

            const csvContent = [
                headers.map(h => `"${h}"`).join(','),
                ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `niveau_defaut_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            console.log('[FLA] Fichier CSV téléchargé');
        }

        function calculateIkHTA(tableau) {
            if (!tableau.isHTA || !tableau.htaData) return null;
            const power = parseFloat(tableau.htaData.transformerPower) * 1000; // kVA to VA
            const voltage = parseFloat(tableau.htaData.voltage) * 1000; // kV to V
            if (!power || !voltage || isNaN(power) || isNaN(voltage)) return null;
            const zTransfo = 0.06 * (voltage * voltage) / power;
            const zNetwork = 0.01;
            const zTotal = zTransfo + zNetwork;
            const ik = (voltage / (Math.sqrt(3) * zTotal)) / 1000; // kA
            return ik > 50 ? null : ik;
        }

        function checkHighIk(data) {
            const highIk = data.flatMap(t => {
                const disjoncteursHigh = t.disjoncteurs.filter(d => d.ik && d.ik > 50);
                const htaHigh = t.isHTA && calculateIkHTA(t) > 50 ? [t] : [];
                return [...disjoncteursHigh, ...htaHigh];
            });
            const alert = document.getElementById('high-ik-alert');
            alert.classList.toggle('hidden', highIk.length === 0);
            console.log('[FLA] Vérification Ik élevé:', highIk.length, 'éléments détectés');
        }

        function updateMissingDataAlert(data) {
            console.log('[FLA] Mise à jour alerte données manquantes');
            const missing = data.flatMap(t => {
                const disjoncteursMissing = t.disjoncteurs.filter(d => 
                    !d.ue || !normalizeVoltage(d.ue) || 
                    !d.section || !normalizeSection(d.section) || 
                    (!d.cableLength && !d.impedance && !d.isPrincipal && d.linkedTableauIds?.length > 0));
                const htaMissing = t.isHTA && (!t.htaData || !t.htaData.transformerPower || !t.htaData.voltage) ? [t] : [];
                return [...disjoncteursMissing, ...htaMissing];
            });
            const alert = document.getElementById('missing-data-alert');
            const countSpan = document.getElementById('missing-count');
            if (missing.length > 0) {
                alert.classList.remove('hidden');
                countSpan.textContent = missing.length;
                console.log('[FLA] Données manquantes détectées:', missing.length);
            } else {
                alert.classList.add('hidden');
                console.log('[FLA] Aucune donnée manquante');
            }
        }

        function renderTable(data) {
            console.log('[FLA] Rendu du tableau avec', data.length, 'tableaux');
            const tbody = document.getElementById('disjoncteurs-table');
            tbody.innerHTML = '';
            data.forEach(tableau => {
                const ikHTA = calculateIkHTA(tableau);
                const icnHTA = tableau.isHTA && tableau.htaData ? normalizeIcn(tableau.htaData.icn) : null;
                const statusHTA = tableau.isHTA && ikHTA != null && icnHTA ? (ikHTA <= icnHTA ? 'OK' : 'KO') : 'N/A';

                if (tableau.isHTA) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="p-2">${tableau.id} (HTA)</td>
                        <td class="p-2">-</td>
                        <td class="p-2">-</td>
                        <td class="p-2">-</td>
                        <td class="p-2">${tableau.htaData?.voltage ? tableau.htaData.voltage + ' kV' : 'N/A'}</td>
                        <td class="p-2">${icnHTA ? icnHTA.toFixed(2) : 'N/A'}</td>
                        <td class="p-2">${ikHTA ? ikHTA.toFixed(2) : 'N/A'}${ikHTA > 50 ? ' <span class="text-yellow-400">(Aberrant)</span>' : ''}</td>
                        <td class="p-2">-</td>
                        <td class="p-2 ${statusHTA === 'OK' ? 'text-green-600' : statusHTA === 'KO' ? 'text-red-600' : ''}">${statusHTA}</td>
                        <td class="p-2">
                            <a href="edit.html?id=${encodeURIComponent(tableau.id)}" class="bg-yellow-600 text-white px-2 py-1 rounded hover:bg-yellow-700 touch-friendly"><i class="fas fa-edit"></i></a>
                        </td>
                    `;
                    tbody.appendChild(row);
                }

                tableau.disjoncteurs.forEach(d => {
                    const row = document.createElement('tr');
                    const ik = d.ik ? (d.ik >= 1 ? d.ik.toFixed(2) : d.ik.toFixed(3)) : 'N/A';
                    const icn = d.icn ? parseFloat(d.icn).toFixed(2) : 'N/A';
                    const status = d.ik != null && d.icn ? (d.ik <= d.icn ? 'OK' : 'KO') : 'Incomplet';
                    row.innerHTML = `
                        <td class="p-2">${tableau.id}</td>
                        <td class="p-2">${d.id}</td>
                        <td class="p-2">${d.marque || 'N/A'}</td>
                        <td class="p-2">${d.ref || 'N/A'}</td>
                        <td class="p-2">${d.ue || 'N/A'}</td>
                        <td class="p-2">${icn}</td>
                        <td class="p-2">${ik}${ik !== 'N/A' && d.ik > 50 ? ' <span class="text-yellow-400">(Aberrant)</span>' : ''}</td>
                        <td class="p-2">-</td>
                        <td class="p-2 ${status === 'OK' ? 'text-green-600' : status === 'KO' ? 'text-red-600' : ''}">${status}</td>
                        <td class="p-2">
                            <button class="action-btn bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700 touch-friendly" data-tableau-id="${encodeURIComponent(tableau.id)}" data-disjoncteur-id="${encodeURIComponent(d.id)}"><i class="fas fa-chart-line"></i></button>
                            <a href="edit.html?id=${encodeURIComponent(tableau.id)}" class="bg-yellow-600 text-white px-2 py-1 rounded hover:bg-yellow-700 touch-friendly"><i class="fas fa-edit"></i></a>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            });
            console.log('[FLA] Tableau rendu avec', tbody.children.length, 'lignes');
        }

        function handleActionClick(event) {
            const btn = event.target.closest('.action-btn');
            if (!btn) {
                console.log('[FLA] Clic ignoré: pas un bouton .action-btn');
                return;
            }

            event.preventDefault();
            event.stopPropagation();
            console.log('[FLA] Clic détecté sur bouton d\'action');

            const tableauId = decodeURIComponent(btn.getAttribute('data-tableau-id'));
            const disjoncteurId = decodeURIComponent(btn.getAttribute('data-disjoncteur-id'));
            console.log('[FLA] Données du bouton:', { tableauId, disjoncteurId });

            if (!tableauId || !disjoncteurId) {
                console.error('[FLA] Attributs data- manquants ou invalides:', { tableauId, disjoncteurId });
                showPopup('Erreur: Identifiants de tableau ou disjoncteur manquants.', '', () => {});
                return;
            }

            const now = Date.now();
            if (now - lastClickTime < 1000) {
                console.log('[FLA] Clic ignoré (trop rapide)', { timeSinceLast: now - lastClickTime });
                return;
            }
            lastClickTime = now;

            try {
                const tableau = tableauxData.find(t => t.id === tableauId);
                const disjoncteur = tableau?.disjoncteurs.find(d => d.id === disjoncteurId);
                if (!tableau || !disjoncteur) {
                    console.error('[FLA] Tableau ou disjoncteur non trouvé:', { tableauId, disjoncteurId });
                    showPopup('Erreur: Tableau ou disjoncteur non trouvé.', '', () => {});
                    return;
                }
                console.log('[FLA] Ouverture panneau pour:', { tableauId, disjoncteurId });
                openPanel(tableauId, disjoncteurId);
            } catch (error) {
                console.error('[FLA] Erreur dans handleActionClick:', error.message);
                showPopup('Erreur lors du traitement de l\'action: ' + error.message, '', () => {});
            }
        }

        function openPanel(tableauId, disjoncteurId) {
            console.log('[FLA] Ouverture panneau pour:', tableauId, disjoncteurId);
            try {
                const tableau = tableauxData.find(t => t.id === tableauId);
                const disjoncteur = tableau.disjoncteurs.find(d => d.id === disjoncteurId);
                const panel = document.getElementById('details-panel');
                const content = document.getElementById('panel-content');
                const errorDiv = document.getElementById('panel-error');
                const successDiv = document.getElementById('panel-success');
                const impedanceInfo = document.getElementById('panel-impedance-info');

                if (!tableau || !disjoncteur) {
                    console.error('[FLA] Tableau ou disjoncteur non trouvé:', tableauId, disjoncteurId);
                    showPopup('Erreur: Tableau ou disjoncteur non trouvé.', '', () => {});
                    return;
                }

                const ik = disjoncteur.ik ? (disjoncteur.ik >= 1 ? disjoncteur.ik.toFixed(2) : disjoncteur.ik.toFixed(3)) : 'N/A';
                const icn = disjoncteur.icn ? parseFloat(disjoncteur.icn).toFixed(2) : 'N/A';
                const status = disjoncteur.ik != null && disjoncteur.icn ? (disjoncteur.ik <= disjoncteur.icn ? 'OK' : 'KO') : 'Incomplet';
                const isPrincipal = disjoncteur.isPrincipal || false;
                const hasSubTableau = disjoncteur.linkedTableauIds?.length > 0;
                const ikHTA = calculateIkHTA(tableau);
                const icnHTA = tableau.isHTA && tableau.htaData ? normalizeIcn(tableau.htaData.icn) : null;
                const statusHTA = tableau.isHTA && ikHTA != null && icnHTA ? (ikHTA <= icnHTA ? 'OK' : 'KO') : 'N/A';

                let impedanceDisplay = 'N/A';
                if (disjoncteur.cableLength && disjoncteur.section && !disjoncteur.impedance) {
                    const rho = 0.0175;
                    const L = parseFloat(disjoncteur.cableLength);
                    const sectionMatch = disjoncteur.section.match(/[\d.]+/);
                    const S = sectionMatch ? parseFloat(sectionMatch[0]) : 2.5;
                    const z = (rho * L * 2) / S;
                    impedanceDisplay = z.toFixed(4) + ' Ω';
                } else if (disjoncteur.impedance) {
                    impedanceDisplay = parseFloat(disjoncteur.impedance).toFixed(4) + ' Ω';
                }

                let htaInfo = '';
                if (tableau.isHTA && tableau.htaData) {
                    htaInfo = `
                        <div class="mt-4">
                            <h3 class="text-lg font-semibold mb-2">Cellule HTA</h3>
                            <p class="text-sm sm:text-base"><strong>Puissance transformateur :</strong> ${tableau.htaData.transformerPower || 'N/A'} kVA</p>
                            <p class="text-sm sm:text-base"><strong>Tension HTA :</strong> ${tableau.htaData.voltage || 'N/A'} kV</p>
                            <p class="text-sm sm:text-base"><strong>Ik HTA :</strong> ${ikHTA ? ikHTA.toFixed(2) : 'N/A'} kA${ikHTA > 50 ? ' (Aberrant)' : ''}</p>
                            <p class="text-sm sm:text-base"><strong>Icn HTA :</strong> ${icnHTA ? icnHTA.toFixed(2) : 'N/A'} kA</p>
                            <p class="text-sm sm:text-base"><strong>Statut HTA :</strong> <span class="${statusHTA === 'OK' ? 'text-green-600' : statusHTA === 'KO' ? 'text-red-600' : ''}">${statusHTA}</span></p>
                            <p class="text-sm sm:text-base"><strong>Explication HTA :</strong> ${statusHTA === 'OK' ? 'La cellule HTA peut supporter le courant de court-circuit.' : statusHTA === 'KO' ? 'Ik dépasse Icn de la cellule HTA. Vérifiez les réglages ou remplacez la cellule.' : 'Complétez les paramètres HTA dans Modifier.'}</p>
                        </div>
                    `;
                }

                content.innerHTML = `
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <div>
                            <p class="text-sm sm:text-base"><strong>ID :</strong> ${disjoncteur.id}</p>
                            <p class="text-sm sm:text-base"><strong>Tableau :</strong> ${tableau.id}${tableau.isHTA ? ' (HTA)' : ''}</p>
                            <p class="text-sm sm:text-base"><strong>Marque :</strong> ${disjoncteur.marque || 'N/A'}</p>
                            <p class="text-sm sm:text-base"><strong>Référence :</strong> ${disjoncteur.ref || 'N/A'}</p>
                            <p class="text-sm sm:text-base"><strong>Principal :</strong> ${isPrincipal ? 'Oui' : 'Non'}</p>
                            <p class="text-sm sm:text-base"><strong>Sous-tableaux :</strong> ${disjoncteur.linkedTableauIds?.length > 0 ? disjoncteur.linkedTableauIds.join(', ') : 'Aucun'}</p>
                        </div>
                        <div>
                            <p class="text-sm sm:text-base"><strong>Ik calculé :</strong> ${ik} kA${ik !== 'N/A' && disjoncteur.ik > 50 ? ' (Aberrant)' : ''}</p>
                            <p class="text-sm sm:text-base"><strong>Icn :</strong> ${icn} kA</p>
                            <p class="text-sm sm:text-base"><strong>Statut :</strong> <span class="${status === 'OK' ? 'text-green-600' : status === 'KO' ? 'text-red-600' : ''}">${status}</span></p>
                            <p class="text-sm sm:text-base"><strong>Explication :</strong> ${status === 'OK' ? 'Le disjoncteur peut supporter le courant de court-circuit.' : status === 'KO' ? 'Ik dépasse Icn. Remplacez le disjoncteur ou ajustez l’installation.' : 'Complétez Ue, section, et longueur pour calculer Ik.'}</p>
                        </div>
                    </div>
                    ${htaInfo}
                    <hr class="my-4">
                    <h3 class="text-lg font-semibold mb-2">Compléter les données BT</h3>
                    <p class="mb-2 text-sm sm:text-base">Saisissez les données ci-dessous pour calculer Ik. Les paramètres HTA doivent être modifiés via <a href="edit.html?id=${encodeURIComponent(tableau.id)}" class="text-blue-400 underline">Modifier</a>.</p>
                    <div class="space-y-4">
                        <div>
                            <label for="ue" class="block text-sm font-medium mb-1">Tension nominale Ue (V) <span class="text-red-600">*</span></label>
                            <input id="ue" type="text" value="${disjoncteur.ue || '400 V'}" class="bg-gray-100 text-gray-900 p-2 rounded w-full border border-gray-300 focus:ring-2 focus:ring-blue-500 text-sm sm:text-base" placeholder="Ex. 400 V" required>
                        </div>
                        <div>
                            <label for="section" class="block text-sm font-medium mb-1">Section de câble (mm²) <span class="text-red-600">*</span></label>
                            <input id="section" type="text" value="${disjoncteur.section || '2.5 mm²'}" class="bg-gray-100 text-gray-900 p-2 rounded w-full border border-gray-300 focus:ring-2 focus:ring-blue-500 text-sm sm:text-base" placeholder="Ex. 2.5 mm²" required>
                        </div>
                        <div>
                            <label for="cable-length" class="block text-sm font-medium mb-1">Longueur de câble (m) ${isPrincipal ? '(Min. 5 m)' : hasSubTableau ? '<span class="text-red-600">* (Min. 20 m)</span>' : ''}</label>
                            <input id="cable-length" type="number" value="${disjoncteur.cableLength || (isPrincipal ? 5 : 20)}" class="bg-gray-100 text-gray-900 p-2 rounded w-full border border-gray-300 focus:ring-2 focus:ring-blue-500 text-sm sm:text-base" placeholder="Ex. ${isPrincipal ? 5 : 20}" ${hasSubTableau && !isPrincipal ? 'required' : ''}>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Mode d'impédance</label>
                            <div class="radio-group space-y-2">
                                <label><input type="radio" name="impedance-mode" value="auto" ${!disjoncteur.impedance ? 'checked' : ''} class="mr-1"> Calcul automatique (Z = ρ × L / S)</label>
                                <label><input type="radio" name="impedance-mode" value="manual" ${disjoncteur.impedance ? 'checked' : ''} class="mr-1"> Entrée manuelle</label>
                            </div>
                        </div>
                        <div>
                            <label for="impedance" class="block text-sm font-medium mb-1">Impédance (Ω) ${disjoncteur.impedance ? '' : '(Désactivé en mode automatique)'}</label>
                            <input id="impedance" type="number" step="0.01" value="${disjoncteur.impedance || ''}" class="bg-gray-100 text-gray-900 p-2 rounded w-full border border-gray-300 focus:ring-2 focus:ring-blue-500 text-sm sm:text-base" placeholder="Ex. 0.35" ${!disjoncteur.impedance ? 'disabled' : ''}>
                        </div>
                    </div>
                    <p class="text-sm text-gray-400 mt-2">* Champs obligatoires pour calculer Ik. ρ = 0.0175 Ω·mm²/m (cuivre).</p>
                    <div class="mt-4">
                        <h3 class="text-lg font-semibold mb-2">Données actuelles</h3>
                        <table class="w-full border-collapse text-sm sm:text-base">
                            <tr><th class="border p-2">Champ</th><th class="border p-2">Valeur</th></tr>
                            <tr><td class="border p-2">Tension (Ue)</td><td class="border p-2">${disjoncteur.ue || 'N/A'}</td></tr>
                            <tr><td class="border p-2">Section</td><td class="border p-2">${disjoncteur.section || 'N/A'}</td></tr>
                            <tr><td class="border p-2">Longueur</td><td class="border p-2">${disjoncteur.cableLength || 'N/A'} m</td></tr>
                            <tr><td class="border p-2">Impédance</td><td class="border p-2">${impedanceDisplay}</td></tr>
                        </table>
                    </div>
                `;

                console.log('[FLA] Panneau rendu pour:', tableauId, disjoncteurId);
                errorDiv.classList.add('hidden');
                successDiv.classList.add('hidden');
                impedanceInfo.classList.remove('hidden');
                impedanceInfo.textContent = `Impédance actuelle : ${impedanceDisplay}`;
                panel.classList.remove('hidden');
                gsap.from('#details-panel', { opacity: 0, x: 100, duration: 0.5, ease: 'power2.out' });

                renderDisjoncteurChart(disjoncteur, tableauId, tableau);

                const impedanceInput = document.getElementById('impedance');
                const radioButtons = document.querySelectorAll('input[name="impedance-mode"]');
                radioButtons.forEach(radio => {
                    radio.addEventListener('change', () => {
                        impedanceInput.disabled = radio.value === 'auto';
                        impedanceInput.value = radio.value === 'auto' ? '' : impedanceInput.value || '0.35';
                    });
                });

                const closePanelBtn = document.getElementById('close-panel');
                closePanelBtn.onclick = () => {
                    console.log('[FLA] Fermeture panneau');
                    gsap.to('#details-panel', {
                        opacity: 0,
                        x: 100,
                        duration: 0.5,
                        ease: 'power2.in',
                        onComplete: () => panel.classList.add('hidden')
                    });
                };

                document.getElementById('update-cable-data').onclick = async () => {
                    console.log('[FLA] Bouton Mettre à jour cliqué');
                    const ue = document.getElementById('ue').value.trim();
                    const section = document.getElementById('section').value.trim();
                    const cableLength = document.getElementById('cable-length').value;
                    const impedanceMode = document.querySelector('input[name="impedance-mode"]:checked').value;
                    const impedance = impedanceMode === 'manual' ? document.getElementById('impedance').value : null;

                    console.log('[FLA] Données saisies:', { ue, section, cableLength, impedanceMode, impedance });

                    if (!ue || !normalizeVoltage(ue)) {
                        errorDiv.classList.remove('hidden');
                        errorDiv.textContent = 'La tension Ue doit être une valeur numérique positive (ex. 400 V).';
                        successDiv.classList.add('hidden');
                        console.log('[FLA] Erreur: Ue invalide');
                        return;
                    }
                    if (!section || !normalizeSection(section)) {
                        errorDiv.classList.remove('hidden');
                        errorDiv.textContent = 'La section de câble doit être une valeur numérique positive (ex. 2.5 mm²).';
                        successDiv.classList.add('hidden');
                        console.log('[FLA] Erreur: Section invalide');
                        return;
                    }
                    if (hasSubTableau && !cableLength && !isPrincipal) {
                        errorDiv.classList.remove('hidden');
                        errorDiv.textContent = 'La longueur de câble est obligatoire pour les sous-tableaux.';
                        successDiv.classList.add('hidden');
                        console.log('[FLA] Erreur: Longueur de câble manquante pour sous-tableau');
                        return;
                    }
                    if (cableLength && parseFloat(cableLength) < (isPrincipal ? 5 : 20)) {
                        errorDiv.classList.remove('hidden');
                        errorDiv.textContent = `La longueur de câble doit être d’au moins ${isPrincipal ? 5 : 20} m.`;
                        successDiv.classList.add('hidden');
                        console.log('[FLA] Erreur: Longueur de câble trop courte');
                        return;
                    }
                    if (impedanceMode === 'manual' && impedance && parseFloat(impedance) <= 0) {
                        errorDiv.classList.remove('hidden');
                        errorDiv.textContent = 'L’impédance manuelle doit être positive.';
                        successDiv.classList.add('hidden');
                        console.log('[FLA] Erreur: Impédance manuelle invalide');
                        return;
                    }

                    try {
                        console.log('[FLA] Envoi mise à jour:', { tableauId, disjoncteurId, ue, section, cableLength, impedanceMode, impedance });
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 5000);
                        const response = await fetch('/api/fault-level/update', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                tableauId,
                                disjoncteurId,
                                ue: ue || null,
                                section: section || null,
                                cableLength: cableLength ? parseFloat(cableLength) : isPrincipal ? 5 : 20,
                                impedance: impedance ? parseFloat(impedance) : null
                            }),
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);
                        const result = await response.json();
                        console.log('[FLA] Réponse serveur:', result);
                        if (response.ok && result.success) {
                            successDiv.classList.remove('hidden');
                            successDiv.textContent = 'Données mises à jour avec succès !';
                            errorDiv.classList.add('hidden');
                            await loadTableaux();
                            gsap.to('#details-panel', {
                                opacity: 0,
                                x: 100,
                                duration: 0.5,
                                ease: 'power2.in',
                                onComplete: () => panel.classList.add('hidden')
                            });
                            console.log('[FLA] Mise à jour réussie, panneau fermé');
                        } else {
                            errorDiv.classList.remove('hidden');
                            errorDiv.textContent = result.error || 'Erreur lors de la mise à jour des données.';
                            successDiv.classList.add('hidden');
                            console.error('[FLA] Erreur mise à jour:', result.error);
                        }
                    } catch (error) {
                        console.error('[FLA] Erreur réseau:', error);
                        errorDiv.classList.remove('hidden');
                        errorDiv.textContent = 'Erreur réseau lors de la mise à jour. Vérifiez votre connexion.';
                        successDiv.classList.add('hidden');
                    }
                };
            } catch (error) {
                console.error('[FLA] Erreur dans openPanel:', error);
                showPopup('Erreur lors de l’ouverture du panneau: ' + error.message, '', () => {});
            }
        }

        function renderDisjoncteurChart(disjoncteur, tableauId, tableau) {
            console.log('[FLA] Rendu du graphique pour disjoncteur:', disjoncteur.id);
            const canvas = document.getElementById('disjoncteur-chart');
            if (!canvas) {
                console.error('[FLA] Canvas disjoncteur-chart non trouvé');
                showPopup('Erreur: Élément de graphique non trouvé.', '', () => {});
                return;
            }

            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error('[FLA] Contexte 2D non disponible');
                showPopup('Erreur: Contexte de rendu graphique non disponible.', '', () => {});
                return;
            }

            if (panelChartInstance) {
                panelChartInstance.destroy();
                console.log('[FLA] Ancien graphique disjoncteur détruit');
            }

            const ik = disjoncteur.ik ? Math.min(disjoncteur.ik, 50) : 0;
            const icn = disjoncteur.icn ? parseFloat(disjoncteur.icn) : 0;
            const ikHTA = calculateIkHTA(tableau);
            const icnHTA = tableau.isHTA && tableau.htaData ? normalizeIcn(tableau.htaData.icn) : null;
            const labels = ['Ik (BT)', 'Icn (BT)'];
            const data = [ik, icn];
            const backgroundColors = [ik > icn ? '#EF4444' : '#10B981', '#FF4500'];

            if (tableau.isHTA && ikHTA != null && icnHTA != null) {
                labels.push('Ik (HTA)', 'Icn (HTA)');
                data.push(Math.min(ikHTA, 50), icnHTA);
                backgroundColors.push(ikHTA > icnHTA ? '#EF4444' : '#10B981', '#B91C1C');
            }

            try {
                panelChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [{
                            label: `Disjoncteur ${disjoncteur.id} (${tableauId})`,
                            data,
                            backgroundColor: backgroundColors
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: Math.max(...data, 50),
                                title: { display: true, text: 'kA', color: '#ffffff', font: { size: 12 } },
                                grid: { color: '#4B5563' },
                                ticks: { color: '#ffffff', font: { size: 12 } }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: '#ffffff', font: { size: 12 } }
                            }
                        },
                        plugins: {
                            legend: { display: true, position: 'top', labels: { color: '#ffffff', font: { size: 12 } } },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const label = context.dataset.label || '';
                                        const value = context.parsed.y;
                                        const index = context.dataIndex;
                                        const type = labels[index].includes('HTA') ? 'HTA' : 'BT';
                                        return `${labels[index]}: ${value} kA ${labels[index] === 'Ik (BT)' && disjoncteur.ik > 50 ? '(Aberrant)' : labels[index] === 'Ik (BT)' && ik > icn ? '(Risque !)' : labels[index] === 'Ik (HTA)' && ikHTA > 50 ? '(Aberrant)' : labels[index] === 'Ik (HTA)' && ikHTA > icnHTA ? '(Risque !)' : ''}`;
                                    }
                                }
                            }
                        }
                    }
                });
                console.log('[FLA] Graphique disjoncteur rendu avec succès');
                gsap.from('#disjoncteur-chart', { opacity: 0, y: 20, duration: 0.5, ease: 'power2.out' });
            } catch (error) {
                console.error('[FLA] Erreur rendu graphique disjoncteur:', error);
                showPopup('Erreur lors du rendu du graphique: ' + error.message, '', () => {});
            }
        }

        function renderBubbleChart(data) {
            console.log('[FLA] Rendu du graphique à bulles');
            const canvas = document.getElementById('bubble-chart');
            if (!canvas) {
                console.error('[FLA] Canvas bubble-chart non trouvé');
                showPopup('Erreur: Élément de graphique à bulles non trouvé.', '', () => {});
                return;
            }

            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error('[FLA] Contexte 2D non disponible pour bubble-chart');
                showPopup('Erreur: Contexte de rendu graphique non disponible.', '', () => {});
                return;
            }

            if (bubbleChartInstance) {
                bubbleChartInstance.destroy();
                console.log('[FLA] Ancien graphique à bulles détruit');
            }

            const datasets = [];
            let maxIk = 0;
            let maxIcn = 0;

            data.forEach(tableau => {
                tableau.disjoncteurs.forEach(disjoncteur => {
                    const ik = disjoncteur.ik ? parseFloat(disjoncteur.ik) : null;
                    const icn = disjoncteur.icn ? parseFloat(disjoncteur.icn) : null;
                    if (ik != null && icn != null && ik <= 50) {
                        datasets.push({
                            label: `${tableau.id} - ${disjoncteur.id}`,
                            data: [{ x: ik, y: icn, r: 8 }],
                            backgroundColor: ik > icn ? 'rgba(220, 38, 38, 0.7)' : 'rgba(34, 197, 94, 0.7)',
                            borderColor: ik > icn ? '#dc2626' : '#22c55e',
                            borderWidth: 1
                        });
                        maxIk = Math.max(maxIk, ik);
                        maxIcn = Math.max(maxIcn, icn);
                    }
                });
            });

            if (datasets.length === 0) {
                console.log('[FLA] Aucune donnée valide pour le graphique à bulles');
                const parent = canvas.parentElement;
                const existingError = parent.querySelector('.error-message');
                if (!existingError) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'text-red-600 mt-2 error-message';
                    errorDiv.textContent = 'Aucune donnée valide pour afficher le graphique. Veuillez compléter les données des disjoncteurs.';
                    parent.appendChild(errorDiv);
                }
                return;
            }

            const existingError = canvas.parentElement.querySelector('.error-message');
            if (existingError) existingError.remove();

            const diagonalData = {
                label: 'Icn = Ik',
                data: [{ x: 0, y: 0 }, { x: maxIk * 1.1, y: maxIcn * 1.1 }],
                type: 'line',
                borderColor: '#4B5563',
                borderWidth: 2,
                fill: false,
                pointRadius: 0
            };

            try {
                bubbleChartInstance = new Chart(ctx, {
                    type: 'bubble',
                    data: { datasets: [...datasets, diagonalData] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => context.dataset.label
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Ik (kA)', color: '#ffffff', font: { size: 12 } },
                                grid: { color: '#4B5563' },
                                ticks: { color: '#ffffff', font: { size: 12 } },
                                min: 0,
                                max: maxIk * 1.1 || 50
                            },
                            y: {
                                title: { display: true, text: 'Icn (kA)', color: '#ffffff', font: { size: 12 } },
                                grid: { color: '#4B5563' },
                                ticks: { color: '#ffffff', font: { size: 12 } },
                                min: 0,
                                max: maxIcn * 1.1 || 50
                            }
                        }
                    }
                });
                console.log('[FLA] Graphique à bulles rendu avec succès');
                gsap.from('#bubble-chart', { opacity: 0, y: 20, duration: 0.5, ease: 'power2.out' });
            } catch (error) {
                console.error('[FLA] Erreur rendu graphique à bulles:', error);
                showPopup('Erreur lors du rendu du graphique à bulles: ' + error.message, '', () => {});
            }
        }

        function renderNetwork(data) {
            console.log('[FLA] Rendu du schéma électrique');
            const container = document.getElementById('network-schema');
            if (!container) {
                console.error('[FLA] Conteneur network-schema non trouvé');
                showPopup('Erreur: Conteneur de schéma non trouvé.', '', () => {});
                return;
            }

            if (networkInstance) {
                networkInstance.destroy();
                console.log('[FLA] Ancien réseau détruit');
            }

            const nodes = [];
            const edges = [];
            const nodeIds = new Set();
            const tableauLevels = new Map();
            const visited = new Set();

            function assignTableauLevels(tableauId, level = 0) {
                if (visited.has(tableauId)) {
                    console.warn(`[FLA] Boucle détectée pour le tableau ${tableauId}`);
                    return;
                }
                visited.add(tableauId);

                if (!tableauLevels.has(tableauId) || tableauLevels.get(tableauId) < level) {
                    tableauLevels.set(tableauId, level);
                }

                const tableau = data.find(t => t.id === tableauId);
                if (!tableau) return;

                tableau.disjoncteurs.forEach(disjoncteur => {
                    disjoncteur.linkedTableauIds?.forEach(linkedId => {
                        assignTableauLevels(linkedId, level + 3);
                    });
                });
            }

            data.forEach(tableau => assignTableauLevels(tableau.id));

            data.forEach(tableau => {
                const tableauId = `tableau-${tableau.id}`;
                if (!nodeIds.has(tableauId)) {
                    const level = tableauLevels.get(tableau.id) || 0;
                    const ikHTA = calculateIkHTA(tableau);
                    const icnHTA = tableau.isHTA && tableau.htaData ? normalizeIcn(tableau.htaData.icn) : null;
                    const statusHTA = tableau.isHTA && ikHTA != null && icnHTA ? (ikHTA <= icnHTA ? 'OK' : 'KO') : 'N/A';
                    let tooltip = `Tableau: ${tableau.id}\nBâtiment: ${tableau.building}\nHTA: ${tableau.isHTA ? 'Oui' : 'Non'}\nPrincipal: ${tableau.issitemain ? 'Oui' : 'Non'}`;
                    if (tableau.isHTA && tableau.htaData) {
                        tooltip += `\nPuissance transfo: ${tableau.htaData.transformerPower || 'N/A'} kVA\nTension HTA: ${tableau.htaData.voltage || 'N/A'} kV\nIk HTA: ${ikHTA ? ikHTA.toFixed(2) : 'N/A'} kA\nIcn HTA: ${icnHTA ? icnHTA.toFixed(2) : 'N/A'} kA\nStatut HTA: ${statusHTA}`;
                    }
                    nodes.push({
                        id: tableauId,
                        label: `${tableau.id}${tableau.isHTA ? ' (HTA)' : ''}`,
                        shape: 'box',
                        color: tableau.isHTA ? { background: '#fee2e2', border: '#dc2626' } : { background: '#ffffff', border: '#000000' },
                        level,
                        title: tooltip
                    });
                    nodeIds.add(tableauId);
                }
            });

            data.forEach(tableau => {
                const tableauId = `tableau-${tableau.id}`;
                const baseLevel = tableauLevels.get(tableau.id) || 0;
                const principaux = tableau.disjoncteurs.filter(d => d.isPrincipal);
                const nonPrincipaux = tableau.disjoncteurs.filter(d => !d.isPrincipal);

                principaux.forEach(disjoncteur => {
                    const disjoncteurId = `disjoncteur-${tableau.id}-${disjoncteur.id}`;
                    if (!nodeIds.has(disjoncteurId)) {
                        const status = disjoncteur.ik != null && disjoncteur.icn ? (disjoncteur.ik <= disjoncteur.icn ? 'OK' : 'KO') : 'Incomplet';
                        nodes.push({
                            id: disjoncteurId,
                            label: disjoncteur.id,
                            shape: 'box',
                            color: { background: '#d4edda', border: '#22c55e' },
                            level: baseLevel + 1,
                            title: `Disjoncteur: ${disjoncteur.id}\nTableau: ${tableau.id}\nMarque: ${disjoncteur.marque || 'N/A'}\nRéférence: ${disjoncteur.ref || 'N/A'}\nIk: ${disjoncteur.ik ? disjoncteur.ik.toFixed(2) : 'N/A'} kA\nIcn: ${disjoncteur.icn ? disjoncteur.icn.toFixed(2) : 'N/A'} kA\nStatut: ${status}`
                        });
                        nodeIds.add(disjoncteurId);
                        edges.push({ from: tableauId, to: disjoncteurId });
                    }
                });

                nonPrincipaux.forEach(disjoncteur => {
                    const disjoncteurId = `disjoncteur-${tableau.id}-${disjoncteur.id}`;
                    if (!nodeIds.has(disjoncteurId)) {
                        let color;
                        const status = disjoncteur.ik != null && disjoncteur.icn ? (disjoncteur.ik <= disjoncteur.icn ? 'OK' : 'KO') : 'Incomplet';
                        if (disjoncteur.ik != null && disjoncteur.icn && disjoncteur.ik > disjoncteur.icn) {
                            color = { background: '#fee2e2', border: '#dc2626' };
                        } else if (!disjoncteur.ik || !disjoncteur.icn) {
                            color = { background: '#D1D5DB', border: '#6B7280' };
                        } else {
                            color = { background: '#ffffff', border: '#000000' };
                        }
                        nodes.push({
                            id: disjoncteurId,
                            label: disjoncteur.id,
                            shape: 'box',
                            color,
                            level: baseLevel + 2,
                            title: `Disjoncteur: ${disjoncteur.id}\nTableau: ${tableau.id}\nMarque: ${disjoncteur.marque || 'N/A'}\nRéférence: ${disjoncteur.ref || 'N/A'}\nIk: ${disjoncteur.ik ? disjoncteur.ik.toFixed(2) : 'N/A'} kA\nIcn: ${disjoncteur.icn ? disjoncteur.icn.toFixed(2) : 'N/A'} kA\nStatut: ${status}`
                        });
                        nodeIds.add(disjoncteurId);

                        if (principaux.length > 0) {
                            const principalId = `disjoncteur-${tableau.id}-${principaux[0].id}`;
                            edges.push({ from: principalId, to: disjoncteurId });
                        } else {
                            edges.push({ from: tableauId, to: disjoncteurId });
                        }
                    }
                });
            });

            data.forEach(tableau => {
                tableau.disjoncteurs.forEach(disjoncteur => {
                    disjoncteur.linkedTableauIds?.forEach(linkedId => {
                        const disjoncteurId = `disjoncteur-${tableau.id}-${disjoncteur.id}`;
                        const toId = `tableau-${linkedId}`;
                        if (nodeIds.has(toId)) {
                            edges.push({ from: disjoncteurId, to: toId, dashes: true });
                        } else {
                            console.warn(`[FLA] Sous-tableau ${linkedId} non trouvé pour ${disjoncteurId}`);
                        }
                    });
                });
            });

            const noLinkedTableauAlert = document.getElementById('no-linked-tableau-alert');
            const hasLinks = edges.some(e => e.dashes);
            noLinkedTableauAlert.classList.toggle('hidden', hasLinks);
            console.log('[FLA] Liaisons détectées:', hasLinks ? edges.filter(e => e.dashes).length : 0);

            if (nodes.length === 0) {
                console.log('[FLA] Aucune donnée valide pour le schéma électrique');
                const existingError = container.querySelector('.error-message');
                if (!existingError) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'text-red-600 mt-2 error-message';
                    errorDiv.textContent = 'Aucune donnée valide pour afficher le schéma. Veuillez vérifier les données des tableaux.';
                    container.appendChild(errorDiv);
                }
                return;
            }

            const existingError = container.querySelector('.error-message');
            if (existingError) existingError.remove();

            try {
                const visData = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
                const options = {
                    nodes: {
                        font: { size: 12, color: '#000000' },
                        borderWidth: 2,
                        widthConstraint: { minimum: 80, maximum: 150 },
                        shapeProperties: { borderRadius: 6 }
                    },
                    edges: {
                        width: 2,
                        color: '#000000',
                        smooth: { type: 'curvedCW', roundness: 0.2 }
                    },
                    physics: {
                        enabled: true,
                        hierarchicalRepulsion: {
                            centralGravity: 0.0,
                            springLength: 100,
                            springConstant: 0.01,
                            nodeDistance: 120,
                            damping: 0.09
                        },
                        solver: 'hierarchicalRepulsion'
                    },
                    layout: {
                        hierarchical: {
                            enabled: true,
                            levelSeparation: 250,
                            nodeSpacing: 120,
                            treeSpacing: 200,
                            direction: 'UD',
                            sortMethod: 'directed',
                            shakeTowards: 'roots'
                        }
                    },
                    interaction: {
                        hover: true,
                        zoomView: true,
                        dragView: true,
                        navigationButtons: true
                    },
                    manipulation: { enabled: false }
                };
                networkInstance = new vis.Network(container, visData, options);
                console.log('[FLA] Schéma électrique rendu avec succès', { nodes: nodes.length, edges: edges.length, levels: [...tableauLevels.entries()] });
                gsap.from('#network-schema', { opacity: 0, y: 20, duration: 0.5, ease: 'power2.out' });
            } catch (error) {
                console.error('[FLA] Erreur rendu schéma électrique:', error);
                showPopup('Erreur lors du rendu du schéma électrique: ' + error.message, '', () => {});
            }
        }

        function renderData(data) {
            console.log('[FLA] Rendu des données pour', data.length, 'tableaux');
            updateMissingDataAlert(data);
            checkHighIk(data);
            renderTable(data);
            renderBubbleChart(data);
            renderNetwork(data);
        }

        window.onload = () => {
            console.log('[FLA] Initialisation page fault_level_assessment');
            if (window.location.protocol === 'file:') {
                showPopup('Erreur : Veuillez exécuter cette page via un serveur web (ex. http://localhost:3000/fault_level_assessment.html) pour accéder à l\'API.', '', () => {});
                return;
            }
            if (typeof Chart === 'undefined') console.error('[FLA] Chart.js non chargé');
            if (typeof vis === 'undefined') console.error('[FLA] Vis.js non chargé');
            const panel = document.getElementById('details-panel');
            if (panel) {
                panel.classList.add('hidden');
                console.log('[FLA] Panneau caché au chargement');
            }
            document.removeEventListener('click', handleActionClick);
            document.addEventListener('click', handleActionClick);
            console.log('[FLA] Gestionnaire d\'événements attaché au document');
            loadTableaux();
        };
    </script>
</body>
</html>