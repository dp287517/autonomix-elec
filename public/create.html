<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autonomix Elec - Créer un tableau</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-gray-100">
    <nav class="bg-blue-600 p-4">
        <ul class="flex flex-wrap space-x-4 sm:space-x-4 justify-center">
            <li><a href="index.html">Accueil</a></li>
            <li><a href="create.html" class="font-bold">Créer un tableau</a></li>
            <li><a href="view.html">Voir les tableaux</a></li>
            <li><a href="selectivity.html" class="hover:underline">Sélectivité</a></li>
        </ul>
    </nav>

    <div class="container mx-auto p-4 sm:p-6">
        <h1 class="text-2xl sm:text-3xl font-bold text-center mb-6">Créer un nouveau tableau électrique</h1>

        <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-lg sm:text-2xl font-semibold mb-4">Étapes pour créer un tableau</h2>
            <ol class="list-decimal list-inside space-y-2 text-sm sm:text-base">
                <li>Entrez l'identifiant du tableau (ex. 27-9-G).</li>
                <li>Ajoutez des disjoncteurs en :
                    <ul class="list-disc list-inside ml-6">
                        <li>Recherchant via OpenAI (marque et référence).</li>
                        <li>Sélectionnant un disjoncteur existant (marque et référence).</li>
                        <li>Entrant les données manuellement.</li>
                    </ul>
                </li>
                <li>Complétez les champs, en suivant les instructions (ex. ID obligatoire, courbe = B, C ou D).</li>
                <li>Enregistrez le tableau en cliquant sur "Enregistrer".</li>
            </ol>
        </div>

        <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
            <h2 class="text-lg sm:text-xl font-semibold mb-4">Informations du tableau</h2>
            <div class="mb-4">
                <label class="block text-sm font-medium">Identifiant du tableau</label>
                <input id="tableau-id" type="text" class="w-full p-2 border rounded" placeholder="Ex. 27-9-G">
            </div>

            <h2 class="text-lg sm:text-xl font-semibold mb-4">Ajouter un disjoncteur</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium">Marque</label>
                    <input id="disjoncteur-marque" type="text" class="w-full p-2 border rounded" placeholder="Ex. Schneider Electric">
                </div>
                <div>
                    <label class="block text-sm font-medium">Référence</label>
                    <input id="disjoncteur-ref" type="text" class="w-full p-2 border rounded" placeholder="Ex. C60N">
                </div>
            </div>
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 mb-4">
                <button onclick="rechercherDisjoncteur()" class="bg-blue-600 text-white p-2 rounded">Rechercher via OpenAI</button>
                <button onclick="ajouterManuel()" class="bg-gray-600 text-white p-2 rounded">Ajouter manuellement</button>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium">Sélectionner un disjoncteur existant</label>
                <select id="disjoncteur-existant" class="w-full p-2 border rounded">
                    <option value="">-- Choisir un disjoncteur --</option>
                </select>
                <button onclick="ajouterDisjoncteurExistant()" class="bg-green-600 text-white p-2 rounded mt-2">Ajouter</button>
            </div>

            <div id="disjoncteur-form" class="mt-4 hidden">
                <h3 class="text-base sm:text-lg font-semibold mb-2">Caractéristiques du disjoncteur</h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium">ID <span class="text-red-600">*</span></label>
                        <input id="disjoncteur-id" type="text" class="w-full p-1 border rounded" placeholder="Ex. 400Q1 Compresseur">
                        <p class="text-xs text-gray-500">Obligatoire, unique, ex. 400Q1 Compresseur</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Type</label>
                        <input id="disjoncteur-type" type="text" class="w-full p-1 border rounded" placeholder="Ex. disjoncteur">
                        <p class="text-xs text-gray-500">Type d'appareil, ex. disjoncteur</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Pôles</label>
                        <input id="disjoncteur-poles" type="text" class="w-full p-1 border rounded" placeholder="Ex. 2P">
                        <p class="text-xs text-gray-500">Ex. 1P, 2P, 3P ou 4P</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Montage</label>
                        <input id="disjoncteur-montage" type="text" class="w-full p-1 border rounded" placeholder="Ex. rail DIN">
                        <p class="text-xs text-gray-500">Type de montage, ex. rail DIN</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Ue</label>
                        <input id="disjoncteur-ue" type="text" class="w-full p-1 border rounded" placeholder="Ex. 230/400 V AC">
                        <p class="text-xs text-gray-500">Tension nominale, ex. 230/400 V AC</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Ui</label>
                        <input id="disjoncteur-ui" type="text" class="w-full p-1 border rounded" placeholder="Ex. 500 V">
                        <p class="text-xs text-gray-500">Tension d'isolation, ex. 500 V</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Uimp</label>
                        <input id="disjoncteur-uimp" type="text" class="w-full p-1 border rounded" placeholder="Ex. 6 kV">
                        <p class="text-xs text-gray-500">Tension de choc, ex. 6 kV</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Fréquence</label>
                        <input id="disjoncteur-frequence" type="text" class="w-full p-1 border rounded" placeholder="Ex. 50/60 Hz">
                        <p class="text-xs text-gray-500">Ex. 50/60 Hz</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">In</label>
                        <input id="disjoncteur-in" type="text" class="w-full p-1 border rounded" placeholder="Ex. 16 A">
                        <p class="text-xs text-gray-500">Courant nominal, ex. 16 A</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Ir</label>
                        <input id="disjoncteur-ir" type="text" class="w-full p-1 border rounded" placeholder="Ex. 63 A">
                        <p class="text-xs text-gray-500">Courant réglable, ex. 63 A</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Courbe</label>
                        <input id="disjoncteur-courbe" type="text" class="w-full p-1 border rounded" placeholder="Ex. C">
                        <p class="text-xs text-gray-500">Une valeur : B, C ou D</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">TripTime</label>
                        <input id="disjoncteur-triptime" type="text" class="w-full p-1 border rounded" placeholder="Ex. 0.1 s">
                        <p class="text-xs text-gray-500">Temps de déclenchement, ex. 0.1 s</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Icn</label>
                        <input id="disjoncteur-icn" type="text" class="w-full p-1 border rounded" placeholder="Ex. 6 kA">
                        <p class="text-xs text-gray-500">Pouvoir de coupure, ex. 6 kA</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Ics</label>
                        <input id="disjoncteur-ics" type="text" class="w-full p-1 border rounded" placeholder="Ex. 4.5 kA">
                        <p class="text-xs text-gray-500">Pouvoir de coupure de service, ex. 4.5 kA</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">IP</label>
                        <input id="disjoncteur-ip" type="text" class="w-full p-1 border rounded" placeholder="Ex. IP20">
                        <p class="text-xs text-gray-500">Indice de protection, ex. IP20</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Température</label>
                        <input id="disjoncteur-temp" type="text" class="w-full p-1 border rounded" placeholder="Ex. -25°C à +70°C">
                        <p class="text-xs text-gray-500">Plage de température, ex. -25°C à +70°C</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Dimensions</label>
                        <input id="disjoncteur-dimensions" type="text" class="w-full p-1 border rounded" placeholder="Ex. 18 x 85 x 70 mm">
                        <p class="text-xs text-gray-500">L x H x P, ex. 18 x 85 x 70 mm</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Section</label>
                        <input id="disjoncteur-section" type="text" class="w-full p-1 border rounded" placeholder="Ex. 2.5 mm²">
                        <p class="text-xs text-gray-500">Section de câble, ex. 2.5 mm²</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Date de fabrication</label>
                        <input id="disjoncteur-date" type="text" class="w-full p-1 border rounded" placeholder="Ex. 2023-01">
                        <p class="text-xs text-gray-500">Année ou mois/année, ex. 2023-01</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Type de tension</label>
                        <input id="disjoncteur-tension" type="text" class="w-full p-1 border rounded" placeholder="Ex. AC">
                        <p class="text-xs text-gray-500">Ex. AC ou DC</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Sélectivité</label>
                        <input id="disjoncteur-selectivite" type="text" class="w-full p-1 border rounded" placeholder="Ex. sélectif">
                        <p class="text-xs text-gray-500">Type de sélectivité, ex. sélectif</p>
                    </div>
                </div>
                <button onclick="ajouterDisjoncteur()" class="bg-green-600 text-white p-2 rounded mt-4">Ajouter au tableau</button>
            </div>
        </div>

        <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md mt-6">
            <h2 class="text-lg sm:text-xl font-semibold mb-4">Disjoncteurs ajoutés</h2>
            <div class="overflow-x-auto">
                <table id="disjoncteurs-table" class="w-full">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="p-2">ID</th>
                            <th class="p-2">Marque</th>
                            <th class="p-2">Référence</th>
                            <th class="p-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <button onclick="enregistrerTableau()" class="bg-blue-600 text-white p-2 rounded mt-4">Enregistrer le tableau</button>
        </div>
    </div>

    <div id="popup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
            <p id="popup-message" class="mb-4"></p>
            <div id="popup-content" class="mb-4"></div>
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                <button id="popup-confirm" class="bg-green-600 text-white p-2 rounded">Confirmer</button>
                <button id="popup-cancel" class="bg-red-600 text-white p-2 rounded">Annuler</button>
            </div>
        </div>
    </div>

    <script>
        let disjoncteurs = [];
        let disjoncteursExistants = [];

        async function chargerDisjoncteursExistants() {
            console.log('[Create] Chargement disjoncteurs existants');
            try {
                const response = await fetch('/api/disjoncteurs');
                disjoncteursExistants = await response.json();
                console.log('[Create] Disjoncteurs existants reçus:', disjoncteursExistants.length);
                const select = document.getElementById('disjoncteur-existant');
                disjoncteursExistants.forEach(d => {
                    const option = document.createElement('option');
                    option.value = JSON.stringify(d);
                    option.textContent = `${d.marque} ${d.ref}`;
                    select.appendChild(option);
                });
                console.log('[Create] Disjoncteurs existants chargés dans la liste déroulante');
            } catch (error) {
                console.error('[Create] Erreur chargement disjoncteurs existants:', error);
                showPopup('Erreur lors du chargement des disjoncteurs existants: ' + error.message, () => {});
            }
        }

        async function rechercherDisjoncteur() {
            console.log('[Create] Bouton Rechercher via OpenAI cliqué');
            const marque = document.getElementById('disjoncteur-marque').value.trim();
            const ref = document.getElementById('disjoncteur-ref').value.trim();
            if (!marque || !ref) {
                console.log('[Create] Erreur: Marque ou référence vide');
                showPopup('Veuillez entrer la marque et la référence.', () => {});
                return;
            }

            try {
                console.log('[Create] Envoi requête OpenAI pour', { marque, ref });
                const response = await fetch('/api/disjoncteur', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ marque, ref })
                });
                const data = await response.json();
                console.log('[Create] Données OpenAI reçues:', data);
                if (response.ok && data && Object.keys(data).length > 0) {
                    document.getElementById('disjoncteur-form').classList.remove('hidden');
                    document.getElementById('disjoncteur-id').value = '';
                    document.getElementById('disjoncteur-type').value = data.type || '';
                    document.getElementById('disjoncteur-poles').value = data.poles || '';
                    document.getElementById('disjoncteur-montage').value = data.montage || '';
                    document.getElementById('disjoncteur-ue').value = data.ue || '';
                    document.getElementById('disjoncteur-ui').value = data.ui || '';
                    document.getElementById('disjoncteur-uimp').value = data.uimp || '';
                    document.getElementById('disjoncteur-frequence').value = data.frequence || '';
                    document.getElementById('disjoncteur-in').value = data.in || '';
                    document.getElementById('disjoncteur-ir').value = data.ir || '';
                    document.getElementById('disjoncteur-courbe').value = data.courbe || '';
                    document.getElementById('disjoncteur-triptime').value = data.triptime || '';
                    document.getElementById('disjoncteur-icn').value = data.icn || '';
                    document.getElementById('disjoncteur-ics').value = data.ics || '';
                    document.getElementById('disjoncteur-ip').value = data.ip || '';
                    document.getElementById('disjoncteur-temp').value = data.temp || '';
                    document.getElementById('disjoncteur-dimensions').value = data.dimensions || '';
                    document.getElementById('disjoncteur-section').value = data.section || '';
                    document.getElementById('disjoncteur-date').value = data.date || '';
                    document.getElementById('disjoncteur-tension').value = data.tension || '';
                    document.getElementById('disjoncteur-selectivite').value = data.selectivite || '';
                    document.getElementById('disjoncteur-marque').value = marque;
                    document.getElementById('disjoncteur-ref').value = ref;
                    console.log('[Create] Formulaire rempli avec données OpenAI');
                } else {
                    console.log('[Create] Aucune donnée OpenAI reçue');
                    showPopup('Aucune donnée trouvée pour ce disjoncteur. Essayez manuellement ou vérifiez la marque/référence.', () => {});
                }
            } catch (error) {
                console.error('[Create] Erreur recherche OpenAI:', error);
                showPopup('Erreur lors de la recherche OpenAI: ' + error.message, () => {});
            }
        }

        function ajouterManuel() {
            console.log('[Create] Bouton Ajouter manuellement cliqué');
            document.getElementById('disjoncteur-form').classList.remove('hidden');
            document.getElementById('disjoncteur-id').value = '';
            document.getElementById('disjoncteur-type').value = '';
            document.getElementById('disjoncteur-poles').value = '';
            document.getElementById('disjoncteur-montage').value = '';
            document.getElementById('disjoncteur-ue').value = '';
            document.getElementById('disjoncteur-ui').value = '';
            document.getElementById('disjoncteur-uimp').value = '';
            document.getElementById('disjoncteur-frequence').value = '';
            document.getElementById('disjoncteur-in').value = '';
            document.getElementById('disjoncteur-ir').value = '';
            document.getElementById('disjoncteur-courbe').value = '';
            document.getElementById('disjoncteur-triptime').value = '';
            document.getElementById('disjoncteur-icn').value = '';
            document.getElementById('disjoncteur-ics').value = '';
            document.getElementById('disjoncteur-ip').value = '';
            document.getElementById('disjoncteur-temp').value = '';
            document.getElementById('disjoncteur-dimensions').value = '';
            document.getElementById('disjoncteur-section').value = '';
            document.getElementById('disjoncteur-date').value = '';
            document.getElementById('disjoncteur-tension').value = '';
            document.getElementById('disjoncteur-selectivite').value = '';
            document.getElementById('disjoncteur-marque').value = '';
            document.getElementById('disjoncteur-ref').value = '';
            console.log('[Create] Formulaire manuel ouvert');
        }

        async function ajouterDisjoncteurExistant() {
            console.log('[Create] Bouton Ajouter (liste déroulante) cliqué');
            const select = document.getElementById('disjoncteur-existant');
            const selected = select.value;
            if (!selected) {
                console.log('[Create] Erreur: Aucun disjoncteur sélectionné');
                showPopup('Veuillez sélectionner un disjoncteur.', () => {});
                return;
            }
            try {
                const disjoncteurBase = JSON.parse(selected);
                console.log('[Create] Disjoncteur sélectionné:', disjoncteurBase);
                const disjoncteur = { ...disjoncteurBase, id: '', isPrincipal: false, linkedTableauId: '' };
                document.getElementById('disjoncteur-form').classList.remove('hidden');
                document.getElementById('disjoncteur-id').value = '';
                document.getElementById('disjoncteur-marque').value = disjoncteur.marque || '';
                document.getElementById('disjoncteur-ref').value = disjoncteur.ref || '';
                document.getElementById('disjoncteur-type').value = disjoncteur.type || '';
                document.getElementById('disjoncteur-poles').value = disjoncteur.poles || '';
                document.getElementById('disjoncteur-montage').value = disjoncteur.montage || '';
                document.getElementById('disjoncteur-ue').value = disjoncteur.ue || '';
                document.getElementById('disjoncteur-ui').value = disjoncteur.ui || '';
                document.getElementById('disjoncteur-uimp').value = disjoncteur.uimp || '';
                document.getElementById('disjoncteur-frequence').value = disjoncteur.frequence || '';
                document.getElementById('disjoncteur-in').value = disjoncteur.in || '';
                document.getElementById('disjoncteur-ir').value = disjoncteur.ir || '';
                document.getElementById('disjoncteur-courbe').value = disjoncteur.courbe || '';
                document.getElementById('disjoncteur-triptime').value = disjoncteur.triptime || '';
                document.getElementById('disjoncteur-icn').value = disjoncteur.icn || '';
                document.getElementById('disjoncteur-ics').value = disjoncteur.ics || '';
                document.getElementById('disjoncteur-ip').value = disjoncteur.ip || '';
                document.getElementById('disjoncteur-temp').value = disjoncteur.temp || '';
                document.getElementById('disjoncteur-dimensions').value = disjoncteur.dimensions || '';
                document.getElementById('disjoncteur-section').value = disjoncteur.section || '';
                document.getElementById('disjoncteur-date').value = disjoncteur.date || '';
                document.getElementById('disjoncteur-tension').value = disjoncteur.tension || '';
                document.getElementById('disjoncteur-selectivite').value = disjoncteur.selectivite || '';
                console.log('[Create] Formulaire ouvert pour disjoncteur existant');
            } catch (error) {
                console.error('[Create] Erreur parsing disjoncteur:', error);
                showPopup('Erreur lors de la sélection du disjoncteur: ' + error.message, () => {});
            }
        }

        function ajouterDisjoncteur() {
            console.log('[Create] Bouton Ajouter au tableau cliqué');
            const disjoncteur = {
                id: document.getElementById('disjoncteur-id').value.trim(),
                marque: document.getElementById('disjoncteur-marque').value.trim(),
                ref: document.getElementById('disjoncteur-ref').value.trim(),
                type: document.getElementById('disjoncteur-type').value.trim(),
                poles: document.getElementById('disjoncteur-poles').value.trim(),
                montage: document.getElementById('disjoncteur-montage').value.trim(),
                ue: document.getElementById('disjoncteur-ue').value.trim(),
                ui: document.getElementById('disjoncteur-ui').value.trim(),
                uimp: document.getElementById('disjoncteur-uimp').value.trim(),
                frequence: document.getElementById('disjoncteur-frequence').value.trim(),
                in: document.getElementById('disjoncteur-in').value.trim(),
                ir: document.getElementById('disjoncteur-ir').value.trim(),
                courbe: document.getElementById('disjoncteur-courbe').value.trim(),
                triptime: document.getElementById('disjoncteur-triptime').value.trim(),
                icn: document.getElementById('disjoncteur-icn').value.trim(),
                ics: document.getElementById('disjoncteur-ics').value.trim(),
                ip: document.getElementById('disjoncteur-ip').value.trim(),
                temp: document.getElementById('disjoncteur-temp').value.trim(),
                dimensions: document.getElementById('disjoncteur-dimensions').value.trim(),
                section: document.getElementById('disjoncteur-section').value.trim(),
                date: document.getElementById('disjoncteur-date').value.trim(),
                tension: document.getElementById('disjoncteur-tension').value.trim(),
                selectivite: document.getElementById('disjoncteur-selectivite').value.trim(),
                isPrincipal: false,
                linkedTableauId: ''
            };

            console.log('[Create] Disjoncteur à ajouter:', disjoncteur);

            if (!disjoncteur.id) {
                console.log('[Create] Erreur: ID vide');
                showPopup('L\'ID du disjoncteur est obligatoire (ex. 400Q1 Compresseur).', () => {});
                return;
            }
            if (!disjoncteur.marque || !disjoncteur.ref) {
                console.log('[Create] Erreur: Marque ou référence vide');
                showPopup('Veuillez entrer la marque et la référence.', () => {});
                return;
            }
            if (disjoncteur.courbe && !['B', 'C', 'D'].includes(disjoncteur.courbe)) {
                console.log('[Create] Erreur: Courbe invalide', disjoncteur.courbe);
                showPopup('La courbe doit être B, C ou D.', () => {});
                return;
            }
            if (disjoncteur.ir && !/^\d+(\s*A)?$/.test(disjoncteur.ir)) {
                console.log('[Create] Erreur: Ir invalide', disjoncteur.ir);
                showPopup('Ir doit être une valeur numérique, ex. 60 ou 60 A.', () => {});
                return;
            }

            if (disjoncteurs.some(d => d.id === disjoncteur.id)) {
                console.log('[Create] Erreur: ID déjà utilisé', disjoncteur.id);
                showPopup('Cet ID est déjà utilisé dans le tableau. Choisissez un ID unique.', () => {});
                return;
            }

            disjoncteurs.push(disjoncteur);
            console.log('[Create] Disjoncteur ajouté:', disjoncteur.id);
            afficherDisjoncteurs();
            document.getElementById('disjoncteur-form').classList.add('hidden');
            document.getElementById('disjoncteur-marque').value = '';
            document.getElementById('disjoncteur-ref').value = '';
            console.log('[Create] Formulaire réinitialisé');
        }

        function afficherDisjoncteurs() {
            console.log('[Create] Affichage disjoncteurs, total:', disjoncteurs.length);
            const tbody = document.querySelector('#disjoncteurs-table tbody');
            tbody.innerHTML = '';
            disjoncteurs.forEach((d, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="p-2">${d.id}</td>
                    <td class="p-2">${d.marque}</td>
                    <td class="p-2">${d.ref}</td>
                    <td class="p-2">
                        <button onclick="supprimerDisjoncteur(${index})" class="bg-red-500 text-white p-1 rounded-sm">Supprimer</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            console.log('[Create] Disjoncteurs affichés:', disjoncteurs.map(d => d.id));
        }

        function supprimerDisjoncteur(index) {
            console.log('[Create] Bouton Supprimer cliqué, index:', index);
            const disjoncteur = disjoncteurs[index];
            if (!disjoncteur) {
                console.error('[Create] Disjoncteur non trouvé à l\'index:', index);
                showPopup('Erreur: Disjoncteur non trouvé.', () => {});
                return;
            }
            showPopup(`Voulez-vous supprimer le disjoncteur ${disjoncteur.id} ?`, '', () => {
                console.log('[Create] Confirmation suppression disjoncteur:', disjoncteur.id);
                disjoncteurs.splice(index, 1);
                afficherDisjoncteurs();
                hidePopup();
                console.log('[Create] Disjoncteur supprimé:', disjoncteur.id);
            });
        }

        async function enregistrerTableau() {
            console.log('[Create] Bouton Enregistrer le tableau cliqué');
            const tableauId = document.getElementById('tableau-id').value.trim();
            console.log('[Create] Tableau ID:', tableauId, 'Disjoncteurs:', disjoncteurs.length);
            if (!tableauId || disjoncteurs.length === 0) {
                console.log('[Create] Erreur: ID tableau ou disjoncteurs vide');
                showPopup('Veuillez entrer un identifiant et ajouter au moins un disjoncteur.', () => {});
                return;
            }

            try {
                console.log('[Create] Envoi requête POST /api/tableaux', { id: tableauId, disjoncteurs });
                const response = await fetch('/api/tableaux', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: tableauId, disjoncteurs })
                });
                const data = await response.json();
                console.log('[Create] Réponse serveur:', data);
                if (response.ok) {
                    showPopup('Tableau enregistré avec succès !', '', () => {
                        console.log('[Create] Tableau enregistré, redirection vers view.html');
                        window.location.href = 'view.html';
                    });
                } else {
                    console.log('[Create] Erreur serveur:', data.error);
                    showPopup('Erreur lors de l\'enregistrement: ' + data.error, () => {});
                }
            } catch (error) {
                console.error('[Create] Erreur enregistrement:', error);
                showPopup('Erreur lors de l\'enregistrement: ' + error.message, () => {});
            }
        }

        function showPopup(message, content = '', confirmCallback = () => {}) {
            console.log('[Create] Affichage pop-up:', message);
            document.getElementById('popup-message').textContent = message;
            document.getElementById('popup-content').innerHTML = content;
            document.getElementById('popup').classList.remove('hidden');
            document.getElementById('popup-confirm').onclick = () => {
                console.log('[Create] Pop-up confirmé:', message);
                confirmCallback();
            };
            document.getElementById('popup-cancel').onclick = () => {
                console.log('[Create] Pop-up annulé:', message);
                hidePopup();
            };
        }

        function hidePopup() {
            console.log('[Create] Masquage pop-up');
            document.getElementById('popup').classList.add('hidden');
        }

        window.onload = () => {
            console.log('[Create] Initialisation page create');
            document.getElementById('tableau-id').value = '';
            chargerDisjoncteursExistants();
        };
    </script>
</body>
</html>